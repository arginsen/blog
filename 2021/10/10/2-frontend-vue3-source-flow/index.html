<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta name="google-site-verification" content="OcsZXBpQqAp8163-20wn3epncmCv_UBtqBLZmspy-NA">
  
  <title>ğŸ”¥ å‰ç«¯ | vue3 æºç å­¦ä¹  - æµç¨‹ | Arginsen&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="FrontendVue">
  
  
  
  
  <meta name="keywords" content="Frontend,Vue">
<meta property="og:type" content="article">
<meta property="og:title" content="ğŸ”¥ å‰ç«¯ | vue3 æºç å­¦ä¹  - æµç¨‹">
<meta property="og:url" content="https://arginsen.github.io/blog/2021/10/10/2-frontend-vue3-source-flow/index.html">
<meta property="og:site_name" content="Arginsen&#39;s Blog">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://arginsen.github.io/blog/img/vue.jpg">
<meta property="og:updated_time" content="2025-07-31T17:56:57.929Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ğŸ”¥ å‰ç«¯ | vue3 æºç å­¦ä¹  - æµç¨‹">
<meta name="twitter:image" content="https://arginsen.github.io/blog/img/vue.jpg">
  
    <link rel="alternate" href="/atom.xml" title="Arginsen&#39;s Blog" type="application/atom+xml">
  
  <link rel="icon" href="/blog/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/blog/css/style.css">

  <script src="/blog/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/blog/css/bootstrap.css">
  <link rel="stylesheet" href="/blog/css/fashion.css">
  <link rel="stylesheet" href="/blog/css/glyphs.css">

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  



<header id="allheader" class="site-header" role="banner" 
   >
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/blog/" title="Arginsen&#39;s Blog" rel="home"> Arginsen&#39;s Blog </a>
            
          </h1>
          
          
            <div class="site-description">smells like teen spirit</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows"  style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/">é¦–é¡µ</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/archives">å½’æ¡£</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/categories">åˆ†ç±»</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/about">å…³äº</a> </li>
                    
              </ul>
            </div>
          </nav>
      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-2-frontend-vue3-source-flow" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="/blog/img/vue.jpg" rel="gallery_cmdraqvqh00rirlpu789n9782">
        <img src="/blog/img/vue.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      ğŸ”¥ å‰ç«¯ | vue3 æºç å­¦ä¹  - æµç¨‹
    </h1>
  

      </header>
    

    <div class="article-entry" itemprop="articleBody">
      
        <p><br><br><a id="more"></a></p>
<h1 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h1><p>æ‹‰å– vue-next æºç </p>
<p>vue3 å®‰è£…ä¾èµ–ä¼šèµ° preinstallï¼Œè¿›å…¥åˆ°é¢„æ£€ï¼Œä¼šè¦æ±‚ä½¿ç”¨ pnmp åŒ…æ¥è¿›è¡Œå®‰è£…ï¼Œè¿™é‡Œä½¿ç”¨ yarn å¿½ç•¥è„šæœ¬å®‰è£…ã€‚</p>
<p>å®‰è£…è¿‡ç¨‹ä¼šåœ¨å‘½ä»¤è¡Œè¿›è¡Œäº¤äº’ï¼Œé€‰å–å®‰è£…çš„ @vue/reactivity , @vue/runtime-core , @vue/runtime-dom çš„ç‰ˆæœ¬ï¼Œé€‰æ‹©æœ€æ–°ç‰ˆå®‰è£…å³å¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn --ignore-scripts</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥åœ¨ package.json çœ‹åˆ°ï¼Œscripts å†…çš„ dev è¿è¡Œçš„æ˜¯è·¯å¾„ scripts/dev.js</p>
<p>dev.js å†…å¯ä»¥çœ‹åˆ°å®ç°çš„æ˜¯ä½¿ç”¨ rollup æ‰“åŒ…ï¼Œä½¿ç”¨ minimist åº“æ¥æ”¶é›†å‘½ä»¤è¡Œä¼ æ¥çš„å‚æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨æ­¤å¤„æ˜¯éœ€è¦è°ƒè¯•ä»£ç å°±éœ€è¦å¼€å¯ sourcemapï¼Œäºæ˜¯åœ¨ package.json çš„ dev æŒ‡ä»¤è¿½åŠ  <code>--sourcemap</code> å‚æ•°</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scripts/dev.js</span></span><br><span class="line"><span class="keyword">const</span> execa = <span class="built_in">require</span>(<span class="string">'execa'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; fuzzyMatchTarget &#125; = <span class="built_in">require</span>(<span class="string">'./utils'</span>)</span><br><span class="line"><span class="keyword">const</span> args = <span class="built_in">require</span>(<span class="string">'minimist'</span>)(process.argv.slice(<span class="number">2</span>))</span><br><span class="line"><span class="keyword">const</span> target = args._.length ? fuzzyMatchTarget(args._)[<span class="number">0</span>] : <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">const</span> formats = args.formats || args.f</span><br><span class="line"><span class="keyword">const</span> sourceMap = args.sourcemap || args.s</span><br><span class="line"><span class="keyword">const</span> commit = execa.sync(<span class="string">'git'</span>, [<span class="string">'rev-parse'</span>, <span class="string">'HEAD'</span>]).stdout.slice(<span class="number">0</span>, <span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">execa(</span><br><span class="line">  <span class="string">'rollup'</span>,</span><br><span class="line">  [</span><br><span class="line">    <span class="string">'-wc'</span>,</span><br><span class="line">    <span class="string">'--environment'</span>,</span><br><span class="line">    [</span><br><span class="line">      <span class="string">`COMMIT:<span class="subst">$&#123;commit&#125;</span>`</span>,</span><br><span class="line">      <span class="string">`TARGET:<span class="subst">$&#123;target&#125;</span>`</span>,</span><br><span class="line">      <span class="string">`FORMATS:<span class="subst">$&#123;formats || <span class="string">'global'</span>&#125;</span>`</span>,</span><br><span class="line">      sourceMap ? <span class="string">`SOURCE_MAP:true`</span> : <span class="string">``</span></span><br><span class="line">    ]</span><br><span class="line">      .filter(<span class="built_in">Boolean</span>)</span><br><span class="line">      .join(<span class="string">','</span>)</span><br><span class="line">  ],</span><br><span class="line">  &#123;</span><br><span class="line">    stdio: <span class="string">'inherit'</span></span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"private"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"3.2.21"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"dev"</span>: <span class="string">"node scripts/dev.js --sourcemap"</span>,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥è¿›å…¥å¼€å‘æ¨¡å¼, å¼€å§‹ç”¨ rollup æ‰“åŒ…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yarn run dev</span><br><span class="line"></span><br><span class="line">rollup v2.38.5</span><br><span class="line">bundles E:\vue-next\packages\vue\src\index.ts â†’ packages\vue\dist\vue.global.js...</span><br><span class="line">created packages\vue\dist\vue.global.js in 18.3s</span><br></pre></td></tr></table></figure>
<p>å†æ¥åˆ†æä¸‹æ‰“åŒ…æ˜¯æ¥ç€æ€ä¹ˆå¾€ä¸‹èµ°çš„ã€‚å¯ä»¥åœ¨ä¸Šè¾¹çœ‹åˆ° dev.js é‡Œè·å–çš„ targetï¼Œä¹Ÿå°±æ˜¯ rollup è¦æ‰“åŒ…çš„ç›®æ ‡ï¼Œè‹¥æ˜¯å‘½ä»¤è¡Œç”¨æˆ·æ²¡æœ‰æŒ‡å®šç›®æ ‡ï¼Œé‚£ä¹ˆé»˜è®¤ä¸º vue</p>
<p>å†æ¥çœ‹ rollup.config.js , å…¶è·å–å½“ä¸‹ç›®å½•ä¸‹çš„ package è·¯å¾„ï¼Œå†åœ¨ package ä¸­è¯»å– rollup æ³¨å…¥ç¯å¢ƒå˜é‡çš„ TARGETï¼Œä¹Ÿå°±æ˜¯ vue , è·å– vue ç›®å½•ä¸‹çš„ package.json å¹¶è¯»å–ï¼Œå¾—åˆ° vue çš„æ„å»ºé…ç½®ï¼Œä»¥åŠå‘½åï¼Œé»˜è®¤ä¸º vue</p>
<p>æ¥ç€å°±è¿›å…¥è¾“å‡ºé…ç½®çš„è¯»å–ï¼Œä¹‹å‰åœ¨ dev.js ä¸­æˆ‘ä»¬å¯¹æ‰“åŒ…çš„ç‰ˆå¼å¹¶æœªé…ç½®ï¼Œä¹Ÿå¯ä»¥åœ¨é…ç½®ä¸­è®¾ç½®ç‰ˆå¼ï¼Œé»˜è®¤ä¸º globalï¼Œä¹Ÿå¯ä»¥å‡ºè¿è¡Œæ—¶ç‰ˆæœ¬çš„ï¼Œé‚£æ ·å°±å°‘äº†ç¼–è¯‘ç¯èŠ‚ã€‚é‚£ä¹ˆæˆ‘ä»¬åœ¨æ­¤å¤„è·å–çš„æ ¼å¼å°±æ˜¯ global</p>
<p>æœ€åå¼€å§‹æ„å»ºï¼ŒæŒ‰ç…§ vue/package.json ä¸­çš„æ„å»ºé…ç½®ï¼Œä»å…¥å£ vue/src/index.ts å¼€å§‹ï¼Œè¾“å‡ºä¸º vue/dist/vue.global.js , è¿™ä¸ªæ–‡ä»¶å³æ˜¯æˆ‘ä»¬è°ƒè¯•æ‰€è¦å¼•ç”¨çš„ vue æ–‡ä»¶</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rollup.config.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> packagesDir = path.resolve(__dirname, <span class="string">'packages'</span>)</span><br><span class="line"><span class="keyword">const</span> packageDir = path.resolve(packagesDir, process.env.TARGET)</span><br><span class="line"><span class="keyword">const</span> resolve = <span class="function"><span class="params">p</span> =&gt;</span> path.resolve(packageDir, p)</span><br><span class="line"><span class="keyword">const</span> pkg = <span class="built_in">require</span>(resolve(<span class="string">`package.json`</span>))</span><br><span class="line"><span class="keyword">const</span> packageOptions = pkg.buildOptions || &#123;&#125;</span><br><span class="line"><span class="keyword">const</span> name = packageOptions.filename || path.basename(packageDir)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> outputConfigs = &#123;</span><br><span class="line">  <span class="string">'esm-bundler'</span>: &#123;</span><br><span class="line">    file: resolve(<span class="string">`dist/<span class="subst">$&#123;name&#125;</span>.esm-bundler.js`</span>),</span><br><span class="line">    format: <span class="string">`es`</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">'esm-browser'</span>: &#123;</span><br><span class="line">    file: resolve(<span class="string">`dist/<span class="subst">$&#123;name&#125;</span>.esm-browser.js`</span>),</span><br><span class="line">    format: <span class="string">`es`</span></span><br><span class="line">  &#125;,</span><br><span class="line">  cjs: &#123;</span><br><span class="line">    file: resolve(<span class="string">`dist/<span class="subst">$&#123;name&#125;</span>.cjs.js`</span>),</span><br><span class="line">    format: <span class="string">`cjs`</span></span><br><span class="line">  &#125;,</span><br><span class="line">  global: &#123;</span><br><span class="line">    file: resolve(<span class="string">`dist/<span class="subst">$&#123;name&#125;</span>.global.js`</span>),</span><br><span class="line">    format: <span class="string">`iife`</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// runtime-only builds, for main "vue" package only</span></span><br><span class="line">  <span class="string">'esm-bundler-runtime'</span>: &#123;</span><br><span class="line">    file: resolve(<span class="string">`dist/<span class="subst">$&#123;name&#125;</span>.runtime.esm-bundler.js`</span>),</span><br><span class="line">    format: <span class="string">`es`</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">'esm-browser-runtime'</span>: &#123;</span><br><span class="line">    file: resolve(<span class="string">`dist/<span class="subst">$&#123;name&#125;</span>.runtime.esm-browser.js`</span>),</span><br><span class="line">    format: <span class="string">'es'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">'global-runtime'</span>: &#123;</span><br><span class="line">    file: resolve(<span class="string">`dist/<span class="subst">$&#123;name&#125;</span>.runtime.global.js`</span>),</span><br><span class="line">    format: <span class="string">'iife'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> defaultFormats = [<span class="string">'esm-bundler'</span>, <span class="string">'cjs'</span>]</span><br><span class="line"><span class="keyword">const</span> inlineFormats = process.env.FORMATS &amp;&amp; process.env.FORMATS.split(<span class="string">','</span>)</span><br><span class="line"><span class="keyword">const</span> packageFormats = inlineFormats || packageOptions.formats || defaultFormats</span><br><span class="line"><span class="keyword">const</span> packageConfigs = process.env.PROD_ONLY</span><br></pre></td></tr></table></figure>
<h1 id="è°ƒè¯•é…ç½®"><a href="#è°ƒè¯•é…ç½®" class="headerlink" title="è°ƒè¯•é…ç½®"></a>è°ƒè¯•é…ç½®</h1><p>åœ¨ vscode åˆ›å»ºä¸€ä¸ªè°ƒè¯•ç¯å¢ƒ , é…ç½® launch.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"0.2.0"</span>,</span><br><span class="line">  <span class="attr">"configurations"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"launch Chrome"</span>,</span><br><span class="line">      <span class="attr">"request"</span>: <span class="string">"launch"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"chrome"</span>,</span><br><span class="line">      <span class="attr">"file"</span>: <span class="string">"$&#123;workspaceFolder&#125;/packages/vue/dist/index.html"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¯¥ç›®å½•ä¸‹åˆ›å»º index.html å’Œ index.js , å°±å¯ä»¥å¼€å§‹è°ƒè¯•äº†</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">      &#123;&#123; state.foo &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../dist/vue.global.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"practice.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createApp, reactive, ref &#125; = Vue</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = createApp(&#123;</span><br><span class="line">  setup() &#123;</span><br><span class="line">    <span class="keyword">let</span> state = reactive(&#123;</span><br><span class="line">      foo: <span class="string">'Reactive'</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      state</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.mount(<span class="string">'#app'</span>)</span><br></pre></td></tr></table></figure>
<h1 id="æºç æµç¨‹"><a href="#æºç æµç¨‹" class="headerlink" title="æºç æµç¨‹"></a>æºç æµç¨‹</h1><h1 id="createApp"><a href="#createApp" class="headerlink" title="createApp"></a>createApp</h1><p>vue3 å°†åˆ›å»º vue å®ä¾‹çš„å‡½æ•°æ¢æˆäº† createApp , é¦–å…ˆå°±æ¥åˆ° runtime-dom ä¸‹çš„åŒ…é‡Œï¼Œæ­¤å¤–ä¹Ÿèƒ½çœ‹åˆ°è¯¥å±‚è¿˜æš´éœ²å‡ºå»äº† render å‡½æ•°</p>
<p>å¯ä»¥çœ‹åˆ°é¦–å…ˆåˆ›å»º app , æ˜¯è°ƒç”¨ ensureRenderer æ–¹æ³•, ç¡®ä¿æ˜¯å¦å­˜åœ¨æœ‰ renderer , è‹¥æ— åˆ™è°ƒç”¨ createRenderer æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„ renderer , è€Œè¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªåŒ…å« render, createApp æ–¹æ³•çš„å¯¹è±¡, è¿™ä¹Ÿå°±è§£é‡Šäº† <code>ensureRenderer()</code> æ‰§è¡Œåæ¥ç€è°ƒç”¨ createApp() , createApp æ–¹æ³•æŒ‡å‘çš„å®é™…æ˜¯ createAppAPI, æœ€åæ˜¯è°ƒç”¨è¯¥æ–¹æ³•ç”Ÿæˆ app , æ¥ç€å†è¿›è¡Œæ‹¦æˆª mount;</p>
<p>ä»¥ä¸Šå°±å¤–å±‚ä»£ç åˆ›å»º app èµ°å®Œäº†, æ¥ä¸‹æ¥ä¼šè¿›è¡Œç¼–è¯‘, åœ¨ createApp æ—¶èµ‹äºˆäº† mount æ–¹æ³•, å¹¶åœ¨åˆå§‹åŒ– app åå¯¹ mount æ–¹æ³•è¿›è¡Œäº†æ‹¦æˆªå¤„ç†</p>
<p>é¦–å…ˆå¾—åˆ°æ ¹èŠ‚ç‚¹, å¾—åˆ°å½“å‰çš„ç»„ä»¶å¯¹è±¡, çœ‹æ˜¯å¦æ˜¯å‡½æ•°, æ˜¯å¦å­˜åœ¨ render, template, è‹¥å‡ä¸ºåˆ™å¯¹å±æ€§è¿›è¡Œæ‹¦æˆªå¤„ç†, æ¥ç€æ¸…ç©ºèŠ‚ç‚¹, æ‰§è¡Œ mount</p>
<p>å¤§è‡´ä¸ vue2 ä¸€æ ·çš„ç¼–è¯‘ç”Ÿæˆä»£ç , å†ç”Ÿæˆè™šæ‹ŸèŠ‚ç‚¹, æœ€åè½¬ä¸ºçœŸå® dom æ¸²æŸ“ä¸Šå»çš„æµç¨‹</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\runtime-dom\src\index.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; createRenderer &#125; <span class="keyword">from</span> <span class="string">'@vue/runtime-core'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rendererOptions = extend(&#123; patchProp &#125;, nodeOps)</span><br><span class="line"><span class="keyword">let</span> renderer: Renderer&lt;Element | ShadowRoot&gt; | HydrationRenderer</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰ ensureRenderer</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ensureRenderer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    renderer ||</span><br><span class="line">    (renderer = createRenderer&lt;Node, Element | ShadowRoot&gt;(rendererOptions))</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨è¿è¡Œæ—¶æš´éœ² render æ–¹æ³•</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> render = <span class="function">(<span class="params">(<span class="params">...args</span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  ensureRenderer(<span class="params"></span>).render(<span class="params">...args</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">&#125;</span>) <span class="params">as</span> <span class="params">RootRenderFunction</span>&lt;<span class="params">Element</span> | <span class="params">ShadowRoot</span>&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// å®šä¹‰ <span class="params">createApp</span></span></span><br><span class="line"><span class="function"><span class="params">export</span> <span class="params">const</span> <span class="params">createApp</span> = (<span class="params">(<span class="params">...args</span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">const</span> app = ensureRenderer(<span class="params"></span>).createApp(<span class="params">...args</span>)</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">if</span> (<span class="params">__DEV__</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    injectNativeTagCheck(<span class="params">app</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">    injectCompilerOptionsCheck(<span class="params">app</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// è·å–åˆå§‹åŒ– app åœ¨ createAppAPI æ—¶å®šä¹‰çš„ mount æ–¹æ³•</span></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">const</span> &#123; mount &#125; = app</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="comment">// æ‹¦æˆª mount è¿›è¡Œä»£ç†</span></span></span></span><br><span class="line"><span class="function"><span class="params">  app.mount = (<span class="params">containerOrSelector: Element | ShadowRoot | <span class="built_in">string</span></span>): <span class="built_in">any</span> =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">// å¾—åˆ°æ ¹èŠ‚ç‚¹</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> container = normalizeContainer(<span class="params">containerOrSelector</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">if</span> (<span class="params">!container</span>) <span class="keyword">return</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">// åˆ›å»º app å¯¹è±¡æ—¶ä»¤ _component ç­‰äºæ ¹ç»„ä»¶ rootComponent</span></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> component = app._component</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">if</span> (<span class="params">!isFunction(<span class="params">component</span>) &amp;&amp; !component.render &amp;&amp; !component.template</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="comment">// __UNSAFE__</span></span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="comment">// Reason: potential execution of JS expressions in in-DOM template.</span></span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="comment">// The user must make sure the in-DOM template is trusted. If it's</span></span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="comment">// rendered by the server, the template should not contain any user data.</span></span></span></span><br><span class="line"><span class="function"><span class="params">      component.template = container.innerHTML</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="comment">// 2.x compat check</span></span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">if</span> (<span class="params">__COMPAT__ &amp;&amp; __DEV__</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">for</span> (<span class="params"><span class="keyword">let</span> i = 0; i &lt; container.attributes.length; i++</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">const</span> attr = container.attributes[i]</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">if</span> (<span class="params">attr.name !== 'v-cloak' &amp;&amp; /^(<span class="params">v-|:|@</span>)/.test(<span class="params">attr.name</span>)</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">            compatUtils.warnDeprecation(<span class="params"></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">              DeprecationTypes.GLOBAL_MOUNT_CONTAINER,</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">              <span class="literal">null</span></span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">            </span>)</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">break</span></span></span></span><br><span class="line"><span class="function"><span class="params">          &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">        &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">// clear content before mounting</span></span></span></span><br><span class="line"><span class="function"><span class="params">    container.innerHTML = ''</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> proxy = mount(<span class="params">container, <span class="literal">false</span>, container <span class="keyword">instanceof</span> SVGElement</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">if</span> (<span class="params">container <span class="keyword">instanceof</span> Element</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      container.removeAttribute(<span class="params">'v-cloak'</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">      container.setAttribute(<span class="params">'data-v-app', ''</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">return</span> proxy</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">return</span> app</span></span></span><br><span class="line"><span class="function"><span class="params">&#125;</span>) <span class="params">as</span> <span class="params">CreateAppFunction</span>&lt;<span class="params">Element</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="createRenderer"><a href="#createRenderer" class="headerlink" title="createRenderer"></a>createRenderer</h2><p>createRenderer å‡½æ•°æ¥åˆ°è¿è¡Œæ—¶çš„æ ¸å¿ƒ, è¯¥æ–¹æ³•æ¥æ”¶ render çš„é…ç½®, RendererOptions å†…éƒ¨æ•´åˆäº†å„ç±»æ‰“åŒ…æ¸²æŸ“å‡½æ•°, ä»ç±»å‹æ¥çœ‹åŒ…å«æœ‰ Node, Element</p>
<p>æ¥ç€æ¥åˆ° baseCreateRenderer å‡½æ•°, è¿™æ˜¯ä¸€ä¸ªä½“é‡å·¨å¤§çš„å‡½æ•°, é‡Œè¾¹å®šä¹‰äº†è®¸å¤šæ–¹æ³•, å¦‚ä¸‹æ‰€åˆ—, æœ€åç”¨ internals å¯¹è±¡å°è£…äº†ä¸€äº›æ–¹æ³•çš„ç®€ç§°, æœ€ç»ˆè¿”å›ä¸€ä¸ªå¯¹è±¡, åŒ…å« render, hydrate, createApp;</p>
<p>åˆ°æ­¤å°±ç»“æŸäº†, è‡³äºä»¥ä¸Šçš„ä¸€å †æ–¹æ³•, ç­‰è°ƒç”¨æ—¶æˆ‘ä»¬è‡ªä¼šçŸ¥é“, å…ˆæ¥ç€å¾€ä¸‹çœ‹ <code>createAppAPI(render, hydrate)</code> çš„æ‰§è¡Œ, å› ä¸ºä¸Šä¸€æ­¥æ‰§è¡Œåˆ° <code>createApp(...args)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">patch, processText, processCommentNode, mountStaticNode, patchStaticNode,</span><br><span class="line">moveStaticNode, removeStaticNode, processElement, mountElement, setScopeId,</span><br><span class="line">mountChildren, patchElement, patchBlockChildren, patchProps,</span><br><span class="line">processFragment, processComponent, mountComponent, updateComponent,</span><br><span class="line">setupRenderEffect, updateComponentPreRender, patchChildren,</span><br><span class="line">patchKeyedChildren, move, mount, remove, removeFragment, unmountComponent,</span><br><span class="line">unmountChildren, getNextHostNode, render</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> internals: RendererInternals = &#123;</span><br><span class="line">  p: patch,</span><br><span class="line">  um: unmount,</span><br><span class="line">  m: move,</span><br><span class="line">  r: remove,</span><br><span class="line">  mt: mountComponent,</span><br><span class="line">  mc: mountChildren,</span><br><span class="line">  pc: patchChildren,</span><br><span class="line">  pbc: patchBlockChildren,</span><br><span class="line">  n: getNextHostNode,</span><br><span class="line">  o: options</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\runtime-core\src\renderer.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRenderer</span>&lt;</span></span><br><span class="line"><span class="function">  <span class="title">HostNode</span> = <span class="title">RendererNode</span>,</span></span><br><span class="line"><span class="function">  <span class="title">HostElement</span> = <span class="title">RendererElement</span></span></span><br><span class="line"><span class="function">&gt;(<span class="params">options: RendererOptions&lt;HostNode, HostElement&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> baseCreateRenderer&lt;HostNode, HostElement&gt;(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">baseCreateRenderer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  options: RendererOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">  createHydrationFns?: <span class="keyword">typeof</span> createHydrationFunctions</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="comment">// compile-time feature flags check</span></span><br><span class="line">  <span class="keyword">if</span> (__ESM_BUNDLER__ &amp;&amp; !__TEST__) &#123;</span><br><span class="line">    initFeatureFlags()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–å½“å‰å…¨å±€å˜é‡ window</span></span><br><span class="line">  <span class="keyword">const</span> target = getGlobalThis()</span><br><span class="line">  target.__VUE__ = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">    setDevtoolsHook(target.__VUE_DEVTOOLS_GLOBAL_HOOK__, target)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä»å‚æ•° render çš„é…ç½®ä¸­æå–ä¸‹åˆ—æ–¹æ³•</span></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    insert: hostInsert,</span><br><span class="line">    remove: hostRemove,</span><br><span class="line">    patchProp: hostPatchProp,</span><br><span class="line">    createElement: hostCreateElement,</span><br><span class="line">    createText: hostCreateText,</span><br><span class="line">    createComment: hostCreateComment,</span><br><span class="line">    setText: hostSetText,</span><br><span class="line">    setElementText: hostSetElementText,</span><br><span class="line">    parentNode: hostParentNode,</span><br><span class="line">    nextSibling: hostNextSibling,</span><br><span class="line">    setScopeId: hostSetScopeId = NOOP,</span><br><span class="line">    cloneNode: hostCloneNode,</span><br><span class="line">    insertStaticContent: hostInsertStaticContent</span><br><span class="line">  &#125; = options</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> hydrate: ReturnType&lt;<span class="keyword">typeof</span> createHydrationFunctions&gt;[<span class="number">0</span>] | <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">let</span> hydrateNode: ReturnType&lt;<span class="keyword">typeof</span> createHydrationFunctions&gt;[<span class="number">1</span>] | <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">if</span> (createHydrationFns) &#123;</span><br><span class="line">    ;[hydrate, hydrateNode] = createHydrationFns(</span><br><span class="line">      internals <span class="keyword">as</span> RendererInternals&lt;Node, Element&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    render,</span><br><span class="line">    hydrate,</span><br><span class="line">    createApp: createAppAPI(render, hydrate)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createAppAPI"><a href="#createAppAPI" class="headerlink" title="createAppAPI"></a>createAppAPI</h2><p>æ¥åˆ° apiCreateApp æ–‡ä»¶, å¯ä»¥çœ‹åˆ° <code>createAppAPI(render, hydrate)</code> åˆšå¥½æ˜¯æˆ‘ä»¬ä¸Šä¸€æ­¥å¾—åˆ°çš„, è¿”å›å®é™…çš„ createApp å‡½æ•°, åœ¨æ­¤æ¥æ”¶æˆ‘ä»¬ä»åˆå§‹ä¼ å…¥çš„å‚æ•° args, ä¹Ÿå°±æ˜¯æ­¤æ—¶çš„ rootComponent æ ¹ç»„ä»¶;</p>
<p>æ¥ç€å¼€å§‹åˆ›å»º app, å¯ä»¥çœ‹åˆ° app å®é™…ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå¡æ»¡äº†æ–¹æ³•çš„å¯¹è±¡, éœ€è¦æ—¶è°ƒç”¨å…¶ä¸Šæ–¹æ³•, è¿™äº›ä¹Ÿæ˜¯æ”¹å˜å…¨å±€ Vue è¡Œä¸ºçš„ API, å¦‚æˆ‘ä»¬ä¸€èˆ¬åœ¨é¡¹ç›®ä¸­ä¼šä¹¦å†™:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = createApp(App)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†Œå„ç±»æ’ä»¶</span></span><br><span class="line">app.use(router).use(store).use(ElementPlus)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡ŒæŒ‚è½½æ–¹æ³•</span></span><br><span class="line">app.mount(<span class="string">'#app'</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\runtime-core\src\apiCreateApp.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createAppAPI</span>&lt;<span class="title">HostElement</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  render: RootRenderFunction,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrate?: RootHydrateFunction</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">CreateAppFunction</span>&lt;<span class="title">HostElement</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">createApp</span>(<span class="params">rootComponent, rootProps = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rootProps != <span class="literal">null</span> &amp;&amp; !isObject(rootProps)) &#123;</span><br><span class="line">      __DEV__ &amp;&amp; warn(<span class="string">`root props passed to app.mount() must be an object.`</span>)</span><br><span class="line">      rootProps = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> context = createAppContext()</span><br><span class="line">    <span class="comment">// ç¼“å­˜å·²å®‰è£…çš„æ’ä»¶</span></span><br><span class="line">    <span class="keyword">const</span> installedPlugins = <span class="keyword">new</span> Set()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ‡è®°å°šæœªæŒ‚è½½</span></span><br><span class="line">    <span class="keyword">let</span> isMounted = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† app åŒæ—¶å­˜å‚¨åœ¨ context ä¸‹</span></span><br><span class="line">    <span class="keyword">const</span> app: App = (context.app = &#123;</span><br><span class="line">      _uid: uid++,</span><br><span class="line">      _component: rootComponent <span class="keyword">as</span> ConcreteComponent,</span><br><span class="line">      _props: rootProps,</span><br><span class="line">      _container: <span class="literal">null</span>,</span><br><span class="line">      _context: context,</span><br><span class="line">      _instance: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">      version,</span><br><span class="line"></span><br><span class="line">      <span class="keyword">get</span> config() &#123;</span><br><span class="line">        <span class="keyword">return</span> context.config</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="keyword">set</span> config(v) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          warn(</span><br><span class="line">            <span class="string">`app.config cannot be replaced. Modify individual options instead.`</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      use(plugin: Plugin, ...options: <span class="built_in">any</span>[]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (installedPlugins.has(plugin)) &#123;</span><br><span class="line">          __DEV__ &amp;&amp; warn(<span class="string">`Plugin has already been applied to target app.`</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (plugin &amp;&amp; isFunction(plugin.install)) &#123;</span><br><span class="line">          installedPlugins.add(plugin)</span><br><span class="line">          plugin.install(app, ...options)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isFunction(plugin)) &#123;</span><br><span class="line">          installedPlugins.add(plugin)</span><br><span class="line">          plugin(app, ...options)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          warn(</span><br><span class="line">            <span class="string">`A plugin must either be a function or an object with an "install" `</span> +</span><br><span class="line">              <span class="string">`function.`</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      mixin(mixin: ComponentOptions) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__FEATURE_OPTIONS_API__) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!context.mixins.includes(mixin)) &#123;</span><br><span class="line">            context.mixins.push(mixin)</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            warn(</span><br><span class="line">              <span class="string">'Mixin has already been applied to target app'</span> +</span><br><span class="line">                (mixin.name ? <span class="string">`: <span class="subst">$&#123;mixin.name&#125;</span>`</span> : <span class="string">''</span>)</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          warn(<span class="string">'Mixins are only available in builds supporting Options API'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      component(name: <span class="built_in">string</span>, component?: Component): <span class="built_in">any</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          validateComponentName(name, context.config)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!component) &#123;</span><br><span class="line">          <span class="keyword">return</span> context.components[name]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__ &amp;&amp; context.components[name]) &#123;</span><br><span class="line">          warn(<span class="string">`Component "<span class="subst">$&#123;name&#125;</span>" has already been registered in target app.`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        context.components[name] = component</span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      directive(name: <span class="built_in">string</span>, directive?: Directive) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          validateDirectiveName(name)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!directive) &#123;</span><br><span class="line">          <span class="keyword">return</span> context.directives[name] <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__ &amp;&amp; context.directives[name]) &#123;</span><br><span class="line">          warn(<span class="string">`Directive "<span class="subst">$&#123;name&#125;</span>" has already been registered in target app.`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        context.directives[name] = directive</span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      mount(</span><br><span class="line">        rootContainer: HostElement,</span><br><span class="line">        isHydrate?: <span class="built_in">boolean</span>,</span><br><span class="line">        isSVG?: <span class="built_in">boolean</span></span><br><span class="line">      ): <span class="built_in">any</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isMounted) &#123;</span><br><span class="line">          <span class="keyword">const</span> vnode = createVNode(</span><br><span class="line">            rootComponent <span class="keyword">as</span> ConcreteComponent,</span><br><span class="line">            rootProps</span><br><span class="line">          )</span><br><span class="line">          <span class="comment">// store app context on the root VNode.</span></span><br><span class="line">          <span class="comment">// this will be set on the root instance on initial mount.</span></span><br><span class="line">          vnode.appContext = context</span><br><span class="line"></span><br><span class="line">          <span class="comment">// HMR root reload</span></span><br><span class="line">          <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">            context.reload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">              render(cloneVNode(vnode), rootContainer, isSVG)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (isHydrate &amp;&amp; hydrate) &#123;</span><br><span class="line">            hydrate(vnode <span class="keyword">as</span> VNode&lt;Node, Element&gt;, rootContainer <span class="keyword">as</span> <span class="built_in">any</span>)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            render(vnode, rootContainer, isSVG)</span><br><span class="line">          &#125;</span><br><span class="line">          isMounted = <span class="literal">true</span></span><br><span class="line">          app._container = rootContainer</span><br><span class="line">          <span class="comment">// for devtools and telemetry</span></span><br><span class="line">          ;(rootContainer <span class="keyword">as</span> <span class="built_in">any</span>).__vue_app__ = app</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">            app._instance = vnode.component</span><br><span class="line">            devtoolsInitApp(app, version)</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> getExposeProxy(vnode.component!) || vnode.component!.proxy</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          warn(</span><br><span class="line">            <span class="string">`App has already been mounted.\n`</span> +</span><br><span class="line">              <span class="string">`If you want to remount the same app, move your app creation logic `</span> +</span><br><span class="line">              <span class="string">`into a factory function and create fresh app instances for each `</span> +</span><br><span class="line">              <span class="string">`mount - e.g. \`const createMyApp = () =&gt; createApp(App)\``</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      unmount() &#123;</span><br><span class="line">        <span class="keyword">if</span> (isMounted) &#123;</span><br><span class="line">          render(<span class="literal">null</span>, app._container)</span><br><span class="line">          <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">            app._instance = <span class="literal">null</span></span><br><span class="line">            devtoolsUnmountApp(app)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">delete</span> app._container.__vue_app__</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          warn(<span class="string">`Cannot unmount an app that is not mounted.`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      provide(key, value) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__ &amp;&amp; (key <span class="keyword">as</span> <span class="built_in">string</span> | symbol) <span class="keyword">in</span> context.provides) &#123;</span><br><span class="line">          warn(</span><br><span class="line">            <span class="string">`App already provides property with key "<span class="subst">$&#123;<span class="built_in">String</span>(key)&#125;</span>". `</span> +</span><br><span class="line">              <span class="string">`It will be overwritten with the new value.`</span></span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// TypeScript doesn't allow symbols as index type</span></span><br><span class="line">        <span class="comment">// https://github.com/Microsoft/TypeScript/issues/24587</span></span><br><span class="line">        context.provides[key <span class="keyword">as</span> <span class="built_in">string</span>] = value</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (__COMPAT__) &#123;</span><br><span class="line">      installAppCompatProperties(app, context, render)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»º app çš„ä¸Šä¸‹æ–‡å¯¹è±¡</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createAppContext</span>(<span class="params"></span>): <span class="title">AppContext</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    app: <span class="literal">null</span> <span class="keyword">as</span> <span class="built_in">any</span>,</span><br><span class="line">    config: &#123;</span><br><span class="line">      isNativeTag: NO,</span><br><span class="line">      performance: <span class="literal">false</span>,</span><br><span class="line">      globalProperties: &#123;&#125;,</span><br><span class="line">      optionMergeStrategies: &#123;&#125;,</span><br><span class="line">      errorHandler: <span class="literal">undefined</span>,</span><br><span class="line">      warnHandler: <span class="literal">undefined</span>,</span><br><span class="line">      compilerOptions: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    mixins: [],</span><br><span class="line">    components: &#123;&#125;,</span><br><span class="line">    directives: &#123;&#125;,</span><br><span class="line">    provides: <span class="built_in">Object</span>.create(<span class="literal">null</span>),</span><br><span class="line">    optionsCache: <span class="keyword">new</span> WeakMap(),</span><br><span class="line">    propsCache: <span class="keyword">new</span> WeakMap(),</span><br><span class="line">    emitsCache: <span class="keyword">new</span> WeakMap()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="mount"><a href="#mount" class="headerlink" title="[mount]"></a>[mount]</h1><p>é¦–å…ˆè¿›å…¥ createAppApi å†…å®šä¹‰ app å¯¹è±¡æ—¶ä¼ å…¥çš„ mount æ–¹æ³•, æ£€æŸ¥å½“å‰æ˜¯å¦å·²ç»æŒ‚è½½, è‹¥æ˜¯åˆå§‹æŒ‚è½½, å…ˆä¼ å…¥æ ¹ç»„ä»¶å’Œæ ¹å±æ€§åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹ï¼›</p>
<p>ç»™æ ¹è™šæ‹ŸèŠ‚ç‚¹ä¿å­˜å…¨å±€å®ä¾‹ä¸Šä¸‹æ–‡; å¼€å‘ç¯å¢ƒä¸‹ç»‘å®šæ ¹å®ä¾‹çš„é‡è½½çš„æ–¹æ³•, åˆ©ç”¨å…‹éš†èŠ‚ç‚¹å† render</p>
<p>å†åˆ¤æ–­å½“å‰æ˜¯å¦ä½¿ hydrate çŠ¶æ€, å¦‚ä¸æ˜¯åˆ™è¿›è¡Œ render</p>
<p>render æ“ä½œåˆä¼šå›åˆ°ä¹‹å‰ baseCreateRenderer é˜¶æ®µå®šä¹‰çš„ render æ–¹æ³•</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\runtime-core\src\apiCreateApp.ts</span></span><br><span class="line">mount(</span><br><span class="line">  rootContainer: HostElement,</span><br><span class="line">  isHydrate?: <span class="built_in">boolean</span>,</span><br><span class="line">  isSVG?: <span class="built_in">boolean</span></span><br><span class="line">): <span class="built_in">any</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!isMounted) &#123;</span><br><span class="line">    <span class="keyword">const</span> vnode = createVNode(</span><br><span class="line">      rootComponent <span class="keyword">as</span> ConcreteComponent,</span><br><span class="line">      rootProps</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// store app context on the root VNode.</span></span><br><span class="line">    <span class="comment">// this will be set on the root instance on initial mount.</span></span><br><span class="line">    vnode.appContext = context</span><br><span class="line"></span><br><span class="line">    <span class="comment">// HMR root reload</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      context.reload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        render(cloneVNode(vnode), rootContainer, isSVG)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isHydrate &amp;&amp; hydrate) &#123;</span><br><span class="line">      hydrate(vnode <span class="keyword">as</span> VNode&lt;Node, Element&gt;, rootContainer <span class="keyword">as</span> <span class="built_in">any</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      render(vnode, rootContainer, isSVG)</span><br><span class="line">    &#125;</span><br><span class="line">    isMounted = <span class="literal">true</span></span><br><span class="line">    app._container = rootContainer</span><br><span class="line">    <span class="comment">// for devtools and telemetry</span></span><br><span class="line">    ;(rootContainer <span class="keyword">as</span> <span class="built_in">any</span>).__vue_app__ = app</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">      app._instance = vnode.component</span><br><span class="line">      devtoolsInitApp(app, version)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> getExposeProxy(vnode.component!) || vnode.component!.proxy</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`App has already been mounted.\n`</span> +</span><br><span class="line">        <span class="string">`If you want to remount the same app, move your app creation logic `</span> +</span><br><span class="line">        <span class="string">`into a factory function and create fresh app instances for each `</span> +</span><br><span class="line">        <span class="string">`mount - e.g. \`const createMyApp = () =&gt; createApp(App)\``</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createVNode"><a href="#createVNode" class="headerlink" title="createVNode"></a>createVNode</h2><p>æºå¸¦å‚æ•° æ ¹ç»„ä»¶å’Œæ ¹å±æ€§ åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹, å¦‚æœä¸ºå¼€å‘ç¯å¢ƒ, é‚£ä¹ˆèµ° createVNodeWithArgsTransform é€šé“, ç”Ÿäº§ç¯å¢ƒåˆ™èµ° <code>_createVNode</code>, ç›¸æ¯”ç”Ÿäº§ç¯å¢ƒ, å¼€å‘ç¯å¢ƒå¤šäº†åˆ¤æ–­, å¯¹å½“å‰å‚æ•°è¿›è¡Œè½¬æ¢, æ— è½¬æ¢æ ‡è®°ç›´æ¥å°†å‚æ•°å‚å…¥ <code>_createVNode</code></p>
<p>è¿›å…¥è¯¥å‡½æ•°åæ£€æŸ¥å½“å‰èŠ‚ç‚¹ç±»å‹æ˜¯å¦ä¸º VNode ç±»å‹, å¦‚æœæ˜¯åˆ™è¿›å…¥å…‹éš†, å†è§„èŒƒåŒ–å…¶å­èŠ‚ç‚¹</p>
<p>æ¥ç€æ£€æŸ¥æ˜¯å¦ä¸º class ç»„ä»¶, æ˜¯å¦ä¸ºå¼‚æ­¥æˆ–å‡½æ•°çš„ç»„ä»¶å½¢å¼</p>
<p>è‹¥å­˜åœ¨ props, åˆ™å¯¹å“åº”å¼åŒ–çš„æˆ–å·²è¢«ä»£ç†çš„å¯¹è±¡è¿›è¡Œå…‹éš†ä»¥ä½¿å…¶çŠ¶æ€æ”¹å˜</p>
<p>æ¥ç€è¿›å…¥åˆ°åŸºç¡€çš„è™šæ‹ŸèŠ‚ç‚¹åˆ›å»ºå‡½æ•° createBaseVNode, é™¤ _createVNode å‡½æ•°è¿”å›è°ƒç”¨æ­¤å‡½æ•°, åˆ›å»ºå…ƒç´ åŒºå— createElementBlock ä¹Ÿä¼šè°ƒç”¨</p>
<p>æœ€åè¿”å› vnode</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\runtime-core\src\vnode.ts</span></span><br><span class="line"><span class="comment">// åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹, ä¾æ®ç¯å¢ƒæ£€æµ‹åŒ¹é…å‡½æ•°</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createVNode = (</span><br><span class="line">  __DEV__ ? createVNodeWithArgsTransform : _createVNode</span><br><span class="line">) <span class="keyword">as</span> <span class="keyword">typeof</span> _createVNode</span><br><span class="line"></span><br><span class="line"><span class="comment">// vnodeArgsTransformer å®šä¹‰, é»˜è®¤ä¸º undefined</span></span><br><span class="line"><span class="keyword">let</span> vnodeArgsTransformer:</span><br><span class="line">  | ((</span><br><span class="line">      args: Parameters&lt;<span class="keyword">typeof</span> _createVNode&gt;,</span><br><span class="line">      instance: ComponentInternalInstance | <span class="literal">null</span></span><br><span class="line">    ) =&gt; Parameters&lt;<span class="keyword">typeof</span> _createVNode&gt;)</span><br><span class="line">  | <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼€å‘ç¯å¢ƒä¸‹åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹å‡½æ•°å‚æ•°è½¬æ¢</span></span><br><span class="line"><span class="keyword">const</span> createVNodeWithArgsTransform = (</span><br><span class="line">  ...args: Parameters&lt;<span class="keyword">typeof</span> _createVNode&gt;</span><br><span class="line">): <span class="function"><span class="params">VNode</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> _createVNode(</span><br><span class="line">    ...(vnodeArgsTransformer</span><br><span class="line">      ? vnodeArgsTransformer(args, currentRenderingInstance)</span><br><span class="line">      : args)</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_createVNode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">type</span>: VNodeTypes | ClassComponent | <span class="keyword">typeof</span> NULL_DYNAMIC_COMPONENT,</span></span></span><br><span class="line"><span class="function"><span class="params">  props: (Data &amp; VNodeProps) | <span class="literal">null</span> = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  children: unknown = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  patchFlag: <span class="built_in">number</span> = 0,</span></span></span><br><span class="line"><span class="function"><span class="params">  dynamicProps: <span class="built_in">string</span>[] | <span class="literal">null</span> = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  isBlockNode = <span class="literal">false</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">VNode</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">type</span> || <span class="keyword">type</span> === NULL_DYNAMIC_COMPONENT) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; !<span class="keyword">type</span>) &#123;</span><br><span class="line">      warn(<span class="string">`Invalid vnode type when creating vnode: <span class="subst">$&#123;<span class="keyword">type</span>&#125;</span>.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">type</span> = Comment</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isVNode(<span class="keyword">type</span>)) &#123;</span><br><span class="line">    <span class="comment">// createVNode receiving an existing vnode. This happens in cases like</span></span><br><span class="line">    <span class="comment">// &lt;component :is="vnode"/&gt;</span></span><br><span class="line">    <span class="comment">// #2078 make sure to merge refs during the clone instead of overwriting it</span></span><br><span class="line">    <span class="keyword">const</span> cloned = cloneVNode(<span class="keyword">type</span>, props, <span class="literal">true</span> <span class="comment">/* mergeRef: true */</span>)</span><br><span class="line">    <span class="keyword">if</span> (children) &#123;</span><br><span class="line">      normalizeChildren(cloned, children)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cloned</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// class component normalization.</span></span><br><span class="line">  <span class="keyword">if</span> (isClassComponent(<span class="keyword">type</span>)) &#123;</span><br><span class="line">    <span class="keyword">type</span> = <span class="keyword">type</span>.__vccOpts</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2.x async/functional component compat</span></span><br><span class="line">  <span class="keyword">if</span> (__COMPAT__) &#123;</span><br><span class="line">    <span class="keyword">type</span> = convertLegacyComponent(<span class="keyword">type</span>, currentRenderingInstance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// class &amp; style normalization.</span></span><br><span class="line">  <span class="keyword">if</span> (props) &#123;</span><br><span class="line">    <span class="comment">// for reactive or proxy objects, we need to clone it to enable mutation.</span></span><br><span class="line">    props = guardReactiveProps(props)!</span><br><span class="line">    <span class="keyword">let</span> &#123; <span class="keyword">class</span>: klass, style &#125; = props</span><br><span class="line">    <span class="keyword">if</span> (klass &amp;&amp; !isString(klass)) &#123;</span><br><span class="line">      props.class = normalizeClass(klass)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isObject(style)) &#123;</span><br><span class="line">      <span class="comment">// reactive state objects need to be cloned since they are likely to be</span></span><br><span class="line">      <span class="comment">// mutated</span></span><br><span class="line">      <span class="keyword">if</span> (isProxy(style) &amp;&amp; !isArray(style)) &#123;</span><br><span class="line">        style = extend(&#123;&#125;, style)</span><br><span class="line">      &#125;</span><br><span class="line">      props.style = normalizeStyle(style)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// encode the vnode type information into a bitmap</span></span><br><span class="line">  <span class="keyword">const</span> shapeFlag = isString(<span class="keyword">type</span>)</span><br><span class="line">    ? ShapeFlags.ELEMENT</span><br><span class="line">    : __FEATURE_SUSPENSE__ &amp;&amp; isSuspense(<span class="keyword">type</span>)</span><br><span class="line">    ? ShapeFlags.SUSPENSE</span><br><span class="line">    : isTeleport(<span class="keyword">type</span>)</span><br><span class="line">    ? ShapeFlags.TELEPORT</span><br><span class="line">    : isObject(<span class="keyword">type</span>)</span><br><span class="line">    ? ShapeFlags.STATEFUL_COMPONENT</span><br><span class="line">    : isFunction(<span class="keyword">type</span>)</span><br><span class="line">    ? ShapeFlags.FUNCTIONAL_COMPONENT</span><br><span class="line">    : <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; shapeFlag &amp; ShapeFlags.STATEFUL_COMPONENT &amp;&amp; isProxy(<span class="keyword">type</span>)) &#123;</span><br><span class="line">    <span class="keyword">type</span> = toRaw(<span class="keyword">type</span>)</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`Vue received a Component which was made a reactive object. This can `</span> +</span><br><span class="line">        <span class="string">`lead to unnecessary performance overhead, and should be avoided by `</span> +</span><br><span class="line">        <span class="string">`marking the component with \`markRaw\` or using \`shallowRef\` `</span> +</span><br><span class="line">        <span class="string">`instead of \`ref\`.`</span>,</span><br><span class="line">      <span class="string">`\nComponent that was made reactive: `</span>,</span><br><span class="line">      <span class="keyword">type</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> createBaseVNode(</span><br><span class="line">    <span class="keyword">type</span>,</span><br><span class="line">    props,</span><br><span class="line">    children,</span><br><span class="line">    patchFlag,</span><br><span class="line">    dynamicProps,</span><br><span class="line">    shapeFlag,</span><br><span class="line">    isBlockNode,</span><br><span class="line">    <span class="literal">true</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸºç¡€åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createBaseVNode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">type</span>: VNodeTypes | ClassComponent | <span class="keyword">typeof</span> NULL_DYNAMIC_COMPONENT,</span></span></span><br><span class="line"><span class="function"><span class="params">  props: (Data &amp; VNodeProps) | <span class="literal">null</span> = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  children: unknown = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  patchFlag = 0,</span></span></span><br><span class="line"><span class="function"><span class="params">  dynamicProps: <span class="built_in">string</span>[] | <span class="literal">null</span> = <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  shapeFlag = <span class="keyword">type</span> === Fragment ? 0 : ShapeFlags.ELEMENT,</span></span></span><br><span class="line"><span class="function"><span class="params">  isBlockNode = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  needFullChildrenNormalization = <span class="literal">false</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// å®šä¹‰ vnode å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">const</span> vnode = &#123;</span><br><span class="line">    __v_isVNode: <span class="literal">true</span>,</span><br><span class="line">    __v_skip: <span class="literal">true</span>,</span><br><span class="line">    <span class="keyword">type</span>,</span><br><span class="line">    props,</span><br><span class="line">    key: props &amp;&amp; normalizeKey(props),</span><br><span class="line">    ref: props &amp;&amp; normalizeRef(props),</span><br><span class="line">    scopeId: currentScopeId,</span><br><span class="line">    slotScopeIds: <span class="literal">null</span>,</span><br><span class="line">    children,</span><br><span class="line">    component: <span class="literal">null</span>,</span><br><span class="line">    suspense: <span class="literal">null</span>,</span><br><span class="line">    ssContent: <span class="literal">null</span>,</span><br><span class="line">    ssFallback: <span class="literal">null</span>,</span><br><span class="line">    dirs: <span class="literal">null</span>,</span><br><span class="line">    transition: <span class="literal">null</span>,</span><br><span class="line">    el: <span class="literal">null</span>,</span><br><span class="line">    anchor: <span class="literal">null</span>,</span><br><span class="line">    target: <span class="literal">null</span>,</span><br><span class="line">    targetAnchor: <span class="literal">null</span>,</span><br><span class="line">    staticCount: <span class="number">0</span>,</span><br><span class="line">    shapeFlag,</span><br><span class="line">    patchFlag,</span><br><span class="line">    dynamicProps,</span><br><span class="line">    dynamicChildren: <span class="literal">null</span>,</span><br><span class="line">    appContext: <span class="literal">null</span></span><br><span class="line">  &#125; <span class="keyword">as</span> VNode</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä½¿å­èŠ‚ç‚¹è§„èŒƒåŒ–</span></span><br><span class="line">  <span class="keyword">if</span> (needFullChildrenNormalization) &#123;</span><br><span class="line">    normalizeChildren(vnode, children)</span><br><span class="line">    <span class="comment">// normalize suspense children</span></span><br><span class="line">    <span class="keyword">if</span> (__FEATURE_SUSPENSE__ &amp;&amp; shapeFlag &amp; ShapeFlags.SUSPENSE) &#123;</span><br><span class="line">      ;(<span class="keyword">type</span> <span class="keyword">as</span> <span class="keyword">typeof</span> SuspenseImpl).normalize(vnode)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (children) &#123;</span><br><span class="line">    <span class="comment">// compiled element vnode - if children is passed, only possible types are</span></span><br><span class="line">    <span class="comment">// string or Array.</span></span><br><span class="line">    vnode.shapeFlag |= isString(children)</span><br><span class="line">      ? ShapeFlags.TEXT_CHILDREN</span><br><span class="line">      : ShapeFlags.ARRAY_CHILDREN</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// validate key</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; vnode.key !== vnode.key) &#123;</span><br><span class="line">    warn(<span class="string">`VNode created with invalid key (NaN). VNode type:`</span>, vnode.type)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// track vnode for block tree</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    isBlockTreeEnabled &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">    <span class="comment">// avoid a block node from tracking itself</span></span><br><span class="line">    !isBlockNode &amp;&amp;</span><br><span class="line">    <span class="comment">// has current parent block</span></span><br><span class="line">    currentBlock &amp;&amp;</span><br><span class="line">    <span class="comment">// presence of a patch flag indicates this node needs patching on updates.</span></span><br><span class="line">    <span class="comment">// component nodes also should always be patched, because even if the</span></span><br><span class="line">    <span class="comment">// component doesn't need to update, it needs to persist the instance on to</span></span><br><span class="line">    <span class="comment">// the next vnode so that it can be properly unmounted later.</span></span><br><span class="line">    (vnode.patchFlag &gt; <span class="number">0</span> || shapeFlag &amp; ShapeFlags.COMPONENT) &amp;&amp;</span><br><span class="line">    <span class="comment">// the EVENTS flag is only for hydration and if it is the only flag, the</span></span><br><span class="line">    <span class="comment">// vnode should not be considered dynamic due to handler caching.</span></span><br><span class="line">    vnode.patchFlag !== PatchFlags.HYDRATE_EVENTS</span><br><span class="line">  ) &#123;</span><br><span class="line">    currentBlock.push(vnode)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__COMPAT__) &#123;</span><br><span class="line">    convertLegacyVModelProps(vnode)</span><br><span class="line">    convertLegacyRefInFor(vnode)</span><br><span class="line">    defineLegacyVNodeProperties(vnode)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="render"><a href="#render" class="headerlink" title="[render]"></a>[render]</h2><p>render é¦–å…ˆåˆ¤æ–­ vnode æ˜¯å¦ä¸ºç©º, å¦‚æœæ ¹èŠ‚ç‚¹ dom ä¸Šå­˜åœ¨ _vnode(vnode çˆ¶è™šæ‹ŸèŠ‚ç‚¹), é‚£ä¹ˆè¿›è¡Œå¸è½½</p>
<p>å¦‚æœæ­¤æ—¶å­˜åœ¨ vnode ,ä¸Šä¸€æ­¥æˆ‘ä»¬ç”Ÿæˆå¥½äº† vnode, é‚£ä¹ˆè¿™ä¸‹å°±è¿›å…¥ patch é˜¶æ®µ, ä¼ å…¥çˆ¶è™šæ‹ŸèŠ‚ç‚¹, å½“å‰è™šæ‹ŸèŠ‚ç‚¹, çœŸå® dom</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\runtime-core\src\renderer.ts</span></span><br><span class="line"><span class="keyword">const</span> render: RootRenderFunction = <span class="function">(<span class="params">vnode, container, isSVG</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (vnode == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (container._vnode) &#123;</span><br><span class="line">      unmount(container._vnode, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    patch(container._vnode || <span class="literal">null</span>, vnode, container, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, isSVG)</span><br><span class="line">  &#125;</span><br><span class="line">  flushPostFlushCbs()</span><br><span class="line">  container._vnode = vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h2><p>patch å°†ä¼ å…¥çš„ä¸€è€ä¸€æ–°vnodeè¿›è¡Œæ¯”å¯¹, å¦‚æœä¸€æ ·ç›´æ¥è¿”å›, å¦‚æœ n1 å­˜åœ¨ä¸”æ–°æ—§ç±»å‹ä¸åŒ, é‚£ä¹ˆå°±ç›´æ¥å¸è½½æ‰æ—§æ ‘, åˆå§‹åŒ–åˆ™ä¼šç›´æ¥è·³è¿‡</p>
<p>æå–æ–°èŠ‚ç‚¹ä¸­çš„ä¿¡æ¯, è¿™é‡Œçš„ type ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ createApp æ—¶ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°, æœ‰æ–‡æœ¬èŠ‚ç‚¹çš„, ä¹Ÿæœ‰è¯„è®ºèŠ‚ç‚¹çš„, ä¹Ÿæœ‰ç»„ä»¶, ç¢ç‰‡çš„, è¿™é‡Œæˆ‘ä»¬ä¼ å…¥çš„æ˜¯æ ¹èŠ‚ç‚¹ rootComponent å¯¹è±¡</p>
<p>å› æ­¤è¿™é‡Œä¼šè¿›å…¥é»˜è®¤çš„ type, ä¸”æˆ‘ä»¬è¿™é‡Œçš„ shapeflag å­˜åœ¨ä¸”ä¸ºç»„ä»¶ ShapeFlags.COMPONENT ä¹Ÿæ˜¯ä¸º true çš„, å› æ­¤ä¼šèµ° processComponent æµç¨‹; æ­¤å¤–ä¹Ÿæœ‰ ELEMENT TELEPORT SUSPENSE æµç¨‹</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\runtime-core\src\renderer.ts</span></span><br><span class="line"><span class="keyword">const</span> patch: PatchFn = (</span><br><span class="line">  n1,</span><br><span class="line">  n2,</span><br><span class="line">  container,</span><br><span class="line">  anchor = <span class="literal">null</span>,</span><br><span class="line">  parentComponent = <span class="literal">null</span>,</span><br><span class="line">  parentSuspense = <span class="literal">null</span>,</span><br><span class="line">  isSVG = <span class="literal">false</span>,</span><br><span class="line">  slotScopeIds = <span class="literal">null</span>,</span><br><span class="line">  optimized = __DEV__ &amp;&amp; isHmrUpdating ? <span class="literal">false</span> : !!n2.dynamicChildren</span><br><span class="line">) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (n1 === n2) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// patching &amp; not same type, unmount old tree</span></span><br><span class="line">  <span class="keyword">if</span> (n1 &amp;&amp; !isSameVNodeType(n1, n2)) &#123;</span><br><span class="line">    anchor = getNextHostNode(n1)</span><br><span class="line">    unmount(n1, parentComponent, parentSuspense, <span class="literal">true</span>)</span><br><span class="line">    n1 = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (n2.patchFlag === PatchFlags.BAIL) &#123;</span><br><span class="line">    optimized = <span class="literal">false</span></span><br><span class="line">    n2.dynamicChildren = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æå–æ–°èŠ‚ç‚¹çš„ä¿¡æ¯</span></span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="keyword">type</span>, ref, shapeFlag &#125; = n2</span><br><span class="line">  <span class="comment">// æŒ‰ä¸åŒç±»å‹æ‰§è¡Œä¸åŒçš„è¿›ç¨‹</span></span><br><span class="line">  <span class="keyword">switch</span> (<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> Text:</span><br><span class="line">      processText(n1, n2, container, anchor)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> Comment:</span><br><span class="line">      processCommentNode(n1, n2, container, anchor)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> Static:</span><br><span class="line">      <span class="keyword">if</span> (n1 == <span class="literal">null</span>) &#123;</span><br><span class="line">        mountStaticNode(n2, container, anchor, isSVG)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        patchStaticNode(n1, n2, container, isSVG)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> Fragment:</span><br><span class="line">      processFragment(</span><br><span class="line">        n1,</span><br><span class="line">        n2,</span><br><span class="line">        container,</span><br><span class="line">        anchor,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG,</span><br><span class="line">        slotScopeIds,</span><br><span class="line">        optimized</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.ELEMENT) &#123;</span><br><span class="line">        processElement(</span><br><span class="line">          n1,</span><br><span class="line">          n2,</span><br><span class="line">          container,</span><br><span class="line">          anchor,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          slotScopeIds,</span><br><span class="line">          optimized</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.COMPONENT) &#123;</span><br><span class="line">        processComponent(</span><br><span class="line">          n1,</span><br><span class="line">          n2,</span><br><span class="line">          container,</span><br><span class="line">          anchor,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          slotScopeIds,</span><br><span class="line">          optimized</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; ShapeFlags.TELEPORT) &#123;</span><br><span class="line">        ;(<span class="keyword">type</span> <span class="keyword">as</span> <span class="keyword">typeof</span> TeleportImpl).process(</span><br><span class="line">          n1 <span class="keyword">as</span> TeleportVNode,</span><br><span class="line">          n2 <span class="keyword">as</span> TeleportVNode,</span><br><span class="line">          container,</span><br><span class="line">          anchor,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          slotScopeIds,</span><br><span class="line">          optimized,</span><br><span class="line">          internals</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__FEATURE_SUSPENSE__ &amp;&amp; shapeFlag &amp; ShapeFlags.SUSPENSE) &#123;</span><br><span class="line">        ;(<span class="keyword">type</span> <span class="keyword">as</span> <span class="keyword">typeof</span> SuspenseImpl).process(</span><br><span class="line">          n1,</span><br><span class="line">          n2,</span><br><span class="line">          container,</span><br><span class="line">          anchor,</span><br><span class="line">          parentComponent,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          isSVG,</span><br><span class="line">          slotScopeIds,</span><br><span class="line">          optimized,</span><br><span class="line">          internals</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        warn(<span class="string">'Invalid VNode type:'</span>, <span class="keyword">type</span>, <span class="string">`(<span class="subst">$&#123;<span class="keyword">typeof</span> <span class="keyword">type</span>&#125;</span>)`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set ref</span></span><br><span class="line">  <span class="keyword">if</span> (ref != <span class="literal">null</span> &amp;&amp; parentComponent) &#123;</span><br><span class="line">    setRef(ref, n1 &amp;&amp; n1.ref, parentSuspense, n2 || n1, !n2)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="processComponent"><a href="#processComponent" class="headerlink" title="processComponent"></a>processComponent</h2><p>æ¥æ”¶ä¼ é€’è¿‡æ¥çš„æ–°æ—§è™šæ‹ŸèŠ‚ç‚¹, çœŸå® dom èŠ‚ç‚¹ç­‰;</p>
<p>åˆ¤æ–­æ—§èŠ‚ç‚¹æ˜¯å¦ä¸å­˜åœ¨, è‹¥å­˜åœ¨åˆ™ç›´æ¥è¿›è¡Œ updateComponent; ä¸å­˜åœ¨åˆ™è¯´æ˜ä¸ºåˆå§‹åŒ–, åˆå§‹åŒ–æ¥ç€åˆ¤æ–­ COMPONENT_KEPT_ALIVE è‹¥ç»„ä»¶æ²¡æœ‰å¼€å¯ keep-alive, åˆ™è¿›å…¥ mountComponent ç¯èŠ‚</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> processComponent = (</span><br><span class="line">  n1: VNode | <span class="literal">null</span>,</span><br><span class="line">  n2: VNode,</span><br><span class="line">  container: RendererElement,</span><br><span class="line">  anchor: RendererNode | <span class="literal">null</span>,</span><br><span class="line">  parentComponent: ComponentInternalInstance | <span class="literal">null</span>,</span><br><span class="line">  parentSuspense: SuspenseBoundary | <span class="literal">null</span>,</span><br><span class="line">  isSVG: <span class="built_in">boolean</span>,</span><br><span class="line">  slotScopeIds: <span class="built_in">string</span>[] | <span class="literal">null</span>,</span><br><span class="line">  optimized: <span class="built_in">boolean</span></span><br><span class="line">) =&gt; &#123;</span><br><span class="line">  n2.slotScopeIds = slotScopeIds</span><br><span class="line">  <span class="keyword">if</span> (n1 == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (n2.shapeFlag &amp; ShapeFlags.COMPONENT_KEPT_ALIVE) &#123;</span><br><span class="line">      ;(parentComponent!.ctx <span class="keyword">as</span> KeepAliveContext).activate(</span><br><span class="line">        n2,</span><br><span class="line">        container,</span><br><span class="line">        anchor,</span><br><span class="line">        isSVG,</span><br><span class="line">        optimized</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      mountComponent(</span><br><span class="line">        n2,</span><br><span class="line">        container,</span><br><span class="line">        anchor,</span><br><span class="line">        parentComponent,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG,</span><br><span class="line">        optimized</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    updateComponent(n1, n2, optimized)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="mountComponent"><a href="#mountComponent" class="headerlink" title="mountComponent"></a>mountComponent</h2><p>æ¥æ”¶å‚æ•°å°±ç›´æ¥æ¥æ”¶æ–°çš„è™šæ‹ŸèŠ‚ç‚¹, çœŸå® dom æ ¹èŠ‚ç‚¹;</p>
<p>åˆ›å»ºæŒ‚è½½çš„ vue å®ä¾‹, å®‰è£…ç»„ä»¶ setup, å®‰è£… render çš„ effect</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\runtime-core\src\renderer.ts</span></span><br><span class="line"><span class="keyword">const</span> mountComponent: MountComponentFn = (</span><br><span class="line">  initialVNode,</span><br><span class="line">  container,</span><br><span class="line">  anchor,</span><br><span class="line">  parentComponent,</span><br><span class="line">  parentSuspense,</span><br><span class="line">  isSVG,</span><br><span class="line">  optimized</span><br><span class="line">) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 2.x compat may pre-create the component instance before actually</span></span><br><span class="line">  <span class="comment">// mounting</span></span><br><span class="line">  <span class="comment">// compat å¯ä»¥åœ¨å®é™…æ“ä½œä¹‹å‰é¢„å…ˆåˆ›å»ºç»„ä»¶å®ä¾‹</span></span><br><span class="line">  <span class="keyword">const</span> compatMountInstance =</span><br><span class="line">    __COMPAT__ &amp;&amp; initialVNode.isCompatRoot &amp;&amp; initialVNode.component</span><br><span class="line">  <span class="keyword">const</span> instance: ComponentInternalInstance =</span><br><span class="line">    compatMountInstance ||</span><br><span class="line">    (initialVNode.component = createComponentInstance(</span><br><span class="line">      initialVNode,</span><br><span class="line">      parentComponent,</span><br><span class="line">      parentSuspense</span><br><span class="line">    ))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; instance.type.__hmrId) &#123;</span><br><span class="line">    registerHMR(instance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    pushWarningContext(initialVNode)</span><br><span class="line">    startMeasure(instance, <span class="string">`mount`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// inject renderer internals for keepAlive</span></span><br><span class="line">  <span class="keyword">if</span> (isKeepAlive(initialVNode)) &#123;</span><br><span class="line">    ;(instance.ctx <span class="keyword">as</span> KeepAliveContext).renderer = internals</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// resolve props and slots for setup context</span></span><br><span class="line">  <span class="keyword">if</span> (!(__COMPAT__ &amp;&amp; compatMountInstance)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      startMeasure(instance, <span class="string">`init`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    setupComponent(instance)</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      endMeasure(instance, <span class="string">`init`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setup() is async. This component relies on async logic to be resolved</span></span><br><span class="line">  <span class="comment">// before proceeding</span></span><br><span class="line">  <span class="keyword">if</span> (__FEATURE_SUSPENSE__ &amp;&amp; instance.asyncDep) &#123;</span><br><span class="line">    parentSuspense &amp;&amp; parentSuspense.registerDep(instance, setupRenderEffect)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Give it a placeholder if this is not hydration</span></span><br><span class="line">    <span class="comment">// TODO handle self-defined fallback</span></span><br><span class="line">    <span class="keyword">if</span> (!initialVNode.el) &#123;</span><br><span class="line">      <span class="keyword">const</span> placeholder = (instance.subTree = createVNode(Comment))</span><br><span class="line">      processCommentNode(<span class="literal">null</span>, placeholder, container!, anchor)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setupRenderEffect(</span><br><span class="line">    instance,</span><br><span class="line">    initialVNode,</span><br><span class="line">    container,</span><br><span class="line">    anchor,</span><br><span class="line">    parentSuspense,</span><br><span class="line">    isSVG,</span><br><span class="line">    optimized</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    popWarningContext()</span><br><span class="line">    endMeasure(instance, <span class="string">`mount`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="createComponentInstance"><a href="#createComponentInstance" class="headerlink" title="createComponentInstance"></a>createComponentInstance</h3><p>æ¥æ”¶æ–°çš„è™šæ‹ŸèŠ‚ç‚¹, çˆ¶çº§èŠ‚ç‚¹</p>
<p>è·å–è™šæ‹ŸèŠ‚ç‚¹çš„ type, ä¹Ÿå°±æ˜¯æ ¹ç»„ä»¶å¯¹è±¡, ä»¥åŠè™šæ‹ŸèŠ‚ç‚¹çš„ appContext</p>
<p>å®šä¹‰ç»„ä»¶å®ä¾‹ instance , åŒæ—¶ç»™ç»„ä»¶åˆ›å»º effectScope, å®šä¹‰åœ¨ç»„ä»¶çš„ scope å±æ€§ä¸Š ,åœ¨å±æ€§ ctx / root ä¿ç•™å®ä¾‹å¯¹è±¡</p>
<p>è¿”å›åˆ›å»ºçš„å®ä¾‹, æ­¤æ—¶çš„å®ä¾‹ä¹Ÿå°±æ˜¯åœ¨ç»„ä»¶ä¿¡æ¯åŸºç¡€ä¸Š, è½¬æ¢ä¸º vue çš„ç»„ä»¶å®ä¾‹</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\runtime-core\src\component.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createComponentInstance</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  vnode: VNode,</span></span></span><br><span class="line"><span class="function"><span class="params">  parent: ComponentInternalInstance | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  suspense: SuspenseBoundary | <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">type</span> = vnode.type <span class="keyword">as</span> ConcreteComponent</span><br><span class="line">  <span class="comment">// inherit parent app context - or - if root, adopt from root vnode</span></span><br><span class="line">  <span class="keyword">const</span> appContext =</span><br><span class="line">    (parent ? parent.appContext : vnode.appContext) || emptyAppContext</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> instance: ComponentInternalInstance = &#123;</span><br><span class="line">    uid: uid++,</span><br><span class="line">    vnode,</span><br><span class="line">    <span class="keyword">type</span>,</span><br><span class="line">    parent,</span><br><span class="line">    appContext,</span><br><span class="line">    root: <span class="literal">null</span>!, <span class="comment">// to be immediately set</span></span><br><span class="line">    next: <span class="literal">null</span>,</span><br><span class="line">    subTree: <span class="literal">null</span>!, <span class="comment">// will be set synchronously right after creation</span></span><br><span class="line">    update: <span class="literal">null</span>!, <span class="comment">// will be set synchronously right after creation</span></span><br><span class="line">    scope: <span class="keyword">new</span> EffectScope(<span class="literal">true</span> <span class="comment">/* detached */</span>),</span><br><span class="line">    render: <span class="literal">null</span>,</span><br><span class="line">    proxy: <span class="literal">null</span>,</span><br><span class="line">    exposed: <span class="literal">null</span>,</span><br><span class="line">    exposeProxy: <span class="literal">null</span>,</span><br><span class="line">    withProxy: <span class="literal">null</span>,</span><br><span class="line">    provides: parent ? parent.provides : <span class="built_in">Object</span>.create(appContext.provides),</span><br><span class="line">    accessCache: <span class="literal">null</span>!,</span><br><span class="line">    renderCache: [],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// local resovled assets</span></span><br><span class="line">    components: <span class="literal">null</span>,</span><br><span class="line">    directives: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// resolved props and emits options</span></span><br><span class="line">    propsOptions: normalizePropsOptions(<span class="keyword">type</span>, appContext),</span><br><span class="line">    emitsOptions: normalizeEmitsOptions(<span class="keyword">type</span>, appContext),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// emit</span></span><br><span class="line">    emit: <span class="literal">null</span>!, <span class="comment">// to be set immediately</span></span><br><span class="line">    emitted: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// props default value</span></span><br><span class="line">    propsDefaults: EMPTY_OBJ,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// inheritAttrs</span></span><br><span class="line">    inheritAttrs: <span class="keyword">type</span>.inheritAttrs,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// state</span></span><br><span class="line">    ctx: EMPTY_OBJ,</span><br><span class="line">    data: EMPTY_OBJ,</span><br><span class="line">    props: EMPTY_OBJ,</span><br><span class="line">    attrs: EMPTY_OBJ,</span><br><span class="line">    slots: EMPTY_OBJ,</span><br><span class="line">    refs: EMPTY_OBJ,</span><br><span class="line">    setupState: EMPTY_OBJ,</span><br><span class="line">    setupContext: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// suspense related</span></span><br><span class="line">    suspense,</span><br><span class="line">    suspenseId: suspense ? suspense.pendingId : <span class="number">0</span>,</span><br><span class="line">    asyncDep: <span class="literal">null</span>,</span><br><span class="line">    asyncResolved: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// lifecycle hooks</span></span><br><span class="line">    <span class="comment">// not using enums here because it results in computed properties</span></span><br><span class="line">    isMounted: <span class="literal">false</span>,</span><br><span class="line">    isUnmounted: <span class="literal">false</span>,</span><br><span class="line">    isDeactivated: <span class="literal">false</span>,</span><br><span class="line">    bc: <span class="literal">null</span>,</span><br><span class="line">    c: <span class="literal">null</span>,</span><br><span class="line">    bm: <span class="literal">null</span>,</span><br><span class="line">    m: <span class="literal">null</span>,</span><br><span class="line">    bu: <span class="literal">null</span>,</span><br><span class="line">    u: <span class="literal">null</span>,</span><br><span class="line">    um: <span class="literal">null</span>,</span><br><span class="line">    bum: <span class="literal">null</span>,</span><br><span class="line">    da: <span class="literal">null</span>,</span><br><span class="line">    a: <span class="literal">null</span>,</span><br><span class="line">    rtg: <span class="literal">null</span>,</span><br><span class="line">    rtc: <span class="literal">null</span>,</span><br><span class="line">    ec: <span class="literal">null</span>,</span><br><span class="line">    sp: <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ç»™å®ä¾‹çš„ ctx æ³¨å…¥ _ å±æ€§, æŒ‡å‘å®ä¾‹</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    instance.ctx = createDevRenderContext(instance)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    instance.ctx = &#123; _: instance &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ä¿ç•™å®ä¾‹çš„æ ¹</span></span><br><span class="line">  instance.root = parent ? parent.root : instance</span><br><span class="line">  <span class="comment">// å®ä¾‹çš„ emit æ–¹æ³• this æŒ‡å‘ null</span></span><br><span class="line">  instance.emit = emit.bind(<span class="literal">null</span>, instance)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// apply custom element special handling</span></span><br><span class="line">  <span class="keyword">if</span> (vnode.ce) &#123;</span><br><span class="line">    vnode.ce(instance)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> instance</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="setupComponent"><a href="#setupComponent" class="headerlink" title="setupComponent"></a>setupComponent</h3><p>åˆå§‹åŒ– props / slots</p>
<p>initProps ç»™å®ä¾‹ instance æ·»åŠ  props / attrs å±æ€§, å¹¶åšæ‹¦æˆª</p>
<p>å‡†å¤‡å¥½çš„ç»„ä»¶è¿›è¡Œå®‰è£…</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">setupComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  instance: ComponentInternalInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">  isSSR = <span class="literal">false</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  isInSSRComponentSetup = isSSR</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; props, children &#125; = instance.vnode</span><br><span class="line">  <span class="keyword">const</span> isStateful = isStatefulComponent(instance)</span><br><span class="line">  initProps(instance, props, isStateful, isSSR)</span><br><span class="line">  initSlots(instance, children)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å¾—å®‰è£…ç»“æœ</span></span><br><span class="line">  <span class="keyword">const</span> setupResult = isStateful</span><br><span class="line">    ? setupStatefulComponent(instance, isSSR)</span><br><span class="line">    : <span class="literal">undefined</span></span><br><span class="line">  isInSSRComponentSetup = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">return</span> setupResult</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="setupStatefulComponent"><a href="#setupStatefulComponent" class="headerlink" title="setupStatefulComponent"></a>setupStatefulComponent</h3><p>æ¥æ”¶ instance å‚æ•°, ä»¥åŠæ˜¯å¦æœåŠ¡ç«¯æ¸²æŸ“</p>
<p>ä»å®ä¾‹çš„ type è·å–ç”¨æˆ·å®šä¹‰çš„æ ¹ç»„ä»¶å†…å®¹ Component, å¦‚æœæ˜¯å¼€å‘ç¯å¢ƒ, éœ€è¦å¯¹ç»„ä»¶è¿›è¡Œæ£€æŸ¥, æŸ¥çœ‹å…¶å®šä¹‰æ˜¯å¦æœ‰æ•ˆ</p>
<p>æ¥ç€ä» Component è¯»å– setup, å¦‚æœç”¨æˆ·ä¾§ç”¨ç»„åˆå¼ API , é‚£ä¹ˆå°±æœ‰ç”¨åˆ° setup, å¦‚æœæœªå®šä¹‰, é‚£ä¹ˆå°±ç»“æŸç»„ä»¶å®‰è£…</p>
<p>å¦‚æœå†™å…¥äº† setup å‡½æ•°, é‚£ä¹ˆå°±å¼€å§‹å®‰è£…, å…ˆè®¾å®šå½“å‰çš„å®ä¾‹, å…¨å±€å˜é‡ currentInstance å°±ç­‰äºå½“å‰æ´»åŠ¨çš„ instance, æ¥ç€è¿›å…¥ effectScope, è°ƒç”¨ on æ–¹æ³•, å°†å½“å‰æ´»è·ƒçš„ effectScope å‹å…¥ effectScopeStack æ ˆä¸­, å¹¶æ ‡è®° activeEffectScope ä¸º å½“å‰çš„ effectScope</p>
<p>pauseTracking å°† shouldTrack å‹å…¥ trackStack , å†å°†å…¨å±€çš„ shouldTrack å˜æ›´ä¸º false</p>
<p>æ¥ç€å¤„ç† setup, å¼€å‘ç¯å¢ƒä¸‹å¾—åˆ°æµ…å±‚åªè¯»(shallow readonly)çš„ props å“åº”å¼ä»£ç†, å°† props ä½œä¸ºå‚æ•°, ä¼ å…¥æˆ‘ä»¬å®šä¹‰çš„ setup å‡½æ•°æ‰§è¡Œ, è·å–åˆ° setupResult, å®é™…ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ setup() API ä¸­è®¾ç½®çš„ return çš„å¯¹è±¡</p>
<p>å› æ­¤ä¹Ÿå¹¶ä¸åƒ vue2 ä¸­, é¦–å…ˆåˆå§‹åŒ–å°†æ‰€æœ‰æ•°æ®å“åº”å¼åŒ–, è¿›è¡Œç¼–è¯‘ parse ä»£ç æˆ AST æ ‘, å†ä¼˜åŒ–è½¬æˆä»£ç , å†ç”±ä»£ç ç”Ÿæˆ vnode, åœ¨æ­¤è¯»å–ä»£ç æ—¶æ•è·çš„å˜é‡è§¦å‘å“åº”å¼ç³»ç»Ÿä¾èµ–æ”¶é›†</p>
<p>vue3 ä¸æ˜¯è¿™æ ·çš„, vue3 åˆå§‹æ˜¯å…ˆåˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹, å†è¿›è¡Œ mount, å†è¿›å…¥render, åˆ›å»ºç»„ä»¶, å®‰è£…ç»„ä»¶, åœ¨æ­¤è¿‡ç¨‹ä¸­å†å¯¹ä»£ç ä¸­æœ‰ä¹¦å†™åˆ°å“åº”å¼çš„åœ°æ–¹å†è¿›è¡Œå“åº”å¼åŒ–, æˆ–æ˜¯å®šä¹‰äº† computed, ref, watch, watchEffect ç­‰, æœ‰è¿è¡Œåˆ°å†å»æ“ä½œ, ä¸¤è€…çš„æ•´ä¸ªè¿è¡Œé€»è¾‘ä¸åŒ</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\runtime-core\src\component.ts</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setupStatefulComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  instance: ComponentInternalInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">  isSSR: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> Component = instance.type <span class="keyword">as</span> ComponentOptions</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Component.name) &#123;</span><br><span class="line">      validateComponentName(Component.name, instance.appContext.config)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Component.components) &#123;</span><br><span class="line">      <span class="keyword">const</span> names = <span class="built_in">Object</span>.keys(Component.components)</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; names.length; i++) &#123;</span><br><span class="line">        validateComponentName(names[i], instance.appContext.config)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Component.directives) &#123;</span><br><span class="line">      <span class="keyword">const</span> names = <span class="built_in">Object</span>.keys(Component.directives)</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; names.length; i++) &#123;</span><br><span class="line">        validateDirectiveName(names[i])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Component.compilerOptions &amp;&amp; isRuntimeOnly()) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`"compilerOptions" is only supported when using a build of Vue that `</span> +</span><br><span class="line">          <span class="string">`includes the runtime compiler. Since you are using a runtime-only `</span> +</span><br><span class="line">          <span class="string">`build, the options should be passed via your build tool config instead.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 0. create render proxy property access cache</span></span><br><span class="line">  <span class="comment">// åˆ›å»ºä»£ç†å±æ€§ accessCache æ¥è®¿é—®ç¼“å­˜</span></span><br><span class="line">  instance.accessCache = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  <span class="comment">// 1. create public instance / render proxy</span></span><br><span class="line">  <span class="comment">// also mark it raw so it's never observed</span></span><br><span class="line">  <span class="comment">// åˆ›å»ºå®ä¾‹çš„ proxy å±æ€§,</span></span><br><span class="line">  <span class="comment">// æ¥æ ‡è®°ä¸€ä¸ªå¹¶æœªè¢«ç›¸åº”å¼åŒ–çš„åŸç”Ÿå¯¹è±¡</span></span><br><span class="line">  instance.proxy = markRaw(<span class="keyword">new</span> Proxy(instance.ctx, PublicInstanceProxyHandlers))</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    exposePropsOnRenderContext(instance)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 2. call setup()</span></span><br><span class="line">  <span class="keyword">const</span> &#123; setup &#125; = Component</span><br><span class="line">  <span class="keyword">if</span> (setup) &#123;</span><br><span class="line">    <span class="keyword">const</span> setupContext = (instance.setupContext =</span><br><span class="line">      setup.length &gt; <span class="number">1</span> ? createSetupContext(instance) : <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">    setCurrentInstance(instance)</span><br><span class="line">    pauseTracking()</span><br><span class="line">    <span class="keyword">const</span> setupResult = callWithErrorHandling(</span><br><span class="line">      setup,</span><br><span class="line">      instance,</span><br><span class="line">      ErrorCodes.SETUP_FUNCTION,</span><br><span class="line">      [__DEV__ ? shallowReadonly(instance.props) : instance.props, setupContext]</span><br><span class="line">    )</span><br><span class="line">    resetTracking()</span><br><span class="line">    unsetCurrentInstance()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isPromise(setupResult)) &#123;</span><br><span class="line">      setupResult.then(unsetCurrentInstance, unsetCurrentInstance)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (isSSR) &#123;</span><br><span class="line">        <span class="comment">// return the promise so server-renderer can wait on it</span></span><br><span class="line">        <span class="keyword">return</span> setupResult</span><br><span class="line">          .then(<span class="function">(<span class="params">resolvedResult: unknown</span>) =&gt;</span> &#123;</span><br><span class="line">            handleSetupResult(instance, resolvedResult, isSSR)</span><br><span class="line">          &#125;)</span><br><span class="line">          .catch(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">            handleError(e, instance, ErrorCodes.SETUP_FUNCTION)</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__FEATURE_SUSPENSE__) &#123;</span><br><span class="line">        <span class="comment">// async setup returned Promise.</span></span><br><span class="line">        <span class="comment">// bail here and wait for re-entry.</span></span><br><span class="line">        instance.asyncDep = setupResult</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`setup() returned a Promise, but the version of Vue you are using `</span> +</span><br><span class="line">            <span class="string">`does not support it yet.`</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      handleSetupResult(instance, setupResult, isSSR)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    finishComponentSetup(instance, isSSR)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="setupResult"><a href="#setupResult" class="headerlink" title="setupResult"></a>setupResult</h4><p>è·å– setup() è¿è¡Œåè¿”å›çš„ç»“æœ</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\runtime-core\src\component.ts</span></span><br><span class="line"><span class="keyword">const</span> &#123; setup &#125; = Component</span><br><span class="line"><span class="keyword">if</span> (setup) &#123;</span><br><span class="line">  <span class="keyword">const</span> setupResult = callWithErrorHandling(</span><br><span class="line">    setup,</span><br><span class="line">    instance,</span><br><span class="line">    ErrorCodes.SETUP_FUNCTION,</span><br><span class="line">    [__DEV__ ? shallowReadonly(instance.props) : instance.props, setupContext]</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\runtime-core\src\errorHandling.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">callWithErrorHandling</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fn: <span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  instance: ComponentInternalInstance | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">type</span>: ErrorTypes,</span></span></span><br><span class="line"><span class="function"><span class="params">  args?: unknown[]</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> res</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    res = args ? fn(...args) : fn()</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    handleError(err, instance, <span class="keyword">type</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="handleSetupResult"><a href="#handleSetupResult" class="headerlink" title="handleSetupResult"></a>handleSetupResult</h4><p>åˆ¤æ–­ setup çš„ç»“æœæ˜¯å¦ä¸ºå‡½æ•°, å¦‚æœä¸ºå‡½æ•°åˆ™å°†ç»“æœèµ‹å€¼ç»™å®ä¾‹ instance.render;</p>
<p>ç»“æœä¸ºå¯¹è±¡æ—¶, å°† setupResult ç”¨ proxyRefs å¤„ç†, åˆ¤æ–­ä¼ å…¥çš„ç»“æœæ˜¯å¦æ—¶ reactive å¯¹è±¡, è‹¥ä¸æ˜¯åˆ™è¿›è¡Œ proxy ä»£ç†èµ‹å€¼ç»™ instance.setupState</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\runtime-core\src\component.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">handleSetupResult</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  instance: ComponentInternalInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">  setupResult: unknown,</span></span></span><br><span class="line"><span class="function"><span class="params">  isSSR: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isFunction(setupResult)) &#123;</span><br><span class="line">    <span class="comment">// setup returned an inline render function</span></span><br><span class="line">    <span class="keyword">if</span> (__SSR__ &amp;&amp; (instance.type <span class="keyword">as</span> ComponentOptions).__ssrInlineRender) &#123;</span><br><span class="line">      <span class="comment">// when the function's name is `ssrRender` (compiled by SFC inline mode),</span></span><br><span class="line">      <span class="comment">// set it as ssrRender instead.</span></span><br><span class="line">      instance.ssrRender = setupResult</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      instance.render = setupResult <span class="keyword">as</span> InternalRenderFunction</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isObject(setupResult)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; isVNode(setupResult)) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`setup() should not return VNodes directly - `</span> +</span><br><span class="line">          <span class="string">`return a render function instead.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// setup returned bindings.</span></span><br><span class="line">    <span class="comment">// assuming a render function compiled from template is present.</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">      instance.devtoolsRawSetupState = setupResult</span><br><span class="line">    &#125;</span><br><span class="line">    instance.setupState = proxyRefs(setupResult)</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      exposeSetupStateOnRenderContext(instance)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__DEV__ &amp;&amp; setupResult !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`setup() should return an object. Received: <span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">        setupResult === <span class="literal">null</span> ? <span class="string">'null'</span> : <span class="keyword">typeof</span> setupResult</span></span></span><br><span class="line"><span class="string"><span class="subst">      &#125;</span>`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  finishComponentSetup(instance, isSSR)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packages\reactivity\src\ref.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">proxyRefs</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  objectWithRefs: T</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ShallowUnwrapRef</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> isReactive(objectWithRefs)</span><br><span class="line">    ? objectWithRefs</span><br><span class="line">    : <span class="keyword">new</span> Proxy(objectWithRefs, shallowUnwrapHandlers)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="finishComponentSetup"><a href="#finishComponentSetup" class="headerlink" title="finishComponentSetup"></a>finishComponentSetup</h4><p>æœŸé—´ä¼šè¿›è¡Œç¼–è¯‘ compile</p>
<p>å¦‚æœ instance.render ä¸å­˜åœ¨, åˆ™å¼€å§‹å‡†å¤‡ç¼–è¯‘çš„ template, template å­˜åœ¨å°±è°ƒç”¨ compile è¿›è¡Œå¤„ç†, å®Œåèµ‹å€¼ç»™ Component.render, å†èµ‹å€¼ç»™ instance.render , å¾—åˆ°çš„å³æ˜¯æ•´ä¸ªç»„ä»¶çš„æ¸²æŸ“è¯­å¥</p>
<p>æ¥ç€ä¼šæ ¹æ®æ˜¯å¦æœ‰ vue2 çš„ options api ä¹¦å†™æ¥æŒ‰ vue2 çš„æ­¥éª¤æ¥æ‰§è¡Œ; è®¾ç½®å…¨å±€å®ä¾‹, å¼€å§‹ track, æ¥ç€åº”ç”¨ options, åœ¨æ­¤æœŸé—´ä¼šå…ˆæ‰§è¡Œ vue2 çš„ beforeCreate é’©å­å‡½æ•°, æ¥ç€åˆ¤æ–­æ˜¯å¦æœ‰ inject, methods, data, computed, watch, provide, å®Œæˆæ•°æ®åˆå§‹åŒ–, æ¥ç€å†æ‰§è¡Œ created é’©å­å‡½æ•°; å†æ³¨å†Œå…¶ä»–çš„é’©å­å‡½æ•°(æ¥å£è‡³vue3è¿™äº›é’©å­å‡½æ•°çš„åœ°æ–¹), è€Œå¯¹äº vue3 ç»„åˆå¼ api çš„å†™æ³•, æ˜¯æ²¡æœ‰ beforeCreate å’Œ created é’©å­å‡½æ•°çš„, è€Œä¸”æ­¤å¤„çš„é’©å­å‡½æ•°å‡æ˜¯ä» options è·å–, ç»„åˆå¼ api æ˜¯åœ¨ setup æœŸé—´ä½¿ç”¨ onMounted è¿™ç§ Api æ¥å®ç°çš„</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">finishComponentSetup</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  instance: ComponentInternalInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">  isSSR: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  skipOptions?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> Component = instance.type <span class="keyword">as</span> ComponentOptions</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__COMPAT__) &#123;</span><br><span class="line">    convertLegacyRenderFn(instance)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; Component.compatConfig) &#123;</span><br><span class="line">      validateCompatConfig(Component.compatConfig)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// template / render function normalization</span></span><br><span class="line">  <span class="comment">// could be already set when returned from setup()</span></span><br><span class="line">  <span class="keyword">if</span> (!instance.render) &#123;</span><br><span class="line">    <span class="comment">// only do on-the-fly compile if not in SSR - SSR on-the-fly compliation</span></span><br><span class="line">    <span class="comment">// is done by server-renderer</span></span><br><span class="line">    <span class="keyword">if</span> (!isSSR &amp;&amp; compile &amp;&amp; !Component.render) &#123;</span><br><span class="line">      <span class="keyword">const</span> template =</span><br><span class="line">        (__COMPAT__ &amp;&amp;</span><br><span class="line">          instance.vnode.props &amp;&amp;</span><br><span class="line">          instance.vnode.props[<span class="string">'inline-template'</span>]) ||</span><br><span class="line">        Component.template</span><br><span class="line">      <span class="keyword">if</span> (template) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          startMeasure(instance, <span class="string">`compile`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> &#123; isCustomElement, compilerOptions &#125; = instance.appContext.config</span><br><span class="line">        <span class="keyword">const</span> &#123; delimiters, compilerOptions: componentCompilerOptions &#125; =</span><br><span class="line">          Component</span><br><span class="line">        <span class="keyword">const</span> finalCompilerOptions: CompilerOptions = extend(</span><br><span class="line">          extend(</span><br><span class="line">            &#123;</span><br><span class="line">              isCustomElement,</span><br><span class="line">              delimiters</span><br><span class="line">            &#125;,</span><br><span class="line">            compilerOptions</span><br><span class="line">          ),</span><br><span class="line">          componentCompilerOptions</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> (__COMPAT__) &#123;</span><br><span class="line">          <span class="comment">// pass runtime compat config into the compiler</span></span><br><span class="line">          finalCompilerOptions.compatConfig = <span class="built_in">Object</span>.create(globalCompatConfig)</span><br><span class="line">          <span class="keyword">if</span> (Component.compatConfig) &#123;</span><br><span class="line">            extend(finalCompilerOptions.compatConfig, Component.compatConfig)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Component.render = compile(template, finalCompilerOptions)</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          endMeasure(instance, <span class="string">`compile`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    instance.render = (Component.render || NOOP) <span class="keyword">as</span> InternalRenderFunction</span><br><span class="line"></span><br><span class="line">    <span class="comment">// for runtime-compiled render functions using `with` blocks, the render</span></span><br><span class="line">    <span class="comment">// proxy used needs a different `has` handler which is more performant and</span></span><br><span class="line">    <span class="comment">// also only allows a whitelist of globals to fallthrough.</span></span><br><span class="line">    <span class="keyword">if</span> (installWithProxy) &#123;</span><br><span class="line">      installWithProxy(instance)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// support for 2.x options</span></span><br><span class="line">  <span class="keyword">if</span> (__FEATURE_OPTIONS_API__ &amp;&amp; !(__COMPAT__ &amp;&amp; skipOptions)) &#123;</span><br><span class="line">    setCurrentInstance(instance)</span><br><span class="line">    pauseTracking()</span><br><span class="line">    applyOptions(instance)</span><br><span class="line">    resetTracking()</span><br><span class="line">    unsetCurrentInstance()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// warn missing template/render</span></span><br><span class="line">  <span class="comment">// the runtime compilation of template in SSR is done by server-render</span></span><br><span class="line">  <span class="keyword">if</span> (__DEV__ &amp;&amp; !Component.render &amp;&amp; instance.render === NOOP &amp;&amp; !isSSR) &#123;</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (!compile &amp;&amp; Component.template) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`Component provided template option but `</span> +</span><br><span class="line">          <span class="string">`runtime compilation is not supported in this build of Vue.`</span> +</span><br><span class="line">          (__ESM_BUNDLER__</span><br><span class="line">            ? <span class="string">` Configure your bundler to alias "vue" to "vue/dist/vue.esm-bundler.js".`</span></span><br><span class="line">            : __ESM_BROWSER__</span><br><span class="line">            ? <span class="string">` Use "vue.esm-browser.js" instead.`</span></span><br><span class="line">            : __GLOBAL__</span><br><span class="line">            ? <span class="string">` Use "vue.global.js" instead.`</span></span><br><span class="line">            : <span class="string">``</span>) <span class="comment">/* should not happen */</span></span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      warn(<span class="string">`Component is missing template or render function.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="compile"><a href="#compile" class="headerlink" title="[compile]"></a>[compile]</h5><p>ç¼–è¯‘çš„å‡½æ•°æ˜¯åœ¨åˆå§‹åŒ– vue å®ä¾‹æ—¶è¢«å®‰è£…çš„, åœ¨ vue/src/index.ts åŠ è½½ vue æºç æ—¶, ä¼šä»å½“å‰é¡µå¼€å§‹; ä½¿ç”¨ registerRuntimeCompiler æ³¨å†Œ compile å‡½æ•°</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\vue\src\index.ts</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileToFunction</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">const</span> &#123; code &#125; = compile(</span><br><span class="line">    template,</span><br><span class="line">    extend(</span><br><span class="line">      &#123;</span><br><span class="line">        hoistStatic: <span class="literal">true</span>,</span><br><span class="line">        onError: __DEV__ ? onError : <span class="literal">undefined</span>,</span><br><span class="line">        onWarn: __DEV__ ? <span class="function"><span class="params">e</span> =&gt;</span> onError(e, <span class="literal">true</span>) : NOOP</span><br><span class="line">      &#125; <span class="keyword">as</span> CompilerOptions,</span><br><span class="line">      options</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">const</span> render = (</span><br><span class="line">    __GLOBAL__ ? <span class="keyword">new</span> <span class="built_in">Function</span>(code)() : <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">'Vue'</span>, code)(runtimeDom)</span><br><span class="line">  ) <span class="keyword">as</span> RenderFunction</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">registerRuntimeCompiler(compileToFunction)</span><br></pre></td></tr></table></figure>
<p>registerRuntimeCompiler åœ¨ä¸Šè¾¹ä¼ å…¥äº† compileToFunction çš„æ–¹æ³•, åœ¨ä¸‹è¾¹å°±å¯ä»¥çœ‹åˆ°è¯¥å‡½æ•°è¢«èµ‹å€¼ç»™å½“å‰é¡µçš„ compile, åœ¨å…¶åç›´æ¥æ‰§è¡Œ compile()</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\runtime-core\src\component.ts</span></span><br><span class="line"><span class="keyword">let</span> compile: CompileFunction | <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">registerRuntimeCompiler</span>(<span class="params">_compile: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  compile = _compile</span><br><span class="line">  installWithProxy = <span class="function"><span class="params">i</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (i.render!._rc) &#123;</span><br><span class="line">      i.withProxy = <span class="keyword">new</span> Proxy(i.ctx, RuntimeCompiledPublicInstanceProxyHandlers)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸Šä¸€æ­¥å®Œæˆç»„ä»¶å®‰è£…çš„å‡½æ•°ä¸­ä½¿ç”¨åˆ°çš„ compile</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">finishComponentSetup</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  instance: ComponentInternalInstance,</span></span></span><br><span class="line"><span class="function"><span class="params">  isSSR: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  skipOptions?: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> Component = instance.type <span class="keyword">as</span> ComponentOptions</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (!instance.render) &#123;</span><br><span class="line">    <span class="keyword">const</span> template =</span><br><span class="line">      (__COMPAT__ &amp;&amp;</span><br><span class="line">        instance.vnode.props &amp;&amp;</span><br><span class="line">        instance.vnode.props[<span class="string">'inline-template'</span>]) ||</span><br><span class="line">      Component.template <span class="comment">// è¿™é‡Œèµ°çš„æ˜¯ç»„ä»¶çš„æ¨¡æ¿</span></span><br><span class="line">    <span class="keyword">if</span> (template) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      Component.render = compile(template, finalCompilerOptions)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="compileToFunction"><a href="#compileToFunction" class="headerlink" title="compileToFunction"></a>compileToFunction</h5><p>æˆ‘ä»¬ä¹Ÿå°±æ¸…æ¥šäº†ä¸Šè¾¹çš„ compile ä¹Ÿå°±æ˜¯ compileToFunction</p>
<p>å¯ä»¥çœ‹åˆ°å¯¹ template è¿›è¡Œåˆ¤æ–­, æ¥ç€è°ƒç”¨çœŸæ­£çš„ compile è¿›è¡Œè§£æ template, æœ€åæå– code, é€šè¿‡ code æ¥ç”Ÿæˆå‡½æ•°æ‰§è¡Œ, æœ€åèµ‹å€¼ç»™ render, æœ€åç¼“å­˜å½“å‰ template å¯¹åº”çš„è¿™ä¸ª render æ–¹æ³•, å¹¶è¿”å›</p>
<p>ps: (render å‡½æ•°çš„è·å¾—åœ¨ compileToFunction ä¹‹åå±•ç¤º)</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\vue\src\index.ts</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compileToFunction</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  template: <span class="built_in">string</span> | HTMLElement,</span></span></span><br><span class="line"><span class="function"><span class="params">  options?: CompilerOptions</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">RenderFunction</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isString(template)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (template.nodeType) &#123;</span><br><span class="line">      template = template.innerHTML</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      __DEV__ &amp;&amp; warn(<span class="string">`invalid template option: `</span>, template)</span><br><span class="line">      <span class="keyword">return</span> NOOP</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> key = template</span><br><span class="line">  <span class="keyword">const</span> cached = compileCache[key]</span><br><span class="line">  <span class="keyword">if</span> (cached) &#123;</span><br><span class="line">    <span class="keyword">return</span> cached</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (template[<span class="number">0</span>] === <span class="string">'#'</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> el = <span class="built_in">document</span>.querySelector(template)</span><br><span class="line">    <span class="keyword">if</span> (__DEV__ &amp;&amp; !el) &#123;</span><br><span class="line">      warn(<span class="string">`Template element not found or is empty: <span class="subst">$&#123;template&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// __UNSAFE__</span></span><br><span class="line">    <span class="comment">// Reason: potential execution of JS expressions in in-DOM template.</span></span><br><span class="line">    <span class="comment">// The user must make sure the in-DOM template is trusted. If it's rendered</span></span><br><span class="line">    <span class="comment">// by the server, the template should not contain any user data.</span></span><br><span class="line">    template = el ? el.innerHTML : <span class="string">``</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; code &#125; = compile(</span><br><span class="line">    template,</span><br><span class="line">    extend(</span><br><span class="line">      &#123;</span><br><span class="line">        hoistStatic: <span class="literal">true</span>,</span><br><span class="line">        onError: __DEV__ ? onError : <span class="literal">undefined</span>,</span><br><span class="line">        onWarn: __DEV__ ? <span class="function"><span class="params">e</span> =&gt;</span> onError(e, <span class="literal">true</span>) : NOOP</span><br><span class="line">      &#125; <span class="keyword">as</span> CompilerOptions,</span><br><span class="line">      options</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">onError</span>(<span class="params">err: CompilerError, asWarning = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> message = asWarning</span><br><span class="line">      ? err.message</span><br><span class="line">      : <span class="string">`Template compilation error: <span class="subst">$&#123;err.message&#125;</span>`</span></span><br><span class="line">    <span class="keyword">const</span> codeFrame =</span><br><span class="line">      err.loc &amp;&amp;</span><br><span class="line">      generateCodeFrame(</span><br><span class="line">        template <span class="keyword">as</span> <span class="built_in">string</span>,</span><br><span class="line">        err.loc.start.offset,</span><br><span class="line">        err.loc.end.offset</span><br><span class="line">      )</span><br><span class="line">    warn(codeFrame ? <span class="string">`<span class="subst">$&#123;message&#125;</span>\n<span class="subst">$&#123;codeFrame&#125;</span>`</span> : message)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The wildcard import results in a huge object with every export</span></span><br><span class="line">  <span class="comment">// with keys that cannot be mangled, and can be quite heavy size-wise.</span></span><br><span class="line">  <span class="comment">// In the global build we know `Vue` is available globally so we can avoid</span></span><br><span class="line">  <span class="comment">// the wildcard object.</span></span><br><span class="line">  <span class="keyword">const</span> render = (</span><br><span class="line">    __GLOBAL__ ? <span class="keyword">new</span> <span class="built_in">Function</span>(code)() : <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">'Vue'</span>, code)(runtimeDom)</span><br><span class="line">  ) <span class="keyword">as</span> RenderFunction</span><br><span class="line"></span><br><span class="line">  <span class="comment">// mark the function as runtime compiled</span></span><br><span class="line">  ;(render <span class="keyword">as</span> InternalRenderFunction)._rc = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (compileCache[key] = render)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘ˆæ¥ <a href="######generate">generate</a> ç”Ÿæˆçš„ code, æ¥ä¸‹æ¥çœ‹å¦‚ä½•æ‰§è¡Œ:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> render = (</span><br><span class="line">  __GLOBAL__ ? <span class="keyword">new</span> <span class="built_in">Function</span>(code)() : <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">'Vue'</span>, code)(runtimeDom)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// new å‡½æ•°ç«‹å³æ‰§è¡Œ</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">anonymous</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">const</span> _Vue = Vue</span><br><span class="line"><span class="comment">// ä»æ„é€ å‡½æ•°è·å¾—åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹çš„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">const</span> &#123; createElementVNode: _createElementVNode, createTextVNode: _createTextVNode &#125; = _Vue</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸‰ä¸ªé™æ€å­èŠ‚ç‚¹çš„è™šæ‹ŸèŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = <span class="comment">/*#__PURE__*/</span>_createElementVNode(<span class="string">"span"</span>, <span class="literal">null</span>, <span class="string">"reactive:"</span>, <span class="number">-1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = <span class="comment">/*#__PURE__*/</span>_createElementVNode(<span class="string">"span"</span>, <span class="literal">null</span>, <span class="string">"ref:"</span>, <span class="number">-1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createElementVNode(<span class="string">"span"</span>, <span class="literal">null</span>, <span class="string">"computed:"</span>, <span class="number">-1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">with</span> (_ctx) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; createElementVNode: _createElementVNode, toDisplayString: _toDisplayString, createTextVNode: _createTextVNode, Fragment: _Fragment, openBlock: _openBlock, createElementBlock: _createElementBlock &#125; = _Vue</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (_openBlock(), _createElementBlock(_Fragment, <span class="literal">null</span>, [</span><br><span class="line">      _createElementVNode(<span class="string">"div"</span>, <span class="literal">null</span>, [</span><br><span class="line">        _hoisted_1,</span><br><span class="line">        _createTextVNode(_toDisplayString(state.title), <span class="number">1</span> <span class="comment">/* TEXT */</span>)</span><br><span class="line">      ]),</span><br><span class="line">      _createElementVNode(<span class="string">"div"</span>, <span class="literal">null</span>, [</span><br><span class="line">        _hoisted_2,</span><br><span class="line">        _createTextVNode(_toDisplayString(price), <span class="number">1</span> <span class="comment">/* TEXT */</span>)</span><br><span class="line">      ]),</span><br><span class="line">      _createElementVNode(<span class="string">"div"</span>, <span class="literal">null</span>, [</span><br><span class="line">        _hoisted_3,</span><br><span class="line">        _createTextVNode(_toDisplayString(currTime), <span class="number">1</span> <span class="comment">/* TEXT */</span>)</span><br><span class="line">      ])</span><br><span class="line">    ], <span class="number">64</span> <span class="comment">/* STABLE_FRAGMENT */</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h5 id="compile-1"><a href="#compile-1" class="headerlink" title="compile"></a>compile</h5><p>è¿™é‡Œçš„ compile æ‰æ˜¯å®é™…æ‰§è¡Œç¼–è¯‘çš„æ–¹æ³•, ä¼šå°†ä¼ å…¥çš„ template è§£æç”Ÿæˆ code</p>
<p>åœ¨è¿™é‡Œå°±åˆ©ç”¨äº†å‡½æ•°æŸ¯é‡ŒåŒ–, compile è·å–å‚æ•° template å’Œ option, ç›´æ¥è¿”å› baseCompile å‡½æ•°ä¼ å…¥ template åŠå…¶ä»–é…ç½®</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\compiler-dom\src\index.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">compile</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  template: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  options: CompilerOptions = &#123;&#125;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">CodegenResult</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> baseCompile(</span><br><span class="line">    template,</span><br><span class="line">    extend(&#123;&#125;, parserOptions, options, &#123;</span><br><span class="line">      nodeTransforms: [</span><br><span class="line">        <span class="comment">// ignore &lt;script&gt; and &lt;tag&gt;</span></span><br><span class="line">        <span class="comment">// this is not put inside DOMNodeTransforms because that list is used</span></span><br><span class="line">        <span class="comment">// by compiler-ssr to generate vnode fallback branches</span></span><br><span class="line">        ignoreSideEffectTags,</span><br><span class="line">        ...DOMNodeTransforms,</span><br><span class="line">        ...(options.nodeTransforms || [])</span><br><span class="line">      ],</span><br><span class="line">      directiveTransforms: extend(</span><br><span class="line">        &#123;&#125;,</span><br><span class="line">        DOMDirectiveTransforms,</span><br><span class="line">        options.directiveTransforms || &#123;&#125;</span><br><span class="line">      ),</span><br><span class="line">      transformHoist: __BROWSER__ ? <span class="literal">null</span> : stringifyStatic</span><br><span class="line">    &#125;)</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="baseCompile"><a href="#baseCompile" class="headerlink" title="baseCompile"></a>baseCompile</h5><p>baseCompile çš„å·¥ä½œå°±æ˜¯è§£æ template, vue3 æ˜¯å…ˆç”¨ baseParse è§£ææˆ ast æ ‘, å†ç”¨ transform æ¥å°†ç”Ÿæˆçš„ ast æ ‘å¤„ç†, æœ€åè¿”å›ç”¨ generate ç”Ÿæˆçš„ä»£ç  code</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\compiler-core\src\compile.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">baseCompile</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  template: <span class="built_in">string</span> | RootNode,</span></span></span><br><span class="line"><span class="function"><span class="params">  options: CompilerOptions = &#123;&#125;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">CodegenResult</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> onError = options.onError || defaultOnError</span><br><span class="line">  <span class="keyword">const</span> isModuleMode = options.mode === <span class="string">'module'</span></span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="keyword">if</span> (__BROWSER__) &#123;</span><br><span class="line">    <span class="keyword">if</span> (options.prefixIdentifiers === <span class="literal">true</span>) &#123;</span><br><span class="line">      onError(createCompilerError(ErrorCodes.X_PREFIX_ID_NOT_SUPPORTED))</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isModuleMode) &#123;</span><br><span class="line">      onError(createCompilerError(ErrorCodes.X_MODULE_MODE_NOT_SUPPORTED))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> prefixIdentifiers =</span><br><span class="line">    !__BROWSER__ &amp;&amp; (options.prefixIdentifiers === <span class="literal">true</span> || isModuleMode)</span><br><span class="line">  <span class="keyword">if</span> (!prefixIdentifiers &amp;&amp; options.cacheHandlers) &#123;</span><br><span class="line">    onError(createCompilerError(ErrorCodes.X_CACHE_HANDLER_NOT_SUPPORTED))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (options.scopeId &amp;&amp; !isModuleMode) &#123;</span><br><span class="line">    onError(createCompilerError(ErrorCodes.X_SCOPE_ID_NOT_SUPPORTED))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æ template ä¸º ast æ ‘</span></span><br><span class="line">  <span class="keyword">const</span> ast = isString(template) ? baseParse(template, options) : template</span><br><span class="line">  <span class="keyword">const</span> [nodeTransforms, directiveTransforms] =</span><br><span class="line">    getBaseTransformPreset(prefixIdentifiers)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!__BROWSER__ &amp;&amp; options.isTS) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; expressionPlugins &#125; = options</span><br><span class="line">    <span class="keyword">if</span> (!expressionPlugins || !expressionPlugins.includes(<span class="string">'typescript'</span>)) &#123;</span><br><span class="line">      options.expressionPlugins = [...(expressionPlugins || []), <span class="string">'typescript'</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  transform(</span><br><span class="line">    ast,</span><br><span class="line">    extend(&#123;&#125;, options, &#123;</span><br><span class="line">      prefixIdentifiers,</span><br><span class="line">      nodeTransforms: [</span><br><span class="line">        ...nodeTransforms,</span><br><span class="line">        ...(options.nodeTransforms || []) <span class="comment">// user transforms</span></span><br><span class="line">      ],</span><br><span class="line">      directiveTransforms: extend(</span><br><span class="line">        &#123;&#125;,</span><br><span class="line">        directiveTransforms,</span><br><span class="line">        options.directiveTransforms || &#123;&#125; <span class="comment">// user transforms</span></span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> generate(</span><br><span class="line">    ast,</span><br><span class="line">    extend(&#123;&#125;, options, &#123;</span><br><span class="line">      prefixIdentifiers</span><br><span class="line">    &#125;)</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="baseParse"><a href="#baseParse" class="headerlink" title="baseParse"></a>baseParse</h6><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªè§£æçš„ä¸Šä¸‹æ–‡ context, ä½œä»¥æ•´ä¸ªçš„è®°å½•; åŒ…å«æœ‰é…ç½®, å¦‚ delimeters, isNativeTag ç­‰, ä»¥åŠç¼“å­˜ source(å³åŸ template)</p>
<p>getCursor æ¥è·å–å¼€å§‹è§£æçš„ä¸€ä¸ªå®šä½</p>
<p>å…ˆè§£æå­èŠ‚ç‚¹, å†åˆ›å»º root, ç”Ÿæˆå®Œæ•´çš„ ast æ ‘,</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\compiler-core\src\parse.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">baseParse</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  content: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  options: ParserOptions = &#123;&#125;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">RootNode</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> context = createParserContext(content, options)</span><br><span class="line">  <span class="keyword">const</span> start = getCursor(context)</span><br><span class="line">  <span class="keyword">return</span> createRoot(</span><br><span class="line">    parseChildren(context, TextModes.DATA, []),</span><br><span class="line">    getSelection(context, start)</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// createParserContext</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createParserContext</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  content: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  rawOptions: ParserOptions</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">ParserContext</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options = extend(&#123;&#125;, defaultParserOptions)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> key: keyof ParserOptions</span><br><span class="line">  <span class="keyword">for</span> (key <span class="keyword">in</span> rawOptions) &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    options[key] =</span><br><span class="line">      rawOptions[key] === <span class="literal">undefined</span></span><br><span class="line">        ? defaultParserOptions[key]</span><br><span class="line">        : rawOptions[key]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    options,</span><br><span class="line">    column: <span class="number">1</span>,</span><br><span class="line">    line: <span class="number">1</span>,</span><br><span class="line">    offset: <span class="number">0</span>,</span><br><span class="line">    originalSource: content,</span><br><span class="line">    source: content,</span><br><span class="line">    inPre: <span class="literal">false</span>,</span><br><span class="line">    inVPre: <span class="literal">false</span>,</span><br><span class="line">    onWarn: options.onWarn</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="transform"><a href="#transform" class="headerlink" title="transform"></a>transform</h6><p>å°† ast ä½œä¸º root , ç»™ root ä¸Šæ·»åŠ  codegenNode æè¿°</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\compiler-core\src\transform.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">transform</span>(<span class="params">root: RootNode, options: TransformOptions</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> context = createTransformContext(root, options)</span><br><span class="line">  traverseNode(root, context)</span><br><span class="line">  <span class="keyword">if</span> (options.hoistStatic) &#123;</span><br><span class="line">    hoistStatic(root, context)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!options.ssr) &#123;</span><br><span class="line">    createRootCodegen(root, context)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// finalize meta information</span></span><br><span class="line">  root.helpers = [...context.helpers.keys()]</span><br><span class="line">  root.components = [...context.components]</span><br><span class="line">  root.directives = [...context.directives]</span><br><span class="line">  root.imports = context.imports</span><br><span class="line">  root.hoists = context.hoists</span><br><span class="line">  root.temps = context.temps</span><br><span class="line">  root.cached = context.cached</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__COMPAT__) &#123;</span><br><span class="line">    root.filters = [...context.filters!]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="generate"><a href="#generate" class="headerlink" title="generate"></a>generate</h6><p>åˆ›å»º codegen ä¸Šä¸‹æ–‡, å¼€å§‹æ ¹æ® ast æ‰€æœ‰çš„å±æ€§æ¥ç”Ÿæˆ code, é€šè¿‡éå†æ‰€æœ‰çš„å±æ€§, æ¥æ‹¼è´´æˆå­—ç¬¦ä¸², åœ¨ compile åæå– code</p>
<p>ç”Ÿæˆ code åæµç¨‹å°±å›åˆ° <a href="#####compileToFunction">compileToFunction</a> å‡½æ•°, åˆ©ç”¨ code æ¥ new ä¸€ä¸ªå‡½æ•°å¹¶æ‰§è¡Œ, èµ‹å€¼ç»™ render, è¿™å°±æ˜¯ render æ–¹æ³•äº†;</p>
<p>å¯ä»¥çœ‹åˆ°æˆ‘æ­¤å¤„çš„ code ä¸º:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'const _Vue = Vue\nconst &#123; createElementVNode: _createElementVNode, createTextVNode: _createTextVNode &#125; = _Vue\n\nconst _hoisted_1 = /*#__PURE__*/_createElementVNode("span", null, "reactive:", -1 /* HOISTED */)\nconst _hoisted_2 = /*#__PURE__*/_createElementVNode("span", null, "ref:", -1 /* HOISTED */)\nconst _hoisted_3 = /*#__PURE__*/_createElementVNode("span", null, "computed:", -1 /* HOISTED */)\n\nreturn function render(_ctx, _cache) &#123;\n  with (_ctx) &#123;\n    const &#123; createElementVNode: _createElementVâ€¦ock(), _createElementBlock(_Fragment, null, [\n      _createElementVNode("div", null, [\n        _hoisted_1,\n        _createTextVNode(_toDisplayString(state.title), 1 /* TEXT */)\n      ]),\n      _createElementVNode("div", null, [\n        _hoisted_2,\n        _createTextVNode(_toDisplayString(price), 1 /* TEXT */)\n      ]),\n      _createElementVNode("div", null, [\n        _hoisted_3,\n        _createTextVNode(_toDisplayString(currTime), 1 /* TEXT */)\n      ])\n    ], 64 /* STABLE_FRAGMENT */))\n  &#125;\n&#125;'</span></span><br></pre></td></tr></table></figure>
<p>æ ¼å¼åŒ–ä¸‹:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> _Vue = Vue</span><br><span class="line"><span class="keyword">const</span> &#123; createElementVNode: _createElementVNode, createTextVNode: _createTextVNode &#125; = _Vue</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> _hoisted_1 = <span class="comment">/*#__PURE__*/</span>_createElementVNode(<span class="string">"span"</span>, <span class="literal">null</span>, <span class="string">"reactive:"</span>, <span class="number">-1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_2 = <span class="comment">/*#__PURE__*/</span>_createElementVNode(<span class="string">"span"</span>, <span class="literal">null</span>, <span class="string">"ref:"</span>, <span class="number">-1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"><span class="keyword">const</span> _hoisted_3 = <span class="comment">/*#__PURE__*/</span>_createElementVNode(<span class="string">"span"</span>, <span class="literal">null</span>, <span class="string">"computed:"</span>, <span class="number">-1</span> <span class="comment">/* HOISTED */</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">_ctx, _cache</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">with</span> (_ctx) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; createElementVNode: _createElementVNode, toDisplayString: _toDisplayString, createTextVNode: _createTextVNode, Fragment: _Fragment, openBlock: _openBlock, createElementBlock: _createElementBlock &#125; = _Vue</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (_openBlock(), _createElementBlock(_Fragment, <span class="literal">null</span>, [</span><br><span class="line">      _createElementVNode(<span class="string">"div"</span>, <span class="literal">null</span>, [</span><br><span class="line">        _hoisted_1,</span><br><span class="line">        _createTextVNode(_toDisplayString(state.title), <span class="number">1</span> <span class="comment">/* TEXT */</span>)</span><br><span class="line">      ]),</span><br><span class="line">      _createElementVNode(<span class="string">"div"</span>, <span class="literal">null</span>, [</span><br><span class="line">        _hoisted_2,</span><br><span class="line">        _createTextVNode(_toDisplayString(price), <span class="number">1</span> <span class="comment">/* TEXT */</span>)</span><br><span class="line">      ]),</span><br><span class="line">      _createElementVNode(<span class="string">"div"</span>, <span class="literal">null</span>, [</span><br><span class="line">        _hoisted_3,</span><br><span class="line">        _createTextVNode(_toDisplayString(currTime), <span class="number">1</span> <span class="comment">/* TEXT */</span>)</span><br><span class="line">      ])</span><br><span class="line">    ], <span class="number">64</span> <span class="comment">/* STABLE_FRAGMENT */</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>generate å‡½æ•°:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\compiler-core\src\codegen.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">generate</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  ast: RootNode,</span></span></span><br><span class="line"><span class="function"><span class="params">  options: CodegenOptions &amp; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    onContextCreated?: (context: CodegenContext) =&gt; <span class="built_in">void</span></span></span></span><br><span class="line"><span class="function"><span class="params">  &#125; = &#123;&#125;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">CodegenResult</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> context = createCodegenContext(ast, options)</span><br><span class="line">  <span class="keyword">if</span> (options.onContextCreated) options.onContextCreated(context)</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    mode,</span><br><span class="line">    push,</span><br><span class="line">    prefixIdentifiers,</span><br><span class="line">    indent,</span><br><span class="line">    deindent,</span><br><span class="line">    newline,</span><br><span class="line">    scopeId,</span><br><span class="line">    ssr</span><br><span class="line">  &#125; = context</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> hasHelpers = ast.helpers.length &gt; <span class="number">0</span></span><br><span class="line">  <span class="keyword">const</span> useWithBlock = !prefixIdentifiers &amp;&amp; mode !== <span class="string">'module'</span></span><br><span class="line">  <span class="keyword">const</span> genScopeId = !__BROWSER__ &amp;&amp; scopeId != <span class="literal">null</span> &amp;&amp; mode === <span class="string">'module'</span></span><br><span class="line">  <span class="keyword">const</span> isSetupInlined = !__BROWSER__ &amp;&amp; !!options.inline</span><br><span class="line"></span><br><span class="line">  <span class="comment">// preambles</span></span><br><span class="line">  <span class="comment">// in setup() inline mode, the preamble is generated in a sub context</span></span><br><span class="line">  <span class="comment">// and returned separately.</span></span><br><span class="line">  <span class="keyword">const</span> preambleContext = isSetupInlined</span><br><span class="line">    ? createCodegenContext(ast, options)</span><br><span class="line">    : context</span><br><span class="line">  <span class="keyword">if</span> (!__BROWSER__ &amp;&amp; mode === <span class="string">'module'</span>) &#123;</span><br><span class="line">    genModulePreamble(ast, preambleContext, genScopeId, isSetupInlined)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    genFunctionPreamble(ast, preambleContext)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// enter render function</span></span><br><span class="line">  <span class="keyword">const</span> functionName = ssr ? <span class="string">`ssrRender`</span> : <span class="string">`render`</span></span><br><span class="line">  <span class="keyword">const</span> args = ssr ? [<span class="string">'_ctx'</span>, <span class="string">'_push'</span>, <span class="string">'_parent'</span>, <span class="string">'_attrs'</span>] : [<span class="string">'_ctx'</span>, <span class="string">'_cache'</span>]</span><br><span class="line">  <span class="keyword">if</span> (!__BROWSER__ &amp;&amp; options.bindingMetadata &amp;&amp; !options.inline) &#123;</span><br><span class="line">    <span class="comment">// binding optimization args</span></span><br><span class="line">    args.push(<span class="string">'$props'</span>, <span class="string">'$setup'</span>, <span class="string">'$data'</span>, <span class="string">'$options'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> signature =</span><br><span class="line">    !__BROWSER__ &amp;&amp; options.isTS</span><br><span class="line">      ? args.map(<span class="function"><span class="params">arg</span> =&gt;</span> <span class="string">`<span class="subst">$&#123;arg&#125;</span>: any`</span>).join(<span class="string">','</span>)</span><br><span class="line">      : args.join(<span class="string">', '</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isSetupInlined) &#123;</span><br><span class="line">    push(<span class="string">`(<span class="subst">$&#123;signature&#125;</span>) =&gt; &#123;`</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    push(<span class="string">`function <span class="subst">$&#123;functionName&#125;</span>(<span class="subst">$&#123;signature&#125;</span>) &#123;`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  indent()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (useWithBlock) &#123;</span><br><span class="line">    push(<span class="string">`with (_ctx) &#123;`</span>)</span><br><span class="line">    indent()</span><br><span class="line">    <span class="comment">// function mode const declarations should be inside with block</span></span><br><span class="line">    <span class="comment">// also they should be renamed to avoid collision with user properties</span></span><br><span class="line">    <span class="keyword">if</span> (hasHelpers) &#123;</span><br><span class="line">      push(</span><br><span class="line">        <span class="string">`const &#123; <span class="subst">$&#123;ast.helpers</span></span></span><br><span class="line"><span class="string"><span class="subst">          .map(s =&gt; <span class="string">`<span class="subst">$&#123;helperNameMap[s]&#125;</span>: _<span class="subst">$&#123;helperNameMap[s]&#125;</span>`</span>)</span></span></span><br><span class="line"><span class="string"><span class="subst">          .join(<span class="string">', '</span>)&#125;</span> &#125; = _Vue`</span></span><br><span class="line">      )</span><br><span class="line">      push(<span class="string">`\n`</span>)</span><br><span class="line">      newline()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// generate asset resolution statements</span></span><br><span class="line">  <span class="keyword">if</span> (ast.components.length) &#123;</span><br><span class="line">    genAssets(ast.components, <span class="string">'component'</span>, context)</span><br><span class="line">    <span class="keyword">if</span> (ast.directives.length || ast.temps &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      newline()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (ast.directives.length) &#123;</span><br><span class="line">    genAssets(ast.directives, <span class="string">'directive'</span>, context)</span><br><span class="line">    <span class="keyword">if</span> (ast.temps &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      newline()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (__COMPAT__ &amp;&amp; ast.filters &amp;&amp; ast.filters.length) &#123;</span><br><span class="line">    newline()</span><br><span class="line">    genAssets(ast.filters, <span class="string">'filter'</span>, context)</span><br><span class="line">    newline()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ast.temps &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    push(<span class="string">`let `</span>)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; ast.temps; i++) &#123;</span><br><span class="line">      push(<span class="string">`<span class="subst">$&#123;i &gt; <span class="number">0</span> ? <span class="string">`, `</span> : <span class="string">``</span>&#125;</span>_temp<span class="subst">$&#123;i&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (ast.components.length || ast.directives.length || ast.temps) &#123;</span><br><span class="line">    push(<span class="string">`\n`</span>)</span><br><span class="line">    newline()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// generate the VNode tree expression</span></span><br><span class="line">  <span class="keyword">if</span> (!ssr) &#123;</span><br><span class="line">    push(<span class="string">`return `</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (ast.codegenNode) &#123;</span><br><span class="line">    genNode(ast.codegenNode, context)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    push(<span class="string">`null`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (useWithBlock) &#123;</span><br><span class="line">    deindent()</span><br><span class="line">    push(<span class="string">`&#125;`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  deindent()</span><br><span class="line">  push(<span class="string">`&#125;`</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ast,</span><br><span class="line">    code: context.code,</span><br><span class="line">    preamble: isSetupInlined ? preambleContext.code : <span class="string">``</span>,</span><br><span class="line">    <span class="comment">// SourceMapGenerator does have toJSON() method but it's not in the types</span></span><br><span class="line">    map: context.map ? (context.map <span class="keyword">as</span> <span class="built_in">any</span>).toJSON() : <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="setupRenderEffect"><a href="#setupRenderEffect" class="headerlink" title="setupRenderEffect"></a>setupRenderEffect</h3><p>å…ˆå®šä¹‰ç»„ä»¶æ›´æ–°çš„å‡½æ•° componentUpdateFn(å®é™…å°±æ˜¯ this.fn, åè¾¹åœ¨ update æ—¶è§¦å‘), æ¥ç€åˆ›å»º effect å‡†å¤‡ render, ReactiveEffect æ„é€ å‡½æ•°ä¼ å…¥ä¹‹å‰çš„æ›´æ–°å‡½æ•°, ä»¥åŠå°†å®ä¾‹æ›´æ–°çš„é˜Ÿåˆ—ä½œä¸º scheduler å‡½æ•°å‹å…¥ effect, æœ€åå°†å®ä¾‹çš„ scope ä½œä¸º effect scope</p>
<p>æ¥ç€ç»™ instance.update èµ‹å€¼ effect.run.bind(effect), å®é™…ä¹Ÿå°±æ˜¯ effect å‰¯ä½œç”¨æ›´æ–°çš„ run å‡½æ•°ç»‘å®š this æŒ‡å‘åçš„å‡½æ•°, instance.update èµ‹å€¼ç»™ update, åœ¨æœ€åæ‰§è¡Œ update(), è¿›è¡Œåˆå§‹åŒ– render</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> setupRenderEffect: SetupRenderEffectFn = (</span><br><span class="line">  instance,</span><br><span class="line">  initialVNode,</span><br><span class="line">  container,</span><br><span class="line">  anchor,</span><br><span class="line">  parentSuspense,</span><br><span class="line">  isSVG,</span><br><span class="line">  optimized</span><br><span class="line">) =&gt; &#123;</span><br><span class="line">  <span class="comment">// ç»„ä»¶æ›´æ–°å‡½æ•°, ä½œä¸º fn è¢«ä¼ å…¥ ReactiveEffect</span></span><br><span class="line">  <span class="keyword">const</span> componentUpdateFn = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// create reactive effect for rendering</span></span><br><span class="line">  <span class="keyword">const</span> effect = <span class="keyword">new</span> ReactiveEffect(</span><br><span class="line">    componentUpdateFn,</span><br><span class="line">    () =&gt; queueJob(instance.update),</span><br><span class="line">    instance.scope <span class="comment">// track it in component's effect scope</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»™ update å’Œ instance.update èµ‹å€¼ effect.run æ–¹æ³•</span></span><br><span class="line">  <span class="keyword">const</span> update = (instance.update = effect.run.bind(effect) <span class="keyword">as</span> SchedulerJob)</span><br><span class="line">  update.id = instance.uid</span><br><span class="line">  <span class="comment">// allowRecurse</span></span><br><span class="line">  <span class="comment">// #1801, #2043 component render effects should allow recursive updates</span></span><br><span class="line">  effect.allowRecurse = update.allowRecurse = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    effect.onTrack = instance.rtc</span><br><span class="line">      ? <span class="function"><span class="params">e</span> =&gt;</span> invokeArrayFns(instance.rtc!, e)</span><br><span class="line">      : <span class="built_in">void</span> <span class="number">0</span></span><br><span class="line">    effect.onTrigger = instance.rtg</span><br><span class="line">      ? <span class="function"><span class="params">e</span> =&gt;</span> invokeArrayFns(instance.rtg!, e)</span><br><span class="line">      : <span class="built_in">void</span> <span class="number">0</span></span><br><span class="line">    <span class="comment">// @ts-ignore (for scheduler)</span></span><br><span class="line">    update.ownerInstance = instance</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç›¸å½“äºæ‰§è¡Œ effect.run()</span></span><br><span class="line">  update()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="update-effect-run"><a href="#update-effect-run" class="headerlink" title="update() == effect.run()"></a>update() == effect.run()</h4><p>run ä½œä¸º effect å®ä¾‹çš„æ–¹æ³•, ç”¨ä»¥è§¦å‘ effect è¿›è¡Œä¾èµ–æ”¶é›†, setupRenderEffect</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\reactivity\src\effect.ts</span></span><br><span class="line"></span><br><span class="line">run() &#123;</span><br><span class="line">  <span class="comment">// å¦‚æœå½“å‰çš„ effect å‰¯ä½œç”¨æ—¶æ¿€æ´»çš„, åˆ™ç›´æ¥è¿”å› fn(), ä¹Ÿå°±æ˜¯ç»„ä»¶æ›´æ–°çš„å‡½æ•°</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.active) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.fn()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!effectStack.includes(<span class="keyword">this</span>)) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// å°†å½“å‰æ´»è·ƒçš„ effect æ·»åŠ è¿›æ ˆ</span></span><br><span class="line">      effectStack.push((activeEffect = <span class="keyword">this</span>))</span><br><span class="line">      <span class="comment">// å¼€å§‹ track</span></span><br><span class="line">      enableTracking()</span><br><span class="line"></span><br><span class="line">      trackOpBit = <span class="number">1</span> &lt;&lt; ++effectTrackDepth</span><br><span class="line"></span><br><span class="line">      <span class="comment">// effect track çš„æ·±åº¦è¦å°äº 30, å¦åˆ™å°±å¼€å§‹æ¸…ç† effect</span></span><br><span class="line">      <span class="keyword">if</span> (effectTrackDepth &lt;= maxMarkerBits) &#123;</span><br><span class="line">        initDepMarkers(<span class="keyword">this</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cleanupEffect(<span class="keyword">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.fn()</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (effectTrackDepth &lt;= maxMarkerBits) &#123;</span><br><span class="line">        finalizeDepMarkers(<span class="keyword">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      trackOpBit = <span class="number">1</span> &lt;&lt; --effectTrackDepth</span><br><span class="line"></span><br><span class="line">      resetTracking()</span><br><span class="line">      effectStack.pop()</span><br><span class="line">      <span class="keyword">const</span> n = effectStack.length</span><br><span class="line">      activeEffect = n &gt; <span class="number">0</span> ? effectStack[n - <span class="number">1</span>] : <span class="literal">undefined</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="componentUpdateFn"><a href="#componentUpdateFn" class="headerlink" title="componentUpdateFn"></a>componentUpdateFn</h4><p>åœ¨ effect.run ä¸­ this.fn() é‡Œè¢«è°ƒç”¨, ç”¨ä»¥æ›´æ–°æˆ–åˆå§‹åŒ–ç»„ä»¶; é€šè¿‡ renderComponentRoot æ„å»ºæ ‘</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\runtime-core\src\renderer.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> componentUpdateFn = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// æŒ‰å®ä¾‹æ˜¯å¦æŒ‚è½½æ¥åˆ¤æ–­æ¥ä¸‹æ¥æ‰§è¡Œåˆå§‹åŒ–è¿˜æ˜¯æ›´æ–°</span></span><br><span class="line">  <span class="keyword">if</span> (!instance.isMounted) &#123;</span><br><span class="line">    <span class="keyword">let</span> vnodeHook: VNodeHook | <span class="literal">null</span> | <span class="literal">undefined</span></span><br><span class="line">    <span class="keyword">const</span> &#123; el, props &#125; = initialVNode</span><br><span class="line">    <span class="keyword">const</span> &#123; bm, m, parent &#125; = instance</span><br><span class="line">    <span class="keyword">const</span> isAsyncWrapperVNode = isAsyncWrapper(initialVNode)</span><br><span class="line"></span><br><span class="line">    effect.allowRecurse = <span class="literal">false</span></span><br><span class="line">    <span class="comment">// beforeMount hook</span></span><br><span class="line">    <span class="comment">// æ‰§è¡Œ beforeMount å®šä¹‰çš„é’©å­å‡½æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (bm) &#123;</span><br><span class="line">      invokeArrayFns(bm)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// onVnodeBeforeMount</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      !isAsyncWrapperVNode &amp;&amp;</span><br><span class="line">      (vnodeHook = props &amp;&amp; props.onVnodeBeforeMount)</span><br><span class="line">    ) &#123;</span><br><span class="line">      invokeVNodeHook(vnodeHook, parent, initialVNode)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      __COMPAT__ &amp;&amp;</span><br><span class="line">      isCompatEnabled(DeprecationTypes.INSTANCE_EVENT_HOOKS, instance)</span><br><span class="line">    ) &#123;</span><br><span class="line">      instance.emit(<span class="string">'hook:beforeMount'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    effect.allowRecurse = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (el &amp;&amp; hydrateNode) &#123;</span><br><span class="line">      <span class="comment">// vnode has adopted host node - perform hydration instead of mount.</span></span><br><span class="line">      <span class="keyword">const</span> hydrateSubTree = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          startMeasure(instance, <span class="string">`render`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        instance.subTree = renderComponentRoot(instance)</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          endMeasure(instance, <span class="string">`render`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          startMeasure(instance, <span class="string">`hydrate`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        hydrateNode!(</span><br><span class="line">          el <span class="keyword">as</span> Node,</span><br><span class="line">          instance.subTree,</span><br><span class="line">          instance,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          <span class="literal">null</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">          endMeasure(instance, <span class="string">`hydrate`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (isAsyncWrapperVNode) &#123;</span><br><span class="line">        ;(initialVNode.type <span class="keyword">as</span> ComponentOptions).__asyncLoader!().then(</span><br><span class="line">          <span class="comment">// note: we are moving the render call into an async callback,</span></span><br><span class="line">          <span class="comment">// which means it won't track dependencies - but it's ok because</span></span><br><span class="line">          <span class="comment">// a server-rendered async wrapper is already in resolved state</span></span><br><span class="line">          <span class="comment">// and it will never need to change.</span></span><br><span class="line">          () =&gt; !instance.isUnmounted &amp;&amp; hydrateSubTree()</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        hydrateSubTree()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        startMeasure(instance, <span class="string">`render`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> subTree = (instance.subTree = renderComponentRoot(instance))</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        endMeasure(instance, <span class="string">`render`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        startMeasure(instance, <span class="string">`patch`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      patch(</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        subTree,</span><br><span class="line">        container,</span><br><span class="line">        anchor,</span><br><span class="line">        instance,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">        endMeasure(instance, <span class="string">`patch`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      initialVNode.el = subTree.el</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// mounted hook</span></span><br><span class="line">    <span class="keyword">if</span> (m) &#123;</span><br><span class="line">      queuePostRenderEffect(m, parentSuspense)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// onVnodeMounted</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      !isAsyncWrapperVNode &amp;&amp;</span><br><span class="line">      (vnodeHook = props &amp;&amp; props.onVnodeMounted)</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">const</span> scopedInitialVNode = initialVNode</span><br><span class="line">      queuePostRenderEffect(</span><br><span class="line">        () =&gt; invokeVNodeHook(vnodeHook!, parent, scopedInitialVNode),</span><br><span class="line">        parentSuspense</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      __COMPAT__ &amp;&amp;</span><br><span class="line">      isCompatEnabled(DeprecationTypes.INSTANCE_EVENT_HOOKS, instance)</span><br><span class="line">    ) &#123;</span><br><span class="line">      queuePostRenderEffect(</span><br><span class="line">        () =&gt; instance.emit(<span class="string">'hook:mounted'</span>),</span><br><span class="line">        parentSuspense</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// activated hook for keep-alive roots.</span></span><br><span class="line">    <span class="comment">// #1742 activated hook must be accessed after first render</span></span><br><span class="line">    <span class="comment">// since the hook may be injected by a child keep-alive</span></span><br><span class="line">    <span class="keyword">if</span> (initialVNode.shapeFlag &amp; ShapeFlags.COMPONENT_SHOULD_KEEP_ALIVE) &#123;</span><br><span class="line">      instance.a &amp;&amp; queuePostRenderEffect(instance.a, parentSuspense)</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        __COMPAT__ &amp;&amp;</span><br><span class="line">        isCompatEnabled(DeprecationTypes.INSTANCE_EVENT_HOOKS, instance)</span><br><span class="line">      ) &#123;</span><br><span class="line">        queuePostRenderEffect(</span><br><span class="line">          () =&gt; instance.emit(<span class="string">'hook:activated'</span>),</span><br><span class="line">          parentSuspense</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    instance.isMounted = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">      devtoolsComponentAdded(instance)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// #2458: deference mount-only object parameters to prevent memleaks</span></span><br><span class="line">    initialVNode = container = anchor = <span class="literal">null</span> <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// updateComponent</span></span><br><span class="line">    <span class="comment">// This is triggered by mutation of component's own state (next: null)</span></span><br><span class="line">    <span class="comment">// OR parent calling processComponent (next: VNode)</span></span><br><span class="line">    <span class="keyword">let</span> &#123; next, bu, u, parent, vnode &#125; = instance</span><br><span class="line">    <span class="keyword">let</span> originNext = next</span><br><span class="line">    <span class="keyword">let</span> vnodeHook: VNodeHook | <span class="literal">null</span> | <span class="literal">undefined</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      pushWarningContext(next || instance.vnode)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Disallow component effect recursion during pre-lifecycle hooks.</span></span><br><span class="line">    effect.allowRecurse = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (next) &#123;</span><br><span class="line">      next.el = vnode.el</span><br><span class="line">      updateComponentPreRender(instance, next, optimized)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      next = vnode</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// beforeUpdate hook</span></span><br><span class="line">    <span class="keyword">if</span> (bu) &#123;</span><br><span class="line">      invokeArrayFns(bu)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// onVnodeBeforeUpdate</span></span><br><span class="line">    <span class="keyword">if</span> ((vnodeHook = next.props &amp;&amp; next.props.onVnodeBeforeUpdate)) &#123;</span><br><span class="line">      invokeVNodeHook(vnodeHook, parent, next, vnode)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      __COMPAT__ &amp;&amp;</span><br><span class="line">      isCompatEnabled(DeprecationTypes.INSTANCE_EVENT_HOOKS, instance)</span><br><span class="line">    ) &#123;</span><br><span class="line">      instance.emit(<span class="string">'hook:beforeUpdate'</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    effect.allowRecurse = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// render</span></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      startMeasure(instance, <span class="string">`render`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> nextTree = renderComponentRoot(instance)</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      endMeasure(instance, <span class="string">`render`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> prevTree = instance.subTree</span><br><span class="line">    instance.subTree = nextTree</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      startMeasure(instance, <span class="string">`patch`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    patch(</span><br><span class="line">      prevTree,</span><br><span class="line">      nextTree,</span><br><span class="line">      <span class="comment">// parent may have changed if it's in a teleport</span></span><br><span class="line">      hostParentNode(prevTree.el!)!,</span><br><span class="line">      <span class="comment">// anchor may have changed if it's in a fragment</span></span><br><span class="line">      getNextHostNode(prevTree),</span><br><span class="line">      instance,</span><br><span class="line">      parentSuspense,</span><br><span class="line">      isSVG</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      endMeasure(instance, <span class="string">`patch`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    next.el = nextTree.el</span><br><span class="line">    <span class="keyword">if</span> (originNext === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// self-triggered update. In case of HOC, update parent component</span></span><br><span class="line">      <span class="comment">// vnode el. HOC is indicated by parent instance's subTree pointing</span></span><br><span class="line">      <span class="comment">// to child component's vnode</span></span><br><span class="line">      updateHOCHostEl(instance, nextTree.el)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// updated hook</span></span><br><span class="line">    <span class="keyword">if</span> (u) &#123;</span><br><span class="line">      queuePostRenderEffect(u, parentSuspense)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// onVnodeUpdated</span></span><br><span class="line">    <span class="keyword">if</span> ((vnodeHook = next.props &amp;&amp; next.props.onVnodeUpdated)) &#123;</span><br><span class="line">      queuePostRenderEffect(</span><br><span class="line">        () =&gt; invokeVNodeHook(vnodeHook!, parent, next!, vnode),</span><br><span class="line">        parentSuspense</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      __COMPAT__ &amp;&amp;</span><br><span class="line">      isCompatEnabled(DeprecationTypes.INSTANCE_EVENT_HOOKS, instance)</span><br><span class="line">    ) &#123;</span><br><span class="line">      queuePostRenderEffect(</span><br><span class="line">        () =&gt; instance.emit(<span class="string">'hook:updated'</span>),</span><br><span class="line">        parentSuspense</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__ || __FEATURE_PROD_DEVTOOLS__) &#123;</span><br><span class="line">      devtoolsComponentUpdated(instance)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      popWarningContext()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="renderComponentRoot"><a href="#renderComponentRoot" class="headerlink" title="renderComponentRoot"></a>renderComponentRoot</h5><p>æ„å»º subTree, nextTree</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages\runtime-core\src\componentRenderUtils.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">renderComponentRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  instance: ComponentInternalInstance</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">VNode</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">type</span>: Component,</span><br><span class="line">    vnode,</span><br><span class="line">    proxy,</span><br><span class="line">    withProxy,</span><br><span class="line">    props,</span><br><span class="line">    propsOptions: [propsOptions],</span><br><span class="line">    slots,</span><br><span class="line">    attrs,</span><br><span class="line">    emit,</span><br><span class="line">    render,</span><br><span class="line">    renderCache,</span><br><span class="line">    data,</span><br><span class="line">    setupState,</span><br><span class="line">    ctx,</span><br><span class="line">    inheritAttrs</span><br><span class="line">  &#125; = instance</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> result</span><br><span class="line">  <span class="keyword">let</span> fallthroughAttrs</span><br><span class="line">  <span class="keyword">const</span> prev = setCurrentRenderingInstance(instance)</span><br><span class="line">  <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">    accessedAttrs = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (vnode.shapeFlag &amp; ShapeFlags.STATEFUL_COMPONENT) &#123;</span><br><span class="line">      <span class="comment">// withProxy is a proxy with a different `has` trap only for</span></span><br><span class="line">      <span class="comment">// runtime-compiled render functions using `with` block.</span></span><br><span class="line">      <span class="keyword">const</span> proxyToUse = withProxy || proxy</span><br><span class="line">      result = normalizeVNode(</span><br><span class="line">        render!.call(</span><br><span class="line">          proxyToUse,</span><br><span class="line">          proxyToUse!,</span><br><span class="line">          renderCache,</span><br><span class="line">          props,</span><br><span class="line">          setupState,</span><br><span class="line">          data,</span><br><span class="line">          ctx</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">      fallthroughAttrs = attrs</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// functional</span></span><br><span class="line">      <span class="keyword">const</span> render = Component <span class="keyword">as</span> FunctionalComponent</span><br><span class="line">      <span class="comment">// in dev, mark attrs accessed if optional props (attrs === props)</span></span><br><span class="line">      <span class="keyword">if</span> (__DEV__ &amp;&amp; attrs === props) &#123;</span><br><span class="line">        markAttrsAccessed()</span><br><span class="line">      &#125;</span><br><span class="line">      result = normalizeVNode(</span><br><span class="line">        render.length &gt; <span class="number">1</span></span><br><span class="line">          ? render(</span><br><span class="line">              props,</span><br><span class="line">              __DEV__</span><br><span class="line">                ? &#123;</span><br><span class="line">                    <span class="keyword">get</span> attrs() &#123;</span><br><span class="line">                      markAttrsAccessed()</span><br><span class="line">                      <span class="keyword">return</span> attrs</span><br><span class="line">                    &#125;,</span><br><span class="line">                    slots,</span><br><span class="line">                    emit</span><br><span class="line">                  &#125;</span><br><span class="line">                : &#123; attrs, slots, emit &#125;</span><br><span class="line">            )</span><br><span class="line">          : render(props, <span class="literal">null</span> <span class="keyword">as</span> <span class="built_in">any</span> <span class="comment">/* we know it doesn't need it */</span>)</span><br><span class="line">      )</span><br><span class="line">      fallthroughAttrs = Component.props</span><br><span class="line">        ? attrs</span><br><span class="line">        : getFunctionalFallthrough(attrs)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    blockStack.length = <span class="number">0</span></span><br><span class="line">    handleError(err, instance, ErrorCodes.RENDER_FUNCTION)</span><br><span class="line">    result = createVNode(Comment)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// attr merging</span></span><br><span class="line">  <span class="comment">// in dev mode, comments are preserved, and it's possible for a template</span></span><br><span class="line">  <span class="comment">// to have comments along side the root element which makes it a fragment</span></span><br><span class="line">  <span class="keyword">let</span> root = result</span><br><span class="line">  <span class="keyword">let</span> setRoot: <span class="function">(<span class="params">(<span class="params">root: VNode</span>) =&gt; <span class="built_in">void</span></span>) | <span class="params">undefined</span> = <span class="params">undefined</span></span></span><br><span class="line"><span class="function">  <span class="params">if</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    __DEV__ &amp;&amp;</span></span></span><br><span class="line"><span class="function"><span class="params">    result.patchFlag &gt; 0 &amp;&amp;</span></span></span><br><span class="line"><span class="function"><span class="params">    result.patchFlag &amp; PatchFlags.DEV_ROOT_FRAGMENT</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) &#123;</span></span><br><span class="line"><span class="function">    ;[<span class="params">root</span>, <span class="params">setRoot</span>] = <span class="params">getChildRoot</span>(<span class="params">result</span>)</span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">if</span> (<span class="params">fallthroughAttrs &amp;&amp; inheritAttrs !== <span class="literal">false</span></span>) &#123;</span></span><br><span class="line"><span class="function">    <span class="params">const</span> <span class="params">keys</span> = <span class="params">Object</span>.<span class="params">keys</span>(<span class="params">fallthroughAttrs</span>)</span></span><br><span class="line"><span class="function">    <span class="params">const</span> &#123; <span class="params">shapeFlag</span> &#125; = <span class="params">root</span></span></span><br><span class="line"><span class="function">    <span class="params">if</span> (<span class="params">keys.length</span>) &#123;</span></span><br><span class="line"><span class="function">      <span class="params">if</span> (<span class="params">shapeFlag &amp; (<span class="params">ShapeFlags.ELEMENT | ShapeFlags.COMPONENT</span>)</span>) &#123;</span></span><br><span class="line"><span class="function">        <span class="params">if</span> (<span class="params">propsOptions &amp;&amp; keys.some(<span class="params">isModelListener</span>)</span>) &#123;</span></span><br><span class="line"><span class="function">          // <span class="params">If</span> <span class="params">a</span> <span class="params">v</span>-<span class="params">model</span> <span class="params">listener</span> (<span class="params">onUpdate:xxx</span>) <span class="params">has</span> <span class="params">a</span> <span class="params">corresponding</span> <span class="params">declared</span></span></span><br><span class="line"><span class="function">          // <span class="params">prop</span>, <span class="params">it</span> <span class="params">indicates</span> <span class="params">this</span> <span class="params">component</span> <span class="params">expects</span> <span class="params">to</span> <span class="params">handle</span> <span class="params">v</span>-<span class="params">model</span> <span class="params">and</span></span></span><br><span class="line"><span class="function">          // <span class="params">it</span> <span class="params">should</span> <span class="params">not</span> <span class="params">fallthrough</span>.</span></span><br><span class="line"><span class="function">          // <span class="params">related</span>: #1543, #1643, #1989</span></span><br><span class="line"><span class="function">          <span class="params">fallthroughAttrs</span> = <span class="params">filterModelListeners</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">            fallthroughAttrs,</span></span></span><br><span class="line"><span class="function"><span class="params">            propsOptions</span></span></span><br><span class="line"><span class="function"><span class="params">          </span>)</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">        <span class="params">root</span> = <span class="params">cloneVNode</span>(<span class="params">root, fallthroughAttrs</span>)</span></span><br><span class="line"><span class="function">      &#125; <span class="params">else</span> <span class="params">if</span> (<span class="params">__DEV__ &amp;&amp; !accessedAttrs &amp;&amp; root.<span class="keyword">type</span> !== Comment</span>) &#123;</span></span><br><span class="line"><span class="function">        <span class="params">const</span> <span class="params">allAttrs</span> = <span class="params">Object</span>.<span class="params">keys</span>(<span class="params">attrs</span>)</span></span><br><span class="line"><span class="function">        <span class="params">const</span> <span class="params">eventAttrs</span>: <span class="params">string</span>[] = []</span></span><br><span class="line"><span class="function">        <span class="params">const</span> <span class="params">extraAttrs</span>: <span class="params">string</span>[] = []</span></span><br><span class="line"><span class="function">        <span class="params">for</span> (<span class="params"><span class="keyword">let</span> i = 0, l = allAttrs.length; i &lt; l; i++</span>) &#123;</span></span><br><span class="line"><span class="function">          <span class="params">const</span> <span class="params">key</span> = <span class="params">allAttrs</span>[<span class="params">i</span>]</span></span><br><span class="line"><span class="function">          <span class="params">if</span> (<span class="params">isOn(<span class="params">key</span>)</span>) &#123;</span></span><br><span class="line"><span class="function">            // <span class="params">ignore</span> <span class="params">v</span>-<span class="params">model</span> <span class="params">handlers</span> <span class="params">when</span> <span class="params">they</span> <span class="params">fail</span> <span class="params">to</span> <span class="params">fallthrough</span></span></span><br><span class="line"><span class="function">            <span class="params">if</span> (<span class="params">!isModelListener(<span class="params">key</span>)</span>) &#123;</span></span><br><span class="line"><span class="function">              // <span class="params">remove</span> `<span class="params">on</span>`, <span class="params">lowercase</span> <span class="params">first</span> <span class="params">letter</span> <span class="params">to</span> <span class="params">reflect</span> <span class="params">event</span> <span class="params">casing</span></span></span><br><span class="line"><span class="function">              // <span class="params">accurately</span></span></span><br><span class="line"><span class="function">              <span class="params">eventAttrs</span>.<span class="params">push</span>(<span class="params">key[2].toLowerCase(<span class="params"></span>) + key.slice(<span class="params">3</span>)</span>)</span></span><br><span class="line"><span class="function">            &#125;</span></span><br><span class="line"><span class="function">          &#125; <span class="params">else</span> &#123;</span></span><br><span class="line"><span class="function">            <span class="params">extraAttrs</span>.<span class="params">push</span>(<span class="params">key</span>)</span></span><br><span class="line"><span class="function">          &#125;</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">        <span class="params">if</span> (<span class="params">extraAttrs.length</span>) &#123;</span></span><br><span class="line"><span class="function">          <span class="params">warn</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">            `Extraneous non-props attributes (<span class="params">` +</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">              `$&#123;extraAttrs.join(<span class="params">', '</span>)&#125;</span>) ` +</span></span></span><br><span class="line"><span class="function"><span class="params">              `were passed to component but could not be automatically inherited ` +</span></span></span><br><span class="line"><span class="function"><span class="params">              `because component renders fragment or text root nodes.`</span></span></span><br><span class="line"><span class="function"><span class="params">          </span>)</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">        <span class="params">if</span> (<span class="params">eventAttrs.length</span>) &#123;</span></span><br><span class="line"><span class="function">          <span class="params">warn</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">            `Extraneous non-emits event listeners (<span class="params">` +</span></span></span></span><br><span class="line"><span class="function"><span class="params"><span class="params">              `$&#123;eventAttrs.join(<span class="params">', '</span>)&#125;</span>) ` +</span></span></span><br><span class="line"><span class="function"><span class="params">              `were passed to component but could not be automatically inherited ` +</span></span></span><br><span class="line"><span class="function"><span class="params">              `because component renders fragment or text root nodes. ` +</span></span></span><br><span class="line"><span class="function"><span class="params">              `If the listener is intended to be a component custom event listener only, ` +</span></span></span><br><span class="line"><span class="function"><span class="params">              `<span class="keyword">declare</span> it using the "emits" option.`</span></span></span><br><span class="line"><span class="function"><span class="params">          </span>)</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">      &#125;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">if</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    __COMPAT__ &amp;&amp;</span></span></span><br><span class="line"><span class="function"><span class="params">    isCompatEnabled(<span class="params">DeprecationTypes.INSTANCE_ATTRS_CLASS_STYLE, instance</span>) &amp;&amp;</span></span></span><br><span class="line"><span class="function"><span class="params">    vnode.shapeFlag &amp; ShapeFlags.STATEFUL_COMPONENT &amp;&amp;</span></span></span><br><span class="line"><span class="function"><span class="params">    root.shapeFlag &amp; (<span class="params">ShapeFlags.ELEMENT | ShapeFlags.COMPONENT</span>)</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) &#123;</span></span><br><span class="line"><span class="function">    <span class="params">const</span> &#123; <span class="params">class</span>: <span class="params">cls</span>, <span class="params">style</span> &#125; = <span class="params">vnode</span>.<span class="params">props</span> || &#123;&#125;</span></span><br><span class="line"><span class="function">    <span class="params">if</span> (<span class="params">cls || style</span>) &#123;</span></span><br><span class="line"><span class="function">      <span class="params">if</span> (<span class="params">__DEV__ &amp;&amp; inheritAttrs === <span class="literal">false</span></span>) &#123;</span></span><br><span class="line"><span class="function">        <span class="params">warnDeprecation</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">          DeprecationTypes.INSTANCE_ATTRS_CLASS_STYLE,</span></span></span><br><span class="line"><span class="function"><span class="params">          instance,</span></span></span><br><span class="line"><span class="function"><span class="params">          getComponentName(<span class="params">instance.<span class="keyword">type</span></span>)</span></span></span><br><span class="line"><span class="function"><span class="params">        </span>)</span></span><br><span class="line"><span class="function">      &#125;</span></span><br><span class="line"><span class="function">      <span class="params">root</span> = <span class="params">cloneVNode</span>(<span class="params">root, &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">class</span>: cls,</span></span></span><br><span class="line"><span class="function"><span class="params">        style: style</span></span></span><br><span class="line"><span class="function"><span class="params">      &#125;</span>)</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // <span class="params">inherit</span> <span class="params">directives</span></span></span><br><span class="line"><span class="function">  <span class="params">if</span> (<span class="params">vnode.dirs</span>) &#123;</span></span><br><span class="line"><span class="function">    <span class="params">if</span> (<span class="params">__DEV__ &amp;&amp; !isElementRoot(<span class="params">root</span>)</span>) &#123;</span></span><br><span class="line"><span class="function">      <span class="params">warn</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        `Runtime directive used on component <span class="keyword">with</span> non-element root node. ` +</span></span></span><br><span class="line"><span class="function"><span class="params">          `The directives will not <span class="keyword">function</span> <span class="keyword">as</span> intended.`</span></span></span><br><span class="line"><span class="function"><span class="params">      </span>)</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">    <span class="params">root</span>.<span class="params">dirs</span> = <span class="params">root</span>.<span class="params">dirs</span> ? <span class="params">root</span>.<span class="params">dirs</span>.<span class="params">concat</span>(<span class="params">vnode.dirs</span>) : <span class="params">vnode</span>.<span class="params">dirs</span></span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function">  // <span class="params">inherit</span> <span class="params">transition</span> <span class="params">data</span></span></span><br><span class="line"><span class="function">  <span class="params">if</span> (<span class="params">vnode.transition</span>) &#123;</span></span><br><span class="line"><span class="function">    <span class="params">if</span> (<span class="params">__DEV__ &amp;&amp; !isElementRoot(<span class="params">root</span>)</span>) &#123;</span></span><br><span class="line"><span class="function">      <span class="params">warn</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        `Component inside &lt;Transition&gt; renders non-element root node ` +</span></span></span><br><span class="line"><span class="function"><span class="params">          `that cannot be animated.`</span></span></span><br><span class="line"><span class="function"><span class="params">      </span>)</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">    <span class="params">root</span>.<span class="params">transition</span> = <span class="params">vnode</span>.<span class="params">transition</span></span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">if</span> (<span class="params">__DEV__ &amp;&amp; setRoot</span>) &#123;</span></span><br><span class="line"><span class="function">    <span class="params">setRoot</span>(<span class="params">root</span>)</span></span><br><span class="line"><span class="function">  &#125; <span class="params">else</span> &#123;</span></span><br><span class="line"><span class="function">    <span class="params">result</span> = <span class="params">root</span></span></span><br><span class="line"><span class="function">  &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="params">setCurrentRenderingInstance</span>(<span class="params">prev</span>)</span></span><br><span class="line"><span class="function">  <span class="params">return</span> <span class="params">result</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <br>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/notes/">notes</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Frontend/">Frontend</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Vue/">Vue</a></li></ul>

      
	<span class="ico-date"></span>
	<a href="/blog/2021/10/10/2-frontend-vue3-source-flow/" class="article-date">
	  <time datetime="2021-10-10T10:45:00.000Z" itemprop="datePublished">åæœˆ 10, 2021</time>
	</a>

      <!-- æ·»åŠ å­—æ•°ç»Ÿè®¡ -->
      
        <span class="ico-fontcount"></span><span class="post-count">11kå­—</span>
      
    </footer>
    <!-- æ–‡ç« æ·»åŠ è¯„è®º -->
    
      
    <script defer src="//unpkg.com/leancloud-storage@4/dist/av-min.js"></script>
    <script defer src='//unpkg.com/valine@latest/dist/Valine.min.js'></script>
    <div id="vcomments"></div>
    <script>

        var notify = 'false' == true ? true : false;
        var verify = 'false' == true ? true : false;
		// è®¾ç½®è½®è¯¢
		const timer = setInterval(() => {
			if (window.Valine && typeof window.Valine === 'function') {
				clearInterval(timer);
				new Valine({
					el: '#vcomments',
					notify: notify,
					verify: verify,
					app_id: 'AJj6aG4cDMBqBIISAr1U53Az-gzGzoHsz',
					app_key: 'bIYBhlht4PSXI4pCWuH7Gnuo',
					placeholder: 'say something bro ~',
					avatar: 'monsterid',
					avatarCDN:'https://cravatar.cn/avatar/'
				});
			}
		}, 1000);
    </script>



    
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
    <a href="/blog/2021/12/06/4-python-excel-handle/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">ä¸Šä¸€ç¯‡</strong>
      <div class="article-nav-title">
        
          python æ‰¹é‡æŠ“å– html æ–‡ä»¶å†…æ•°æ®å¹¶å†™å…¥åŒå excel æ–‡æ¡£æŒ‡å®šä½ç½®åè¾“å‡º pdf
        
      </div>
    </a>
  
  
    <a href="/blog/2021/10/08/2-frontend-vue3-reactivity/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">ä¸‹ä¸€ç¯‡</strong>
      <div class="article-nav-title">ğŸ”¥ å‰ç«¯ | vue3 å“åº”å¼å­¦ä¹ </div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">æ–‡ç« ç›®å½•</strong>
    
      <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#å‡†å¤‡"><span class="nav-number">1.</span> <span class="nav-text">å‡†å¤‡</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#è°ƒè¯•é…ç½®"><span class="nav-number">2.</span> <span class="nav-text">è°ƒè¯•é…ç½®</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#æºç æµç¨‹"><span class="nav-number">3.</span> <span class="nav-text">æºç æµç¨‹</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#createApp"><span class="nav-number">4.</span> <span class="nav-text">createApp</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#createRenderer"><span class="nav-number">4.1.</span> <span class="nav-text">createRenderer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createAppAPI"><span class="nav-number">4.2.</span> <span class="nav-text">createAppAPI</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#mount"><span class="nav-number">5.</span> <span class="nav-text">[mount]</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#createVNode"><span class="nav-number">5.1.</span> <span class="nav-text">createVNode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#render"><span class="nav-number">5.2.</span> <span class="nav-text">[render]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#patch"><span class="nav-number">5.3.</span> <span class="nav-text">patch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#processComponent"><span class="nav-number">5.4.</span> <span class="nav-text">processComponent</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mountComponent"><span class="nav-number">5.5.</span> <span class="nav-text">mountComponent</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#createComponentInstance"><span class="nav-number">5.5.1.</span> <span class="nav-text">createComponentInstance</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#setupComponent"><span class="nav-number">5.5.2.</span> <span class="nav-text">setupComponent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#setupStatefulComponent"><span class="nav-number">5.5.3.</span> <span class="nav-text">setupStatefulComponent</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#setupResult"><span class="nav-number">5.5.3.1.</span> <span class="nav-text">setupResult</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#handleSetupResult"><span class="nav-number">5.5.3.2.</span> <span class="nav-text">handleSetupResult</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#finishComponentSetup"><span class="nav-number">5.5.3.3.</span> <span class="nav-text">finishComponentSetup</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#compile"><span class="nav-number">5.5.3.3.1.</span> <span class="nav-text">[compile]</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#compileToFunction"><span class="nav-number">5.5.3.3.2.</span> <span class="nav-text">compileToFunction</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#compile-1"><span class="nav-number">5.5.3.3.3.</span> <span class="nav-text">compile</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#baseCompile"><span class="nav-number">5.5.3.3.4.</span> <span class="nav-text">baseCompile</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#baseParse"><span class="nav-number">5.5.3.3.4.1.</span> <span class="nav-text">baseParse</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#transform"><span class="nav-number">5.5.3.3.4.2.</span> <span class="nav-text">transform</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#generate"><span class="nav-number">5.5.3.3.4.3.</span> <span class="nav-text">generate</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#setupRenderEffect"><span class="nav-number">5.5.4.</span> <span class="nav-text">setupRenderEffect</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#update-effect-run"><span class="nav-number">5.5.4.1.</span> <span class="nav-text">update() == effect.run()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#componentUpdateFn"><span class="nav-number">5.5.4.2.</span> <span class="nav-text">componentUpdateFn</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#renderComponentRoot"><span class="nav-number">5.5.4.2.1.</span> <span class="nav-text">renderComponentRoot</span></a></li></ol></li></ol></li></ol></li></ol></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">HOME</a>
  
    <a href="/blog/archives" class="mobile-nav-link">ARCHIVES</a>
  
    <a href="/blog/categories" class="mobile-nav-link">CATEGORIES</a>
  
    <a href="/blog/about" class="mobile-nav-link">ABOUT</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2025 Arginsen&#39;s Blog All Rights Reserved.
      </div>
      <div class="site-credit">
        ID  <a href="https://lixupeng.cn" target="_blank">Arginsen</a>
      </div>
      <br>
      <div class="busuanzi-analytics">
        
        <span id="busuanzi_container_site_pv">
          æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
        </span>
        <span class="post-meta-divider">|</span>
        <!-- <span id="busuanzi_container_site_uv">
          æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äºº
        </span> -->
        <span class="post-count">å…¨ç«™å…± 340.7k å­—</span>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        
      </div>
  </div> 
</footer>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>
<script src="/blog/js/bootstrap.js"></script>
<script src="/blog/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>


<script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?bb74e3da22205cadfa4f6e0a31a76ac4";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
</script>
    


  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/blog/js/totop.js" async=""></script>
</body>
</html>
