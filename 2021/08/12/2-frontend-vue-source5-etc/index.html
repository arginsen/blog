<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta name="google-site-verification" content="OcsZXBpQqAp8163-20wn3epncmCv_UBtqBLZmspy-NA">
  
  <title>ğŸ”¥ å‰ç«¯ | Vue2 åˆå§‹åŒ–æµç¨‹ - è¡¥å……ï¼šå…¶ä»–åŠŸèƒ½çš„å®ç° | Arginsen&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="FrontendVue">
  
  
  
  
  <meta name="keywords" content="Frontend,Vue">
<meta property="og:type" content="article">
<meta property="og:title" content="ğŸ”¥ å‰ç«¯ | Vue2 åˆå§‹åŒ–æµç¨‹ - è¡¥å……ï¼šå…¶ä»–åŠŸèƒ½çš„å®ç°">
<meta property="og:url" content="https://lixupeng.cn/blog/2021/08/12/2-frontend-vue-source5-etc/index.html">
<meta property="og:site_name" content="Arginsen&#39;s Blog">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://lixupeng.cn/blog/img/vue.jpg">
<meta property="og:updated_time" content="2025-07-31T17:48:48.729Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ğŸ”¥ å‰ç«¯ | Vue2 åˆå§‹åŒ–æµç¨‹ - è¡¥å……ï¼šå…¶ä»–åŠŸèƒ½çš„å®ç°">
<meta name="twitter:image" content="https://lixupeng.cn/blog/img/vue.jpg">
  
    <link rel="alternate" href="/atom.xml" title="Arginsen&#39;s Blog" type="application/atom+xml">
  
  <link rel="icon" href="/blog/css/images/favicon.ico">
  
    <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="https://fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/blog/css/style.css">

  <script src="/blog/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/blog/css/bootstrap.css">
  <link rel="stylesheet" href="/blog/css/fashion.css">
  <link rel="stylesheet" href="/blog/css/glyphs.css">

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  



<header id="allheader" class="site-header" role="banner" 
   >
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/blog/" title="Arginsen&#39;s Blog" rel="home"> Arginsen&#39;s Blog </a>
            
          </h1>
          
          
            <div class="site-description">smells like teen spirit</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows"  style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/">é¦–é¡µ</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/archives">å½’æ¡£</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/categories">åˆ†ç±»</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/about">å…³äº</a> </li>
                    
              </ul>
            </div>
          </nav>
      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-2-frontend-vue-source5-etc" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="/blog/img/vue.jpg" rel="gallery_cmeclz8n000ugmtpunrvsionv">
        <img src="/blog/img/vue.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      ğŸ”¥ å‰ç«¯ | Vue2 åˆå§‹åŒ–æµç¨‹ - è¡¥å……ï¼šå…¶ä»–åŠŸèƒ½çš„å®ç°
    </h1>
  

      </header>
    

    <div class="article-entry" itemprop="articleBody">
      
        <p><br><br><a id="more"></a></p>
<h1 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h1><p>hmtl</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- v-if --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"switchShow"</span>&gt;</span>å¼€å…³<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"show"</span>&gt;</span>$[ show ? 'bad ass' : 'motherfucker' ]<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- v-for --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">"food in foodList"</span> <span class="attr">:key</span>=<span class="string">"food.name"</span>&gt;</span>$[food.name]ï¼šï¿¥ $[food.price]<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- v-model --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">v-model</span>=<span class="string">"text"</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- v-bind &amp; event --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">:class</span>=<span class="string">"bindClass"</span> @<span class="attr">click</span>=<span class="string">"update"</span>&gt;</span>$[sum]<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  delimiters: [<span class="string">'$['</span>, <span class="string">']'</span>],</span><br><span class="line">  watch: &#123;</span><br><span class="line">    sum(val) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'the newVal of sum is'</span> + val)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      bindClass: <span class="string">'date'</span>,</span><br><span class="line">      base: <span class="number">10</span>,</span><br><span class="line">      arr: [<span class="string">'num1'</span>, &#123;<span class="string">'num2'</span>: <span class="number">2</span>&#125;, [<span class="string">'num3'</span>, <span class="number">3</span>]],</span><br><span class="line">      show: <span class="literal">true</span>,</span><br><span class="line">      foodList: [&#123;</span><br><span class="line">          name: <span class="string">'è‘±'</span>,</span><br><span class="line">          price: <span class="string">'10'</span>,</span><br><span class="line">          discount: <span class="number">.8</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">'å§œ'</span>,</span><br><span class="line">          price: <span class="string">'8'</span>,</span><br><span class="line">          discount: <span class="number">.6</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">'è’œ'</span>,</span><br><span class="line">          price: <span class="string">'8'</span>,</span><br><span class="line">          discount: <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      logo: <span class="string">'æŸ¥è¯¢èœå•'</span>,</span><br><span class="line">      text: <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  computed: &#123;</span><br><span class="line">    sum() &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.base * <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    update() &#123;</span><br><span class="line">      <span class="keyword">this</span>.base += <span class="number">10</span></span><br><span class="line">    &#125;,</span><br><span class="line">    switchShow() &#123;</span><br><span class="line">      <span class="keyword">this</span>.show = !<span class="keyword">this</span>.show</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.show ? <span class="string">'æ‰“å¼€é¢æ¿'</span> : <span class="string">'å…³é—­é¢æ¿'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>åœ¨ compile é˜¶æ®µï¼ŒcompileToFunctions -&gt; baseCompile -&gt; compile -&gt; parse è¿›è¡Œè§£æ html, ç”Ÿæˆ AST æ ‘ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼ŒcompileToFunctions å‡½æ•°æ˜¯ createCompilerCreator(baseCompile) è¿”å›çš„ CreateCompiler(baseOptions) æ‰§è¡Œè¿”å›çš„å¯¹è±¡ { complie, createCompileToFunctionFn(compile) } ä¸­æå–çš„ï¼›</p>
<p>è€Œ createCompileToFunctionFn(compile) ä¸­ç”± compile(template, options) è¿›è¡Œç¼–è¯‘ï¼Œcompile ä¸­è°ƒç”¨ baseCompile(template, finalOptions) æ‰§è¡Œå…³é”®æ­¥éª¤ï¼šparse, optimize, generate å¾—åˆ°æœ€åçš„ render å‡½æ•°</p>
<h2 id="parse"><a href="#parse" class="headerlink" title="parse"></a>parse</h2><p>parse å®Œæˆå, æˆ‘ä»¬çš„ AST æ ‘å¦‚ä¸‹, å…¶å®é€»è¾‘ä¹Ÿå¾ˆæ¸…æ™°, è¿™ä¸ªé˜¶æ®µå®Œæˆçš„ä¹Ÿæ˜¯åŸºæœ¬çš„å‡†å¤‡å·¥ä½œï¼Œå°†èŠ‚ç‚¹æŒ‰çˆ¶å­çº§æ’åˆ—å‡ºæ¥, æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰è‡ªå·±å¯¹åº”çš„ attrsListã€attrsMapã€endã€parentã€plainã€rawAttrsMapã€startã€tagã€type , è¡¨ç¤ºå½“å‰èŠ‚ç‚¹çš„ä¸€äº›åŸºæœ¬å†…å®¹ï¼Œå±æ€§ä¹Ÿåªæ˜¯ä½œä»¥è¯»å–å‚¨å­˜ã€‚</p>
<p>å¯¹äº vue ç‰¹å®šçš„ä¸€äº›å±æ€§æŒ‡ä»¤ä½œä»¥ç‰¹æ®Šå¤„ç†, ä»¥ v- : @ å¼€å¤´çš„å±æ€§å‡ä¼šæ·»åŠ  <code>hasBindings: true</code> å±æ€§; å¯¹äºè®¡ç®—å±æ€§, ä¼šæ·»åŠ  classBinding; å¯¹äºäº‹ä»¶, ä¼šæ·»åŠ  events å±æ€§æè¿°; å¯¹äº v-if æŒ‡ä»¤, ä¼šæ·»åŠ  if, ifConditions å±æ€§; å¯¹äº v-for , ä¼šæ·»åŠ  for key æ¥æè¿°; å¯¹äº v-model , ä¼šæ·»åŠ  directives æ¥æè¿°æŒ‡ä»¤</p>
<p>å…¶å® parse é˜¶æ®µä¹Ÿå°±æ˜¯è§£ææˆ‘ä»¬å†™çš„ html ä¸ºä¸€ä¸ª Abstract Syntax Tree, å°†å†™çš„ä¸€å †çš„ä¸œè¥¿æŒ‰åµŒå¥—å±‚ä½œä»¥å½’çº³.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">ast: &#123;</span><br><span class="line">  attrs: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="number">0</span>: &#123;<span class="attr">name</span>: <span class="string">"id"</span>, <span class="attr">value</span>: <span class="string">"\"app\""</span>, <span class="attr">dynamic</span>: <span class="literal">undefined</span>, <span class="attr">start</span>: <span class="number">5</span>, <span class="attr">end</span>: <span class="number">13</span>&#125;</span><br><span class="line">  attrsList: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="number">0</span>: &#123;<span class="attr">name</span>: <span class="string">"id"</span>, <span class="attr">value</span>: <span class="string">"app"</span>, <span class="attr">start</span>: <span class="number">5</span>, <span class="attr">end</span>: <span class="number">13</span>&#125;</span><br><span class="line">  attrsMap: &#123;<span class="attr">id</span>: <span class="string">"app"</span>&#125;</span><br><span class="line">  children: <span class="built_in">Array</span>(<span class="number">9</span>)</span><br><span class="line">    <span class="number">0</span>: &#123;</span><br><span class="line">      attrsList: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">        <span class="number">0</span>: &#123;<span class="attr">name</span>: <span class="string">"@click"</span>, <span class="attr">value</span>: <span class="string">"switchShow"</span>, <span class="attr">start</span>: <span class="number">53</span>, <span class="attr">end</span>: <span class="number">72</span>&#125;</span><br><span class="line">      attrsMap: &#123;@click: <span class="string">"switchShow"</span>&#125;</span><br><span class="line">        <span class="number">0</span>: &#123;<span class="attr">type</span>: <span class="number">3</span>, <span class="attr">text</span>: <span class="string">"å¼€å…³"</span>, <span class="attr">start</span>: <span class="number">73</span>, <span class="attr">end</span>: <span class="number">75</span>&#125;</span><br><span class="line">      end: <span class="number">84</span></span><br><span class="line">      events:</span><br><span class="line">        click: &#123;<span class="attr">value</span>: <span class="string">"switchShow"</span>, <span class="attr">dynamic</span>: <span class="literal">false</span>, <span class="attr">start</span>: <span class="number">53</span>, <span class="attr">end</span>: <span class="number">72</span>&#125;</span><br><span class="line">      hasBindings: <span class="literal">true</span></span><br><span class="line">      parent: &#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">"div"</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">attrsMap</span>: &#123;â€¦&#125;, <span class="attr">rawAttrsMap</span>: &#123;â€¦&#125;, â€¦&#125;</span><br><span class="line">      plain: <span class="literal">false</span></span><br><span class="line">      rawAttrsMap: &#123;@click: &#123;â€¦&#125;&#125;</span><br><span class="line">      start: <span class="number">45</span></span><br><span class="line">      tag: <span class="string">"button"</span></span><br><span class="line">      type: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="number">1</span>: &#123;<span class="attr">type</span>: <span class="number">3</span>, <span class="attr">text</span>: <span class="string">" "</span>, <span class="attr">start</span>: <span class="number">84</span>, <span class="attr">end</span>: <span class="number">93</span>&#125;</span><br><span class="line">    <span class="number">2</span>: &#123;</span><br><span class="line">      attrsList: <span class="built_in">Array</span>(<span class="number">0</span>)</span><br><span class="line">      length: <span class="number">0</span></span><br><span class="line">      attrsMap: &#123;v-<span class="keyword">if</span>: <span class="string">"show"</span>&#125;</span><br><span class="line">      children: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">        <span class="number">0</span>: &#123;<span class="attr">type</span>: <span class="number">2</span>, <span class="attr">expression</span>: <span class="string">"_s(show ? 'bad ass' : 'motherfucker')"</span>, <span class="attr">tokens</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">text</span>: <span class="string">"$[ show ? 'bad ass' : 'motherfucker' ]"</span>, <span class="attr">start</span>: <span class="number">110</span>, â€¦&#125;</span><br><span class="line">      end: <span class="number">154</span></span><br><span class="line">      <span class="keyword">if</span>: <span class="string">"show"</span></span><br><span class="line">      ifConditions: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">        <span class="number">0</span>: &#123;<span class="attr">exp</span>: <span class="string">"show"</span>, <span class="attr">block</span>: &#123;â€¦&#125;&#125;</span><br><span class="line">      parent: &#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">"div"</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">attrsMap</span>: &#123;â€¦&#125;, <span class="attr">rawAttrsMap</span>: &#123;â€¦&#125;, â€¦&#125;</span><br><span class="line">      plain: <span class="literal">true</span></span><br><span class="line">      rawAttrsMap: &#123;v-<span class="keyword">if</span>: &#123;â€¦&#125;&#125;</span><br><span class="line">      start: <span class="number">93</span></span><br><span class="line">      tag: <span class="string">"div"</span></span><br><span class="line">      type: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="number">3</span>: &#123;<span class="attr">type</span>: <span class="number">3</span>, <span class="attr">text</span>: <span class="string">" "</span>, <span class="attr">start</span>: <span class="number">154</span>, <span class="attr">end</span>: <span class="number">163</span>&#125;</span><br><span class="line">  <span class="number">4</span>: &#123;</span><br><span class="line">    attrsList: []</span><br><span class="line">    attrsMap: &#123;&#125;</span><br><span class="line">    children: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">      <span class="number">0</span>: &#123;</span><br><span class="line">        alias: <span class="string">"food"</span></span><br><span class="line">        attrsList: []</span><br><span class="line">        attrsMap: &#123;v-<span class="keyword">for</span>: <span class="string">"food in foodList"</span>, :key: <span class="string">"food.name"</span>&#125;</span><br><span class="line">        children: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">          <span class="number">0</span>: &#123;<span class="attr">type</span>: <span class="number">2</span>, <span class="attr">expression</span>: <span class="string">"_s(food.name)+\"ï¼šï¿¥ \"+_s(food.price)"</span>, <span class="attr">tokens</span>: <span class="built_in">Array</span>(<span class="number">3</span>), <span class="attr">text</span>: <span class="string">"$[food.name]ï¼šï¿¥ $[food.price]"</span>, <span class="attr">start</span>: <span class="number">249</span>, â€¦&#125;</span><br><span class="line">        end: <span class="number">282</span></span><br><span class="line">        <span class="keyword">for</span>: <span class="string">"foodList"</span></span><br><span class="line">        key: <span class="string">"food.name"</span></span><br><span class="line">        parent: &#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">"ul"</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">0</span>), <span class="attr">attrsMap</span>: &#123;â€¦&#125;, <span class="attr">rawAttrsMap</span>: &#123;â€¦&#125;, â€¦&#125;</span><br><span class="line">        plain: <span class="literal">false</span></span><br><span class="line">        rawAttrsMap: &#123;v-<span class="keyword">for</span>: &#123;â€¦&#125;, :key: &#123;â€¦&#125;&#125;</span><br><span class="line">        start: <span class="number">203</span></span><br><span class="line">        tag: <span class="string">"li"</span></span><br><span class="line">        type: <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    end: <span class="number">296</span></span><br><span class="line">    parent: &#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">"div"</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">attrsMap</span>: &#123;â€¦&#125;, <span class="attr">rawAttrsMap</span>: &#123;â€¦&#125;, â€¦&#125;</span><br><span class="line">    plain: <span class="literal">true</span></span><br><span class="line">    rawAttrsMap: &#123;&#125;</span><br><span class="line">    start: <span class="number">186</span></span><br><span class="line">    tag: <span class="string">"ul"</span></span><br><span class="line">    type: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="number">5</span>: &#123;<span class="attr">type</span>: <span class="number">3</span>, <span class="attr">text</span>: <span class="string">" "</span>, <span class="attr">start</span>: <span class="number">296</span>, <span class="attr">end</span>: <span class="number">305</span>&#125;</span><br><span class="line">  <span class="number">6</span>: &#123;</span><br><span class="line">    attrsList: []</span><br><span class="line">    attrsMap: &#123;&#125;</span><br><span class="line">    children: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">      <span class="number">0</span>: &#123;</span><br><span class="line">        attrsList: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">          <span class="number">0</span>: &#123;<span class="attr">name</span>: <span class="string">"v-model"</span>, <span class="attr">value</span>: <span class="string">"text"</span>, <span class="attr">start</span>: <span class="number">342</span>, <span class="attr">end</span>: <span class="number">356</span>&#125;</span><br><span class="line">        length: <span class="number">1</span></span><br><span class="line">        attrsMap: &#123;v-model: <span class="string">"text"</span>&#125;</span><br><span class="line">        children: []</span><br><span class="line">        directives: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">          <span class="number">0</span>: &#123;<span class="attr">name</span>: <span class="string">"model"</span>, <span class="attr">rawName</span>: <span class="string">"v-model"</span>, <span class="attr">value</span>: <span class="string">"text"</span>, <span class="attr">arg</span>: <span class="literal">null</span>, <span class="attr">isDynamicArg</span>: <span class="literal">false</span>, â€¦&#125;</span><br><span class="line">        length: <span class="number">1</span></span><br><span class="line">        end: <span class="number">357</span></span><br><span class="line">        hasBindings: <span class="literal">true</span></span><br><span class="line">        parent: &#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">"div"</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">0</span>), <span class="attr">attrsMap</span>: &#123;â€¦&#125;, <span class="attr">rawAttrsMap</span>: &#123;â€¦&#125;, â€¦&#125;</span><br><span class="line">        plain: <span class="literal">false</span></span><br><span class="line">        rawAttrsMap: &#123;v-model: &#123;â€¦&#125;&#125;</span><br><span class="line">        start: <span class="number">335</span></span><br><span class="line">        tag: <span class="string">"input"</span></span><br><span class="line">        type: <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    end: <span class="number">363</span></span><br><span class="line">    parent: &#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">"div"</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">attrsMap</span>: &#123;â€¦&#125;, <span class="attr">rawAttrsMap</span>: &#123;â€¦&#125;, â€¦&#125;</span><br><span class="line">    plain: <span class="literal">true</span></span><br><span class="line">    rawAttrsMap: &#123;&#125;</span><br><span class="line">    start: <span class="number">330</span></span><br><span class="line">    tag: <span class="string">"div"</span></span><br><span class="line">    type: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="number">7</span>: &#123;<span class="attr">type</span>: <span class="number">3</span>, <span class="attr">text</span>: <span class="string">" "</span>, <span class="attr">start</span>: <span class="number">363</span>, <span class="attr">end</span>: <span class="number">372</span>&#125;</span><br><span class="line">  <span class="number">8</span>: &#123;</span><br><span class="line">    attrsList: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">      <span class="number">0</span>: &#123;<span class="attr">name</span>: <span class="string">"@click"</span>, <span class="attr">value</span>: <span class="string">"update"</span>, <span class="attr">start</span>: <span class="number">428</span>, <span class="attr">end</span>: <span class="number">443</span>&#125;</span><br><span class="line">    attrsMap: &#123;:class: "bindClass", @click: "update"&#125;</span><br><span class="line">    children: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">      <span class="number">0</span>: &#123;<span class="attr">type</span>: <span class="number">2</span>, <span class="attr">expression</span>: <span class="string">"_s(sum)"</span>, <span class="attr">tokens</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">text</span>: <span class="string">"$[sum]"</span>, <span class="attr">start</span>: <span class="number">444</span>, â€¦&#125;</span><br><span class="line">    classBinding: <span class="string">"bindClass"</span></span><br><span class="line">    end: <span class="number">456</span></span><br><span class="line">    events:</span><br><span class="line">      click: &#123;<span class="attr">value</span>: <span class="string">"update"</span>, <span class="attr">dynamic</span>: <span class="literal">false</span>, <span class="attr">start</span>: <span class="number">428</span>, <span class="attr">end</span>: <span class="number">443</span>&#125;</span><br><span class="line">    hasBindings: <span class="literal">true</span></span><br><span class="line">    parent: &#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">"div"</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">attrsMap</span>: &#123;â€¦&#125;, <span class="attr">rawAttrsMap</span>: &#123;â€¦&#125;, â€¦&#125;</span><br><span class="line">    plain: <span class="literal">false</span></span><br><span class="line">    rawAttrsMap: &#123;:class: &#123;â€¦&#125;, @click: &#123;â€¦&#125;&#125;</span><br><span class="line">    start: <span class="number">404</span></span><br><span class="line">    tag: <span class="string">"div"</span></span><br><span class="line">    type: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  length: <span class="number">9</span></span><br><span class="line">  end: <span class="number">467</span></span><br><span class="line">  parent: <span class="literal">undefined</span></span><br><span class="line">  plain: <span class="literal">false</span></span><br><span class="line">  rawAttrsMap: &#123;<span class="attr">id</span>: &#123;â€¦&#125;&#125;</span><br><span class="line">  start: <span class="number">0</span></span><br><span class="line">  tag: <span class="string">"div"</span></span><br><span class="line">  type: <span class="number">1</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="generate"><a href="#generate" class="headerlink" title="generate"></a>generate</h2><p>å°†ä¸Šè¾¹çš„ AST è½¬æ¢ä¸ºä»£ç </p>
<p>ä»æ ¹èŠ‚ç‚¹å¼€å§‹, genElement, åœ¨å…¶å†…ä¼šåˆ¤æ–­èŠ‚ç‚¹ä¸Šæ˜¯å¦æœ‰å„ç±»å±æ€§, æ ¹èŠ‚ç‚¹å°±ä¸€ä¸ª id, æ‰€ä»¥ä¼šè¿›å…¥ genAttrs -&gt; genProps, æ¥ç€åˆ¤æ–­å±æ€§æ˜¯åŠ¨æ€è¿˜æ˜¯é™æ€, è¿™é‡Œçš„ id å°±ç›´æ¥å†™å…¥ <code>&quot;${prop.name}&quot;:${value},</code>, ä»¥æ­¤å°±è·å¾—äº†æ ¹èŠ‚ç‚¹çš„ä»£ç ; </p>
<p>æ¥ç€ä¼šè¯»å–æ ¹èŠ‚ç‚¹ä¸‹ children, ä½¿ç”¨ genChildren ç”Ÿæˆå­èŠ‚ç‚¹çš„ä»£ç , åœ¨å…¶å†…ç”¨ map éå† children, æ¯ä¸ª child éƒ½ä½¿ç”¨ genNode æ¥åˆ›å»ºä»£ç ; æ ¹æ®å½“å‰èŠ‚ç‚¹çš„ç±»å‹, çœ‹æ˜¯å…ƒç´ èŠ‚ç‚¹1, è¿˜æ˜¯æ³¨é‡ŠèŠ‚ç‚¹2, æˆ–è€…æ˜¯æ–‡æœ¬èŠ‚ç‚¹3, åˆ†åˆ«é‡‡ç”¨ genElement genComment genText æ¥åˆ›å»ºå¯¹åº”çš„ä»£ç , æœ€åå†æ‹¼æ¥åœ¨ä¸€èµ·.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'with(this)&#123;return _c('</span>div<span class="string">',&#123;attrs:&#123;"id":"app"&#125;&#125;,[_c('</span>button<span class="string">',&#123;on:&#123;"click":switchShow&#125;&#125;,[_v("å¼€å…³")]),_v(" "),(show)?_c('</span>div<span class="string">',[_v(_s(show ? '</span>bad ass<span class="string">' : '</span>motherfucker<span class="string">'))]):_e(),_v(" "),_c('</span>ul<span class="string">',_l((foodList),function(food)&#123;return _c('</span>li<span class="string">',&#123;key:food.name&#125;,[_v(_s(food.name)+"ï¼šï¿¥ "+_s(food.price))])&#125;),0),_v(" "),_c('</span>div<span class="string">',[_c('</span>input<span class="string">',&#123;directives:[&#123;name:"model",rawName:"v-model",value:(text),expression:"text"&#125;],domProps:&#123;"value":(text)&#125;,on:&#123;"input":function($event)&#123;if($event.target.composing)return;text=$event.target.value&#125;&#125;&#125;)]),_v(" "),_c('</span>div<span class="string">',&#123;class:bindClass,on:&#123;"click":update&#125;&#125;,[_v(_s(sum))])])&#125;'</span></span><br></pre></td></tr></table></figure>
<p>ç»§ç»­å°†ä»£ç è½¬æˆ render å‡½æ•°è¿”å›, ä¹Ÿæ˜¯æ¶‰åŠ _c, _v, _e, _l, _s ç­‰å·¥ä½œ, åœ¨ä¹‹åæ‰§è¡Œåˆ° updateComponent æ—¶, è°ƒç”¨ render å‡½æ•°æ‰§è¡Œä»£ç ç”Ÿæˆ VNode</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Æ’ anonymous(</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">with</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> _c(<span class="string">'div'</span>,&#123;</span><br><span class="line">      attrs:&#123;<span class="string">"id"</span>:<span class="string">"app"</span>&#125;&#125;,[</span><br><span class="line">        _c(<span class="string">'button'</span>,&#123;<span class="attr">on</span>:&#123;<span class="string">"click"</span>:switchShow&#125;&#125;,[_v(<span class="string">"å¼€å…³"</span>)]), <span class="comment">// event</span></span><br><span class="line">        _v(<span class="string">" "</span>),</span><br><span class="line">        (show)?_c(<span class="string">'div'</span>,[_v(_s(show ? <span class="string">'bad ass'</span> : <span class="string">'motherfucker'</span>))]):_e(), <span class="comment">// v-if</span></span><br><span class="line">        _v(<span class="string">" "</span>),</span><br><span class="line">        _c(<span class="string">'ul'</span>,_l((foodList),<span class="function"><span class="keyword">function</span>(<span class="params">food</span>)</span>&#123;</span><br><span class="line">          <span class="keyword">return</span> _c(<span class="string">'li'</span>,&#123;<span class="attr">key</span>:food.name&#125;,[</span><br><span class="line">            _v(_s(food.name)+<span class="string">"ï¼šï¿¥ "</span>+_s(food.price))</span><br><span class="line">          ])</span><br><span class="line">        &#125;),<span class="number">0</span>), <span class="comment">// v-for</span></span><br><span class="line">        _v(<span class="string">" "</span>),</span><br><span class="line">        _c(<span class="string">'div'</span>,[_c(<span class="string">'input'</span>,&#123;</span><br><span class="line">          directives:[&#123;<span class="attr">name</span>:<span class="string">"model"</span>,<span class="attr">rawName</span>:<span class="string">"v-model"</span>,<span class="attr">value</span>:(text),<span class="attr">expression</span>:<span class="string">"text"</span>&#125;],</span><br><span class="line">          domProps:&#123;<span class="string">"value"</span>:(text)&#125;,</span><br><span class="line">          on:&#123;</span><br><span class="line">            <span class="string">"input"</span>:<span class="function"><span class="keyword">function</span>(<span class="params">$event</span>)</span>&#123;<span class="keyword">if</span>($event.target.composing)<span class="keyword">return</span>;text=$event.target.value&#125;</span><br><span class="line">          &#125;&#125;)]</span><br><span class="line">        ), <span class="comment">// v-model</span></span><br><span class="line">        _v(<span class="string">" "</span>),</span><br><span class="line">        _c(<span class="string">'div'</span>,&#123;<span class="attr">class</span>:bindClass,<span class="attr">on</span>:&#123;<span class="string">"click"</span>:update&#125;&#125;,[_v(_s(sum))])])&#125; <span class="comment">// v-bind &amp; event</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="render"><a href="#render" class="headerlink" title="render"></a>render</h2><p>å› ä¸º with(this) çš„ä½œç”¨, å°†å½“å‰ä»£ç å—å¤„äº vm._renderProxy ä½œç”¨åŸŸä¸‹, è¿™æ—¶è¯»å–ä»£ç å—ä¸­çš„å˜é‡å°±ä¼šåœ¨è¯¥ä½œç”¨åŸŸä¸‹è¿›è¡ŒæŸ¥æ‰¾, è€Œ vm åšäº†ä»£ç†, ä¼šä½¿å¾—åœ¨è·å–å˜é‡(ä¹Ÿå°±æ˜¯ vm ä¸‹çš„å±æ€§) æ—¶ä¼šè§¦å‘ hasHandler è¿›è¡Œæ£€æµ‹ vm å½“å‰æ˜¯å¦æœ‰è¿™ä¸ªå±æ€§;</p>
<p>ä»æ ¹èŠ‚ç‚¹çš„ children å¼€å§‹, ä¾æ¬¡å°† child è™šæ‹ŸèŠ‚ç‚¹åŒ–; ä»å¤–åˆ°é‡Œè·å–å˜é‡, ä»é‡Œåˆ°å¤–æ‰§è¡Œå‡½æ•°, æ¯”å¦‚ç¬¬ä¸€ä¸ª child, å°±æ˜¯å…ˆè·å– _c(ä¹‹å‰è¿˜ä¼šè·å–ä¸€æ¬¡æ ¹çš„), switchShow, _v; ç„¶åæ¥ç€ä» _v æ‰§è¡Œ, åˆ›å»ºè™šæ‹Ÿæ–‡æœ¬èŠ‚ç‚¹, æ¥ç€æ‰§è¡Œ _c, åˆ›å»ºå…ƒç´ èŠ‚ç‚¹</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬ä¸€æ®µ äº‹ä»¶</span></span><br><span class="line">_c(<span class="string">'button'</span>,&#123;<span class="attr">on</span>:&#123;<span class="string">"click"</span>:switchShow&#125;&#125;,[_v(<span class="string">"å¼€å…³"</span>)])</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬ä¸‰æ®µ v-if</span></span><br><span class="line">(show)?_c(<span class="string">'div'</span>,[_v(_s(show ? <span class="string">'bad ass'</span> : <span class="string">'motherfucker'</span>))]):_e()</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬äº”æ®µ v-for</span></span><br><span class="line">_c(<span class="string">'ul'</span>,_l((foodList),<span class="function"><span class="keyword">function</span>(<span class="params">food</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> _c(<span class="string">'li'</span>,&#123;<span class="attr">key</span>:food.name&#125;,[</span><br><span class="line">    _v(_s(food.name)+<span class="string">"ï¼šï¿¥ "</span>+_s(food.price))</span><br><span class="line">  ])</span><br><span class="line">&#125;),<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬ä¸ƒæ®µ v-model</span></span><br><span class="line">_c(<span class="string">'div'</span>,[_c(<span class="string">'input'</span>,&#123;</span><br><span class="line">  directives:[&#123;<span class="attr">name</span>:<span class="string">"model"</span>,<span class="attr">rawName</span>:<span class="string">"v-model"</span>,<span class="attr">value</span>:(text),<span class="attr">expression</span>:<span class="string">"text"</span>&#125;],</span><br><span class="line">  domProps:&#123;<span class="string">"value"</span>:(text)&#125;,</span><br><span class="line">  on:&#123;</span><br><span class="line">    <span class="string">"input"</span>:<span class="function"><span class="keyword">function</span>(<span class="params">$event</span>)</span>&#123;<span class="keyword">if</span>($event.target.composing)<span class="keyword">return</span>;text=$event.target.value&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)])</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬ä¹æ®µ </span></span><br><span class="line">_c(<span class="string">'div'</span>,&#123;<span class="attr">class</span>:bindClass,<span class="attr">on</span>:&#123;<span class="string">"click"</span>:update&#125;&#125;,[_v(_s(sum))])])&#125;</span><br></pre></td></tr></table></figure>
<h2 id="update"><a href="#update" class="headerlink" title="update"></a>update</h2><p>ç»è¿‡ render å‡½æ•°, AST æ ‘ä¹Ÿå°±è½¬æ¢æˆäº† VNode</p>
<p>æ¥ä¸‹æ¥åˆ¤æ–­å½“å‰å®ä¾‹æ˜¯å¦å­˜åœ¨ prevVnode , å¦‚æ— åˆ™è¯´æ˜æ˜¯æ ¹èŠ‚ç‚¹æŒ‚è½½, æ‰§è¡Œ <code>__patch__</code> è¿›è¡Œæ‰“åŒ…, å°† VNode è½¬æˆ dom èŠ‚ç‚¹</p>
<p>åˆ¤æ–­ä¼ å…¥ patch çš„æ—§èŠ‚ç‚¹ç±»å‹, å¦‚æ˜¯çœŸå®èŠ‚ç‚¹åˆ™ä»¥æ—§èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºè™šæ‹ŸèŠ‚ç‚¹, ä¿ç•™çœŸå®çš„èŠ‚ç‚¹ä¸º elm å±æ€§; åŒæ—¶è®°æ—§èŠ‚ç‚¹çœŸå®èŠ‚ç‚¹ä¸º oldElm, å…¶çˆ¶çº§èŠ‚ç‚¹ä¸º parentElm; æ¥ç€ createElm å¯¹ vnode è¿›è¡Œåˆ›å»º dom èŠ‚ç‚¹</p>
<p>ç»™ vnode åˆ›å»ºçœŸå®èŠ‚ç‚¹ vnode.elm; æ¥ç€ç»™å…¶ children åˆ›å»ºèŠ‚ç‚¹; éå† children, å¯¹æ¯ä¸ªå­èŠ‚ç‚¹å‡è¿›è¡Œ createElm, å®Œæˆå±æ€§ç­‰ data ç»‘å®šè‡³æ–°èŠ‚ç‚¹ vnode.elm; æœ€åå°† children ä¹Ÿæ’å…¥åˆ°æ ¹ vnode.elm</p>
<p>æ¥ç€ removeVnodes æ¸…é™¤æ‰ oldVnode; ç„¶åæ‰§è¡Œ invokeInsertHook, å¯¹å¤„ç†æ‰§è¡Œæ—¶ ä¸ªåˆ«èŠ‚ç‚¹ data.hook.insert èµ‹å€¼çš„è¿›è¡Œ insert; è¿™é‡Œä¹Ÿå°±æ˜¯ç»™ input ç»§ç»­ç»‘å®šäº† compositionStart, change ç­‰æ–¹æ³•</p>
<p>æœ€åä»¤ <code>vm.$el.__vue__ = vm</code>; <code>vm._isMounted = true</code> ä½œä»¥æ ‡è®°, è‡³æ­¤æŒ‚è½½è¿‡ç¨‹èµ°å®Œ, æ‰§è¡Œ mounted é’©å­å‡½æ•°</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">vnode: VNode &#123;</span><br><span class="line">  asyncFactory: <span class="literal">undefined</span></span><br><span class="line">  asyncMeta: <span class="literal">undefined</span></span><br><span class="line">  children: <span class="built_in">Array</span>(<span class="number">9</span>)</span><br><span class="line">    <span class="number">0</span>: VNode &#123;<span class="attr">tag</span>: <span class="string">"button"</span>, <span class="attr">data</span>: &#123;â€¦&#125;, <span class="attr">children</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">text</span>: <span class="literal">undefined</span>, <span class="attr">elm</span>: <span class="literal">undefined</span>, â€¦&#125;</span><br><span class="line">    <span class="number">1</span>: VNode &#123;<span class="attr">tag</span>: <span class="literal">undefined</span>, <span class="attr">data</span>: <span class="literal">undefined</span>, <span class="attr">children</span>: <span class="literal">undefined</span>, <span class="attr">text</span>: <span class="string">" "</span>, <span class="attr">elm</span>: <span class="literal">undefined</span>, â€¦&#125;</span><br><span class="line">    <span class="number">2</span>: VNode &#123;<span class="attr">tag</span>: <span class="string">"div"</span>, <span class="attr">data</span>: <span class="literal">undefined</span>, <span class="attr">children</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">text</span>: <span class="literal">undefined</span>, <span class="attr">elm</span>: <span class="literal">undefined</span>, â€¦&#125;</span><br><span class="line">    <span class="number">3</span>: VNode &#123;<span class="attr">tag</span>: <span class="literal">undefined</span>, <span class="attr">data</span>: <span class="literal">undefined</span>, <span class="attr">children</span>: <span class="literal">undefined</span>, <span class="attr">text</span>: <span class="string">" "</span>, <span class="attr">elm</span>: <span class="literal">undefined</span>, â€¦&#125;</span><br><span class="line">    <span class="number">4</span>: VNode &#123;<span class="attr">tag</span>: <span class="string">"ul"</span>, <span class="attr">data</span>: <span class="literal">undefined</span>, <span class="attr">children</span>: <span class="built_in">Array</span>(<span class="number">3</span>), <span class="attr">text</span>: <span class="literal">undefined</span>, <span class="attr">elm</span>: <span class="literal">undefined</span>, â€¦&#125;</span><br><span class="line">    <span class="number">5</span>: VNode &#123;<span class="attr">tag</span>: <span class="literal">undefined</span>, <span class="attr">data</span>: <span class="literal">undefined</span>, <span class="attr">children</span>: <span class="literal">undefined</span>, <span class="attr">text</span>: <span class="string">" "</span>, <span class="attr">elm</span>: <span class="literal">undefined</span>, â€¦&#125;</span><br><span class="line">    <span class="number">6</span>: VNode &#123;<span class="attr">tag</span>: <span class="string">"div"</span>, <span class="attr">data</span>: <span class="literal">undefined</span>, <span class="attr">children</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">text</span>: <span class="literal">undefined</span>, <span class="attr">elm</span>: <span class="literal">undefined</span>, â€¦&#125;</span><br><span class="line">    <span class="number">7</span>: VNode &#123;<span class="attr">tag</span>: <span class="literal">undefined</span>, <span class="attr">data</span>: <span class="literal">undefined</span>, <span class="attr">children</span>: <span class="literal">undefined</span>, <span class="attr">text</span>: <span class="string">" "</span>, <span class="attr">elm</span>: <span class="literal">undefined</span>, â€¦&#125;</span><br><span class="line">    <span class="number">8</span>: VNode &#123;<span class="attr">tag</span>: <span class="string">"div"</span>, <span class="attr">data</span>: &#123;â€¦&#125;, <span class="attr">children</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">text</span>: <span class="literal">undefined</span>, <span class="attr">elm</span>: <span class="literal">undefined</span>, â€¦&#125;</span><br><span class="line">    length: <span class="number">9</span></span><br><span class="line">    [[Prototype]]: <span class="built_in">Array</span>(<span class="number">0</span>)</span><br><span class="line">  componentInstance: <span class="literal">undefined</span></span><br><span class="line">  componentOptions: <span class="literal">undefined</span></span><br><span class="line">  context: Vue &#123;<span class="attr">_uid</span>: <span class="number">0</span>, <span class="attr">_isVue</span>: <span class="literal">true</span>, <span class="attr">$options</span>: &#123;â€¦&#125;, <span class="attr">_renderProxy</span>: <span class="built_in">Proxy</span>, <span class="attr">_self</span>: Vue, â€¦&#125;</span><br><span class="line">  data: &#123;<span class="attr">attrs</span>: &#123;â€¦&#125;&#125;</span><br><span class="line">  elm: <span class="literal">undefined</span></span><br><span class="line">  fnContext: <span class="literal">undefined</span></span><br><span class="line">  fnOptions: <span class="literal">undefined</span></span><br><span class="line">  fnScopeId: <span class="literal">undefined</span></span><br><span class="line">  isAsyncPlaceholder: <span class="literal">false</span></span><br><span class="line">  isCloned: <span class="literal">false</span></span><br><span class="line">  isComment: <span class="literal">false</span></span><br><span class="line">  isOnce: <span class="literal">false</span></span><br><span class="line">  isRootInsert: <span class="literal">true</span></span><br><span class="line">  isStatic: <span class="literal">false</span></span><br><span class="line">  key: <span class="literal">undefined</span></span><br><span class="line">  ns: <span class="literal">undefined</span></span><br><span class="line">  parent: <span class="literal">undefined</span></span><br><span class="line">  raw: <span class="literal">false</span></span><br><span class="line">  tag: <span class="string">"div"</span></span><br><span class="line">  text: <span class="literal">undefined</span></span><br><span class="line">  child: <span class="literal">undefined</span></span><br><span class="line">  [[Prototype]]: <span class="built_in">Object</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="event"><a href="#event" class="headerlink" title="event"></a>event</h1><h2 id="processAttrs"><a href="#processAttrs" class="headerlink" title="processAttrs"></a>processAttrs</h2><p>åœ¨ç»è¿‡ processAttrs å¤„ç†åï¼Œv-on æˆ– @ ä¼šè¢«è¯»å–åˆ°ï¼Œæ¥ç€ç»™å½“å‰èŠ‚ç‚¹å±‚ AST åŠ å…¥ events å±æ€§, å¯¹ç‰¹æ®Šçš„å±æ€§ç»‘å®šä¹Ÿä¼šå¢åŠ  <code>hasBindings:true</code></p>
<p>å¦‚ä¸‹ï¼Œä¾‹å­ä¸­æ˜¯åœ¨ button ä¸ŠåŠ å…¥äº†ç‚¹å‡»äº‹ä»¶ switchShow</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  attrsList:(<span class="number">1</span>) [&#123;â€¦&#125;]</span><br><span class="line">  attrsMap:&#123;@click: <span class="string">'switchShow'</span>&#125;</span><br><span class="line">  children:(<span class="number">1</span>) [&#123;â€¦&#125;]</span><br><span class="line">  plain:<span class="literal">false</span></span><br><span class="line">  end:<span class="number">84</span></span><br><span class="line">  start:<span class="number">45</span></span><br><span class="line">  hasBindings:<span class="literal">true</span></span><br><span class="line">  parent:&#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">'div'</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">attrsMap</span>: &#123;â€¦&#125;, <span class="attr">rawAttrsMap</span>: &#123;â€¦&#125;, â€¦&#125;</span><br><span class="line">  events:&#123;<span class="attr">click</span>: &#123;â€¦&#125;&#125;</span><br><span class="line">    click:&#123;<span class="attr">value</span>: <span class="string">'switchShow'</span>, <span class="attr">dynamic</span>: <span class="literal">false</span>, <span class="attr">start</span>: <span class="number">53</span>, <span class="attr">end</span>: <span class="number">72</span>&#125;</span><br><span class="line">  rawAttrsMap:&#123;@click: &#123;â€¦&#125;&#125;</span><br><span class="line">    @click:&#123;<span class="attr">name</span>: <span class="string">'@click'</span>, <span class="attr">value</span>: <span class="string">'switchShow'</span>, <span class="attr">start</span>: <span class="number">53</span>, <span class="attr">end</span>: <span class="number">72</span>&#125;</span><br><span class="line">  tag:<span class="string">'button'</span></span><br><span class="line">  type:<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (onRE.test(name)) &#123; <span class="comment">// v-on</span></span><br><span class="line">  name = name.replace(onRE, <span class="string">''</span>)</span><br><span class="line">  isDynamic = dynamicArgRE.test(name)</span><br><span class="line">  <span class="keyword">if</span> (isDynamic) &#123;</span><br><span class="line">    name = name.slice(<span class="number">1</span>, <span class="number">-1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  addHandler(el, name, value, modifiers, <span class="literal">false</span>, warn, list[i], isDynamic)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="genElement"><a href="#genElement" class="headerlink" title="genElement"></a>genElement</h2><p>åœ¨ç”Ÿæˆäº‹ä»¶èŠ‚ç‚¹ä»£ç æ—¶, ä¸»è¦æ‰§è¡Œåˆ°ä»¥ä¸‹å‡½æ•°: genData genChildren</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!el.plain || (el.pre &amp;&amp; state.maybeComponent(el))) &#123;</span><br><span class="line">  data = genData(el, state)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> children = el.inlineTemplate ? <span class="literal">null</span> : genChildren(el, state, <span class="literal">true</span>)</span><br><span class="line">code = <span class="string">`_c('<span class="subst">$&#123;el.tag&#125;</span>'<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">  data ? <span class="string">`,<span class="subst">$&#123;data&#125;</span>`</span> : <span class="string">''</span> <span class="regexp">//</span> data</span></span></span><br><span class="line"><span class="string"><span class="subst">&#125;</span><span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">  children ? <span class="string">`,<span class="subst">$&#123;children&#125;</span>`</span> : <span class="string">''</span> <span class="regexp">//</span> children</span></span></span><br><span class="line"><span class="string"><span class="subst">&#125;</span>)`</span></span><br></pre></td></tr></table></figure>
<h2 id="genData"><a href="#genData" class="headerlink" title="genData"></a>genData</h2><p>äº‹ä»¶èŠ‚ç‚¹å­˜åœ¨ events, æ¥ç€æ‰§è¡Œ genHandlers</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (el.events) &#123;</span><br><span class="line">  data += <span class="string">`<span class="subst">$&#123;genHandlers(el.events, <span class="literal">false</span>)&#125;</span>,`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="genHandlers"><a href="#genHandlers" class="headerlink" title="genHandlers"></a>genHandlers</h2><p>éå† events, å¾—åˆ°äº‹ä»¶å¯¹åº”çš„æ–¹æ³•, æ‹¼æ¥åœ¨ä¸€èµ·, å†ç»™å‰è¾¹åŠ ä¸Š on: , å¦‚ä¾‹ä¸­æ˜¯ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ â€˜{on:{â€œclickâ€:switchShow},â€™</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">genHandlers</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  events: ASTElementHandlers,</span></span></span><br><span class="line"><span class="function"><span class="params">  isNative: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prefix = isNative ? <span class="string">'nativeOn:'</span> : <span class="string">'on:'</span></span><br><span class="line">  <span class="keyword">let</span> staticHandlers = <span class="string">``</span></span><br><span class="line">  <span class="keyword">let</span> dynamicHandlers = <span class="string">``</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> name <span class="keyword">in</span> events) &#123;</span><br><span class="line">    <span class="keyword">const</span> handlerCode = genHandler(events[name])</span><br><span class="line">    <span class="keyword">if</span> (events[name] &amp;&amp; events[name].dynamic) &#123;</span><br><span class="line">      dynamicHandlers += <span class="string">`<span class="subst">$&#123;name&#125;</span>,<span class="subst">$&#123;handlerCode&#125;</span>,`</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      staticHandlers += <span class="string">`"<span class="subst">$&#123;name&#125;</span>":<span class="subst">$&#123;handlerCode&#125;</span>,`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  staticHandlers = <span class="string">`&#123;<span class="subst">$&#123;staticHandlers.slice(<span class="number">0</span>, <span class="number">-1</span>)&#125;</span>&#125;`</span></span><br><span class="line">  <span class="keyword">if</span> (dynamicHandlers) &#123;</span><br><span class="line">    <span class="keyword">return</span> prefix + <span class="string">`_d(<span class="subst">$&#123;staticHandlers&#125;</span>,[<span class="subst">$&#123;dynamicHandlers.slice(<span class="number">0</span>, <span class="number">-1</span>)&#125;</span>])`</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> prefix + staticHandlers</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createElement"><a href="#createElement" class="headerlink" title="createElement"></a>createElement</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_c(<span class="string">'button'</span>,&#123;<span class="attr">on</span>:&#123;<span class="string">"click"</span>:switchShow&#125;&#125;,[_v(<span class="string">"å¼€å…³"</span>)])</span><br></pre></td></tr></table></figure>
<p>é’ˆå¯¹ä»¥ä¸Šä»£ç , _c å®é™…ä¸Šå°±æ˜¯ createElement æ–¹æ³•, åœ¨ç¬¬ä¸€ä½å‚æ•°ä¼ é€’äº† vm å, å‰©ä¸‹çš„å‚æ•°ç”±ä¸Šè¾¹ç”Ÿæˆçš„ä»£ç ä¼ å…¥, å› æ­¤ createElement æ–¹æ³•ç¬¬äºŒä½å‚æ•°å°±æ˜¯ tag æ ‡ç­¾; ç¬¬ä¸‰ä½æ˜¯ data, ä¹Ÿæ˜¯å½“å‰èŠ‚ç‚¹çš„å±æ€§; ç¬¬å››ä½æ˜¯ children, ä¹Ÿæ˜¯èŠ‚ç‚¹çš„å­èŠ‚ç‚¹, åœ¨æ­¤çš„ _v è¡¨ç¤ºè¿™ä¸ªå­èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹.</p>
<p>å½“å‰èŠ‚ç‚¹ tag ä¸º html å†…ç½®æ ‡ç­¾, é‚£ä¹ˆå°±è¿›è¡Œåˆ›å»ºå…ƒç´ èŠ‚ç‚¹ vnode, å°†è¿™ä¸€æ®µ _c ç”¨vnode æ›¿æ¢æ‰, å®Œæˆåè¿›å…¥ä¸‹ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹çš„åˆ›å»º</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  context: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  data: any, <span class="regexp">//</span> èŠ‚ç‚¹å¯¹åº”çš„å±æ€§æ•°æ®</span></span></span><br><span class="line"><span class="function"><span class="params">  children: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  normalizationType: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  alwaysNormalize: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">VNode</span> | <span class="title">Array</span>&lt;<span class="title">VNode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(data) || isPrimitive(data)) &#123;</span><br><span class="line">    normalizationType = children</span><br><span class="line">    children = data</span><br><span class="line">    data = <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isTrue(alwaysNormalize)) &#123;</span><br><span class="line">    normalizationType = ALWAYS_NORMALIZE</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> _createElement(context, tag, data, children, normalizationType)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">_createElement</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  context: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag?: string | Class&lt;Component&gt; | Function | Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  data?: VNodeData,</span></span></span><br><span class="line"><span class="function"><span class="params">  children?: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  normalizationType?: number</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">VNode</span> | <span class="title">Array</span>&lt;<span class="title">VNode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isDef(data) &amp;&amp; isDef((data: any).__ob__)) &#123;</span><br><span class="line">    process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warn(</span><br><span class="line">      <span class="string">`Avoid using observed data object as vnode data: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(data)&#125;</span>\n`</span> +</span><br><span class="line">      <span class="string">'Always create fresh vnode data objects in each render!'</span>,</span><br><span class="line">      context</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> createEmptyVNode()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// object syntax in v-bind</span></span><br><span class="line">  <span class="keyword">if</span> (isDef(data) &amp;&amp; isDef(data.is)) &#123;</span><br><span class="line">    tag = data.is</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!tag) &#123;</span><br><span class="line">    <span class="comment">// in case of component :is set to falsy value</span></span><br><span class="line">    <span class="keyword">return</span> createEmptyVNode()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// warn against non-primitive key</span></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">    isDef(data) &amp;&amp; isDef(data.key) &amp;&amp; !isPrimitive(data.key)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!__WEEX__ || !(<span class="string">'@binding'</span> <span class="keyword">in</span> data.key)) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">'Avoid using non-primitive value as key, '</span> +</span><br><span class="line">        <span class="string">'use string/number value instead.'</span>,</span><br><span class="line">        context</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// support single function children as default scoped slot</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(children) &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> children[<span class="number">0</span>] === <span class="string">'function'</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    data = data || &#123;&#125;</span><br><span class="line">    data.scopedSlots = &#123; <span class="attr">default</span>: children[<span class="number">0</span>] &#125;</span><br><span class="line">    children.length = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è§„èŒƒåŒ– children</span></span><br><span class="line">  <span class="keyword">if</span> (normalizationType === ALWAYS_NORMALIZE) &#123; <span class="comment">// æ ‡å‡†åŒ–-å…¬å…±ï¼Œ1.render å‡½æ•°æ˜¯ç”¨æˆ·æ‰‹å†™çš„ï¼›2.ç¼–è¯‘ slotã€v-for çš„æ—¶å€™ä¼šäº§ç”ŸåµŒå¥—æ•°ç»„çš„æƒ…å†µ</span></span><br><span class="line">    children = normalizeChildren(children)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (normalizationType === SIMPLE_NORMALIZE) &#123; <span class="comment">// ç®€æ˜“æ ‡å‡†åŒ–-å†…éƒ¨ï¼Œ render å‡½æ•°æ˜¯ç¼–è¯‘ç”Ÿæˆçš„</span></span><br><span class="line">    children = simpleNormalizeChildren(children)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆ›å»º VNode</span></span><br><span class="line">  <span class="keyword">let</span> vnode, ns</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> tag === <span class="string">'string'</span>) &#123; <span class="comment">// æ ‡ç­¾ä¸º string</span></span><br><span class="line">    <span class="keyword">let</span> Ctor</span><br><span class="line">    ns = (context.$vnode &amp;&amp; context.$vnode.ns) || config.getTagNamespace(tag)</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºå†…ç½®çš„ä¸€äº›èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (config.isReservedTag(tag)) &#123;</span><br><span class="line">      <span class="comment">// platform built-in elements</span></span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; isDef(data) &amp;&amp; isDef(data.nativeOn)) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`The .native modifier for v-on is only valid on components but it was used on &lt;<span class="subst">$&#123;tag&#125;</span>&gt;.`</span>,</span><br><span class="line">          context</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å¦‚ä¸ºå†…ç½®çš„èŠ‚ç‚¹ç±»å‹ï¼Œåˆ›å»ºä¸€ä¸ªæ™®é€š VNode</span></span><br><span class="line">      vnode = <span class="keyword">new</span> VNode(</span><br><span class="line">        config.parsePlatformTagName(tag), data, children,</span><br><span class="line">        <span class="literal">undefined</span>, <span class="literal">undefined</span>, context</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((!data || !data.pre) &amp;&amp; isDef(Ctor = resolveAsset(context.$options, <span class="string">'components'</span>, tag))) &#123;</span><br><span class="line">      <span class="comment">// å¦‚ä¸ºå·²æ³¨å†Œçš„ç»„ä»¶åï¼Œåˆ™é€šè¿‡ createComponent åˆ›å»ºä¸€ä¸ªç»„ä»¶ç±»å‹çš„ VNode</span></span><br><span class="line">      <span class="comment">// component</span></span><br><span class="line">      vnode = createComponent(Ctor, data, context, children, tag)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// åˆ›å»ºä¸€ä¸ªæœªçŸ¥çš„æ ‡ç­¾çš„ VNode</span></span><br><span class="line">      <span class="comment">// unknown or unlisted namespaced elements</span></span><br><span class="line">      <span class="comment">// check at runtime because it may get assigned a namespace when its</span></span><br><span class="line">      <span class="comment">// parent normalizes children</span></span><br><span class="line">      vnode = <span class="keyword">new</span> VNode(</span><br><span class="line">        tag, data, children,</span><br><span class="line">        <span class="literal">undefined</span>, <span class="literal">undefined</span>, context</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// tag ä¸æ˜¯ string è€Œæ˜¯ Component ç±»å‹ï¼Œç›´æ¥è°ƒç”¨ createComponent åˆ›å»ºä¸€ä¸ªç»„ä»¶ç±»å‹çš„ VNode èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// direct component options / constructor</span></span><br><span class="line">    vnode = createComponent(tag, data, context, children)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(vnode)) &#123;</span><br><span class="line">    <span class="keyword">return</span> vnode</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDef(vnode)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDef(ns)) applyNS(vnode, ns)</span><br><span class="line">    <span class="keyword">if</span> (isDef(data)) registerDeepBindings(data)</span><br><span class="line">    <span class="keyword">return</span> vnode</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> createEmptyVNode()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createElm"><a href="#createElm" class="headerlink" title="createElm"></a>createElm</h2><p>ç»™å½“å‰çš„å­èŠ‚ç‚¹åˆ›å»ºçœŸå®èŠ‚ç‚¹æŒ‚åœ¨ elm å±æ€§ä¸‹</p>
<p>åœ¨åˆ›å»ºå¥½ button èŠ‚ç‚¹å, è¿›å…¥ createChildren, åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹, å†æ‰§è¡Œæ’å…¥, é€šè¿‡çˆ¶èŠ‚ç‚¹ button æ‰§è¡Œ appendChild å®Œæˆæ’å…¥æ“ä½œ; </p>
<p>å®Œæˆ createChildren å, è¿›å…¥ invokeCreateHooks, é€šè¿‡æ‰§è¡Œ cbs å›è°ƒå‡½æ•°ä¸­çš„ create ä¸‹çš„ç³»åˆ—åˆ›å»ºæ–¹æ³•, å®Œæˆæ–°æ—§èŠ‚ç‚¹çš„æ›´æ–°; è¿™é‡Œçš„äº‹ä»¶ä¼šæ‰§è¡Œ updateDOMListeners, å®Œæˆä»¥ä¸‹å†…å®¹çš„åŒæ­¥æ›´æ–°; æ¥ç€å°†å‡†å¤‡å¥½çš„ children æ’å…¥åˆ°çˆ¶çº§èŠ‚ç‚¹, å¦‚æ­¤å°±ç®—èµ°å®Œäº†å½“å‰è¿™ä¸ªäº‹ä»¶èŠ‚ç‚¹</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cbs.create &#123;</span><br><span class="line">  <span class="number">0</span>:Æ’ updateAttrs(oldVnode, vnode)</span><br><span class="line">  <span class="number">1</span>:Æ’ updateClass (oldVnode, vnode) </span><br><span class="line">  <span class="number">2</span>:Æ’ updateDOMListeners (oldVnode, vnode) </span><br><span class="line">  <span class="number">3</span>:Æ’ updateDOMProps(oldVnode, vnode)</span><br><span class="line">  <span class="number">4</span>:Æ’ updateStyle(oldVnode, vnode)</span><br><span class="line">  <span class="number">5</span>:Æ’ _enter (_, vnode) </span><br><span class="line">  <span class="number">6</span>:Æ’ create (_, vnode) </span><br><span class="line">  <span class="number">7</span>:Æ’ updateDirectives (oldVnode, vnode)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸»è¦æ¶‰åŠåˆ°çš„ç¯èŠ‚: </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">vnode.elm = vnode.ns</span><br><span class="line">  ? nodeOps.createElementNS(vnode.ns, tag)</span><br><span class="line">  : nodeOps.createElement(tag, vnode)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºå­èŠ‚ç‚¹, å¦‚æœæœ‰å±æ€§ data, åˆå§‹åŒ–æŒ‚è½½å±æ€§ data, åæœŸæ›´æ–°å±æ€§ data</span></span><br><span class="line">createChildren(vnode, children, insertedVnodeQueue)</span><br><span class="line"><span class="keyword">if</span> (isDef(data)) &#123;</span><br><span class="line">  invokeCreateHooks(vnode, insertedVnodeQueue)</span><br><span class="line">&#125;</span><br><span class="line">insert(parentElm, vnode.elm, refElm)</span><br><span class="line"></span><br><span class="line"><span class="comment">// button ä¸‹å­èŠ‚ç‚¹ä¸ºæ–‡æœ¬èŠ‚ç‚¹</span></span><br><span class="line">vnode.elm = nodeOps.createTextNode(vnode.text)</span><br><span class="line"></span><br><span class="line"><span class="comment">// insert</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insert</span> (<span class="params">parent, elm, ref</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isDef(parent)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDef(ref)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (nodeOps.parentNode(ref) === parent) &#123;</span><br><span class="line">        nodeOps.insertBefore(parent, elm, ref)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      nodeOps.appendChild(parent, elm)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// invokeCreateHooks</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">invokeCreateHooks</span> (<span class="params">vnode, insertedVnodeQueue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cbs.create.length; ++i) &#123;</span><br><span class="line">    cbs.create[i](emptyNode, vnode)</span><br><span class="line">  &#125;</span><br><span class="line">  i = vnode.data.hook <span class="comment">// Reuse variable</span></span><br><span class="line">  <span class="keyword">if</span> (isDef(i)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDef(i.create)) i.create(emptyNode, vnode)</span><br><span class="line">    <span class="keyword">if</span> (isDef(i.insert)) insertedVnodeQueue.push(vnode) <span class="comment">// æ’å…¥çš„ VNode é˜Ÿåˆ—</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// updateDOMListeners</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateDOMListeners</span> (<span class="params">oldVnode: VNodeWithData, vnode: VNodeWithData</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isUndef(oldVnode.data.on) &amp;&amp; isUndef(vnode.data.on)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> on = vnode.data.on || &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> oldOn = oldVnode.data.on || &#123;&#125;</span><br><span class="line">  target = vnode.elm</span><br><span class="line">  normalizeEvents(on)</span><br><span class="line">  updateListeners(on, oldOn, add, remove, createOnceHandler, vnode.context)</span><br><span class="line">  target = <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="updateDOMListeners"><a href="#updateDOMListeners" class="headerlink" title="updateDOMListeners"></a>updateDOMListeners</h2><p>è·å–æ–°æ—§èŠ‚ç‚¹çš„ on ä¸‹çš„äº‹ä»¶, è¿›è¡Œå¯¹æ¯”æ›´æ–° updateListeners; ä»¤ target ç­‰äº vnode.elm, ä¹Ÿå°±æ˜¯æˆ‘ä»¬æœ€ç»ˆè¦è·å¾—æ–°è™šæ‹ŸèŠ‚ç‚¹ dom åŒ–åçš„çœŸå®èŠ‚ç‚¹;</p>
<p>åœ¨ updateListeners å‡½æ•°ä¸­, å°†æ–°æ—§èŠ‚ç‚¹çš„ on è¿›è¡Œå¯¹æ¯”, å…¶å®åˆå§‹åŒ–æ—¶æ—§èŠ‚ç‚¹å¹¶æ²¡æœ‰ä»€ä¹ˆ, åªæ˜¯ç”Ÿæˆçš„ä¸€ä¸ªç©ºçš„è™šæ‹ŸèŠ‚ç‚¹; ç­‰åˆ°ä¸‹æ¬¡å˜åŠ¨åšæ›´æ–°æ—¶æ‰æ˜¯æœ‰å†…å®¹çš„æ—§èŠ‚ç‚¹.</p>
<p>éå†æ–°èŠ‚ç‚¹ on ä¸­çš„æ–¹æ³•, å¯¹æ¯”æ–°æ—§èŠ‚ç‚¹ on ä¸­çš„äº‹ä»¶: æ–°èŠ‚ç‚¹ on ä¸­çš„æ–¹æ³•æ˜¯å¦æœªè¢«å®šä¹‰? è‹¥æœªå®šä¹‰åˆ™æŠ›å‡ºæ—¶é—´é”™è¯¯; æ–°èŠ‚ç‚¹æ–¹æ³•å¯¹åº”çš„å‡½æ•°æœ‰è€Œæ—§èŠ‚ç‚¹æ²¡æœ‰, åˆ™ç›´æ¥å°†è¯¥æ–¹æ³•é€šè¿‡ addEventListener æ·»åŠ è‡³ target, ä¹Ÿå°±æ˜¯æ–° vnode çš„çœŸå®èŠ‚ç‚¹ elm; æœ€åä¸€ç§æƒ…å†µæ˜¯æ–°æ—§èŠ‚ç‚¹çš„äº‹ä»¶å¯¹åº”çš„å‡½æ•°ä¸ä¸€è‡´, åˆ™ä»¤æ—§èŠ‚ç‚¹å‡½æ•°çš„ fns ç­‰äºæ–°èŠ‚ç‚¹å‡½æ•°, å†æ›´æ–°æ–°çš„ä¸º old;</p>
<p>æœ€åéå†æ—§èŠ‚ç‚¹çš„äº‹ä»¶å, å€˜è‹¥æ–°èŠ‚ç‚¹é‡Œæ²¡æœ‰, åˆ™ç§»é™¤è¿™ä¸ªäº‹ä»¶</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateDOMListeners</span> (<span class="params">oldVnode: VNodeWithData, vnode: VNodeWithData</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isUndef(oldVnode.data.on) &amp;&amp; isUndef(vnode.data.on)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> on = vnode.data.on || &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> oldOn = oldVnode.data.on || &#123;&#125;</span><br><span class="line">  target = vnode.elm</span><br><span class="line">  normalizeEvents(on)</span><br><span class="line">  updateListeners(on, oldOn, add, remove, createOnceHandler, vnode.context)</span><br><span class="line">  target = <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// updateListeners</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateListeners</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  on: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  oldOn: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  add: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  remove: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  createOnceHandler: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  vm: Component</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> name, def, cur, old, event</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> on) &#123;</span><br><span class="line">    def = cur = on[name]</span><br><span class="line">    old = oldOn[name]</span><br><span class="line">    event = normalizeEvent(name)</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (__WEEX__ &amp;&amp; isPlainObject(def)) &#123;</span><br><span class="line">      cur = def.handler</span><br><span class="line">      event.params = def.params</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isUndef(cur)) &#123;</span><br><span class="line">      process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warn(</span><br><span class="line">        <span class="string">`Invalid handler for event "<span class="subst">$&#123;event.name&#125;</span>": got `</span> + <span class="built_in">String</span>(cur),</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isUndef(old)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isUndef(cur.fns)) &#123;</span><br><span class="line">        cur = on[name] = createFnInvoker(cur, vm)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (isTrue(event.once)) &#123;</span><br><span class="line">        cur = on[name] = createOnceHandler(event.name, cur, event.capture)</span><br><span class="line">      &#125;</span><br><span class="line">      add(event.name, cur, event.capture, event.passive, event.params)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur !== old) &#123;</span><br><span class="line">      old.fns = cur</span><br><span class="line">      on[name] = old</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> oldOn) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isUndef(on[name])) &#123;</span><br><span class="line">      event = normalizeEvent(name)</span><br><span class="line">      remove(event.name, oldOn[name], event.capture)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// add</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  name: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  handler: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  capture: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  passive: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// async edge case #6566: inner click event triggers patch, event handler</span></span><br><span class="line">  <span class="comment">// attached to outer element during patch, and triggered again. This</span></span><br><span class="line">  <span class="comment">// happens because browsers fire microtask ticks between event propagation.</span></span><br><span class="line">  <span class="comment">// the solution is simple: we save the timestamp when a handler is attached,</span></span><br><span class="line">  <span class="comment">// and the handler would only fire if the event passed to it was fired</span></span><br><span class="line">  <span class="comment">// AFTER it was attached.</span></span><br><span class="line">  <span class="keyword">if</span> (useMicrotaskFix) &#123;</span><br><span class="line">    <span class="keyword">const</span> attachedTimestamp = currentFlushTimestamp</span><br><span class="line">    <span class="keyword">const</span> original = handler</span><br><span class="line">    handler = original._wrapper = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        <span class="comment">// no bubbling, should always fire.</span></span><br><span class="line">        <span class="comment">// this is just a safety net in case event.timeStamp is unreliable in</span></span><br><span class="line">        <span class="comment">// certain weird environments...</span></span><br><span class="line">        e.target === e.currentTarget ||</span><br><span class="line">        <span class="comment">// event is fired after handler attachment</span></span><br><span class="line">        e.timeStamp &gt;= attachedTimestamp ||</span><br><span class="line">        <span class="comment">// bail for environments that have buggy event.timeStamp implementations</span></span><br><span class="line">        <span class="comment">// #9462 iOS 9 bug: event.timeStamp is 0 after history.pushState</span></span><br><span class="line">        <span class="comment">// #9681 QtWebEngine event.timeStamp is negative value</span></span><br><span class="line">        e.timeStamp &lt;= <span class="number">0</span> ||</span><br><span class="line">        <span class="comment">// #9448 bail if event is fired in another document in a multi-page</span></span><br><span class="line">        <span class="comment">// electron/nw.js app, since event.timeStamp will be using a different</span></span><br><span class="line">        <span class="comment">// starting reference</span></span><br><span class="line">        e.target.ownerDocument !== <span class="built_in">document</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="keyword">return</span> original.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  target.addEventListener(</span><br><span class="line">    name,</span><br><span class="line">    handler,</span><br><span class="line">    supportsPassive</span><br><span class="line">      ? &#123; capture, passive &#125;</span><br><span class="line">      : capture</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="v-if"><a href="#v-if" class="headerlink" title="v-if"></a>v-if</h1><p>parseStartTag ä¸­å‰ªè£å‡ºæ ‡ç­¾ div åŠå±æ€§ v-if=â€showâ€, å°†å½“å‰ attr åŒæ­¥åˆ° attrs æ”¶é›†å™¨, å†å¾€ä¸‹æ£€æµ‹æ˜¯å¦è¿˜æœ‰å±æ€§, å¾—çŸ¥ end ä¹Ÿå°±æ˜¯ &gt; å­˜åœ¨, è¯´æ˜åç»­å°±å†æ²¡å±æ€§äº†, å°† html åˆå¯ä»¥æ¨è¿›åˆ° end çš„ index</p>
<p>è§£æå®Œå¼€å§‹æ ‡ç­¾ï¼Œé‚£ä¹ˆæ¥ä¸‹å°±è¦å¤„ç†å¼€å§‹æ ‡ç­¾ï¼ŒhandleStartTag ä¼ å…¥åˆšæ‰åŒ¹é…åˆ°çš„ç»“æœï¼Œè·å–æ ‡ç­¾åï¼Œç„¶åå¼€å§‹å¤„ç†å±æ€§ match.attrs; å°† attrs éå†ï¼Œå°†æ¯ä¸€å¯¹å±æ€§è½¬æˆ { name, value } å­˜å…¥ attrs; æ¥ç€å°† tagã€attrs ç”Ÿæˆ AST æ ‘, å…¶å®æ²¡å¤šå°‘æ“ä½œ, å°±å°† attrs ç”Ÿæˆäº† <code>attrsMap {v-if: &#39;show&#39;}</code>; æ¥ç€èµ°åˆ° processIF, ç»™ v-if æ·»åŠ  <code>IfConditions { exp: &#39;show&#39;, block: el }</code></p>
<p>æ¥ç€å¾€ä¸‹åˆ¤æ–­, è·å–ä¸‹ä¸€ä¸ª &lt; çš„ä½ç½®, å°†å®ƒä¹‹å‰çš„è¿™æ®µ text å‰ªä¸‹æ¥, å°† html æ¨è¿›; æ¥ç€å°†ä¸æ˜¯æ ‡ç­¾å†…å®¹çš„ text æ”¾å…¥ chars å¤„ç†; åˆ¤æ–­ currentParent(ä¸Šæ®µæ ‡ç­¾) æœ‰æ— , è‹¥æœ‰å°±è¯´æ˜ text å°±æ˜¯ä¸Šä¸€ä¸ªæ ‡ç­¾å†…çš„å†…å®¹; æ¥ç€æ£€æŸ¥ currentParent æ˜¯å¦æ˜¯ style / script æ ‡ç­¾, è‹¥ä¸æ˜¯å°±è§£ç è¿™æ®µ text; ç„¶åè§£æå¤„ç†å¥½çš„ text, çœ‹æ˜¯å¦å…¶ä¸­å«æœ‰å˜é‡åˆ†éš”ç¬¦, è·å–åˆ†éš”ç¬¦é‡Œçš„å†…å®¹ exp, ç”¨ _s() åŒ…è£¹, å‡†å¤‡åç»­ä»£ç ;æœ€ç»ˆå¾—åˆ°è¯¥ text çš„å¯¹è±¡ child = {type: 2, expression, tokens, text}; è‹¥æ˜¯çº¯æ–‡æœ¬åˆ™æ²¡æœ‰ expression, tokens; æ¥ç€å°† child æ·»åŠ åˆ°çˆ¶çº§çš„ children ä¸­.</p>
<p>æ­¤æ—¶å¤„ç†å®Œçš„ v-if çš„ AST æ ‘ä¸º:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  attrsList:(<span class="number">0</span>) []</span><br><span class="line">  attrsMap:&#123;v-<span class="keyword">if</span>: <span class="string">'show'</span>&#125;</span><br><span class="line">  children:(<span class="number">1</span>) </span><br><span class="line">    <span class="number">0</span>:&#123;<span class="attr">type</span>: <span class="number">2</span>, <span class="attr">expression</span>: <span class="string">'_s(show ? '</span>bad ass<span class="string">' : '</span>motherfucker<span class="string">')'</span>, <span class="attr">tokens</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">text</span>: <span class="string">'$[ show ? '</span>bad ass<span class="string">' : '</span>motherfucker<span class="string">' ]'</span>, <span class="attr">start</span>: <span class="number">110</span>, â€¦&#125;</span><br><span class="line">  <span class="keyword">if</span>:<span class="string">'show'</span></span><br><span class="line">  ifConditions:(<span class="number">1</span>)</span><br><span class="line">    <span class="number">0</span>:&#123;<span class="attr">exp</span>: <span class="string">'show'</span>, <span class="attr">block</span>: &#123;â€¦&#125;&#125;</span><br><span class="line">  end:<span class="number">154</span></span><br><span class="line">  start:<span class="number">93</span></span><br><span class="line">  parent:&#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">'div'</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">attrsMap</span>: &#123;â€¦&#125;,&#125;</span><br><span class="line">  rawAttrsMap:&#123;v-<span class="keyword">if</span>:&#123;<span class="attr">name</span>: <span class="string">'v-if'</span>, <span class="attr">value</span>: <span class="string">'show'</span>, <span class="attr">start</span>: <span class="number">98</span>, <span class="attr">end</span>: <span class="number">109</span>&#125;&#125;</span><br><span class="line">  plain:<span class="literal">true</span></span><br><span class="line">  tag:<span class="string">'div'</span></span><br><span class="line">  type:<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="parseHTML"><a href="#parseHTML" class="headerlink" title="parseHTML"></a>parseHTML</h2><p>ä» while å¼€å§‹å¤„ç† html, ä¸æ–­æ¨è¿›ç”Ÿæˆ AST æ ‘</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">parseHTML</span> (<span class="params">html, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> stack = []</span><br><span class="line">  <span class="keyword">const</span> expectHTML = options.expectHTML</span><br><span class="line">  <span class="keyword">const</span> isUnaryTag = options.isUnaryTag || no</span><br><span class="line">  <span class="keyword">const</span> canBeLeftOpenTag = options.canBeLeftOpenTag || no</span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> last, lastTag</span><br><span class="line">  <span class="keyword">while</span> (html) &#123;</span><br><span class="line">    last = html</span><br><span class="line">    <span class="comment">// Make sure we're not in a plaintext content element like script/style</span></span><br><span class="line">    <span class="keyword">if</span> (!lastTag || !isPlainTextElement(lastTag)) &#123;</span><br><span class="line">      <span class="keyword">let</span> textEnd = html.indexOf(<span class="string">'&lt;'</span>) <span class="comment">// æ ‡è®°å¼€å§‹æ ‡ç­¾</span></span><br><span class="line">      <span class="keyword">if</span> (textEnd === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Comment:</span></span><br><span class="line">        <span class="keyword">if</span> (comment.test(html)) &#123;</span><br><span class="line">          <span class="keyword">const</span> commentEnd = html.indexOf(<span class="string">'--&gt;'</span>)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (commentEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (options.shouldKeepComment) &#123;</span><br><span class="line">              options.comment(html.substring(<span class="number">4</span>, commentEnd), index, index + commentEnd + <span class="number">3</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            advance(commentEnd + <span class="number">3</span>) <span class="comment">// --&gt; å ä¸‰ä½</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// http://en.wikipedia.org/wiki/Conditional_comment#Downlevel-revealed_conditional_comment</span></span><br><span class="line">        <span class="keyword">if</span> (conditionalComment.test(html)) &#123;</span><br><span class="line">          <span class="keyword">const</span> conditionalEnd = html.indexOf(<span class="string">']&gt;'</span>)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (conditionalEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            advance(conditionalEnd + <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Doctype:</span></span><br><span class="line">        <span class="keyword">const</span> doctypeMatch = html.match(doctype)</span><br><span class="line">        <span class="keyword">if</span> (doctypeMatch) &#123;</span><br><span class="line">          advance(doctypeMatch[<span class="number">0</span>].length)</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// End tag:</span></span><br><span class="line">        <span class="keyword">const</span> endTagMatch = html.match(endTag)</span><br><span class="line">        <span class="keyword">if</span> (endTagMatch) &#123;</span><br><span class="line">          <span class="keyword">const</span> curIndex = index</span><br><span class="line">          advance(endTagMatch[<span class="number">0</span>].length)</span><br><span class="line">          parseEndTag(endTagMatch[<span class="number">1</span>], curIndex, index)</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start tag:</span></span><br><span class="line">        <span class="keyword">const</span> startTagMatch = parseStartTag() <span class="comment">// è§£æå¼€å§‹çš„æ ‡ç­¾ï¼ŒæŠŠ template è½¬åŒ–æˆèŠ‚ç‚¹åå’Œå±æ€§</span></span><br><span class="line">        <span class="keyword">if</span> (startTagMatch) &#123;</span><br><span class="line">          handleStartTag(startTagMatch)</span><br><span class="line">          <span class="keyword">if</span> (shouldIgnoreFirstNewline(startTagMatch.tagName, html)) &#123;</span><br><span class="line">            advance(<span class="number">1</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> text, rest, next</span><br><span class="line">      <span class="keyword">if</span> (textEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        rest = html.slice(textEnd) <span class="comment">// å°†ç»“å°¾æ ‡ç­¾æˆªå‡º</span></span><br><span class="line">        <span class="keyword">while</span> (</span><br><span class="line">          !endTag.test(rest) &amp;&amp;</span><br><span class="line">          !startTagOpen.test(rest) &amp;&amp;</span><br><span class="line">          !comment.test(rest) &amp;&amp;</span><br><span class="line">          !conditionalComment.test(rest)</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="comment">// &lt; in plain text, be forgiving and treat it as text</span></span><br><span class="line">          next = rest.indexOf(<span class="string">'&lt;'</span>, <span class="number">1</span>)</span><br><span class="line">          <span class="keyword">if</span> (next &lt; <span class="number">0</span>) <span class="keyword">break</span></span><br><span class="line">          textEnd += next</span><br><span class="line">          rest = html.slice(textEnd)</span><br><span class="line">        &#125;</span><br><span class="line">        text = html.substring(<span class="number">0</span>, textEnd)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (textEnd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        text = html</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (text) &#123;</span><br><span class="line">        advance(text.length) <span class="comment">// æ›´æ–° index html</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (options.chars &amp;&amp; text) &#123;</span><br><span class="line">        options.chars(text, index - text.length, index)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> endTagLength = <span class="number">0</span></span><br><span class="line">      <span class="keyword">const</span> stackedTag = lastTag.toLowerCase()</span><br><span class="line">      <span class="keyword">const</span> reStackedTag = reCache[stackedTag] || (reCache[stackedTag] = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'([\\s\\S]*?)(&lt;/'</span> + stackedTag + <span class="string">'[^&gt;]*&gt;)'</span>, <span class="string">'i'</span>))</span><br><span class="line">      <span class="keyword">const</span> rest = html.replace(reStackedTag, <span class="function"><span class="keyword">function</span> (<span class="params">all, text, endTag</span>) </span>&#123;</span><br><span class="line">        endTagLength = endTag.length</span><br><span class="line">        <span class="keyword">if</span> (!isPlainTextElement(stackedTag) &amp;&amp; stackedTag !== <span class="string">'noscript'</span>) &#123;</span><br><span class="line">          text = text</span><br><span class="line">            .replace(<span class="regexp">/&lt;!\--([\s\S]*?)--&gt;/g</span>, <span class="string">'$1'</span>) <span class="comment">// #7298</span></span><br><span class="line">            .replace(<span class="regexp">/&lt;!\[CDATA\[([\s\S]*?)]]&gt;/g</span>, <span class="string">'$1'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (shouldIgnoreFirstNewline(stackedTag, text)) &#123;</span><br><span class="line">          text = text.slice(<span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (options.chars) &#123;</span><br><span class="line">          options.chars(text)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">      &#125;)</span><br><span class="line">      index += html.length - rest.length</span><br><span class="line">      html = rest</span><br><span class="line">      parseEndTag(stackedTag, index - endTagLength, index)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (html === last) &#123;</span><br><span class="line">      options.chars &amp;&amp; options.chars(html)</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; !stack.length &amp;&amp; options.warn) &#123;</span><br><span class="line">        options.warn(<span class="string">`Mal-formatted tag at end of template: "<span class="subst">$&#123;html&#125;</span>"`</span>, &#123; <span class="attr">start</span>: index + html.length &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Clean up any remaining tags</span></span><br><span class="line">  parseEndTag()</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">advance</span> (<span class="params">n</span>) </span>&#123;</span><br><span class="line">    index += n</span><br><span class="line">    html = html.substring(n)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è§£æå¼€å§‹çš„æ ‡ç­¾</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">parseStartTag</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> start = html.match(startTagOpen)</span><br><span class="line">    <span class="keyword">if</span> (start) &#123;</span><br><span class="line">      <span class="keyword">const</span> match = &#123;</span><br><span class="line">        tagName: start[<span class="number">1</span>],</span><br><span class="line">        attrs: [],</span><br><span class="line">        start: index</span><br><span class="line">      &#125;</span><br><span class="line">      advance(start[<span class="number">0</span>].length)</span><br><span class="line">      <span class="keyword">let</span> end, attr</span><br><span class="line">      <span class="keyword">while</span> (!(end = html.match(startTagClose)) &amp;&amp; (attr = html.match(dynamicArgAttribute) || html.match(attribute))) &#123;</span><br><span class="line">        attr.start = index</span><br><span class="line">        advance(attr[<span class="number">0</span>].length)</span><br><span class="line">        attr.end = index</span><br><span class="line">        match.attrs.push(attr)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (end) &#123;</span><br><span class="line">        match.unarySlash = end[<span class="number">1</span>]</span><br><span class="line">        advance(end[<span class="number">0</span>].length)</span><br><span class="line">        match.end = index</span><br><span class="line">        <span class="keyword">return</span> match</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¤„ç†å¼€å§‹æ ‡ç­¾</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleStartTag</span> (<span class="params">match</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> tagName = match.tagName</span><br><span class="line">    <span class="keyword">const</span> unarySlash = match.unarySlash</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (expectHTML) &#123;</span><br><span class="line">      <span class="keyword">if</span> (lastTag === <span class="string">'p'</span> &amp;&amp; isNonPhrasingTag(tagName)) &#123;</span><br><span class="line">        parseEndTag(lastTag)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (canBeLeftOpenTag(tagName) &amp;&amp; lastTag === tagName) &#123;</span><br><span class="line">        parseEndTag(tagName)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> unary = isUnaryTag(tagName) || !!unarySlash <span class="comment">// åˆ¤æ–­æ ‡ç­¾æ˜¯å¦æ˜¯ä¸€å…ƒæ ‡ç­¾</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> l = match.attrs.length</span><br><span class="line">    <span class="keyword">const</span> attrs = <span class="keyword">new</span> <span class="built_in">Array</span>(l)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; l; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> args = match.attrs[i]</span><br><span class="line">      <span class="keyword">const</span> value = args[<span class="number">3</span>] || args[<span class="number">4</span>] || args[<span class="number">5</span>] || <span class="string">''</span></span><br><span class="line">      <span class="keyword">const</span> shouldDecodeNewlines = tagName === <span class="string">'a'</span> &amp;&amp; args[<span class="number">1</span>] === <span class="string">'href'</span></span><br><span class="line">        ? options.shouldDecodeNewlinesForHref</span><br><span class="line">        : options.shouldDecodeNewlines</span><br><span class="line">      attrs[i] = &#123;</span><br><span class="line">        name: args[<span class="number">1</span>],</span><br><span class="line">        value: decodeAttr(value, shouldDecodeNewlines)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; options.outputSourceRange) &#123;</span><br><span class="line">        attrs[i].start = args.start + args[<span class="number">0</span>].match(<span class="regexp">/^\s*/</span>).length</span><br><span class="line">        attrs[i].end = args.end</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†éä¸€å…ƒçš„æ ‡ç­¾å‹å…¥æ ˆä¸­ï¼Œå†ç”± parseRndTag å¼¹å‡ºåŒ¹é…ç»“æŸæ ‡ç­¾</span></span><br><span class="line">    <span class="keyword">if</span> (!unary) &#123; </span><br><span class="line">      stack.push(&#123; <span class="attr">tag</span>: tagName, <span class="attr">lowerCasedTag</span>: tagName.toLowerCase(), <span class="attr">attrs</span>: attrs, <span class="attr">start</span>: match.start, <span class="attr">end</span>: match.end &#125;)</span><br><span class="line">      lastTag = tagName</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.start) &#123;</span><br><span class="line">      options.start(tagName, attrs, unary, match.start, match.end) <span class="comment">// å°†è§£æåçš„æ¨¡æ¿æŒ‚ç”¨ä¼ å…¥çš„é…ç½®é‡Œ start å‡½æ•°å¤„ç†å‘½ä»¤ç­‰</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">parseEndTag</span> (<span class="params">tagName, start, end</span>) </span>&#123; <span class="comment">// å¯¹äº</span></span><br><span class="line">    <span class="keyword">let</span> pos, lowerCasedTagName</span><br><span class="line">    <span class="keyword">if</span> (start == <span class="literal">null</span>) start = index</span><br><span class="line">    <span class="keyword">if</span> (end == <span class="literal">null</span>) end = index</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the closest opened tag of the same type</span></span><br><span class="line">    <span class="keyword">if</span> (tagName) &#123;</span><br><span class="line">      lowerCasedTagName = tagName.toLowerCase()</span><br><span class="line">      <span class="keyword">for</span> (pos = stack.length - <span class="number">1</span>; pos &gt;= <span class="number">0</span>; pos--) &#123; <span class="comment">// å°†æ ˆå†…æ ‡ç­¾æ’å‡º</span></span><br><span class="line">        <span class="keyword">if</span> (stack[pos].lowerCasedTag === lowerCasedTagName) &#123;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// If no tag name is provided, clean shop</span></span><br><span class="line">      pos = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pos &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Close all the open elements, up the stack</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = stack.length - <span class="number">1</span>; i &gt;= pos; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">          (i &gt; pos || !tagName) &amp;&amp;</span><br><span class="line">          options.warn</span><br><span class="line">        ) &#123;</span><br><span class="line">          options.warn(</span><br><span class="line">            <span class="string">`tag &lt;<span class="subst">$&#123;stack[i].tag&#125;</span>&gt; has no matching end tag.`</span>,</span><br><span class="line">            &#123; <span class="attr">start</span>: stack[i].start, <span class="attr">end</span>: stack[i].end &#125;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (options.end) &#123;</span><br><span class="line">          options.end(stack[i].tag, start, end)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Remove the open elements from the stack</span></span><br><span class="line">      stack.length = pos <span class="comment">// æ¸…æ¥š pos åˆ°æ ˆé¡¶çš„æ ‡ç­¾</span></span><br><span class="line">      lastTag = pos &amp;&amp; stack[pos - <span class="number">1</span>].tag</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lowerCasedTagName === <span class="string">'br'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (options.start) &#123;</span><br><span class="line">        options.start(tagName, [], <span class="literal">true</span>, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lowerCasedTagName === <span class="string">'p'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (options.start) &#123;</span><br><span class="line">        options.start(tagName, [], <span class="literal">false</span>, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (options.end) &#123;</span><br><span class="line">        options.end(tagName, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="parseHTML-çš„-option"><a href="#parseHTML-çš„-option" class="headerlink" title="parseHTML çš„ option"></a>parseHTML çš„ option</h2><p>æ¶‰åŠåˆ° start end chars comment å¤„ç†æ–¹æ³•, processIf æ–¹æ³•å°±åœ¨ start ä¸­</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line">parseHTML(template, &#123;</span><br><span class="line">  warn,</span><br><span class="line">  expectHTML: options.expectHTML,</span><br><span class="line">  isUnaryTag: options.isUnaryTag,</span><br><span class="line">  canBeLeftOpenTag: options.canBeLeftOpenTag,</span><br><span class="line">  shouldDecodeNewlines: options.shouldDecodeNewlines,</span><br><span class="line">  shouldDecodeNewlinesForHref: options.shouldDecodeNewlinesForHref,</span><br><span class="line">  shouldKeepComment: options.comments,</span><br><span class="line">  outputSourceRange: options.outputSourceRange,</span><br><span class="line">  start (tag, attrs, unary, start, end) &#123;</span><br><span class="line">    <span class="comment">// check namespace.</span></span><br><span class="line">    <span class="comment">// inherit parent ns if there is one</span></span><br><span class="line">    <span class="keyword">const</span> ns = (currentParent &amp;&amp; currentParent.ns) || platformGetTagNamespace(tag)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// handle IE svg bug</span></span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (isIE &amp;&amp; ns === <span class="string">'svg'</span>) &#123;</span><br><span class="line">      attrs = guardIESVGBug(attrs)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> element: ASTElement = createASTElement(tag, attrs, currentParent) <span class="comment">// åˆ›å»º AST å…ƒç´ </span></span><br><span class="line">    <span class="keyword">if</span> (ns) &#123;</span><br><span class="line">      element.ns = ns</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (options.outputSourceRange) &#123;</span><br><span class="line">        element.start = start</span><br><span class="line">        element.end = end</span><br><span class="line">        element.rawAttrsMap = element.attrsList.reduce(<span class="function">(<span class="params">cumulated, attr</span>) =&gt;</span> &#123;</span><br><span class="line">          cumulated[attr.name] = attr</span><br><span class="line">          <span class="keyword">return</span> cumulated</span><br><span class="line">        &#125;, &#123;&#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      attrs.forEach(<span class="function"><span class="params">attr</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (invalidAttributeRE.test(attr.name)) &#123;</span><br><span class="line">          warn(</span><br><span class="line">            <span class="string">`Invalid dynamic argument expression: attribute names cannot contain `</span> +</span><br><span class="line">            <span class="string">`spaces, quotes, &lt;, &gt;, / or =.`</span>,</span><br><span class="line">            &#123;</span><br><span class="line">              start: attr.start + attr.name.indexOf(<span class="string">`[`</span>),</span><br><span class="line">              end: attr.start + attr.name.length</span><br><span class="line">            &#125;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç† AST å…ƒç´ </span></span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºç¦æ­¢çš„ tag å’ŒæœåŠ¡ç«¯æ¸²æŸ“</span></span><br><span class="line">    <span class="keyword">if</span> (isForbiddenTag(element) &amp;&amp; !isServerRendering()) &#123;</span><br><span class="line">      element.forbidden = <span class="literal">true</span></span><br><span class="line">      process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warn(</span><br><span class="line">        <span class="string">'Templates should only be responsible for mapping the state to the '</span> +</span><br><span class="line">        <span class="string">'UI. Avoid placing tags with side-effects in your templates, such as '</span> +</span><br><span class="line">        <span class="string">`&lt;<span class="subst">$&#123;tag&#125;</span>&gt;`</span> + <span class="string">', as they will not be parsed.'</span>,</span><br><span class="line">        &#123; <span class="attr">start</span>: element.start &#125;</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// apply pre-transforms</span></span><br><span class="line">    <span class="comment">// å¯¹åˆ›å»ºçš„ ASTElement åšé¢„è½¬æ¢</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; preTransforms.length; i++) &#123;</span><br><span class="line">      element = preTransforms[i](element, options) || element</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!inVPre) &#123;</span><br><span class="line">      processPre(element)</span><br><span class="line">      <span class="keyword">if</span> (element.pre) &#123;</span><br><span class="line">        inVPre = <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (platformIsPreTag(element.tag)) &#123;</span><br><span class="line">      inPre = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (inVPre) &#123;</span><br><span class="line">      processRawAttrs(element)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!element.processed) &#123;</span><br><span class="line">      <span class="comment">// structural directives</span></span><br><span class="line">      <span class="comment">// æ„å»ºä»¥å‰å‘½ä»¤</span></span><br><span class="line">      processFor(element) <span class="comment">// ä»å…ƒç´ ä¸­æ‹¿åˆ° v-for æŒ‡ä»¤çš„å†…å®¹ï¼Œç„¶ååˆ†åˆ«è§£æå‡º forã€aliasã€iterator1ã€iterator2 ç­‰å±æ€§çš„å€¼æ·»åŠ åˆ° AST çš„å…ƒç´ </span></span><br><span class="line">      processIf(element) <span class="comment">// ä»å…ƒç´ ä¸­æ‹¿ v-if æŒ‡ä»¤çš„å†…å®¹</span></span><br><span class="line">      processOnce(element)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœä¸å­˜åœ¨ root åˆ™å°†æ–°å»ºçš„ element ä½œä¸º root ,åœ¨æ£€æŸ¥ root çš„çº¦æŸæ¡ä»¶ , æœ‰é—®é¢˜çš„ tag åŠ å±æ€§ v-for å‡ä¸èƒ½åœ¨ root å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">      root = element</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">        checkRootConstraints(root)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!unary) &#123;</span><br><span class="line">      currentParent = element</span><br><span class="line">      stack.push(element)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      closeElement(element)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  end (tag, start, end) &#123;</span><br><span class="line">    <span class="keyword">const</span> element = stack[stack.length - <span class="number">1</span>]</span><br><span class="line">    <span class="comment">// pop stack</span></span><br><span class="line">    stack.length -= <span class="number">1</span></span><br><span class="line">    currentParent = stack[stack.length - <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; options.outputSourceRange) &#123;</span><br><span class="line">      element.end = end</span><br><span class="line">    &#125;</span><br><span class="line">    closeElement(element)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  chars (text: string, <span class="attr">start</span>: number, <span class="attr">end</span>: number) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!currentParent) &#123;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (text === template) &#123;</span><br><span class="line">          warnOnce(</span><br><span class="line">            <span class="string">'Component template requires a root element, rather than just text.'</span>,</span><br><span class="line">            &#123; start &#125;</span><br><span class="line">          )</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((text = text.trim())) &#123;</span><br><span class="line">          warnOnce(</span><br><span class="line">            <span class="string">`text "<span class="subst">$&#123;text&#125;</span>" outside root element will be ignored.`</span>,</span><br><span class="line">            &#123; start &#125;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// IE textarea placeholder bug</span></span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (isIE &amp;&amp;</span><br><span class="line">      currentParent.tag === <span class="string">'textarea'</span> &amp;&amp;</span><br><span class="line">      currentParent.attrsMap.placeholder === text</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> children = currentParent.children</span><br><span class="line">    <span class="keyword">if</span> (inPre || text.trim()) &#123;</span><br><span class="line">      text = isTextTag(currentParent) ? text : decodeHTMLCached(text)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!children.length) &#123;</span><br><span class="line">      <span class="comment">// remove the whitespace-only node right after an opening tag</span></span><br><span class="line">      text = <span class="string">''</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (whitespaceOption) &#123;</span><br><span class="line">      <span class="keyword">if</span> (whitespaceOption === <span class="string">'condense'</span>) &#123; <span class="comment">// å¦‚æœæ­¤å¤„æ–‡æœ¬æ ·å¼ whitespace é…ç½®ä¸º condenseï¼Œæœ‰æ¢è¡Œç¬¦çš„å–æ¶ˆï¼Œæ²¡æœ‰çš„å•ç©ºæ ¼</span></span><br><span class="line">        <span class="comment">// in condense mode, remove the whitespace node if it contains</span></span><br><span class="line">        <span class="comment">// line break, otherwise condense to a single space</span></span><br><span class="line">        text = lineBreakRE.test(text) ? <span class="string">''</span> : <span class="string">' '</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        text = <span class="string">' '</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      text = preserveWhitespace ? <span class="string">' '</span> : <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (text) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!inPre &amp;&amp; whitespaceOption === <span class="string">'condense'</span>) &#123;</span><br><span class="line">        <span class="comment">// condense consecutive whitespaces into single space</span></span><br><span class="line">        text = text.replace(whitespaceRE, <span class="string">' '</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> res</span><br><span class="line">      <span class="keyword">let</span> child: ?ASTNode</span><br><span class="line">      <span class="keyword">if</span> (!inVPre &amp;&amp; text !== <span class="string">' '</span> &amp;&amp; (res = parseText(text, delimiters))) &#123;</span><br><span class="line">        child = &#123;</span><br><span class="line">          type: <span class="number">2</span>, <span class="comment">// æœ‰è¡¨è¾¾å¼</span></span><br><span class="line">          expression: res.expression,</span><br><span class="line">          tokens: res.tokens,</span><br><span class="line">          text</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (text !== <span class="string">' '</span> || !children.length || children[children.length - <span class="number">1</span>].text !== <span class="string">' '</span>) &#123;</span><br><span class="line">        child = &#123;</span><br><span class="line">          type: <span class="number">3</span>, <span class="comment">// çº¯æ–‡æœ¬</span></span><br><span class="line">          text</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (child) &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; options.outputSourceRange) &#123;</span><br><span class="line">          child.start = start</span><br><span class="line">          child.end = end</span><br><span class="line">        &#125;</span><br><span class="line">        children.push(child)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  comment (text: string, start, end) &#123;</span><br><span class="line">    <span class="comment">// adding anything as a sibling to the root node is forbidden</span></span><br><span class="line">    <span class="comment">// comments should still be allowed, but ignored</span></span><br><span class="line">    <span class="keyword">if</span> (currentParent) &#123;</span><br><span class="line">      <span class="keyword">const</span> child: ASTText = &#123;</span><br><span class="line">        type: <span class="number">3</span>,</span><br><span class="line">        text,</span><br><span class="line">        isComment: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; options.outputSourceRange) &#123;</span><br><span class="line">        child.start = start</span><br><span class="line">        child.end = end</span><br><span class="line">      &#125;</span><br><span class="line">      currentParent.children.push(child)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="parseText"><a href="#parseText" class="headerlink" title="parseText"></a>parseText</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">parseText</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  text: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  delimiters?: [string, string]</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">TextParseResult</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å¦‚æœå¤–ç•Œç”¨æˆ·æ²¡æœ‰å®šä¹‰ delimiters åˆ†éš”ç¬¦ç”¨æ¥ä¼ å˜é‡ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨ Vue è‡ªå¸¦çš„åŒæ‹¬å· &#123;&#123;&#125;&#125;</span></span><br><span class="line">  <span class="comment">// å¦‚è¦ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œå¯ä»¥åœ¨ new Vue çš„æ—¶å€™ä¼ å…¥ delimiters å±æ€§ï¼š delimiters: ['', '']</span></span><br><span class="line">  <span class="keyword">const</span> tagRE = delimiters ? buildRegex(delimiters) : defaultTagRE </span><br><span class="line">  <span class="keyword">if</span> (!tagRE.test(text)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> tokens = []</span><br><span class="line">  <span class="keyword">const</span> rawTokens = []</span><br><span class="line">  <span class="keyword">let</span> lastIndex = tagRE.lastIndex = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> match, index, tokenValue</span><br><span class="line">  <span class="keyword">while</span> ((match = tagRE.exec(text))) &#123;</span><br><span class="line">    index = match.index</span><br><span class="line">    <span class="comment">// push text token</span></span><br><span class="line">    <span class="keyword">if</span> (index &gt; lastIndex) &#123;</span><br><span class="line">      rawTokens.push(tokenValue = text.slice(lastIndex, index))</span><br><span class="line">      tokens.push(<span class="built_in">JSON</span>.stringify(tokenValue))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// tag token</span></span><br><span class="line">    <span class="keyword">const</span> exp = parseFilters(match[<span class="number">1</span>].trim())</span><br><span class="line">    tokens.push(<span class="string">`_s(<span class="subst">$&#123;exp&#125;</span>)`</span>)</span><br><span class="line">    rawTokens.push(&#123; <span class="string">'@binding'</span>: exp &#125;)</span><br><span class="line">    lastIndex = index + match[<span class="number">0</span>].length</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (lastIndex &lt; text.length) &#123;</span><br><span class="line">    rawTokens.push(tokenValue = text.slice(lastIndex))</span><br><span class="line">    tokens.push(<span class="built_in">JSON</span>.stringify(tokenValue))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    expression: tokens.join(<span class="string">'+'</span>),</span><br><span class="line">    tokens: rawTokens</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="genElement-1"><a href="#genElement-1" class="headerlink" title="genElement"></a>genElement</h2><p>è¿›å…¥åˆ° genIf ä¸­, åœ¨ genIfConditions é‡Œè·å– ast æ—¶æœŸå»ºç«‹çš„ IfConditions å¯¹è±¡ {exp, block} , å†è¿›è¡Œå±•å¼€</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (el.if &amp;&amp; !el.ifProcessed) &#123;</span><br><span class="line">  <span class="keyword">return</span> genIf(el, state)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// genIf</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">genIf</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  state: CodegenState,</span></span></span><br><span class="line"><span class="function"><span class="params">  altGen?: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  altEmpty?: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  el.ifProcessed = <span class="literal">true</span> <span class="comment">// avoid recursion</span></span><br><span class="line">  <span class="keyword">return</span> genIfConditions(el.ifConditions.slice(), state, altGen, altEmpty)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// genIfConditions</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genIfConditions</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  conditions: ASTIfConditions,</span></span></span><br><span class="line"><span class="function"><span class="params">  state: CodegenState,</span></span></span><br><span class="line"><span class="function"><span class="params">  altGen?: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  altEmpty?: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!conditions.length) &#123;</span><br><span class="line">    <span class="keyword">return</span> altEmpty || <span class="string">'_e()'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> condition = conditions.shift()</span><br><span class="line">  <span class="keyword">if</span> (condition.exp) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`(<span class="subst">$&#123;condition.exp&#125;</span>)?<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">      genTernaryExp(condition.block)</span></span></span><br><span class="line"><span class="string"><span class="subst">    &#125;</span>:<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">      genIfConditions(conditions, state, altGen, altEmpty)</span></span></span><br><span class="line"><span class="string"><span class="subst">    &#125;</span>`</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;genTernaryExp(condition.block)&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// v-if with v-once should generate code like (a)?_m(0):_m(1)</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">genTernaryExp</span> (<span class="params">el</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> altGen</span><br><span class="line">      ? altGen(el, state)</span><br><span class="line">      : el.once</span><br><span class="line">        ? genOnce(el, state)</span><br><span class="line">        : genElement(el, state)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createElement-1"><a href="#createElement-1" class="headerlink" title="createElement"></a>createElement</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(show)?_c(<span class="string">'div'</span>,[_v(_s(show ? <span class="string">'bad ass'</span> : <span class="string">'motherfucker'</span>))]):_e()</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆè·å–å˜é‡ show, åœ¨ vm çš„å±æ€§ä¸ŠæŸ¥æ‰¾, è§¦å‘ proxy ä»£ç†é€šè¿‡ proxyGetter è¯»å–æŒ‚è½½ vm ä¸Šçš„è¯¥å˜é‡, äºæ˜¯åœ¨ vm._data ä¸Šè¿›è¡Œè¯»å–è¯¥å˜é‡, ä»è€Œè§¦å‘è¯¥å˜é‡çš„å“åº”å¼ç³»ç»Ÿ, è¿›å…¥å±æ€§æ‹¦æˆª get, æ¥ç€æ£€æµ‹å½“å‰å…¨å±€æ˜¯å¦ç”± Dep.target, æ­£æ˜¯åˆå§‹åŒ–æ•´ä¸ªæœ€å¤–å±‚çš„ Watcher, é€šè¿‡ watcher å°†è¿™ä¸ªä¾èµ– dep æ·»åŠ è¿›ä¾èµ–æ”¶é›†å™¨, åŒæ—¶ä¾èµ– dep ä¹Ÿå°†å½“å‰çš„è§‚å¯Ÿè€…æ·»åŠ è¿› subs, å½“ç„¶ä¹Ÿå¯èƒ½ä¼šæœ‰å¾ˆå¤šä¸ªè§‚å¯Ÿè€…, åœ¨ get æ—¶å°†è¿™äº›éƒ½æ·»åŠ åˆ°è¢«è§‚å¯Ÿè€… dep ä¸‹, ç­‰å€™è¯¥æ•°æ®å˜åŠ¨å†é€šçŸ¥æ‰€æœ‰ watcher æ›´æ–°; æ·»åŠ å®Œä¾èµ–å, å¼¹å‡ºè·å¾—çš„å˜é‡å€¼, è¿›è¡Œä¸‹ä¸€ä¸ªå˜é‡çš„è·å–.</p>
<p>åœ¨è¯»å–å®Œå˜é‡å, å¼€å§‹æ‰§è¡Œä»£ç , ä» _s å¼€å§‹, ç”±é‡Œè‡³å¤–æ‰§è¡Œ, è¿™é‡Œçš„ä¸‰æ®µå¼ show ä¸º true, é‚£ä¹ˆå°±ä¼šå¯¹åº” â€˜bad assâ€™, æ¥ç€è¿›è¡Œ toString æ“ä½œ</p>
<p>ç»§ç»­è¿›è¡Œ _v, å°†åˆšæ‰è·å¾—çš„å­—ç¬¦ä¸²è½¬ä¸ºæ–‡æœ¬è™šæ‹ŸèŠ‚ç‚¹; æœ€ååˆ° _c, åˆ›å»ºå…ƒç´ è™šæ‹ŸèŠ‚ç‚¹, å…¶å­èŠ‚ç‚¹ä¸ºåˆšæ‰çš„æ–‡æœ¬è™šæ‹ŸèŠ‚ç‚¹</p>
<h2 id="createElm-1"><a href="#createElm-1" class="headerlink" title="createElm"></a>createElm</h2><p>è¿˜æ˜¯é¦–å…ˆç»™å½“å‰å­èŠ‚ç‚¹åˆ›å»ºçœŸå®èŠ‚ç‚¹æŒ‚åˆ° vnode.elm ä¸Š, æ¥ç€è¿›å…¥åˆ°åˆ›å»ºå½“å‰å­èŠ‚ç‚¹çš„å­èŠ‚ç‚¹, è€Œæ­¤æ—¶çš„ v-if èŠ‚ç‚¹å…¶å†…çš„å­èŠ‚ç‚¹æ¨¡æ¿å˜é‡å­—ç¬¦ä¸²å·²ç»åœ¨ createElement é˜¶æ®µç¡®å®šä¸‹æ¥äº†, æ­¤æ—¶ä¸ºå•çº¯çš„æ–‡æœ¬, å› æ­¤ä¹Ÿå°±åˆ›å»ºçœŸå®çš„æ–‡æœ¬èŠ‚ç‚¹, å† appendChild æ’å…¥åˆ°ä¸Šå±‚èŠ‚ç‚¹;</p>
<p>è€Œ v-if åœ¨ render æ‰§è¡Œä»£ç é˜¶æ®µå°±å·²ç»è¯»å–åˆ° if åè¾¹çš„å€¼äº†, ç¡®å®šä¸‹æ¥æ˜¾ç¤ºä¸æ˜¾ç¤º, å…¶ä»–ä¸ç›¸å…³çš„å±æ€§å°±æ­£å¸¸åŒæ­¥; å®Œæˆåå°†è¯¥èŠ‚ç‚¹æ’å…¥åˆ°æ ¹èŠ‚ç‚¹ä¸‹</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vnode.elm = vnode.ns</span><br><span class="line">  ? nodeOps.createElementNS(vnode.ns, tag)</span><br><span class="line">  : nodeOps.createElement(tag, vnode)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">createChildren(vnode, children, insertedVnodeQueue)</span><br><span class="line"><span class="keyword">if</span> (isDef(data)) &#123;</span><br><span class="line">  invokeCreateHooks(vnode, insertedVnodeQueue)</span><br><span class="line">&#125;</span><br><span class="line">insert(parentElm, vnode.elm, refElm) <span class="comment">// æŠŠ DOM æ’å…¥åˆ°çˆ¶èŠ‚ç‚¹ä¸­</span></span><br></pre></td></tr></table></figure>
<h1 id="v-for"><a href="#v-for" class="headerlink" title="v-for"></a>v-for</h1><p>v-for çš„ç¼–è¯‘å·¥ä½œåŒä¸Š, åœ¨ parse å®Œæˆåå¾—åˆ° AST æ ‘ä¸º:</p>
<p>å› ä¸ºæ˜¯ li æ ‡ç­¾æ¥æ‰§è¡Œ v-for, å¤–è¾¹è¿˜å¥—äº†ä¸€å±‚ ul, æ‰€ä»¥æ­¤æ—¶çš„æ ¹èŠ‚ç‚¹å°±æ˜¯ ul, å®ƒçš„ parent ä¹Ÿå°±æ˜¯ app; children é‡Œæ˜¯ä¸‹ä¸€çº§èŠ‚ç‚¹, ä¹Ÿå°±æ˜¯ li, è¿™é‡Œæ–°å¢äº† alias å±æ€§, for å±æ€§, key å±æ€§, å‡æ˜¯åœ¨ processFor ä¸­</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  attrsList:(<span class="number">0</span>) []</span><br><span class="line">  attrsMap:&#123;&#125;</span><br><span class="line">  children:(<span class="number">1</span>) [&#123;â€¦&#125;]</span><br><span class="line">    <span class="number">0</span>: &#123;</span><br><span class="line">      alias:<span class="string">'food'</span></span><br><span class="line">      attrsList:(<span class="number">0</span>) []</span><br><span class="line">      attrsMap:&#123;v-<span class="keyword">for</span>: <span class="string">'food in foodList'</span>, :key: <span class="string">'food.name'</span>&#125;</span><br><span class="line">      children:(<span class="number">1</span>) [&#123;â€¦&#125;]</span><br><span class="line">        <span class="number">0</span>: &#123;</span><br><span class="line">          end:<span class="number">277</span></span><br><span class="line">          expression:<span class="string">'_s(food.name)+"ï¼šï¿¥ "+_s(food.price)'</span></span><br><span class="line">          start:<span class="number">249</span></span><br><span class="line">          text:<span class="string">'$[food.name]ï¼šï¿¥ $[food.price]'</span></span><br><span class="line">          tokens:(<span class="number">3</span>) [&#123;â€¦&#125;, <span class="string">'ï¼šï¿¥ '</span>, &#123;â€¦&#125;]</span><br><span class="line">            <span class="number">0</span>:&#123;@binding: <span class="string">'food.name'</span>&#125;</span><br><span class="line">            <span class="number">1</span>:<span class="string">'ï¼šï¿¥ '</span></span><br><span class="line">            <span class="number">2</span>:&#123;@binding: <span class="string">'food.price'</span>&#125;</span><br><span class="line">          type:<span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">      end:<span class="number">282</span></span><br><span class="line">      <span class="keyword">for</span>:<span class="string">'foodList'</span></span><br><span class="line">      key:<span class="string">'food.name'</span></span><br><span class="line">      parent:&#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">'ul'</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">0</span>), <span class="attr">attrsMap</span>: &#123;â€¦&#125;, <span class="attr">rawAttrsMap</span>: &#123;â€¦&#125;, â€¦&#125;</span><br><span class="line">      plain:<span class="literal">false</span></span><br><span class="line">      rawAttrsMap:&#123;v-<span class="keyword">for</span>: &#123;â€¦&#125;, :key: &#123;â€¦&#125;&#125;</span><br><span class="line">      start:<span class="number">203</span></span><br><span class="line">      tag:<span class="string">'li'</span></span><br><span class="line">      type:<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  rawAttrsMap:&#123;&#125;</span><br><span class="line">  plain:<span class="literal">true</span></span><br><span class="line">  parent:&#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">'div'</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">attrsMap</span>: &#123;â€¦&#125;, â€¦&#125;</span><br><span class="line">  end:<span class="number">296</span></span><br><span class="line">  start:<span class="number">186</span></span><br><span class="line">  plain:<span class="literal">true</span></span><br><span class="line">  rawAttrsMap:&#123;&#125;</span><br><span class="line">  tag:<span class="string">'ul'</span></span><br><span class="line">  type:<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="processFor"><a href="#processFor" class="headerlink" title="processFor"></a>processFor</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">processFor</span> (<span class="params">el: ASTElement</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> exp</span><br><span class="line">  <span class="keyword">if</span> ((exp = getAndRemoveAttr(el, <span class="string">'v-for'</span>))) &#123;</span><br><span class="line">    <span class="keyword">const</span> res = parseFor(exp)</span><br><span class="line">    <span class="keyword">if</span> (res) &#123;</span><br><span class="line">      extend(el, res)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`Invalid v-for expression: <span class="subst">$&#123;exp&#125;</span>`</span>,</span><br><span class="line">        el.rawAttrsMap[<span class="string">'v-for'</span>]</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="parseFor"><a href="#parseFor" class="headerlink" title="parseFor"></a>parseFor</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">parseFor</span> (<span class="params">exp: string</span>): ?<span class="title">ForParseResult</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> inMatch = exp.match(forAliasRE)</span><br><span class="line">  <span class="keyword">if</span> (!inMatch) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">const</span> res = &#123;&#125;</span><br><span class="line">  res.for = inMatch[<span class="number">2</span>].trim()</span><br><span class="line">  <span class="keyword">const</span> alias = inMatch[<span class="number">1</span>].trim().replace(stripParensRE, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">const</span> iteratorMatch = alias.match(forIteratorRE)</span><br><span class="line">  <span class="keyword">if</span> (iteratorMatch) &#123;</span><br><span class="line">    res.alias = alias.replace(forIteratorRE, <span class="string">''</span>).trim()</span><br><span class="line">    res.iterator1 = iteratorMatch[<span class="number">1</span>].trim()</span><br><span class="line">    <span class="keyword">if</span> (iteratorMatch[<span class="number">2</span>]) &#123;</span><br><span class="line">      res.iterator2 = iteratorMatch[<span class="number">2</span>].trim()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.alias = alias</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="genFor"><a href="#genFor" class="headerlink" title="genFor"></a>genFor</h2><p>æ‰§è¡Œåˆ° genFor åˆ™ä¼šç›´æ¥è¿”å›å†…å®¹, ä¸ä¼šå†å‘ä¸‹æ‰§è¡Œ, genFor å†…éƒ¨ä¼šè¯»å–ä¹‹å‰çš„ ast æ ‘æ·»åŠ çš„ for, ä¸ _l æ‹¼æ¥åœ¨ä¸€èµ·, â€˜_l((${exp}), function(key) â€˜ ; ä¹‹åç›´æ¥ genElement ç»§ç»­å¤„ç†å…¶ä»–å±æ€§, ä»¥åŠ children, ä¸”åœ¨ genFor çš„æ—¶å€™, æ”¹å˜ forProcessed ä¸º true, åˆ™åœ¨å†æ¬¡è°ƒç”¨ genElement æ—¶ä¸ä¼šé‡å¤æ‰§è¡Œ genFor; æŒ‰ä¾‹ä¸­ç»§ç»­ç”Ÿæˆ children çš„ä»£ç , ç»§è€Œè¿”å›.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">genFor</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  state: CodegenState,</span></span></span><br><span class="line"><span class="function"><span class="params">  altGen?: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  altHelper?: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> exp = el.for</span><br><span class="line">  <span class="keyword">const</span> alias = el.alias</span><br><span class="line">  <span class="keyword">const</span> iterator1 = el.iterator1 ? <span class="string">`,<span class="subst">$&#123;el.iterator1&#125;</span>`</span> : <span class="string">''</span></span><br><span class="line">  <span class="keyword">const</span> iterator2 = el.iterator2 ? <span class="string">`,<span class="subst">$&#123;el.iterator2&#125;</span>`</span> : <span class="string">''</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">    state.maybeComponent(el) &amp;&amp;</span><br><span class="line">    el.tag !== <span class="string">'slot'</span> &amp;&amp;</span><br><span class="line">    el.tag !== <span class="string">'template'</span> &amp;&amp;</span><br><span class="line">    !el.key</span><br><span class="line">  ) &#123;</span><br><span class="line">    state.warn(</span><br><span class="line">      <span class="string">`&lt;<span class="subst">$&#123;el.tag&#125;</span> v-for="<span class="subst">$&#123;alias&#125;</span> in <span class="subst">$&#123;exp&#125;</span>"&gt;: component lists rendered with `</span> +</span><br><span class="line">      <span class="string">`v-for should have explicit keys. `</span> +</span><br><span class="line">      <span class="string">`See https://vuejs.org/guide/list.html#key for more info.`</span>,</span><br><span class="line">      el.rawAttrsMap[<span class="string">'v-for'</span>],</span><br><span class="line">      <span class="literal">true</span> <span class="comment">/* tip */</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  el.forProcessed = <span class="literal">true</span> <span class="comment">// avoid recursion</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;altHelper || <span class="string">'_l'</span>&#125;</span>((<span class="subst">$&#123;exp&#125;</span>),`</span> +</span><br><span class="line">    <span class="string">`function(<span class="subst">$&#123;alias&#125;</span><span class="subst">$&#123;iterator1&#125;</span><span class="subst">$&#123;iterator2&#125;</span>)&#123;`</span> +</span><br><span class="line">      <span class="string">`return <span class="subst">$&#123;(altGen || genElement)(el, state)&#125;</span>`</span> +</span><br><span class="line">    <span class="string">'&#125;)'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="genData-1"><a href="#genData-1" class="headerlink" title="genData"></a>genData</h2><p>li çš„ ast æ ‘ä¸Šæœ‰ key, å› æ­¤ genData æ—¶ä¼šæ‰§è¡Œåˆ°ä¸‹è¾¹å†…å®¹</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// key</span></span><br><span class="line"><span class="keyword">if</span> (el.key) &#123;</span><br><span class="line">  data += <span class="string">`key:<span class="subst">$&#123;el.key&#125;</span>,`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createElement-2"><a href="#createElement-2" class="headerlink" title="createElement"></a>createElement</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_c(<span class="string">'ul'</span>,_l((foodList),<span class="function"><span class="keyword">function</span>(<span class="params">food</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> _c(<span class="string">'li'</span>,&#123;<span class="attr">key</span>:food.name&#125;,[</span><br><span class="line">    _v(_s(food.name)+<span class="string">"ï¼šï¿¥ "</span>+_s(food.price))</span><br><span class="line">  ])</span><br><span class="line">&#125;),<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>æ¥ç€ä¸Šè¾¹åˆ›å»ºå¥½çš„å‡½æ•°, ä¾æ¬¡è¯»å–å˜é‡ _c, _l, foodList, ç„¶åç”±å†…è€Œå¤–æ‰§è¡Œ.</p>
<h2 id="renderList"><a href="#renderList" class="headerlink" title="renderList"></a>renderList</h2><p>v-for ä½¿ç”¨ _l æ¥æ¸²æŸ“åˆ—è¡¨, éå†ç¬¬ä¸€ä¸ªå‚æ•° foodList, å°†å…ƒç´ ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°å‡½æ•°, å€Ÿ render å‡½æ•°ä½¿æ¯ä¸ªå…ƒç´ å¯¹åº”ç”Ÿæˆä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹;</p>
<p>ä¾æ®ä¸Šè¾¹çš„ li èŠ‚ç‚¹, åœ¨è·å–äº† _s, ä»¥åŠ food.name/food.price å, å°†ä¸¤ä¸ªå˜é‡è½¬æˆå­—ç¬¦ä¸²å¹¶åˆå¹¶åœ¨ä¸€èµ·, ç”¨ _v æ¥ç”Ÿæˆæ–‡æœ¬èŠ‚ç‚¹; æ¥ç€ _c å½“å‰çš„ li èŠ‚ç‚¹, æ ¹æ® â€˜liâ€™, å±æ€§ data, å…¶ children ä¸‰ä¸ªå‚æ•°æ¥åˆ›å»º li çš„è™šæ‹ŸèŠ‚ç‚¹; </p>
<p>å¦‚æ­¤éå†å®Œ foodList, å°±å¾—åˆ°ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹çš„æ•°ç»„, ç»™æ ‡è®° _isVList = true, ä½œä¸º ul çš„ chilren</p>
<p>æ¥ç€å›åˆ° ul çš„ _c æ—¶åˆ», å…¶å®å°±æ˜¯æŒ‰æ™®é€šçš„å†…ç½®å…ƒç´ åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹, ä¸‹è¾¹ children æœ‰å‡ ä¸ª li çš„è™šæ‹ŸèŠ‚ç‚¹</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">renderList</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  val: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  render: (</span></span></span><br><span class="line"><span class="function"><span class="params">    val: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    keyOrIndex: string | number,</span></span></span><br><span class="line"><span class="function"><span class="params">    index?: number</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) =&gt; <span class="title">VNode</span></span></span><br><span class="line"><span class="function">): ?<span class="title">Array</span>&lt;<span class="title">VNode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> ret: ?<span class="built_in">Array</span>&lt;VNode&gt;, i, l, keys, key</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(val) || <span class="keyword">typeof</span> val === <span class="string">'string'</span>) &#123;</span><br><span class="line">    ret = <span class="keyword">new</span> <span class="built_in">Array</span>(val.length)</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, l = val.length; i &lt; l; i++) &#123;</span><br><span class="line">      ret[i] = render(val[i], i)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> val === <span class="string">'number'</span>) &#123;</span><br><span class="line">    ret = <span class="keyword">new</span> <span class="built_in">Array</span>(val)</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; val; i++) &#123;</span><br><span class="line">      ret[i] = render(i + <span class="number">1</span>, i)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isObject(val)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hasSymbol &amp;&amp; val[<span class="built_in">Symbol</span>.iterator]) &#123;</span><br><span class="line">      ret = []</span><br><span class="line">      <span class="keyword">const</span> iterator: Iterator&lt;any&gt; = val[<span class="built_in">Symbol</span>.iterator]()</span><br><span class="line">      <span class="keyword">let</span> result = iterator.next()</span><br><span class="line">      <span class="keyword">while</span> (!result.done) &#123;</span><br><span class="line">        ret.push(render(result.value, ret.length))</span><br><span class="line">        result = iterator.next()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      keys = <span class="built_in">Object</span>.keys(val)</span><br><span class="line">      ret = <span class="keyword">new</span> <span class="built_in">Array</span>(keys.length)</span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>, l = keys.length; i &lt; l; i++) &#123;</span><br><span class="line">        key = keys[i]</span><br><span class="line">        ret[i] = render(val[key], key, i)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!isDef(ret)) &#123;</span><br><span class="line">    ret = []</span><br><span class="line">  &#125;</span><br><span class="line">  (ret: any)._isVList = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createElm-2"><a href="#createElm-2" class="headerlink" title="createElm"></a>createElm</h2><p>v-for èŠ‚ç‚¹çš„çˆ¶çº§è®¾ç½®äº† ul, å› è€Œåœ¨èµ°åˆ° li æ—¶, æ‰èƒ½çœ‹åˆ°æœ‰ v-for çš„ä¸€äº›ç‰¹æ€§, ä½†å…¶å®ä¹Ÿæ²¡ä»€ä¹ˆç‰¹åˆ«;</p>
<p>ä¼šåœ¨ checkDuplicateKeys é‡Œæ£€æŸ¥æ¯ä¸ª li ä¸Šçš„ key æ˜¯å¦æœ‰å†²çª; æ­¤åå†æ¸²æŸ“å‡º li çš„çœŸå®èŠ‚ç‚¹, å®ƒçš„å­èŠ‚ç‚¹ä¹Ÿæ˜¯å·²ç»å‡†å¤‡å¥½çš„æ–‡æœ¬èŠ‚ç‚¹, ç›´æ¥åˆ›å»ºçœŸå®çš„æ–‡æœ¬èŠ‚ç‚¹, å†æ·»åŠ åˆ° li ä¸Š, éå† ul çš„ children, æŠŠæ‰€æœ‰ li éƒ½åˆ›å»ºå®Œ æŒ‚åœ¨ ul ä¸Š; å†æŠŠ ul æŒ‚è½½åˆ°ä¸Šä¸€çº§</p>
<h1 id="v-model"><a href="#v-model" class="headerlink" title="v-model"></a>v-model</h1><p>v-model æ”¾åœ¨ input ä¸Šè¿›è¡Œæ•°æ®åŒå‘ç»‘å®šï¼Œinput å¤–è¾¹è£¹äº†ä¸€å±‚ div</p>
<h2 id="processAttrs-1"><a href="#processAttrs-1" class="headerlink" title="processAttrs"></a>processAttrs</h2><p>parse åç”Ÿæˆçš„ AST æ ‘å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  attrsList:(<span class="number">1</span>) [&#123;â€¦&#125;]</span><br><span class="line">    <span class="number">0</span>:&#123;<span class="attr">name</span>: <span class="string">'v-model'</span>, <span class="attr">value</span>: <span class="string">'text'</span>, <span class="attr">start</span>: <span class="number">342</span>, <span class="attr">end</span>: <span class="number">356</span>&#125;</span><br><span class="line">  attrsMap:&#123;v-model: <span class="string">'text'</span>&#125;</span><br><span class="line">  children:(<span class="number">0</span>) []</span><br><span class="line">  directives: (<span class="number">1</span>) [&#123;â€¦&#125;]</span><br><span class="line">    <span class="number">0</span>: &#123;</span><br><span class="line">      arg:<span class="literal">null</span></span><br><span class="line">      end:<span class="number">356</span></span><br><span class="line">      isDynamicArg:<span class="literal">false</span></span><br><span class="line">      modifiers:<span class="literal">undefined</span></span><br><span class="line">      name:<span class="string">'model'</span></span><br><span class="line">      rawName:<span class="string">'v-model'</span></span><br><span class="line">      start:<span class="number">342</span></span><br><span class="line">      value:<span class="string">'text'</span></span><br><span class="line">    &#125;</span><br><span class="line">  plain:<span class="literal">false</span></span><br><span class="line">  rawAttrsMap:&#123;v-model: &#123;â€¦&#125;&#125;</span><br><span class="line">    v-model:&#123;<span class="attr">name</span>: <span class="string">'v-model'</span>, <span class="attr">value</span>: <span class="string">'text'</span>, <span class="attr">start</span>: <span class="number">342</span>, <span class="attr">end</span>: <span class="number">356</span>&#125;</span><br><span class="line">  start:<span class="number">335</span></span><br><span class="line">  tag:<span class="string">'input'</span></span><br><span class="line">  type:<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="genDirectives"><a href="#genDirectives" class="headerlink" title="genDirectives"></a>genDirectives</h2><p>model ä¼šç»™ ast æ ‘åŠ ä¸Š directives å±æ€§, æ¥æè¿° model, ç»è¿‡ genDefaultModel, å®Œæˆäº† model æŒ‡ä»¤å¯¹åº” value çš„ dom å±æ€§ç»‘å®šä»¥åŠ input äº‹ä»¶ç»‘å®š, å¾—åˆ° </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">directives:[&#123;<span class="attr">name</span>:<span class="string">"model"</span>,<span class="attr">rawName</span>:<span class="string">"v-model"</span>,<span class="attr">value</span>:(text),<span class="attr">expression</span>:<span class="string">"text"</span>&#125;,]</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genDirectives</span> (<span class="params">el: ASTElement, state: CodegenState</span>): <span class="title">string</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dirs = el.directives</span><br><span class="line">  <span class="keyword">if</span> (!dirs) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">let</span> res = <span class="string">'directives:['</span></span><br><span class="line">  <span class="keyword">let</span> hasRuntime = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> i, l, dir, needRuntime</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>, l = dirs.length; i &lt; l; i++) &#123;</span><br><span class="line">    dir = dirs[i]</span><br><span class="line">    needRuntime = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> gen: DirectiveFunction = state.directives[dir.name]</span><br><span class="line">    <span class="keyword">if</span> (gen) &#123;</span><br><span class="line">      <span class="comment">// compile-time directive that manipulates AST.</span></span><br><span class="line">      <span class="comment">// returns true if it also needs a runtime counterpart.</span></span><br><span class="line">      needRuntime = !!gen(el, dir, state.warn)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (needRuntime) &#123;</span><br><span class="line">      hasRuntime = <span class="literal">true</span></span><br><span class="line">      res += <span class="string">`&#123;name:"<span class="subst">$&#123;dir.name&#125;</span>",rawName:"<span class="subst">$&#123;dir.rawName&#125;</span>"<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">        dir.value ? <span class="string">`,value:(<span class="subst">$&#123;dir.value&#125;</span>),expression:<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(dir.value)&#125;</span>`</span> : <span class="string">''</span></span></span></span><br><span class="line"><span class="string"><span class="subst">      &#125;</span><span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">        dir.arg ? <span class="string">`,arg:<span class="subst">$&#123;dir.isDynamicArg ? dir.arg : <span class="string">`"<span class="subst">$&#123;dir.arg&#125;</span>"`</span>&#125;</span>`</span> : <span class="string">''</span></span></span></span><br><span class="line"><span class="string"><span class="subst">      &#125;</span><span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">        dir.modifiers ? <span class="string">`,modifiers:<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(dir.modifiers)&#125;</span>`</span> : <span class="string">''</span></span></span></span><br><span class="line"><span class="string"><span class="subst">      &#125;</span>&#125;,`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (hasRuntime) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.slice(<span class="number">0</span>, <span class="number">-1</span>) + <span class="string">']'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="genDefaultModel"><a href="#genDefaultModel" class="headerlink" title="genDefaultModel"></a>genDefaultModel</h3><p>æ‰§è¡Œ genAssignmentCode åè·å¾—çš„ä»£ç , æ‹¼æ¥åœ¨ <code>if($event.target.composing)return;</code> å…¶å; </p>
<p>æ¥ç€è°ƒç”¨ addProp å°† value æ·»åŠ ä¸º dom å±æ€§ <code>props [{name: &#39;value&#39;, value: &#39;(text)&#39;, dynamic: undefined}]</code>;</p>
<p>ç»§ç»­è°ƒç”¨ addHandler å°† input è¾“å…¥äº‹ä»¶æ·»åŠ è¿›å½“å‰ ast èŠ‚ç‚¹, <code>events: {input:{value: &#39;if($event.target.composing)return;text=$event.target.value&#39;, dynamic: undefined}}</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genDefaultModel</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el: ASTElement,</span></span></span><br><span class="line"><span class="function"><span class="params">  value: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  modifiers: ?ASTModifiers</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): ?<span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> type = el.attrsMap.type</span><br><span class="line"></span><br><span class="line">  <span class="comment">// warn if v-bind:value conflicts with v-model</span></span><br><span class="line">  <span class="comment">// except for inputs with v-bind:type</span></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> value = el.attrsMap[<span class="string">'v-bind:value'</span>] || el.attrsMap[<span class="string">':value'</span>]</span><br><span class="line">    <span class="keyword">const</span> typeBinding = el.attrsMap[<span class="string">'v-bind:type'</span>] || el.attrsMap[<span class="string">':type'</span>]</span><br><span class="line">    <span class="keyword">if</span> (value &amp;&amp; !typeBinding) &#123;</span><br><span class="line">      <span class="keyword">const</span> binding = el.attrsMap[<span class="string">'v-bind:value'</span>] ? <span class="string">'v-bind:value'</span> : <span class="string">':value'</span></span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`<span class="subst">$&#123;binding&#125;</span>="<span class="subst">$&#123;value&#125;</span>" conflicts with v-model on the same element `</span> +</span><br><span class="line">        <span class="string">'because the latter already expands to a value binding internally'</span>,</span><br><span class="line">        el.rawAttrsMap[binding]</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; lazy, number, trim &#125; = modifiers || &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> needCompositionGuard = !lazy &amp;&amp; type !== <span class="string">'range'</span></span><br><span class="line">  <span class="keyword">const</span> event = lazy</span><br><span class="line">    ? <span class="string">'change'</span></span><br><span class="line">    : type === <span class="string">'range'</span></span><br><span class="line">      ? RANGE_TOKEN</span><br><span class="line">      : <span class="string">'input'</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> valueExpression = <span class="string">'$event.target.value'</span></span><br><span class="line">  <span class="keyword">if</span> (trim) &#123;</span><br><span class="line">    valueExpression = <span class="string">`$event.target.value.trim()`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (number) &#123;</span><br><span class="line">    valueExpression = <span class="string">`_n(<span class="subst">$&#123;valueExpression&#125;</span>)`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> code = genAssignmentCode(value, valueExpression)</span><br><span class="line">  <span class="keyword">if</span> (needCompositionGuard) &#123;</span><br><span class="line">    code = <span class="string">`if($event.target.composing)return;<span class="subst">$&#123;code&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  addProp(el, <span class="string">'value'</span>, <span class="string">`(<span class="subst">$&#123;value&#125;</span>)`</span>)</span><br><span class="line">  addHandler(el, event, code, <span class="literal">null</span>, <span class="literal">true</span>)</span><br><span class="line">  <span class="keyword">if</span> (trim || number) &#123;</span><br><span class="line">    addHandler(el, <span class="string">'blur'</span>, <span class="string">'$forceUpdate()'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="genAssignmentCode"><a href="#genAssignmentCode" class="headerlink" title="genAssignmentCode"></a>genAssignmentCode</h3><p>è§£æ model å, çœ‹è¿”å›çš„ç»“æœ key æ˜¯å¦å­˜åœ¨, ç„¶åä¸ä¼ å…¥çš„å‚æ•° valueExpression è¿›è¡Œæ‹¼æ¥, å®é™…ä¸Šä¹Ÿæ˜¯ input è¾“å…¥äº‹ä»¶è·å–åˆ°çš„å€¼, åŒæ­¥åˆ°è¿™é‡Œ,  â€˜textâ€™=â€™$event.target.valueâ€™</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">genAssignmentCode</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  value: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  assignment: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = parseModel(value)</span><br><span class="line">  <span class="keyword">if</span> (res.key === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;value&#125;</span>=<span class="subst">$&#123;assignment&#125;</span>`</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`$set(<span class="subst">$&#123;res.exp&#125;</span>, <span class="subst">$&#123;res.key&#125;</span>, <span class="subst">$&#123;assignment&#125;</span>)`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="parseModel"><a href="#parseModel" class="headerlink" title="parseModel"></a>parseModel</h3><p>è§£æ model ç»‘å®šçš„å˜é‡, è¿”å›ä¸€ä¸ªå¯¹è±¡ {exp: â€˜textâ€™, key: null}</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">parseModel</span> (<span class="params">val: string</span>): <span class="title">ModelParseResult</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Fix https://github.com/vuejs/vue/pull/7730</span></span><br><span class="line">  <span class="comment">// allow v-model="obj.val " (trailing whitespace)</span></span><br><span class="line">  val = val.trim()</span><br><span class="line">  len = val.length</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (val.indexOf(<span class="string">'['</span>) &lt; <span class="number">0</span> || val.lastIndexOf(<span class="string">']'</span>) &lt; len - <span class="number">1</span>) &#123;</span><br><span class="line">    index = val.lastIndexOf(<span class="string">'.'</span>)</span><br><span class="line">    <span class="keyword">if</span> (index &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        exp: val.slice(<span class="number">0</span>, index),</span><br><span class="line">        key: <span class="string">'"'</span> + val.slice(index + <span class="number">1</span>) + <span class="string">'"'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        exp: val,</span><br><span class="line">        key: <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  str = val</span><br><span class="line">  index = expressionPos = expressionEndPos = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (!eof()) &#123;</span><br><span class="line">    chr = next()</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (isStringStart(chr)) &#123;</span><br><span class="line">      parseString(chr)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (chr === <span class="number">0x5B</span>) &#123;</span><br><span class="line">      parseBracket(chr)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    exp: val.slice(<span class="number">0</span>, expressionPos),</span><br><span class="line">    key: val.slice(expressionPos + <span class="number">1</span>, expressionEndPos)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="genProps"><a href="#genProps" class="headerlink" title="genProps"></a>genProps</h2><p>ç»è¿‡ genDirectives, ç»™å½“å‰èŠ‚ç‚¹çš„ ast æ ‘æŒ‚ä¸Šäº† props å±æ€§, ç”¨æ¥æè¿° model å¯¹åº”çš„ value, åˆ¤æ–­æ˜¯é™æ€å±æ€§è¿˜æ˜¯åŠ¨æ€å±æ€§, æœ€ç»ˆå¾—åˆ° <code>domProps:{&quot;value&quot;:(text)},</code> , ä¸ä¹‹å‰çš„æŒ‡ä»¤è¿›è¡Œæ‹¼æ¥; </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DOM props</span></span><br><span class="line"><span class="keyword">if</span> (el.props) &#123;</span><br><span class="line">  data += <span class="string">`domProps:<span class="subst">$&#123;genProps(el.props)&#125;</span>,`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// genProps</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genProps</span> (<span class="params">props: Array&lt;ASTAttr&gt;</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> staticProps = <span class="string">``</span></span><br><span class="line">  <span class="keyword">let</span> dynamicProps = <span class="string">``</span> <span class="comment">// åŠ¨æ€çš„</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; props.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> prop = props[i]</span><br><span class="line">    <span class="keyword">const</span> value = __WEEX__</span><br><span class="line">      ? generateValue(prop.value)</span><br><span class="line">      : transformSpecialNewlines(prop.value)</span><br><span class="line">    <span class="keyword">if</span> (prop.dynamic) &#123;</span><br><span class="line">      dynamicProps += <span class="string">`<span class="subst">$&#123;prop.name&#125;</span>,<span class="subst">$&#123;value&#125;</span>,`</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      staticProps += <span class="string">`"<span class="subst">$&#123;prop.name&#125;</span>":<span class="subst">$&#123;value&#125;</span>,`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  staticProps = <span class="string">`&#123;<span class="subst">$&#123;staticProps.slice(<span class="number">0</span>, <span class="number">-1</span>)&#125;</span>&#125;`</span></span><br><span class="line">  <span class="keyword">if</span> (dynamicProps) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`_d(<span class="subst">$&#123;staticProps&#125;</span>,[<span class="subst">$&#123;dynamicProps.slice(<span class="number">0</span>, <span class="number">-1</span>)&#125;</span>])`</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> staticProps</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="genHandlers-1"><a href="#genHandlers-1" class="headerlink" title="genHandlers"></a>genHandlers</h2><p>ç»è¿‡ genDirectives, ç»™å½“å‰èŠ‚ç‚¹çš„ ast æ ‘æŒ‚ä¸Šäº† events å±æ€§, ç”¨æ¥æè¿° model å¯¹åº”çš„è¾“å…¥äº‹ä»¶, å°† model äº‹ä»¶çš„ value åŠ å…¥å‡½æ•°, æ¥ç€ç»‘å®š input, ä¹Ÿå°±æ˜¯è¯´ input äº‹ä»¶çš„ç›‘å¬å‡½æ•°å°±æ˜¯ value çš„å˜åŠ¨: </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// äº‹ä»¶çš„ prefix</span></span><br><span class="line">on: &#123;<span class="string">"input"</span>:<span class="function"><span class="keyword">function</span>(<span class="params">$event</span>)</span>&#123;<span class="keyword">if</span>($event.target.composing)<span class="keyword">return</span>;text=$event.target.value&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åå°† directives props events çš„ä»£ç æ‹¼æ¥èµ·æ¥:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_c(<span class="string">'input'</span>,&#123;<span class="attr">directives</span>:[&#123;<span class="attr">name</span>:<span class="string">"model"</span>,<span class="attr">rawName</span>:<span class="string">"v-model"</span>,<span class="attr">value</span>:(text),<span class="attr">expression</span>:<span class="string">"text"</span>&#125;],<span class="attr">domProps</span>:&#123;<span class="string">"value"</span>:(text)&#125;,<span class="attr">on</span>:&#123;<span class="string">"input"</span>:<span class="function"><span class="keyword">function</span>(<span class="params">$event</span>)</span>&#123;<span class="keyword">if</span>($event.target.composing)<span class="keyword">return</span>;text=$event.target.value&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event handlers</span></span><br><span class="line"><span class="keyword">if</span> (el.events) &#123;</span><br><span class="line">  data += <span class="string">`<span class="subst">$&#123;genHandlers(el.events, <span class="literal">false</span>)&#125;</span>,`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// genHandlers</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">genHandlers</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  events: ASTElementHandlers,</span></span></span><br><span class="line"><span class="function"><span class="params">  isNative: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prefix = isNative ? <span class="string">'nativeOn:'</span> : <span class="string">'on:'</span></span><br><span class="line">  <span class="keyword">let</span> staticHandlers = <span class="string">``</span></span><br><span class="line">  <span class="keyword">let</span> dynamicHandlers = <span class="string">``</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> name <span class="keyword">in</span> events) &#123;</span><br><span class="line">    <span class="keyword">const</span> handlerCode = genHandler(events[name])</span><br><span class="line">    <span class="keyword">if</span> (events[name] &amp;&amp; events[name].dynamic) &#123;</span><br><span class="line">      dynamicHandlers += <span class="string">`<span class="subst">$&#123;name&#125;</span>,<span class="subst">$&#123;handlerCode&#125;</span>,`</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      staticHandlers += <span class="string">`"<span class="subst">$&#123;name&#125;</span>":<span class="subst">$&#123;handlerCode&#125;</span>,`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  staticHandlers = <span class="string">`&#123;<span class="subst">$&#123;staticHandlers.slice(<span class="number">0</span>, <span class="number">-1</span>)&#125;</span>&#125;`</span></span><br><span class="line">  <span class="keyword">if</span> (dynamicHandlers) &#123;</span><br><span class="line">    <span class="keyword">return</span> prefix + <span class="string">`_d(<span class="subst">$&#123;staticHandlers&#125;</span>,[<span class="subst">$&#123;dynamicHandlers.slice(<span class="number">0</span>, <span class="number">-1</span>)&#125;</span>])`</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> prefix + staticHandlers</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// genHandler</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genHandler</span> (<span class="params">handler: ASTElementHandler | Array&lt;ASTElementHandler&gt;</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!handler) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'function()&#123;&#125;'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(handler)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`[<span class="subst">$&#123;handler.map(handler =&gt; genHandler(handler)).join(<span class="string">','</span>)&#125;</span>]`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> isMethodPath = simplePathRE.test(handler.value)</span><br><span class="line">  <span class="keyword">const</span> isFunctionExpression = fnExpRE.test(handler.value)</span><br><span class="line">  <span class="keyword">const</span> isFunctionInvocation = simplePathRE.test(handler.value.replace(fnInvokeRE, <span class="string">''</span>))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!handler.modifiers) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isMethodPath || isFunctionExpression) &#123;</span><br><span class="line">      <span class="keyword">return</span> handler.value</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (__WEEX__ &amp;&amp; handler.params) &#123;</span><br><span class="line">      <span class="keyword">return</span> genWeexHandler(handler.params, handler.value)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`function($event)&#123;<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">      isFunctionInvocation ? <span class="string">`return <span class="subst">$&#123;handler.value&#125;</span>`</span> : handler.value</span></span></span><br><span class="line"><span class="string"><span class="subst">    &#125;</span>&#125;`</span> <span class="comment">// inline statement</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> code = <span class="string">''</span></span><br><span class="line">    <span class="keyword">let</span> genModifierCode = <span class="string">''</span></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> handler.modifiers) &#123;</span><br><span class="line">      <span class="keyword">if</span> (modifierCode[key]) &#123;</span><br><span class="line">        genModifierCode += modifierCode[key]</span><br><span class="line">        <span class="comment">// left/right</span></span><br><span class="line">        <span class="keyword">if</span> (keyCodes[key]) &#123;</span><br><span class="line">          keys.push(key)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key === <span class="string">'exact'</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> modifiers: ASTModifiers = (handler.modifiers: any)</span><br><span class="line">        genModifierCode += genGuard(</span><br><span class="line">          [<span class="string">'ctrl'</span>, <span class="string">'shift'</span>, <span class="string">'alt'</span>, <span class="string">'meta'</span>]</span><br><span class="line">            .filter(<span class="function"><span class="params">keyModifier</span> =&gt;</span> !modifiers[keyModifier])</span><br><span class="line">            .map(<span class="function"><span class="params">keyModifier</span> =&gt;</span> <span class="string">`$event.<span class="subst">$&#123;keyModifier&#125;</span>Key`</span>)</span><br><span class="line">            .join(<span class="string">'||'</span>)</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        keys.push(key)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (keys.length) &#123;</span><br><span class="line">      code += genKeyFilter(keys)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Make sure modifiers like prevent and stop get executed after key filtering</span></span><br><span class="line">    <span class="keyword">if</span> (genModifierCode) &#123;</span><br><span class="line">      code += genModifierCode</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> handlerCode = isMethodPath</span><br><span class="line">      ? <span class="string">`return <span class="subst">$&#123;handler.value&#125;</span>.apply(null, arguments)`</span></span><br><span class="line">      : isFunctionExpression</span><br><span class="line">        ? <span class="string">`return (<span class="subst">$&#123;handler.value&#125;</span>).apply(null, arguments)`</span></span><br><span class="line">        : isFunctionInvocation</span><br><span class="line">          ? <span class="string">`return <span class="subst">$&#123;handler.value&#125;</span>`</span></span><br><span class="line">          : handler.value</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (__WEEX__ &amp;&amp; handler.params) &#123;</span><br><span class="line">      <span class="keyword">return</span> genWeexHandler(handler.params, code + handlerCode)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`function($event)&#123;<span class="subst">$&#123;code&#125;</span><span class="subst">$&#123;handlerCode&#125;</span>&#125;`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createElement-3"><a href="#createElement-3" class="headerlink" title="createElement"></a>createElement</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">_c(<span class="string">'div'</span>,[_c(<span class="string">'input'</span>,&#123;</span><br><span class="line">  directives:[&#123;<span class="attr">name</span>:<span class="string">"model"</span>,<span class="attr">rawName</span>:<span class="string">"v-model"</span>,<span class="attr">value</span>:(text),<span class="attr">expression</span>:<span class="string">"text"</span>&#125;],</span><br><span class="line">  domProps:&#123;<span class="string">"value"</span>:(text)&#125;,</span><br><span class="line">  on:&#123;</span><br><span class="line">    <span class="string">"input"</span>:<span class="function"><span class="keyword">function</span>(<span class="params">$event</span>)</span>&#123;<span class="keyword">if</span>($event.target.composing)<span class="keyword">return</span>;text=$event.target.value&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)])</span><br></pre></td></tr></table></figure>
<p>ä¾æ¬¡è¯»å–å®Œå„å˜é‡, input å¼€å§‹ç”Ÿæˆè™šæ‹ŸèŠ‚ç‚¹, â€˜inputâ€™ å…¶åä¸ºå±æ€§æŠ½è±¡å‡ºæ¥çš„ data å¯¹è±¡, è€Œæ­¤æ—¶ input åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹çš„ data å°±ç›´æ¥ä¸ºè¯¥å¯¹è±¡, åªä¸è¿‡åšäº†å˜é‡æ›¿æ¢.</p>
<h2 id="createElm-3"><a href="#createElm-3" class="headerlink" title="createElm"></a>createElm</h2><p>åˆ›å»º input æ ‡ç­¾, å†çœ‹å…¶ children, æ²¡æœ‰åˆ™ç»§ç»­è¿›è¡Œ invokeCreateHooks, è¿™ä¹Ÿæ˜¯ v-model çš„é‡ç‚¹, å› ä¸ºå½“å‰èŠ‚ç‚¹çš„å±æ€§ data æœ‰ directives, domProps, on; ä¹Ÿå°±æ˜¯æŒ‡ä»¤ model, input çš„ dom å±æ€§ value ç”¨ä»¥äº‹ä»¶è¯»å–, input è¾“å…¥äº‹ä»¶</p>
<p>æ¥ä¸‹æ¥ç€é‡å¤„ç†å±æ€§ data</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vnode.elm = vnode.ns</span><br><span class="line">  ? nodeOps.createElementNS(vnode.ns, tag)</span><br><span class="line">  : nodeOps.createElement(tag, vnode)</span><br><span class="line"></span><br><span class="line">createChildren(vnode, children, insertedVnodeQueue)</span><br><span class="line"><span class="keyword">if</span> (isDef(data)) &#123;</span><br><span class="line">  invokeCreateHooks(vnode, insertedVnodeQueue)</span><br><span class="line">&#125;</span><br><span class="line">insert(parentElm, vnode.elm, refElm)</span><br></pre></td></tr></table></figure>
<h2 id="invokeCreateHooks"><a href="#invokeCreateHooks" class="headerlink" title="invokeCreateHooks"></a>invokeCreateHooks</h2><p>åœ¨è¿™ä¸ªæ–¹æ³•é‡Œ, ä¼šéå† cbs.create é‡Œçš„æ–¹æ³•æ¥å¤„ç†ä¼ å…¥çš„ vnode å±æ€§ data, å¦‚å±æ€§, class, äº‹ä»¶, dom å±æ€§, è¡Œå†…æ ·å¼, æŒ‡ä»¤ç­‰çš„æŒ‚è½½æ›´æ–°</p>
<p>è¿™é‡Œä¼šæ‰§è¡Œåˆ° updateDOMListeners, updateDOMProps, </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cbs.create &#123;</span><br><span class="line">  <span class="number">0</span>:Æ’ updateAttrs(oldVnode, vnode)</span><br><span class="line">  <span class="number">1</span>:Æ’ updateClass (oldVnode, vnode) </span><br><span class="line">  <span class="number">2</span>:Æ’ updateDOMListeners (oldVnode, vnode) </span><br><span class="line">  <span class="number">3</span>:Æ’ updateDOMProps(oldVnode, vnode)</span><br><span class="line">  <span class="number">4</span>:Æ’ updateStyle(oldVnode, vnode)</span><br><span class="line">  <span class="number">5</span>:Æ’ _enter (_, vnode) </span><br><span class="line">  <span class="number">6</span>:Æ’ create (_, vnode) </span><br><span class="line">  <span class="number">7</span>:Æ’ updateDirectives (oldVnode, vnode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">invokeCreateHooks</span> (<span class="params">vnode, insertedVnodeQueue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cbs.create.length; ++i) &#123;</span><br><span class="line">    cbs.create[i](emptyNode, vnode)</span><br><span class="line">  &#125;</span><br><span class="line">  i = vnode.data.hook <span class="comment">// Reuse variable</span></span><br><span class="line">  <span class="keyword">if</span> (isDef(i)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDef(i.create)) i.create(emptyNode, vnode)</span><br><span class="line">    <span class="keyword">if</span> (isDef(i.insert)) insertedVnodeQueue.push(vnode) <span class="comment">// æ’å…¥çš„ VNode é˜Ÿåˆ—</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="updateDOMListeners-1"><a href="#updateDOMListeners-1" class="headerlink" title="updateDOMListeners"></a>updateDOMListeners</h3><p>updateDOMListeners æ˜¯å› ä¸ºå­˜åœ¨ input äº‹ä»¶; åŒä¹‹å‰è¯´åˆ°çš„å¤„ç†äº‹ä»¶çš„æ–¹æ³•ä¸€æ ·, ä¼šå¯¹æ¯”æ–°æ—§èŠ‚ç‚¹å±æ€§ data é‡Œ on ä¸­çš„äº‹ä»¶, åˆå§‹åŒ–æ—¶, æ—§èŠ‚ç‚¹æ²¡æœ‰, å› æ­¤å°±ç›´æ¥å°†æ–°èŠ‚ç‚¹ on é‡Œçš„äº‹ä»¶æ–¹æ³•è¿›è¡Œ createFnInvoker å¤„ç†, æ¥ç€ç›´æ¥åœ¨ add æ–¹æ³•é‡Œç”¨ addEventListener ç»™å½“å‰èŠ‚ç‚¹ vnode.elm ç»‘å®š input äº‹ä»¶</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateDOMListeners</span> (<span class="params">oldVnode: VNodeWithData, vnode: VNodeWithData</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isUndef(oldVnode.data.on) &amp;&amp; isUndef(vnode.data.on)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> on = vnode.data.on || &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> oldOn = oldVnode.data.on || &#123;&#125;</span><br><span class="line">  target = vnode.elm</span><br><span class="line">  normalizeEvents(on)</span><br><span class="line">  updateListeners(on, oldOn, add, remove, createOnceHandler, vnode.context)</span><br><span class="line">  target = <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// updateListeners</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateListeners</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  on: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  oldOn: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  add: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  remove: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  createOnceHandler: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  vm: Component</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> name, def, cur, old, event</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> on) &#123;</span><br><span class="line">    def = cur = on[name]</span><br><span class="line">    old = oldOn[name]</span><br><span class="line">    event = normalizeEvent(name)</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (__WEEX__ &amp;&amp; isPlainObject(def)) &#123;</span><br><span class="line">      cur = def.handler</span><br><span class="line">      event.params = def.params</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isUndef(cur)) &#123;</span><br><span class="line">      process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warn(</span><br><span class="line">        <span class="string">`Invalid handler for event "<span class="subst">$&#123;event.name&#125;</span>": got `</span> + <span class="built_in">String</span>(cur),</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isUndef(old)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isUndef(cur.fns)) &#123;</span><br><span class="line">        cur = on[name] = createFnInvoker(cur, vm)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (isTrue(event.once)) &#123;</span><br><span class="line">        cur = on[name] = createOnceHandler(event.name, cur, event.capture)</span><br><span class="line">      &#125;</span><br><span class="line">      add(event.name, cur, event.capture, event.passive, event.params)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur !== old) &#123;</span><br><span class="line">      old.fns = cur</span><br><span class="line">      on[name] = old</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> oldOn) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isUndef(on[name])) &#123;</span><br><span class="line">      event = normalizeEvent(name)</span><br><span class="line">      remove(event.name, oldOn[name], event.capture)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="updateDOMProps"><a href="#updateDOMProps" class="headerlink" title="updateDOMProps"></a>updateDOMProps</h3><p>æ¥ç€è¿›è¡Œ domProps çš„å¤„ç†, è·å–å½“å‰çš„ domProps, è¿›è¡Œéå†, å¯¹æ¯ä¸ª prop çš„åå­—è¿›è¡Œåˆ¤æ–­, çœ‹æ˜¯å¦æ˜¯ textContent, innerHTML, value, æŒ‰ä¸åŒæ–¹å¼å¤„ç†;</p>
<p>æ­¤æ—¶æ˜¯ input é”®å…¥çš„å€¼, ä¹Ÿå°±æ˜¯ value, è®¾ç½®å½“å‰èŠ‚ç‚¹ elm çš„ _value ä¸º value å¯¹åº”çš„å€¼, ä¹Ÿå°±æ˜¯å·²ç»å­˜åœ¨ä¸ input æ¡†å†…çš„å€¼; æ¥ç€æ£€æŸ¥ shouldUpdateValue æ˜¯å¦åº”è¯¥æ›´æ–°å€¼, é¿å…å€¼ç›¸åŒäº†è¿˜åšé‡å¤è®¾å®š</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateDOMProps</span> (<span class="params">oldVnode: VNodeWithData, vnode: NodeWithData</span>) </span></span><br><span class="line"><span class="function">  <span class="title">if</span> (<span class="params">isUndef(oldVnode.data.domProps</span>) &amp;&amp; <span class="title">isUndef</span>(<span class="params">vnode.data.domProps</span>)) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> key, cur</span><br><span class="line">  <span class="keyword">const</span> elm: any = vnode.elm</span><br><span class="line">  <span class="keyword">const</span> oldProps = oldVnode.data.domProps || &#123;&#125;</span><br><span class="line">  <span class="keyword">let</span> props = vnode.data.domProps || &#123;&#125;</span><br><span class="line">  <span class="comment">// clone observed objects, as the user probably wants to mutate it</span></span><br><span class="line">  <span class="keyword">if</span> (isDef(props.__ob__)) &#123;</span><br><span class="line">    props = vnode.data.domProps = extend(&#123;&#125;, props)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (key <span class="keyword">in</span> oldProps) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> props)) &#123;</span><br><span class="line">      elm[key] = <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (key <span class="keyword">in</span> props) &#123;</span><br><span class="line">    cur = props[key]</span><br><span class="line">    <span class="comment">// ignore children if the node has textContent or innerHTML,</span></span><br><span class="line">    <span class="comment">// as these will throw away existing DOM nodes and cause removal errors</span></span><br><span class="line">    <span class="comment">// on subsequent patches (#3360)</span></span><br><span class="line">    <span class="keyword">if</span> (key === <span class="string">'textContent'</span> || key === <span class="string">'innerHTML'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (vnode.children) vnode.children.length = <span class="number">0</span></span><br><span class="line">      <span class="keyword">if</span> (cur === oldProps[key]) <span class="keyword">continue</span></span><br><span class="line">      <span class="comment">// #6601 work around Chrome version &lt;= 55 bug where single textNode</span></span><br><span class="line">      <span class="comment">// replaced by innerHTML/textContent retains its parentNode property</span></span><br><span class="line">      <span class="keyword">if</span> (elm.childNodes.length === <span class="number">1</span>) &#123;</span><br><span class="line">        elm.removeChild(elm.childNodes[<span class="number">0</span>])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (key === <span class="string">'value'</span> &amp;&amp; elm.tagName !== <span class="string">'PROGRESS'</span>) &#123;</span><br><span class="line">      <span class="comment">// store value as _value as well since</span></span><br><span class="line">      <span class="comment">// non-string values will be stringified</span></span><br><span class="line">      elm._value = cur</span><br><span class="line">      <span class="comment">// avoid resetting cursor position when value is the same</span></span><br><span class="line">      <span class="keyword">const</span> strCur = isUndef(cur) ? <span class="string">''</span> : <span class="built_in">String</span>(cur)</span><br><span class="line">      <span class="keyword">if</span> (shouldUpdateValue(elm, strCur)) &#123;</span><br><span class="line">        elm.value = strCur</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key === <span class="string">'innerHTML'</span> &amp;&amp; isSVG(elm.tagName) &amp;&amp; isUndef(elm.innerHTML)) &#123;</span><br><span class="line">      <span class="comment">// IE doesn't support innerHTML for SVG elements</span></span><br><span class="line">      svgContainer = svgContainer || <span class="built_in">document</span>.createElement(<span class="string">'div'</span>)</span><br><span class="line">      svgContainer.innerHTML = <span class="string">`&lt;svg&gt;<span class="subst">$&#123;cur&#125;</span>&lt;/svg&gt;`</span></span><br><span class="line">      <span class="keyword">const</span> svg = svgContainer.firstChild</span><br><span class="line">      <span class="keyword">while</span> (elm.firstChild) &#123;</span><br><span class="line">        elm.removeChild(elm.firstChild)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> (svg.firstChild) &#123;</span><br><span class="line">        elm.appendChild(svg.firstChild)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      <span class="comment">// skip the update if old and new VDOM state is the same.</span></span><br><span class="line">      <span class="comment">// `value` is handled separately because the DOM value may be temporarily</span></span><br><span class="line">      <span class="comment">// out of sync with VDOM state due to focus, composition and modifiers.</span></span><br><span class="line">      <span class="comment">// This  #4521 by skipping the unnecessary `checked` update.</span></span><br><span class="line">      cur !== oldProps[key]</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// some property updates can throw</span></span><br><span class="line">      <span class="comment">// e.g. `value` on &lt;progress&gt; w/ non-finite value</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        elm[key] = cur</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="updateDirectives"><a href="#updateDirectives" class="headerlink" title="updateDirectives"></a>updateDirectives</h2><p>å½“å‰çš„èŠ‚ç‚¹æœ‰ Directives å‘½ä»¤, å°†æ–°èŠ‚ç‚¹çš„å‘½ä»¤æ•°ç»„è·å–, éå†, å¦‚æœä¸å­˜åœ¨æ—§èŠ‚ç‚¹, é‚£ä¹ˆå°±å°†æ–°å‘½ä»¤ç»‘å®š, å­˜å…¥ dirsWithInsert; å¦‚æœå­˜åœ¨æ—§èŠ‚ç‚¹, é‚£ä¹ˆå°±å°†å‘½ä»¤ä½œä»¥æ›´æ–°;</p>
<p>åœ¨ _update ä¸­, å¦‚æœæ—§èŠ‚ç‚¹ç­‰äºç©ºèŠ‚ç‚¹, é‚£ä¹ˆ isCreate å°±ä¸º true, è¡¨ç¤ºæ–°åˆ›å»º; å› æ­¤ä¹‹åä¼šæ‰§è¡Œ <code>mergeVNodeHook(vnode, &#39;insert&#39;, callInsert)</code> ç»™å½“å‰çš„èŠ‚ç‚¹å±æ€§ data æ’å…¥ insert hook</p>
<p>åœ¨ ä¸­, oldHook æ˜¯ <code>vnode.data.hook[&#39;insert&#39;]</code>, å½“å‰å¹¶ä¸å­˜åœ¨, å› æ­¤ä¸º undefined; åœ¨åç»­ä¼šæ‰§è¡Œ <code>invoker = createFnInvoker([wrappedHook])</code> , ä¹Ÿæ˜¯ç”¨ callInsert ç”Ÿæˆ invoker, å†ä»¤ <code>vnode.data.hook[&#39;insert&#39;] = invoker</code></p>
<p>å¦‚æ­¤å°±å®Œæˆäº†; å†å¾€ä¸‹å›åˆ° invokeCreateHooks, ä¼šæ£€æŸ¥ if (isDef(i.insert)) æ˜¯å¦å®šä¹‰, è€Œæ­¤æ—¶å®šä¹‰äº†, é‚£ä¹ˆå°±å°†å½“å‰çš„ VNode åŠ å…¥ <code>insertedVnodeQueue.push(vnode)</code> é˜Ÿåˆ—</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateDirectives</span> (<span class="params">oldVnode: VNodeWithData, vnode: VNodeWithData</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (oldVnode.data.directives || vnode.data.directives) &#123;</span><br><span class="line">    _update(oldVnode, vnode)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_update</span> (<span class="params">oldVnode, vnode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> isCreate = oldVnode === emptyNode</span><br><span class="line">  <span class="keyword">const</span> isDestroy = vnode === emptyNode</span><br><span class="line">  <span class="keyword">const</span> oldDirs = normalizeDirectives(oldVnode.data.directives, oldVnode.context)</span><br><span class="line">  <span class="keyword">const</span> newDirs = normalizeDirectives(vnode.data.directives, vnode.context)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> dirsWithInsert = []</span><br><span class="line">  <span class="keyword">const</span> dirsWithPostpatch = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> key, oldDir, dir</span><br><span class="line">  <span class="keyword">for</span> (key <span class="keyword">in</span> newDirs) &#123;</span><br><span class="line">    oldDir = oldDirs[key]</span><br><span class="line">    dir = newDirs[key]</span><br><span class="line">    <span class="keyword">if</span> (!oldDir) &#123;</span><br><span class="line">      <span class="comment">// new directive, bind</span></span><br><span class="line">      callHook(dir, <span class="string">'bind'</span>, vnode, oldVnode)</span><br><span class="line">      <span class="keyword">if</span> (dir.def &amp;&amp; dir.def.inserted) &#123;</span><br><span class="line">        dirsWithInsert.push(dir)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// existing directive, update</span></span><br><span class="line">      dir.oldValue = oldDir.value</span><br><span class="line">      dir.oldArg = oldDir.arg</span><br><span class="line">      callHook(dir, <span class="string">'update'</span>, vnode, oldVnode)</span><br><span class="line">      <span class="keyword">if</span> (dir.def &amp;&amp; dir.def.componentUpdated) &#123;</span><br><span class="line">        dirsWithPostpatch.push(dir)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dirsWithInsert.length) &#123;</span><br><span class="line">    <span class="keyword">const</span> callInsert = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dirsWithInsert.length; i++) &#123;</span><br><span class="line">        callHook(dirsWithInsert[i], <span class="string">'inserted'</span>, vnode, oldVnode)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isCreate) &#123;</span><br><span class="line">      mergeVNodeHook(vnode, <span class="string">'insert'</span>, callInsert)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      callInsert()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dirsWithPostpatch.length) &#123;</span><br><span class="line">    mergeVNodeHook(vnode, <span class="string">'postpatch'</span>, () =&gt; &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dirsWithPostpatch.length; i++) &#123;</span><br><span class="line">        callHook(dirsWithPostpatch[i], <span class="string">'componentUpdated'</span>, vnode, oldVnode)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!isCreate) &#123;</span><br><span class="line">    <span class="keyword">for</span> (key <span class="keyword">in</span> oldDirs) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!newDirs[key]) &#123;</span><br><span class="line">        <span class="comment">// no longer present, unbind</span></span><br><span class="line">        callHook(oldDirs[key], <span class="string">'unbind'</span>, oldVnode, oldVnode, isDestroy)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mergeVNodeHook</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mergeVNodeHook</span> (<span class="params">def: Object, hookKey: string, hook: Function</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (def <span class="keyword">instanceof</span> VNode) &#123;</span><br><span class="line">    def = def.data.hook || (def.data.hook = &#123;&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> invoker</span><br><span class="line">  <span class="keyword">const</span> oldHook = def[hookKey]</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">wrappedHook</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    hook.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>)</span><br><span class="line">    <span class="comment">// important: remove merged hook to ensure it's called only once</span></span><br><span class="line">    <span class="comment">// and prevent memory leak</span></span><br><span class="line">    remove(invoker.fns, wrappedHook)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isUndef(oldHook)) &#123;</span><br><span class="line">    <span class="comment">// no existing hook</span></span><br><span class="line">    invoker = createFnInvoker([wrappedHook])</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (isDef(oldHook.fns) &amp;&amp; isTrue(oldHook.merged)) &#123;</span><br><span class="line">      <span class="comment">// already a merged invoker</span></span><br><span class="line">      invoker = oldHook</span><br><span class="line">      invoker.fns.push(wrappedHook)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// existing plain hook</span></span><br><span class="line">      invoker = createFnInvoker([oldHook, wrappedHook])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  invoker.merged = <span class="literal">true</span></span><br><span class="line">  def[hookKey] = invoker</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="v-bind"><a href="#v-bind" class="headerlink" title="v-bind"></a>v-bind</h1><h2 id="processAttrs-2"><a href="#processAttrs-2" class="headerlink" title="processAttrs"></a>processAttrs</h2><p>åœ¨ processAttrs å¯¹ v-bind çš„å¤„ç†</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (bindRE.test(name)) &#123; <span class="comment">// v-bind</span></span><br><span class="line">  name = name.replace(bindRE, <span class="string">''</span>)</span><br><span class="line">  value = parseFilters(value)</span><br><span class="line">  isDynamic = dynamicArgRE.test(name)</span><br><span class="line">  <span class="keyword">if</span> (isDynamic) &#123;</span><br><span class="line">    name = name.slice(<span class="number">1</span>, <span class="number">-1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">    value.trim().length === <span class="number">0</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`The value for a v-bind expression cannot be empty. Found in "v-bind:<span class="subst">$&#123;name&#125;</span>"`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (modifiers) &#123;</span><br><span class="line">    <span class="keyword">if</span> (modifiers.prop &amp;&amp; !isDynamic) &#123;</span><br><span class="line">      name = camelize(name)</span><br><span class="line">      <span class="keyword">if</span> (name === <span class="string">'innerHtml'</span>) name = <span class="string">'innerHTML'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (modifiers.camel &amp;&amp; !isDynamic) &#123;</span><br><span class="line">      name = camelize(name)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (modifiers.sync) &#123;</span><br><span class="line">      syncGen = genAssignmentCode(value, <span class="string">`$event`</span>)</span><br><span class="line">      <span class="keyword">if</span> (!isDynamic) &#123;</span><br><span class="line">        addHandler(</span><br><span class="line">          el,</span><br><span class="line">          <span class="string">`update:<span class="subst">$&#123;camelize(name)&#125;</span>`</span>,</span><br><span class="line">          syncGen,</span><br><span class="line">          <span class="literal">null</span>,</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          warn,</span><br><span class="line">          list[i]</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> (hyphenate(name) !== camelize(name)) &#123;</span><br><span class="line">          addHandler(</span><br><span class="line">            el,</span><br><span class="line">            <span class="string">`update:<span class="subst">$&#123;hyphenate(name)&#125;</span>`</span>,</span><br><span class="line">            syncGen,</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            <span class="literal">false</span>,</span><br><span class="line">            warn,</span><br><span class="line">            list[i]</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// handler w/ dynamic event name</span></span><br><span class="line">        addHandler(</span><br><span class="line">          el,</span><br><span class="line">          <span class="string">`"update:"+(<span class="subst">$&#123;name&#125;</span>)`</span>,</span><br><span class="line">          syncGen,</span><br><span class="line">          <span class="literal">null</span>,</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          warn,</span><br><span class="line">          list[i],</span><br><span class="line">          <span class="literal">true</span> <span class="comment">// dynamic</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ((modifiers &amp;&amp; modifiers.prop) || (</span><br><span class="line">    !el.component &amp;&amp; platformMustUseProp(el.tag, el.attrsMap.type, name)</span><br><span class="line">  )) &#123;</span><br><span class="line">    addProp(el, name, value, list[i], isDynamic)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    addAttr(el, name, value, list[i], isDynamic)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="genElement-2"><a href="#genElement-2" class="headerlink" title="genElement"></a>genElement</h2><p>dataGenFns ä¸­çš„æ–¹æ³•ä½¿åŠ¨æ€å±æ€§åŠåŠ¨æ€æ ·å¼è¡¨ç¤ºå‡ºæ¥</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// module data generation functions</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; state.dataGenFns.length; i++) &#123;</span><br><span class="line">  data += state.dataGenFns[i](el)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨ dataGenFns ä¸­çš„æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genData</span> (<span class="params">el: ASTElement</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data = <span class="string">''</span></span><br><span class="line">  <span class="keyword">if</span> (el.staticClass) &#123;</span><br><span class="line">    data += <span class="string">`staticClass:<span class="subst">$&#123;el.staticClass&#125;</span>,`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.classBinding) &#123;</span><br><span class="line">    data += <span class="string">`class:<span class="subst">$&#123;el.classBinding&#125;</span>,`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// style</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genData</span> (<span class="params">el: ASTElement</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data = <span class="string">''</span></span><br><span class="line">  <span class="keyword">if</span> (el.staticStyle) &#123;</span><br><span class="line">    data += <span class="string">`staticStyle:<span class="subst">$&#123;el.staticStyle&#125;</span>,`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.styleBinding) &#123;</span><br><span class="line">    data += <span class="string">`style:(<span class="subst">$&#123;el.styleBinding&#125;</span>),`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createElement-4"><a href="#createElement-4" class="headerlink" title="createElement"></a>createElement</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_c(<span class="string">'div'</span>,&#123;<span class="attr">class</span>:bindClass,<span class="attr">on</span>:&#123;<span class="string">"click"</span>:update&#125;&#125;,[_v(_s(sum))])])&#125;</span><br></pre></td></tr></table></figure>
<p>sum é€šè¿‡ computedGetter è·å–, ä¼šå¾—åˆ° initComputed æ—¶æœŸåˆ›å»ºçš„è®¡ç®—å±æ€§ watcher , é€šè¿‡ watcher æ·»åŠ ä¾èµ–, å…¶å® åœ¨å¯¹æ•°æ®çš„æ¯æ¬¡ getter æ—¶, éƒ½ä¼šè§¦å‘ç›¸åº”çš„ä¾èµ–æ”¶é›†, å°†æ–°çš„è®¢é˜…æ·»åŠ å®Œï¼Œä¼šç§»é™¤æ‰æ—§çš„è®¢é˜…, newDeps è¡¨ç¤ºæ–°æ·»åŠ çš„ Dep å®ä¾‹æ•°ç»„ï¼Œè€Œ deps è¡¨ç¤ºä¸Šä¸€æ¬¡æ·»åŠ çš„ Dep å®ä¾‹æ•°ç»„ã€‚</p>
<p>åŒæ—¶æˆ‘ä»¬ä¹Ÿèƒ½çœ‹åˆ°, è®¡ç®—å±æ€§ sum å¯¹åº”çš„ä¾èµ– dep å½“å‰å·²æœ‰ä¸‰ä¸ªè§‚å¯Ÿè€…, ä¸€ä¸ªæ˜¯åˆå§‹åŒ–è®¡ç®—å±æ€§, ä¸€ä¸ªæ˜¯åˆå§‹åŒ– watch æ—¶æˆ‘ä»¬å†™å…¥äº† sum, å†æœ‰å°±æ˜¯åˆšæ‰åš render ç”Ÿæˆè™šæ‹ŸèŠ‚ç‚¹æ—¶è¯»å–åˆ°äº† sum;</p>
<p>è¯»å–å®Œ sum åå°†å…¶è½¬ä¸ºå­—ç¬¦ä¸², æ¥ç€ç”Ÿæˆæ–‡æœ¬è™šæ‹ŸèŠ‚ç‚¹.</p>
<p>æ­¤æ—¶ div æ ‡ç­¾ _c çš„å‡†å¤‡å·¥ä½œå°±åšå®Œäº†, æ ‡ç­¾, å±æ€§ data, children, åˆ›å»ºå…ƒç´ è™šæ‹ŸèŠ‚ç‚¹; åŠ¨æ€å±æ€§ä¹Ÿåœ¨ä¹‹å‰è¯»å–å˜é‡æ—¶å¾—åˆ°äº†å¯¹åº”çš„å€¼</p>
<h2 id="createElm-4"><a href="#createElm-4" class="headerlink" title="createElm"></a>createElm</h2><p>è®¡ç®—å±æ€§åˆ°è¿™ä¸€æ­¥, å’Œä¸€èˆ¬çš„å…¶å®ä¹Ÿå·®ä¸å¤š, è¿™é‡Œè¯´ä¸‹ä¸Šè¾¹æ²¡æœ‰çš„ class çš„æ›´æ–°;</p>
<p>åˆ¤æ–­å¦‚æœå’Œä¹‹å‰æ—§çš„èŠ‚ç‚¹çš„ class ä¸åŒ, é‚£ä¹ˆå°±ç”¨ setAttribute è®¾å®šç°åœ¨çš„ class, åŒæ—¶å†ç”¨ _prevClass å­˜å‚¨å½“å‰çš„ class, ä»¥ä¾¿ä¹‹å class æ”¹å˜äº†ä¸ _prevClass å†è¿›è¡Œå¯¹æ¯”</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateClass</span> (<span class="params">oldVnode: any, vnode: any</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> el = vnode.elm</span><br><span class="line">  <span class="keyword">const</span> data: VNodeData = vnode.data</span><br><span class="line">  <span class="keyword">const</span> oldData: VNodeData = oldVnode.data</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    isUndef(data.staticClass) &amp;&amp;</span><br><span class="line">    isUndef(data.class) &amp;&amp; (</span><br><span class="line">      isUndef(oldData) || (</span><br><span class="line">        isUndef(oldData.staticClass) &amp;&amp;</span><br><span class="line">        isUndef(oldData.class)</span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> cls = genClassForVnode(vnode)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// handle transition classes</span></span><br><span class="line">  <span class="keyword">const</span> transitionClass = el._transitionClasses</span><br><span class="line">  <span class="keyword">if</span> (isDef(transitionClass)) &#123;</span><br><span class="line">    cls = concat(cls, stringifyClass(transitionClass))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set the class</span></span><br><span class="line">  <span class="keyword">if</span> (cls !== el._prevClass) &#123;</span><br><span class="line">    el.setAttribute(<span class="string">'class'</span>, cls)</span><br><span class="line">    el._prevClass = cls</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <br>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/notes/">notes</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Frontend/">Frontend</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Vue/">Vue</a></li></ul>

      
	<span class="ico-date"></span>
	<a href="/blog/2021/08/12/2-frontend-vue-source5-etc/" class="article-date">
	  <time datetime="2021-08-11T16:00:00.000Z" itemprop="datePublished">å…«æœˆ 12, 2021</time>
	</a>

      <!-- æ·»åŠ å­—æ•°ç»Ÿè®¡ -->
      
        <span class="ico-fontcount"></span><span class="post-count">12.8kå­—</span>
      
    </footer>
    <!-- æ–‡ç« æ·»åŠ è¯„è®º -->
    
      
    <script defer src="https://unpkg.com/leancloud-storage@4/dist/av-min.js"></script>
    <script defer src='https://unpkg.com/valine@latest/dist/Valine.min.js'></script>
    <div id="vcomments"></div>
    <script>

        var notify = 'false' == true ? true : false;
        var verify = 'false' == true ? true : false;
		// è®¾ç½®è½®è¯¢
		const timer = setInterval(() => {
			if (window.Valine && typeof window.Valine === 'function') {
				clearInterval(timer);
				new Valine({
					el: '#vcomments',
					notify: notify,
					verify: verify,
					app_id: 'AJj6aG4cDMBqBIISAr1U53Az-gzGzoHsz',
					app_key: 'bIYBhlht4PSXI4pCWuH7Gnuo',
					placeholder: 'say something bro ~',
					avatar: 'monsterid',
					avatarCDN:'https://cravatar.cn/avatar/',
					visitor: 'true',
                    emojiCDN: '//i0.hdslb.com/bfs/emote/', 
                    // è¡¨æƒ…titleå’Œå›¾ç‰‡æ˜ å°„
                    emojiMaps: {
                        "tv_doge": "6ea59c827c414b4a2955fe79e0f6fd3dcd515e24.png",
                        "tv_äº²äº²": "a8111ad55953ef5e3be3327ef94eb4a39d535d06.png",
                        "tv_å·ç¬‘": "bb690d4107620f1c15cff29509db529a73aee261.png",
                        "tv_å†è§": "180129b8ea851044ce71caf55cc8ce44bd4a4fc8.png",
                        "tv_å†·æ¼ ": "b9cbc755c2b3ee43be07ca13de84e5b699a3f101.png",
                        "tv_å‘æ€’": "34ba3cd204d5b05fec70ce08fa9fa0dd612409ff.png",
                        "tv_å‘è´¢": "34db290afd2963723c6eb3c4560667db7253a21a.png",
                        "tv_å¯çˆ±": "9e55fd9b500ac4b96613539f1ce2f9499e314ed9.png",
                        "tv_åè¡€": "09dd16a7aa59b77baa1155d47484409624470c77.png",
                        "tv_å‘†": "fe1179ebaa191569b0d31cecafe7a2cd1c951c9d.png",
                        "tv_å‘•å": "9f996894a39e282ccf5e66856af49483f81870f3.png",
                        "tv_å›°": "241ee304e44c0af029adceb294399391e4737ef2.png",
                        "tv_åç¬‘": "1f0b87f731a671079842116e0991c91c2c88645a.png",
                        "tv_å¤§ä½¬": "093c1e2c490161aca397afc45573c877cdead616.png",
                        "tv_å¤§å“­": "23269aeb35f99daee28dda129676f6e9ea87934f.png",
                        "tv_å§”å±ˆ": "d04dba7b5465779e9755d2ab6f0a897b9b33bb77.png",
                        "tv_å®³ç¾": "a37683fb5642fa3ddfc7f4e5525fd13e42a2bdb1.png",
                        "tv_å°´å°¬": "7cfa62dafc59798a3d3fb262d421eeeff166cfa4.png",
                        "tv_å¾®ç¬‘": "70dc5c7b56f93eb61bddba11e28fb1d18fddcd4c.png",
                        "tv_æ€è€ƒ": "90cf159733e558137ed20aa04d09964436f618a1.png",
                        "tv_æƒŠå“": "0d15c7e2ee58e935adc6a7193ee042388adc22af.png",
                        // ... æ›´å¤šè¡¨æƒ…
                    }
				});
			}
		}, 1000);
    </script>



    
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
    <a href="/blog/2021/08/14/2-frontend-vue-diff/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">ä¸Šä¸€ç¯‡</strong>
      <div class="article-nav-title">
        
          ğŸ”¥ å‰ç«¯ | Vue2 diff æµç¨‹
        
      </div>
    </a>
  
  
    <a href="/blog/2021/08/07/2-frontend-vue-source4-mount/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">ä¸‹ä¸€ç¯‡</strong>
      <div class="article-nav-title">ğŸ”¥ å‰ç«¯ | Vue2 åˆå§‹åŒ–æµç¨‹ - mount</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">æ–‡ç« ç›®å½•</strong>
    
      <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ä¾‹å­"><span class="nav-number">1.</span> <span class="nav-text">ä¾‹å­</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#parse"><span class="nav-number">1.1.</span> <span class="nav-text">parse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#generate"><span class="nav-number">1.2.</span> <span class="nav-text">generate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#render"><span class="nav-number">1.3.</span> <span class="nav-text">render</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#update"><span class="nav-number">1.4.</span> <span class="nav-text">update</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#event"><span class="nav-number">2.</span> <span class="nav-text">event</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#processAttrs"><span class="nav-number">2.1.</span> <span class="nav-text">processAttrs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genElement"><span class="nav-number">2.2.</span> <span class="nav-text">genElement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genData"><span class="nav-number">2.3.</span> <span class="nav-text">genData</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genHandlers"><span class="nav-number">2.4.</span> <span class="nav-text">genHandlers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElement"><span class="nav-number">2.5.</span> <span class="nav-text">createElement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElm"><span class="nav-number">2.6.</span> <span class="nav-text">createElm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#updateDOMListeners"><span class="nav-number">2.7.</span> <span class="nav-text">updateDOMListeners</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#v-if"><span class="nav-number">3.</span> <span class="nav-text">v-if</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#parseHTML"><span class="nav-number">3.1.</span> <span class="nav-text">parseHTML</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#parseHTML-çš„-option"><span class="nav-number">3.2.</span> <span class="nav-text">parseHTML çš„ option</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#parseText"><span class="nav-number">3.3.</span> <span class="nav-text">parseText</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genElement-1"><span class="nav-number">3.4.</span> <span class="nav-text">genElement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElement-1"><span class="nav-number">3.5.</span> <span class="nav-text">createElement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElm-1"><span class="nav-number">3.6.</span> <span class="nav-text">createElm</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#v-for"><span class="nav-number">4.</span> <span class="nav-text">v-for</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#processFor"><span class="nav-number">4.1.</span> <span class="nav-text">processFor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#parseFor"><span class="nav-number">4.2.</span> <span class="nav-text">parseFor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genFor"><span class="nav-number">4.3.</span> <span class="nav-text">genFor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genData-1"><span class="nav-number">4.4.</span> <span class="nav-text">genData</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElement-2"><span class="nav-number">4.5.</span> <span class="nav-text">createElement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#renderList"><span class="nav-number">4.6.</span> <span class="nav-text">renderList</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElm-2"><span class="nav-number">4.7.</span> <span class="nav-text">createElm</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#v-model"><span class="nav-number">5.</span> <span class="nav-text">v-model</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#processAttrs-1"><span class="nav-number">5.1.</span> <span class="nav-text">processAttrs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genDirectives"><span class="nav-number">5.2.</span> <span class="nav-text">genDirectives</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#genDefaultModel"><span class="nav-number">5.2.1.</span> <span class="nav-text">genDefaultModel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#genAssignmentCode"><span class="nav-number">5.2.2.</span> <span class="nav-text">genAssignmentCode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#parseModel"><span class="nav-number">5.2.3.</span> <span class="nav-text">parseModel</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genProps"><span class="nav-number">5.3.</span> <span class="nav-text">genProps</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genHandlers-1"><span class="nav-number">5.4.</span> <span class="nav-text">genHandlers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElement-3"><span class="nav-number">5.5.</span> <span class="nav-text">createElement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElm-3"><span class="nav-number">5.6.</span> <span class="nav-text">createElm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#invokeCreateHooks"><span class="nav-number">5.7.</span> <span class="nav-text">invokeCreateHooks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#updateDOMListeners-1"><span class="nav-number">5.7.1.</span> <span class="nav-text">updateDOMListeners</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#updateDOMProps"><span class="nav-number">5.7.2.</span> <span class="nav-text">updateDOMProps</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#updateDirectives"><span class="nav-number">5.8.</span> <span class="nav-text">updateDirectives</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#v-bind"><span class="nav-number">6.</span> <span class="nav-text">v-bind</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#processAttrs-2"><span class="nav-number">6.1.</span> <span class="nav-text">processAttrs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genElement-2"><span class="nav-number">6.2.</span> <span class="nav-text">genElement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElement-4"><span class="nav-number">6.3.</span> <span class="nav-text">createElement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElm-4"><span class="nav-number">6.4.</span> <span class="nav-text">createElm</span></a></li></ol></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">HOME</a>
  
    <a href="/blog/archives" class="mobile-nav-link">ARCHIVES</a>
  
    <a href="/blog/categories" class="mobile-nav-link">CATEGORIES</a>
  
    <a href="/blog/about" class="mobile-nav-link">ABOUT</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2025 Arginsen&#39;s Blog All Rights Reserved.
      </div>
      <div class="site-credit">
        ID  <a href="https://lixupeng.cn" target="_blank">Arginsen</a>
      </div>
      <br>
      <div class="busuanzi-analytics">
        
        <span id="busuanzi_container_site_pv">
          æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
        </span>
        <span class="post-meta-divider">|</span>
        <!-- <span id="busuanzi_container_site_uv">
          æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äºº
        </span> -->
        <span class="post-count">å…¨ç«™å…± 395.7k å­—</span>
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        
      </div>
  </div> 
</footer>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>
<script src="/blog/js/bootstrap.js"></script>
<script src="/blog/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>


<script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?bb74e3da22205cadfa4f6e0a31a76ac4";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
</script>
    


  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/blog/js/totop.js" async=""></script>
</body>
</html>
