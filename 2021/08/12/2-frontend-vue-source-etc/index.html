<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta name="google-site-verification" content="OcsZXBpQqAp8163-20wn3epncmCv_UBtqBLZmspy-NA">
  
  <title>前端 | Vue2 初始化流程 - 补充：其他功能的实现 | Arginsen&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="FrontendVue">
  
  
  
  
  <meta name="keywords" content="Frontend,Vue">
<meta property="og:type" content="article">
<meta property="og:title" content="前端 | Vue2 初始化流程 - 补充：其他功能的实现">
<meta property="og:url" content="https://arginsen.github.io/blog/2021/08/12/2-frontend-vue-source-etc/index.html">
<meta property="og:site_name" content="Arginsen&#39;s Blog">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://arginsen.github.io/blog/img/vue.jpg">
<meta property="og:updated_time" content="2025-07-17T09:32:52.164Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="前端 | Vue2 初始化流程 - 补充：其他功能的实现">
<meta name="twitter:image" content="https://arginsen.github.io/blog/img/vue.jpg">
  
    <link rel="alternate" href="/atom.xml" title="Arginsen&#39;s Blog" type="application/atom+xml">
  
  <link rel="icon" href="/blog/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/blog/css/style.css">

  <script src="/blog/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/blog/css/bootstrap.css">
  <link rel="stylesheet" href="/blog/css/fashion.css">
  <link rel="stylesheet" href="/blog/css/glyphs.css">

</head>
</html>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  



<header id="allheader" class="site-header" role="banner" 
   >
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/blog/" title="Arginsen&#39;s Blog" rel="home"> Arginsen&#39;s Blog </a>
            
          </h1>
          
          
            <div class="site-description">smells like teen spirit</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows"  style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/">首页</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/archives">归档</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/categories">分类</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/blog/about">关于</a> </li>
                    
              </ul>
            </div>
          </nav>
      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-2-frontend-vue-source-etc" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
<div class="article-gallery">
  <div class="article-gallery-photos">
    
      <a class="article-gallery-img fancybox" href="/blog/img/vue.jpg" rel="gallery_cmdik2o6400qecvpu56wiicno">
        <img src="/blog/img/vue.jpg" itemprop="image">
      </a>
    
  </div>
</div>

    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      前端 | Vue2 初始化流程 - 补充：其他功能的实现
    </h1>
  

      </header>
    

    <div class="article-entry" itemprop="articleBody">
      
        <p><br><br><a id="more"></a></p>
<h1 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h1><p>hmtl</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- v-if --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"switchShow"</span>&gt;</span>开关<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">"show"</span>&gt;</span>$[ show ? 'bad ass' : 'motherfucker' ]<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- v-for --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">"food in foodList"</span> <span class="attr">:key</span>=<span class="string">"food.name"</span>&gt;</span>$[food.name]：￥ $[food.price]<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- v-model --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">v-model</span>=<span class="string">"text"</span> /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- v-bind &amp; event --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">:class</span>=<span class="string">"bindClass"</span> @<span class="attr">click</span>=<span class="string">"update"</span>&gt;</span>$[sum]<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  delimiters: [<span class="string">'$['</span>, <span class="string">']'</span>],</span><br><span class="line">  watch: &#123;</span><br><span class="line">    sum(val) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'the newVal of sum is'</span> + val)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      bindClass: <span class="string">'date'</span>,</span><br><span class="line">      base: <span class="number">10</span>,</span><br><span class="line">      arr: [<span class="string">'num1'</span>, &#123;<span class="string">'num2'</span>: <span class="number">2</span>&#125;, [<span class="string">'num3'</span>, <span class="number">3</span>]],</span><br><span class="line">      show: <span class="literal">true</span>,</span><br><span class="line">      foodList: [&#123;</span><br><span class="line">          name: <span class="string">'葱'</span>,</span><br><span class="line">          price: <span class="string">'10'</span>,</span><br><span class="line">          discount: <span class="number">.8</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">'姜'</span>,</span><br><span class="line">          price: <span class="string">'8'</span>,</span><br><span class="line">          discount: <span class="number">.6</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">'蒜'</span>,</span><br><span class="line">          price: <span class="string">'8'</span>,</span><br><span class="line">          discount: <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      logo: <span class="string">'查询菜单'</span>,</span><br><span class="line">      text: <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  computed: &#123;</span><br><span class="line">    sum() &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.base * <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    update() &#123;</span><br><span class="line">      <span class="keyword">this</span>.base += <span class="number">10</span></span><br><span class="line">    &#125;,</span><br><span class="line">    switchShow() &#123;</span><br><span class="line">      <span class="keyword">this</span>.show = !<span class="keyword">this</span>.show</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.show ? <span class="string">'打开面板'</span> : <span class="string">'关闭面板'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>在 compile 阶段，compileToFunctions -&gt; baseCompile -&gt; compile -&gt; parse 进行解析 html, 生成 AST 树。</p>
<p>总结一下，compileToFunctions 函数是 createCompilerCreator(baseCompile) 返回的 CreateCompiler(baseOptions) 执行返回的对象 { complie, createCompileToFunctionFn(compile) } 中提取的；</p>
<p>而 createCompileToFunctionFn(compile) 中由 compile(template, options) 进行编译，compile 中调用 baseCompile(template, finalOptions) 执行关键步骤：parse, optimize, generate 得到最后的 render 函数</p>
<h2 id="parse"><a href="#parse" class="headerlink" title="parse"></a>parse</h2><p>parse 完成后, 我们的 AST 树如下, 其实逻辑也很清晰, 这个阶段完成的也是基本的准备工作，将节点按父子级排列出来, 每个节点都有自己对应的 attrsList、attrsMap、end、parent、plain、rawAttrsMap、start、tag、type , 表示当前节点的一些基本内容，属性也只是作以读取储存。</p>
<p>对于 vue 特定的一些属性指令作以特殊处理, 以 v- : @ 开头的属性均会添加 <code>hasBindings: true</code> 属性; 对于计算属性, 会添加 classBinding; 对于事件, 会添加 events 属性描述; 对于 v-if 指令, 会添加 if, ifConditions 属性; 对于 v-for , 会添加 for key 来描述; 对于 v-model , 会添加 directives 来描述指令</p>
<p>其实 parse 阶段也就是解析我们写的 html 为一个 Abstract Syntax Tree, 将写的一堆的东西按嵌套层作以归纳.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">ast: &#123;</span><br><span class="line">  attrs: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="number">0</span>: &#123;<span class="attr">name</span>: <span class="string">"id"</span>, <span class="attr">value</span>: <span class="string">"\"app\""</span>, <span class="attr">dynamic</span>: <span class="literal">undefined</span>, <span class="attr">start</span>: <span class="number">5</span>, <span class="attr">end</span>: <span class="number">13</span>&#125;</span><br><span class="line">  attrsList: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="number">0</span>: &#123;<span class="attr">name</span>: <span class="string">"id"</span>, <span class="attr">value</span>: <span class="string">"app"</span>, <span class="attr">start</span>: <span class="number">5</span>, <span class="attr">end</span>: <span class="number">13</span>&#125;</span><br><span class="line">  attrsMap: &#123;<span class="attr">id</span>: <span class="string">"app"</span>&#125;</span><br><span class="line">  children: <span class="built_in">Array</span>(<span class="number">9</span>)</span><br><span class="line">    <span class="number">0</span>: &#123;</span><br><span class="line">      attrsList: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">        <span class="number">0</span>: &#123;<span class="attr">name</span>: <span class="string">"@click"</span>, <span class="attr">value</span>: <span class="string">"switchShow"</span>, <span class="attr">start</span>: <span class="number">53</span>, <span class="attr">end</span>: <span class="number">72</span>&#125;</span><br><span class="line">      attrsMap: &#123;@click: <span class="string">"switchShow"</span>&#125;</span><br><span class="line">        <span class="number">0</span>: &#123;<span class="attr">type</span>: <span class="number">3</span>, <span class="attr">text</span>: <span class="string">"开关"</span>, <span class="attr">start</span>: <span class="number">73</span>, <span class="attr">end</span>: <span class="number">75</span>&#125;</span><br><span class="line">      end: <span class="number">84</span></span><br><span class="line">      events:</span><br><span class="line">        click: &#123;<span class="attr">value</span>: <span class="string">"switchShow"</span>, <span class="attr">dynamic</span>: <span class="literal">false</span>, <span class="attr">start</span>: <span class="number">53</span>, <span class="attr">end</span>: <span class="number">72</span>&#125;</span><br><span class="line">      hasBindings: <span class="literal">true</span></span><br><span class="line">      parent: &#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">"div"</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">attrsMap</span>: &#123;…&#125;, <span class="attr">rawAttrsMap</span>: &#123;…&#125;, …&#125;</span><br><span class="line">      plain: <span class="literal">false</span></span><br><span class="line">      rawAttrsMap: &#123;@click: &#123;…&#125;&#125;</span><br><span class="line">      start: <span class="number">45</span></span><br><span class="line">      tag: <span class="string">"button"</span></span><br><span class="line">      type: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="number">1</span>: &#123;<span class="attr">type</span>: <span class="number">3</span>, <span class="attr">text</span>: <span class="string">" "</span>, <span class="attr">start</span>: <span class="number">84</span>, <span class="attr">end</span>: <span class="number">93</span>&#125;</span><br><span class="line">    <span class="number">2</span>: &#123;</span><br><span class="line">      attrsList: <span class="built_in">Array</span>(<span class="number">0</span>)</span><br><span class="line">      length: <span class="number">0</span></span><br><span class="line">      attrsMap: &#123;v-<span class="keyword">if</span>: <span class="string">"show"</span>&#125;</span><br><span class="line">      children: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">        <span class="number">0</span>: &#123;<span class="attr">type</span>: <span class="number">2</span>, <span class="attr">expression</span>: <span class="string">"_s(show ? 'bad ass' : 'motherfucker')"</span>, <span class="attr">tokens</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">text</span>: <span class="string">"$[ show ? 'bad ass' : 'motherfucker' ]"</span>, <span class="attr">start</span>: <span class="number">110</span>, …&#125;</span><br><span class="line">      end: <span class="number">154</span></span><br><span class="line">      <span class="keyword">if</span>: <span class="string">"show"</span></span><br><span class="line">      ifConditions: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">        <span class="number">0</span>: &#123;<span class="attr">exp</span>: <span class="string">"show"</span>, <span class="attr">block</span>: &#123;…&#125;&#125;</span><br><span class="line">      parent: &#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">"div"</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">attrsMap</span>: &#123;…&#125;, <span class="attr">rawAttrsMap</span>: &#123;…&#125;, …&#125;</span><br><span class="line">      plain: <span class="literal">true</span></span><br><span class="line">      rawAttrsMap: &#123;v-<span class="keyword">if</span>: &#123;…&#125;&#125;</span><br><span class="line">      start: <span class="number">93</span></span><br><span class="line">      tag: <span class="string">"div"</span></span><br><span class="line">      type: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="number">3</span>: &#123;<span class="attr">type</span>: <span class="number">3</span>, <span class="attr">text</span>: <span class="string">" "</span>, <span class="attr">start</span>: <span class="number">154</span>, <span class="attr">end</span>: <span class="number">163</span>&#125;</span><br><span class="line">  <span class="number">4</span>: &#123;</span><br><span class="line">    attrsList: []</span><br><span class="line">    attrsMap: &#123;&#125;</span><br><span class="line">    children: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">      <span class="number">0</span>: &#123;</span><br><span class="line">        alias: <span class="string">"food"</span></span><br><span class="line">        attrsList: []</span><br><span class="line">        attrsMap: &#123;v-<span class="keyword">for</span>: <span class="string">"food in foodList"</span>, :key: <span class="string">"food.name"</span>&#125;</span><br><span class="line">        children: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">          <span class="number">0</span>: &#123;<span class="attr">type</span>: <span class="number">2</span>, <span class="attr">expression</span>: <span class="string">"_s(food.name)+\"：￥ \"+_s(food.price)"</span>, <span class="attr">tokens</span>: <span class="built_in">Array</span>(<span class="number">3</span>), <span class="attr">text</span>: <span class="string">"$[food.name]：￥ $[food.price]"</span>, <span class="attr">start</span>: <span class="number">249</span>, …&#125;</span><br><span class="line">        end: <span class="number">282</span></span><br><span class="line">        <span class="keyword">for</span>: <span class="string">"foodList"</span></span><br><span class="line">        key: <span class="string">"food.name"</span></span><br><span class="line">        parent: &#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">"ul"</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">0</span>), <span class="attr">attrsMap</span>: &#123;…&#125;, <span class="attr">rawAttrsMap</span>: &#123;…&#125;, …&#125;</span><br><span class="line">        plain: <span class="literal">false</span></span><br><span class="line">        rawAttrsMap: &#123;v-<span class="keyword">for</span>: &#123;…&#125;, :key: &#123;…&#125;&#125;</span><br><span class="line">        start: <span class="number">203</span></span><br><span class="line">        tag: <span class="string">"li"</span></span><br><span class="line">        type: <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    end: <span class="number">296</span></span><br><span class="line">    parent: &#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">"div"</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">attrsMap</span>: &#123;…&#125;, <span class="attr">rawAttrsMap</span>: &#123;…&#125;, …&#125;</span><br><span class="line">    plain: <span class="literal">true</span></span><br><span class="line">    rawAttrsMap: &#123;&#125;</span><br><span class="line">    start: <span class="number">186</span></span><br><span class="line">    tag: <span class="string">"ul"</span></span><br><span class="line">    type: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="number">5</span>: &#123;<span class="attr">type</span>: <span class="number">3</span>, <span class="attr">text</span>: <span class="string">" "</span>, <span class="attr">start</span>: <span class="number">296</span>, <span class="attr">end</span>: <span class="number">305</span>&#125;</span><br><span class="line">  <span class="number">6</span>: &#123;</span><br><span class="line">    attrsList: []</span><br><span class="line">    attrsMap: &#123;&#125;</span><br><span class="line">    children: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">      <span class="number">0</span>: &#123;</span><br><span class="line">        attrsList: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">          <span class="number">0</span>: &#123;<span class="attr">name</span>: <span class="string">"v-model"</span>, <span class="attr">value</span>: <span class="string">"text"</span>, <span class="attr">start</span>: <span class="number">342</span>, <span class="attr">end</span>: <span class="number">356</span>&#125;</span><br><span class="line">        length: <span class="number">1</span></span><br><span class="line">        attrsMap: &#123;v-model: <span class="string">"text"</span>&#125;</span><br><span class="line">        children: []</span><br><span class="line">        directives: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">          <span class="number">0</span>: &#123;<span class="attr">name</span>: <span class="string">"model"</span>, <span class="attr">rawName</span>: <span class="string">"v-model"</span>, <span class="attr">value</span>: <span class="string">"text"</span>, <span class="attr">arg</span>: <span class="literal">null</span>, <span class="attr">isDynamicArg</span>: <span class="literal">false</span>, …&#125;</span><br><span class="line">        length: <span class="number">1</span></span><br><span class="line">        end: <span class="number">357</span></span><br><span class="line">        hasBindings: <span class="literal">true</span></span><br><span class="line">        parent: &#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">"div"</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">0</span>), <span class="attr">attrsMap</span>: &#123;…&#125;, <span class="attr">rawAttrsMap</span>: &#123;…&#125;, …&#125;</span><br><span class="line">        plain: <span class="literal">false</span></span><br><span class="line">        rawAttrsMap: &#123;v-model: &#123;…&#125;&#125;</span><br><span class="line">        start: <span class="number">335</span></span><br><span class="line">        tag: <span class="string">"input"</span></span><br><span class="line">        type: <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    end: <span class="number">363</span></span><br><span class="line">    parent: &#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">"div"</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">attrsMap</span>: &#123;…&#125;, <span class="attr">rawAttrsMap</span>: &#123;…&#125;, …&#125;</span><br><span class="line">    plain: <span class="literal">true</span></span><br><span class="line">    rawAttrsMap: &#123;&#125;</span><br><span class="line">    start: <span class="number">330</span></span><br><span class="line">    tag: <span class="string">"div"</span></span><br><span class="line">    type: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="number">7</span>: &#123;<span class="attr">type</span>: <span class="number">3</span>, <span class="attr">text</span>: <span class="string">" "</span>, <span class="attr">start</span>: <span class="number">363</span>, <span class="attr">end</span>: <span class="number">372</span>&#125;</span><br><span class="line">  <span class="number">8</span>: &#123;</span><br><span class="line">    attrsList: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">      <span class="number">0</span>: &#123;<span class="attr">name</span>: <span class="string">"@click"</span>, <span class="attr">value</span>: <span class="string">"update"</span>, <span class="attr">start</span>: <span class="number">428</span>, <span class="attr">end</span>: <span class="number">443</span>&#125;</span><br><span class="line">    attrsMap: &#123;:class: "bindClass", @click: "update"&#125;</span><br><span class="line">    children: <span class="built_in">Array</span>(<span class="number">1</span>)</span><br><span class="line">      <span class="number">0</span>: &#123;<span class="attr">type</span>: <span class="number">2</span>, <span class="attr">expression</span>: <span class="string">"_s(sum)"</span>, <span class="attr">tokens</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">text</span>: <span class="string">"$[sum]"</span>, <span class="attr">start</span>: <span class="number">444</span>, …&#125;</span><br><span class="line">    classBinding: <span class="string">"bindClass"</span></span><br><span class="line">    end: <span class="number">456</span></span><br><span class="line">    events:</span><br><span class="line">      click: &#123;<span class="attr">value</span>: <span class="string">"update"</span>, <span class="attr">dynamic</span>: <span class="literal">false</span>, <span class="attr">start</span>: <span class="number">428</span>, <span class="attr">end</span>: <span class="number">443</span>&#125;</span><br><span class="line">    hasBindings: <span class="literal">true</span></span><br><span class="line">    parent: &#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">"div"</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">attrsMap</span>: &#123;…&#125;, <span class="attr">rawAttrsMap</span>: &#123;…&#125;, …&#125;</span><br><span class="line">    plain: <span class="literal">false</span></span><br><span class="line">    rawAttrsMap: &#123;:class: &#123;…&#125;, @click: &#123;…&#125;&#125;</span><br><span class="line">    start: <span class="number">404</span></span><br><span class="line">    tag: <span class="string">"div"</span></span><br><span class="line">    type: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  length: <span class="number">9</span></span><br><span class="line">  end: <span class="number">467</span></span><br><span class="line">  parent: <span class="literal">undefined</span></span><br><span class="line">  plain: <span class="literal">false</span></span><br><span class="line">  rawAttrsMap: &#123;<span class="attr">id</span>: &#123;…&#125;&#125;</span><br><span class="line">  start: <span class="number">0</span></span><br><span class="line">  tag: <span class="string">"div"</span></span><br><span class="line">  type: <span class="number">1</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="generate"><a href="#generate" class="headerlink" title="generate"></a>generate</h2><p>将上边的 AST 转换为代码</p>
<p>从根节点开始, genElement, 在其内会判断节点上是否有各类属性, 根节点就一个 id, 所以会进入 genAttrs -&gt; genProps, 接着判断属性是动态还是静态, 这里的 id 就直接写入 <code>&quot;${prop.name}&quot;:${value},</code>, 以此就获得了根节点的代码; </p>
<p>接着会读取根节点下 children, 使用 genChildren 生成子节点的代码, 在其内用 map 遍历 children, 每个 child 都使用 genNode 来创建代码; 根据当前节点的类型, 看是元素节点1, 还是注释节点2, 或者是文本节点3, 分别采用 genElement genComment genText 来创建对应的代码, 最后再拼接在一起.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'with(this)&#123;return _c('</span>div<span class="string">',&#123;attrs:&#123;"id":"app"&#125;&#125;,[_c('</span>button<span class="string">',&#123;on:&#123;"click":switchShow&#125;&#125;,[_v("开关")]),_v(" "),(show)?_c('</span>div<span class="string">',[_v(_s(show ? '</span>bad ass<span class="string">' : '</span>motherfucker<span class="string">'))]):_e(),_v(" "),_c('</span>ul<span class="string">',_l((foodList),function(food)&#123;return _c('</span>li<span class="string">',&#123;key:food.name&#125;,[_v(_s(food.name)+"：￥ "+_s(food.price))])&#125;),0),_v(" "),_c('</span>div<span class="string">',[_c('</span>input<span class="string">',&#123;directives:[&#123;name:"model",rawName:"v-model",value:(text),expression:"text"&#125;],domProps:&#123;"value":(text)&#125;,on:&#123;"input":function($event)&#123;if($event.target.composing)return;text=$event.target.value&#125;&#125;&#125;)]),_v(" "),_c('</span>div<span class="string">',&#123;class:bindClass,on:&#123;"click":update&#125;&#125;,[_v(_s(sum))])])&#125;'</span></span><br></pre></td></tr></table></figure>
<p>继续将代码转成 render 函数返回, 也是涉及 _c, _v, _e, _l, _s 等工作, 在之后执行到 updateComponent 时, 调用 render 函数执行代码生成 VNode</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ƒ anonymous(</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">with</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> _c(<span class="string">'div'</span>,&#123;</span><br><span class="line">      attrs:&#123;<span class="string">"id"</span>:<span class="string">"app"</span>&#125;&#125;,[</span><br><span class="line">        _c(<span class="string">'button'</span>,&#123;<span class="attr">on</span>:&#123;<span class="string">"click"</span>:switchShow&#125;&#125;,[_v(<span class="string">"开关"</span>)]), <span class="comment">// event</span></span><br><span class="line">        _v(<span class="string">" "</span>),</span><br><span class="line">        (show)?_c(<span class="string">'div'</span>,[_v(_s(show ? <span class="string">'bad ass'</span> : <span class="string">'motherfucker'</span>))]):_e(), <span class="comment">// v-if</span></span><br><span class="line">        _v(<span class="string">" "</span>),</span><br><span class="line">        _c(<span class="string">'ul'</span>,_l((foodList),<span class="function"><span class="keyword">function</span>(<span class="params">food</span>)</span>&#123;</span><br><span class="line">          <span class="keyword">return</span> _c(<span class="string">'li'</span>,&#123;<span class="attr">key</span>:food.name&#125;,[</span><br><span class="line">            _v(_s(food.name)+<span class="string">"：￥ "</span>+_s(food.price))</span><br><span class="line">          ])</span><br><span class="line">        &#125;),<span class="number">0</span>), <span class="comment">// v-for</span></span><br><span class="line">        _v(<span class="string">" "</span>),</span><br><span class="line">        _c(<span class="string">'div'</span>,[_c(<span class="string">'input'</span>,&#123;</span><br><span class="line">          directives:[&#123;<span class="attr">name</span>:<span class="string">"model"</span>,<span class="attr">rawName</span>:<span class="string">"v-model"</span>,<span class="attr">value</span>:(text),<span class="attr">expression</span>:<span class="string">"text"</span>&#125;],</span><br><span class="line">          domProps:&#123;<span class="string">"value"</span>:(text)&#125;,</span><br><span class="line">          on:&#123;</span><br><span class="line">            <span class="string">"input"</span>:<span class="function"><span class="keyword">function</span>(<span class="params">$event</span>)</span>&#123;<span class="keyword">if</span>($event.target.composing)<span class="keyword">return</span>;text=$event.target.value&#125;</span><br><span class="line">          &#125;&#125;)]</span><br><span class="line">        ), <span class="comment">// v-model</span></span><br><span class="line">        _v(<span class="string">" "</span>),</span><br><span class="line">        _c(<span class="string">'div'</span>,&#123;<span class="attr">class</span>:bindClass,<span class="attr">on</span>:&#123;<span class="string">"click"</span>:update&#125;&#125;,[_v(_s(sum))])])&#125; <span class="comment">// v-bind &amp; event</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="render"><a href="#render" class="headerlink" title="render"></a>render</h2><p>因为 with(this) 的作用, 将当前代码块处于 vm._renderProxy 作用域下, 这时读取代码块中的变量就会在该作用域下进行查找, 而 vm 做了代理, 会使得在获取变量(也就是 vm 下的属性) 时会触发 hasHandler 进行检测 vm 当前是否有这个属性;</p>
<p>从根节点的 children 开始, 依次将 child 虚拟节点化; 从外到里获取变量, 从里到外执行函数, 比如第一个 child, 就是先获取 _c(之前还会获取一次根的), switchShow, _v; 然后接着从 _v 执行, 创建虚拟文本节点, 接着执行 _c, 创建元素节点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一段 事件</span></span><br><span class="line">_c(<span class="string">'button'</span>,&#123;<span class="attr">on</span>:&#123;<span class="string">"click"</span>:switchShow&#125;&#125;,[_v(<span class="string">"开关"</span>)])</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第三段 v-if</span></span><br><span class="line">(show)?_c(<span class="string">'div'</span>,[_v(_s(show ? <span class="string">'bad ass'</span> : <span class="string">'motherfucker'</span>))]):_e()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第五段 v-for</span></span><br><span class="line">_c(<span class="string">'ul'</span>,_l((foodList),<span class="function"><span class="keyword">function</span>(<span class="params">food</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> _c(<span class="string">'li'</span>,&#123;<span class="attr">key</span>:food.name&#125;,[</span><br><span class="line">    _v(_s(food.name)+<span class="string">"：￥ "</span>+_s(food.price))</span><br><span class="line">  ])</span><br><span class="line">&#125;),<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第七段 v-model</span></span><br><span class="line">_c(<span class="string">'div'</span>,[_c(<span class="string">'input'</span>,&#123;</span><br><span class="line">  directives:[&#123;<span class="attr">name</span>:<span class="string">"model"</span>,<span class="attr">rawName</span>:<span class="string">"v-model"</span>,<span class="attr">value</span>:(text),<span class="attr">expression</span>:<span class="string">"text"</span>&#125;],</span><br><span class="line">  domProps:&#123;<span class="string">"value"</span>:(text)&#125;,</span><br><span class="line">  on:&#123;</span><br><span class="line">    <span class="string">"input"</span>:<span class="function"><span class="keyword">function</span>(<span class="params">$event</span>)</span>&#123;<span class="keyword">if</span>($event.target.composing)<span class="keyword">return</span>;text=$event.target.value&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)])</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第九段 </span></span><br><span class="line">_c(<span class="string">'div'</span>,&#123;<span class="attr">class</span>:bindClass,<span class="attr">on</span>:&#123;<span class="string">"click"</span>:update&#125;&#125;,[_v(_s(sum))])])&#125;</span><br></pre></td></tr></table></figure>
<h2 id="update"><a href="#update" class="headerlink" title="update"></a>update</h2><p>经过 render 函数, AST 树也就转换成了 VNode</p>
<p>接下来判断当前实例是否存在 prevVnode , 如无则说明是根节点挂载, 执行 <code>__patch__</code> 进行打包, 将 VNode 转成 dom 节点</p>
<p>判断传入 patch 的旧节点类型, 如是真实节点则以旧节点创建一个新的空虚拟节点, 保留真实的节点为 elm 属性; 同时记旧节点真实节点为 oldElm, 其父级节点为 parentElm; 接着 createElm 对 vnode 进行创建 dom 节点</p>
<p>给 vnode 创建真实节点 vnode.elm; 接着给其 children 创建节点; 遍历 children, 对每个子节点均进行 createElm, 完成属性等 data 绑定至新节点 vnode.elm; 最后将 children 也插入到根 vnode.elm</p>
<p>接着 removeVnodes 清除掉 oldVnode; 然后执行 invokeInsertHook, 对处理执行时 个别节点 data.hook.insert 赋值的进行 insert; 这里也就是给 input 继续绑定了 compositionStart, change 等方法</p>
<p>最后令 <code>vm.$el.__vue__ = vm</code>; <code>vm._isMounted = true</code> 作以标记, 至此挂载过程走完, 执行 mounted 钩子函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">vnode: VNode &#123;</span><br><span class="line">  asyncFactory: <span class="literal">undefined</span></span><br><span class="line">  asyncMeta: <span class="literal">undefined</span></span><br><span class="line">  children: <span class="built_in">Array</span>(<span class="number">9</span>)</span><br><span class="line">    <span class="number">0</span>: VNode &#123;<span class="attr">tag</span>: <span class="string">"button"</span>, <span class="attr">data</span>: &#123;…&#125;, <span class="attr">children</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">text</span>: <span class="literal">undefined</span>, <span class="attr">elm</span>: <span class="literal">undefined</span>, …&#125;</span><br><span class="line">    <span class="number">1</span>: VNode &#123;<span class="attr">tag</span>: <span class="literal">undefined</span>, <span class="attr">data</span>: <span class="literal">undefined</span>, <span class="attr">children</span>: <span class="literal">undefined</span>, <span class="attr">text</span>: <span class="string">" "</span>, <span class="attr">elm</span>: <span class="literal">undefined</span>, …&#125;</span><br><span class="line">    <span class="number">2</span>: VNode &#123;<span class="attr">tag</span>: <span class="string">"div"</span>, <span class="attr">data</span>: <span class="literal">undefined</span>, <span class="attr">children</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">text</span>: <span class="literal">undefined</span>, <span class="attr">elm</span>: <span class="literal">undefined</span>, …&#125;</span><br><span class="line">    <span class="number">3</span>: VNode &#123;<span class="attr">tag</span>: <span class="literal">undefined</span>, <span class="attr">data</span>: <span class="literal">undefined</span>, <span class="attr">children</span>: <span class="literal">undefined</span>, <span class="attr">text</span>: <span class="string">" "</span>, <span class="attr">elm</span>: <span class="literal">undefined</span>, …&#125;</span><br><span class="line">    <span class="number">4</span>: VNode &#123;<span class="attr">tag</span>: <span class="string">"ul"</span>, <span class="attr">data</span>: <span class="literal">undefined</span>, <span class="attr">children</span>: <span class="built_in">Array</span>(<span class="number">3</span>), <span class="attr">text</span>: <span class="literal">undefined</span>, <span class="attr">elm</span>: <span class="literal">undefined</span>, …&#125;</span><br><span class="line">    <span class="number">5</span>: VNode &#123;<span class="attr">tag</span>: <span class="literal">undefined</span>, <span class="attr">data</span>: <span class="literal">undefined</span>, <span class="attr">children</span>: <span class="literal">undefined</span>, <span class="attr">text</span>: <span class="string">" "</span>, <span class="attr">elm</span>: <span class="literal">undefined</span>, …&#125;</span><br><span class="line">    <span class="number">6</span>: VNode &#123;<span class="attr">tag</span>: <span class="string">"div"</span>, <span class="attr">data</span>: <span class="literal">undefined</span>, <span class="attr">children</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">text</span>: <span class="literal">undefined</span>, <span class="attr">elm</span>: <span class="literal">undefined</span>, …&#125;</span><br><span class="line">    <span class="number">7</span>: VNode &#123;<span class="attr">tag</span>: <span class="literal">undefined</span>, <span class="attr">data</span>: <span class="literal">undefined</span>, <span class="attr">children</span>: <span class="literal">undefined</span>, <span class="attr">text</span>: <span class="string">" "</span>, <span class="attr">elm</span>: <span class="literal">undefined</span>, …&#125;</span><br><span class="line">    <span class="number">8</span>: VNode &#123;<span class="attr">tag</span>: <span class="string">"div"</span>, <span class="attr">data</span>: &#123;…&#125;, <span class="attr">children</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">text</span>: <span class="literal">undefined</span>, <span class="attr">elm</span>: <span class="literal">undefined</span>, …&#125;</span><br><span class="line">    length: <span class="number">9</span></span><br><span class="line">    [[Prototype]]: <span class="built_in">Array</span>(<span class="number">0</span>)</span><br><span class="line">  componentInstance: <span class="literal">undefined</span></span><br><span class="line">  componentOptions: <span class="literal">undefined</span></span><br><span class="line">  context: Vue &#123;<span class="attr">_uid</span>: <span class="number">0</span>, <span class="attr">_isVue</span>: <span class="literal">true</span>, <span class="attr">$options</span>: &#123;…&#125;, <span class="attr">_renderProxy</span>: <span class="built_in">Proxy</span>, <span class="attr">_self</span>: Vue, …&#125;</span><br><span class="line">  data: &#123;<span class="attr">attrs</span>: &#123;…&#125;&#125;</span><br><span class="line">  elm: <span class="literal">undefined</span></span><br><span class="line">  fnContext: <span class="literal">undefined</span></span><br><span class="line">  fnOptions: <span class="literal">undefined</span></span><br><span class="line">  fnScopeId: <span class="literal">undefined</span></span><br><span class="line">  isAsyncPlaceholder: <span class="literal">false</span></span><br><span class="line">  isCloned: <span class="literal">false</span></span><br><span class="line">  isComment: <span class="literal">false</span></span><br><span class="line">  isOnce: <span class="literal">false</span></span><br><span class="line">  isRootInsert: <span class="literal">true</span></span><br><span class="line">  isStatic: <span class="literal">false</span></span><br><span class="line">  key: <span class="literal">undefined</span></span><br><span class="line">  ns: <span class="literal">undefined</span></span><br><span class="line">  parent: <span class="literal">undefined</span></span><br><span class="line">  raw: <span class="literal">false</span></span><br><span class="line">  tag: <span class="string">"div"</span></span><br><span class="line">  text: <span class="literal">undefined</span></span><br><span class="line">  child: <span class="literal">undefined</span></span><br><span class="line">  [[Prototype]]: <span class="built_in">Object</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="event"><a href="#event" class="headerlink" title="event"></a>event</h1><h2 id="processAttrs"><a href="#processAttrs" class="headerlink" title="processAttrs"></a>processAttrs</h2><p>在经过 processAttrs 处理后，v-on 或 @ 会被读取到，接着给当前节点层 AST 加入 events 属性, 对特殊的属性绑定也会增加 <code>hasBindings:true</code></p>
<p>如下，例子中是在 button 上加入了点击事件 switchShow</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  attrsList:(<span class="number">1</span>) [&#123;…&#125;]</span><br><span class="line">  attrsMap:&#123;@click: <span class="string">'switchShow'</span>&#125;</span><br><span class="line">  children:(<span class="number">1</span>) [&#123;…&#125;]</span><br><span class="line">  plain:<span class="literal">false</span></span><br><span class="line">  end:<span class="number">84</span></span><br><span class="line">  start:<span class="number">45</span></span><br><span class="line">  hasBindings:<span class="literal">true</span></span><br><span class="line">  parent:&#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">'div'</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">attrsMap</span>: &#123;…&#125;, <span class="attr">rawAttrsMap</span>: &#123;…&#125;, …&#125;</span><br><span class="line">  events:&#123;<span class="attr">click</span>: &#123;…&#125;&#125;</span><br><span class="line">    click:&#123;<span class="attr">value</span>: <span class="string">'switchShow'</span>, <span class="attr">dynamic</span>: <span class="literal">false</span>, <span class="attr">start</span>: <span class="number">53</span>, <span class="attr">end</span>: <span class="number">72</span>&#125;</span><br><span class="line">  rawAttrsMap:&#123;@click: &#123;…&#125;&#125;</span><br><span class="line">    @click:&#123;<span class="attr">name</span>: <span class="string">'@click'</span>, <span class="attr">value</span>: <span class="string">'switchShow'</span>, <span class="attr">start</span>: <span class="number">53</span>, <span class="attr">end</span>: <span class="number">72</span>&#125;</span><br><span class="line">  tag:<span class="string">'button'</span></span><br><span class="line">  type:<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (onRE.test(name)) &#123; <span class="comment">// v-on</span></span><br><span class="line">  name = name.replace(onRE, <span class="string">''</span>)</span><br><span class="line">  isDynamic = dynamicArgRE.test(name)</span><br><span class="line">  <span class="keyword">if</span> (isDynamic) &#123;</span><br><span class="line">    name = name.slice(<span class="number">1</span>, <span class="number">-1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  addHandler(el, name, value, modifiers, <span class="literal">false</span>, warn, list[i], isDynamic)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="genElement"><a href="#genElement" class="headerlink" title="genElement"></a>genElement</h2><p>在生成事件节点代码时, 主要执行到以下函数: genData genChildren</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!el.plain || (el.pre &amp;&amp; state.maybeComponent(el))) &#123;</span><br><span class="line">  data = genData(el, state)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> children = el.inlineTemplate ? <span class="literal">null</span> : genChildren(el, state, <span class="literal">true</span>)</span><br><span class="line">code = <span class="string">`_c('<span class="subst">$&#123;el.tag&#125;</span>'<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">  data ? <span class="string">`,<span class="subst">$&#123;data&#125;</span>`</span> : <span class="string">''</span> <span class="regexp">//</span> data</span></span></span><br><span class="line"><span class="string"><span class="subst">&#125;</span><span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">  children ? <span class="string">`,<span class="subst">$&#123;children&#125;</span>`</span> : <span class="string">''</span> <span class="regexp">//</span> children</span></span></span><br><span class="line"><span class="string"><span class="subst">&#125;</span>)`</span></span><br></pre></td></tr></table></figure>
<h2 id="genData"><a href="#genData" class="headerlink" title="genData"></a>genData</h2><p>事件节点存在 events, 接着执行 genHandlers</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (el.events) &#123;</span><br><span class="line">  data += <span class="string">`<span class="subst">$&#123;genHandlers(el.events, <span class="literal">false</span>)&#125;</span>,`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="genHandlers"><a href="#genHandlers" class="headerlink" title="genHandlers"></a>genHandlers</h2><p>遍历 events, 得到事件对应的方法, 拼接在一起, 再给前边加上 on: , 如例中是一个点击事件 ‘{on:{“click”:switchShow},’</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">genHandlers</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  events: ASTElementHandlers,</span></span></span><br><span class="line"><span class="function"><span class="params">  isNative: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prefix = isNative ? <span class="string">'nativeOn:'</span> : <span class="string">'on:'</span></span><br><span class="line">  <span class="keyword">let</span> staticHandlers = <span class="string">``</span></span><br><span class="line">  <span class="keyword">let</span> dynamicHandlers = <span class="string">``</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> name <span class="keyword">in</span> events) &#123;</span><br><span class="line">    <span class="keyword">const</span> handlerCode = genHandler(events[name])</span><br><span class="line">    <span class="keyword">if</span> (events[name] &amp;&amp; events[name].dynamic) &#123;</span><br><span class="line">      dynamicHandlers += <span class="string">`<span class="subst">$&#123;name&#125;</span>,<span class="subst">$&#123;handlerCode&#125;</span>,`</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      staticHandlers += <span class="string">`"<span class="subst">$&#123;name&#125;</span>":<span class="subst">$&#123;handlerCode&#125;</span>,`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  staticHandlers = <span class="string">`&#123;<span class="subst">$&#123;staticHandlers.slice(<span class="number">0</span>, <span class="number">-1</span>)&#125;</span>&#125;`</span></span><br><span class="line">  <span class="keyword">if</span> (dynamicHandlers) &#123;</span><br><span class="line">    <span class="keyword">return</span> prefix + <span class="string">`_d(<span class="subst">$&#123;staticHandlers&#125;</span>,[<span class="subst">$&#123;dynamicHandlers.slice(<span class="number">0</span>, <span class="number">-1</span>)&#125;</span>])`</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> prefix + staticHandlers</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createElement"><a href="#createElement" class="headerlink" title="createElement"></a>createElement</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_c(<span class="string">'button'</span>,&#123;<span class="attr">on</span>:&#123;<span class="string">"click"</span>:switchShow&#125;&#125;,[_v(<span class="string">"开关"</span>)])</span><br></pre></td></tr></table></figure>
<p>针对以上代码, _c 实际上就是 createElement 方法, 在第一位参数传递了 vm 后, 剩下的参数由上边生成的代码传入, 因此 createElement 方法第二位参数就是 tag 标签; 第三位是 data, 也是当前节点的属性; 第四位是 children, 也是节点的子节点, 在此的 _v 表示这个子节点是文本节点.</p>
<p>当前节点 tag 为 html 内置标签, 那么就进行创建元素节点 vnode, 将这一段 _c 用vnode 替换掉, 完成后进入下一个虚拟节点的创建</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createElement</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  context: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  data: any, <span class="regexp">//</span> 节点对应的属性数据</span></span></span><br><span class="line"><span class="function"><span class="params">  children: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  normalizationType: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  alwaysNormalize: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">VNode</span> | <span class="title">Array</span>&lt;<span class="title">VNode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(data) || isPrimitive(data)) &#123;</span><br><span class="line">    normalizationType = children</span><br><span class="line">    children = data</span><br><span class="line">    data = <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isTrue(alwaysNormalize)) &#123;</span><br><span class="line">    normalizationType = ALWAYS_NORMALIZE</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> _createElement(context, tag, data, children, normalizationType)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">_createElement</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  context: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag?: string | Class&lt;Component&gt; | Function | Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  data?: VNodeData,</span></span></span><br><span class="line"><span class="function"><span class="params">  children?: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  normalizationType?: number</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">VNode</span> | <span class="title">Array</span>&lt;<span class="title">VNode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isDef(data) &amp;&amp; isDef((data: any).__ob__)) &#123;</span><br><span class="line">    process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warn(</span><br><span class="line">      <span class="string">`Avoid using observed data object as vnode data: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(data)&#125;</span>\n`</span> +</span><br><span class="line">      <span class="string">'Always create fresh vnode data objects in each render!'</span>,</span><br><span class="line">      context</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> createEmptyVNode()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// object syntax in v-bind</span></span><br><span class="line">  <span class="keyword">if</span> (isDef(data) &amp;&amp; isDef(data.is)) &#123;</span><br><span class="line">    tag = data.is</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!tag) &#123;</span><br><span class="line">    <span class="comment">// in case of component :is set to falsy value</span></span><br><span class="line">    <span class="keyword">return</span> createEmptyVNode()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// warn against non-primitive key</span></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">    isDef(data) &amp;&amp; isDef(data.key) &amp;&amp; !isPrimitive(data.key)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!__WEEX__ || !(<span class="string">'@binding'</span> <span class="keyword">in</span> data.key)) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">'Avoid using non-primitive value as key, '</span> +</span><br><span class="line">        <span class="string">'use string/number value instead.'</span>,</span><br><span class="line">        context</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// support single function children as default scoped slot</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(children) &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> children[<span class="number">0</span>] === <span class="string">'function'</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    data = data || &#123;&#125;</span><br><span class="line">    data.scopedSlots = &#123; <span class="attr">default</span>: children[<span class="number">0</span>] &#125;</span><br><span class="line">    children.length = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 规范化 children</span></span><br><span class="line">  <span class="keyword">if</span> (normalizationType === ALWAYS_NORMALIZE) &#123; <span class="comment">// 标准化-公共，1.render 函数是用户手写的；2.编译 slot、v-for 的时候会产生嵌套数组的情况</span></span><br><span class="line">    children = normalizeChildren(children)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (normalizationType === SIMPLE_NORMALIZE) &#123; <span class="comment">// 简易标准化-内部， render 函数是编译生成的</span></span><br><span class="line">    children = simpleNormalizeChildren(children)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 创建 VNode</span></span><br><span class="line">  <span class="keyword">let</span> vnode, ns</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> tag === <span class="string">'string'</span>) &#123; <span class="comment">// 标签为 string</span></span><br><span class="line">    <span class="keyword">let</span> Ctor</span><br><span class="line">    ns = (context.$vnode &amp;&amp; context.$vnode.ns) || config.getTagNamespace(tag)</span><br><span class="line">    <span class="comment">// 判断是否为内置的一些节点</span></span><br><span class="line">    <span class="keyword">if</span> (config.isReservedTag(tag)) &#123;</span><br><span class="line">      <span class="comment">// platform built-in elements</span></span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; isDef(data) &amp;&amp; isDef(data.nativeOn)) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`The .native modifier for v-on is only valid on components but it was used on &lt;<span class="subst">$&#123;tag&#125;</span>&gt;.`</span>,</span><br><span class="line">          context</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如为内置的节点类型，创建一个普通 VNode</span></span><br><span class="line">      vnode = <span class="keyword">new</span> VNode(</span><br><span class="line">        config.parsePlatformTagName(tag), data, children,</span><br><span class="line">        <span class="literal">undefined</span>, <span class="literal">undefined</span>, context</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((!data || !data.pre) &amp;&amp; isDef(Ctor = resolveAsset(context.$options, <span class="string">'components'</span>, tag))) &#123;</span><br><span class="line">      <span class="comment">// 如为已注册的组件名，则通过 createComponent 创建一个组件类型的 VNode</span></span><br><span class="line">      <span class="comment">// component</span></span><br><span class="line">      vnode = createComponent(Ctor, data, context, children, tag)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 创建一个未知的标签的 VNode</span></span><br><span class="line">      <span class="comment">// unknown or unlisted namespaced elements</span></span><br><span class="line">      <span class="comment">// check at runtime because it may get assigned a namespace when its</span></span><br><span class="line">      <span class="comment">// parent normalizes children</span></span><br><span class="line">      vnode = <span class="keyword">new</span> VNode(</span><br><span class="line">        tag, data, children,</span><br><span class="line">        <span class="literal">undefined</span>, <span class="literal">undefined</span>, context</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// tag 不是 string 而是 Component 类型，直接调用 createComponent 创建一个组件类型的 VNode 节点</span></span><br><span class="line">    <span class="comment">// direct component options / constructor</span></span><br><span class="line">    vnode = createComponent(tag, data, context, children)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(vnode)) &#123;</span><br><span class="line">    <span class="keyword">return</span> vnode</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isDef(vnode)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDef(ns)) applyNS(vnode, ns)</span><br><span class="line">    <span class="keyword">if</span> (isDef(data)) registerDeepBindings(data)</span><br><span class="line">    <span class="keyword">return</span> vnode</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> createEmptyVNode()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createElm"><a href="#createElm" class="headerlink" title="createElm"></a>createElm</h2><p>给当前的子节点创建真实节点挂在 elm 属性下</p>
<p>在创建好 button 节点后, 进入 createChildren, 创建文本节点, 再执行插入, 通过父节点 button 执行 appendChild 完成插入操作; </p>
<p>完成 createChildren 后, 进入 invokeCreateHooks, 通过执行 cbs 回调函数中的 create 下的系列创建方法, 完成新旧节点的更新; 这里的事件会执行 updateDOMListeners, 完成以下内容的同步更新; 接着将准备好的 children 插入到父级节点, 如此就算走完了当前这个事件节点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cbs.create &#123;</span><br><span class="line">  <span class="number">0</span>:ƒ updateAttrs(oldVnode, vnode)</span><br><span class="line">  <span class="number">1</span>:ƒ updateClass (oldVnode, vnode) </span><br><span class="line">  <span class="number">2</span>:ƒ updateDOMListeners (oldVnode, vnode) </span><br><span class="line">  <span class="number">3</span>:ƒ updateDOMProps(oldVnode, vnode)</span><br><span class="line">  <span class="number">4</span>:ƒ updateStyle(oldVnode, vnode)</span><br><span class="line">  <span class="number">5</span>:ƒ _enter (_, vnode) </span><br><span class="line">  <span class="number">6</span>:ƒ create (_, vnode) </span><br><span class="line">  <span class="number">7</span>:ƒ updateDirectives (oldVnode, vnode)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要涉及到的环节: </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">vnode.elm = vnode.ns</span><br><span class="line">  ? nodeOps.createElementNS(vnode.ns, tag)</span><br><span class="line">  : nodeOps.createElement(tag, vnode)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建子节点, 如果有属性 data, 初始化挂载属性 data, 后期更新属性 data</span></span><br><span class="line">createChildren(vnode, children, insertedVnodeQueue)</span><br><span class="line"><span class="keyword">if</span> (isDef(data)) &#123;</span><br><span class="line">  invokeCreateHooks(vnode, insertedVnodeQueue)</span><br><span class="line">&#125;</span><br><span class="line">insert(parentElm, vnode.elm, refElm)</span><br><span class="line"></span><br><span class="line"><span class="comment">// button 下子节点为文本节点</span></span><br><span class="line">vnode.elm = nodeOps.createTextNode(vnode.text)</span><br><span class="line"></span><br><span class="line"><span class="comment">// insert</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insert</span> (<span class="params">parent, elm, ref</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isDef(parent)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDef(ref)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (nodeOps.parentNode(ref) === parent) &#123;</span><br><span class="line">        nodeOps.insertBefore(parent, elm, ref)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      nodeOps.appendChild(parent, elm)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// invokeCreateHooks</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">invokeCreateHooks</span> (<span class="params">vnode, insertedVnodeQueue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cbs.create.length; ++i) &#123;</span><br><span class="line">    cbs.create[i](emptyNode, vnode)</span><br><span class="line">  &#125;</span><br><span class="line">  i = vnode.data.hook <span class="comment">// Reuse variable</span></span><br><span class="line">  <span class="keyword">if</span> (isDef(i)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDef(i.create)) i.create(emptyNode, vnode)</span><br><span class="line">    <span class="keyword">if</span> (isDef(i.insert)) insertedVnodeQueue.push(vnode) <span class="comment">// 插入的 VNode 队列</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// updateDOMListeners</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateDOMListeners</span> (<span class="params">oldVnode: VNodeWithData, vnode: VNodeWithData</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isUndef(oldVnode.data.on) &amp;&amp; isUndef(vnode.data.on)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> on = vnode.data.on || &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> oldOn = oldVnode.data.on || &#123;&#125;</span><br><span class="line">  target = vnode.elm</span><br><span class="line">  normalizeEvents(on)</span><br><span class="line">  updateListeners(on, oldOn, add, remove, createOnceHandler, vnode.context)</span><br><span class="line">  target = <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="updateDOMListeners"><a href="#updateDOMListeners" class="headerlink" title="updateDOMListeners"></a>updateDOMListeners</h2><p>获取新旧节点的 on 下的事件, 进行对比更新 updateListeners; 令 target 等于 vnode.elm, 也就是我们最终要获得新虚拟节点 dom 化后的真实节点;</p>
<p>在 updateListeners 函数中, 将新旧节点的 on 进行对比, 其实初始化时旧节点并没有什么, 只是生成的一个空的虚拟节点; 等到下次变动做更新时才是有内容的旧节点.</p>
<p>遍历新节点 on 中的方法, 对比新旧节点 on 中的事件: 新节点 on 中的方法是否未被定义? 若未定义则抛出时间错误; 新节点方法对应的函数有而旧节点没有, 则直接将该方法通过 addEventListener 添加至 target, 也就是新 vnode 的真实节点 elm; 最后一种情况是新旧节点的事件对应的函数不一致, 则令旧节点函数的 fns 等于新节点函数, 再更新新的为 old;</p>
<p>最后遍历旧节点的事件名, 倘若新节点里没有, 则移除这个事件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateDOMListeners</span> (<span class="params">oldVnode: VNodeWithData, vnode: VNodeWithData</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isUndef(oldVnode.data.on) &amp;&amp; isUndef(vnode.data.on)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> on = vnode.data.on || &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> oldOn = oldVnode.data.on || &#123;&#125;</span><br><span class="line">  target = vnode.elm</span><br><span class="line">  normalizeEvents(on)</span><br><span class="line">  updateListeners(on, oldOn, add, remove, createOnceHandler, vnode.context)</span><br><span class="line">  target = <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// updateListeners</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateListeners</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  on: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  oldOn: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  add: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  remove: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  createOnceHandler: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  vm: Component</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> name, def, cur, old, event</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> on) &#123;</span><br><span class="line">    def = cur = on[name]</span><br><span class="line">    old = oldOn[name]</span><br><span class="line">    event = normalizeEvent(name)</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (__WEEX__ &amp;&amp; isPlainObject(def)) &#123;</span><br><span class="line">      cur = def.handler</span><br><span class="line">      event.params = def.params</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isUndef(cur)) &#123;</span><br><span class="line">      process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warn(</span><br><span class="line">        <span class="string">`Invalid handler for event "<span class="subst">$&#123;event.name&#125;</span>": got `</span> + <span class="built_in">String</span>(cur),</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isUndef(old)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isUndef(cur.fns)) &#123;</span><br><span class="line">        cur = on[name] = createFnInvoker(cur, vm)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (isTrue(event.once)) &#123;</span><br><span class="line">        cur = on[name] = createOnceHandler(event.name, cur, event.capture)</span><br><span class="line">      &#125;</span><br><span class="line">      add(event.name, cur, event.capture, event.passive, event.params)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur !== old) &#123;</span><br><span class="line">      old.fns = cur</span><br><span class="line">      on[name] = old</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> oldOn) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isUndef(on[name])) &#123;</span><br><span class="line">      event = normalizeEvent(name)</span><br><span class="line">      remove(event.name, oldOn[name], event.capture)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// add</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  name: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  handler: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  capture: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  passive: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// async edge case #6566: inner click event triggers patch, event handler</span></span><br><span class="line">  <span class="comment">// attached to outer element during patch, and triggered again. This</span></span><br><span class="line">  <span class="comment">// happens because browsers fire microtask ticks between event propagation.</span></span><br><span class="line">  <span class="comment">// the solution is simple: we save the timestamp when a handler is attached,</span></span><br><span class="line">  <span class="comment">// and the handler would only fire if the event passed to it was fired</span></span><br><span class="line">  <span class="comment">// AFTER it was attached.</span></span><br><span class="line">  <span class="keyword">if</span> (useMicrotaskFix) &#123;</span><br><span class="line">    <span class="keyword">const</span> attachedTimestamp = currentFlushTimestamp</span><br><span class="line">    <span class="keyword">const</span> original = handler</span><br><span class="line">    handler = original._wrapper = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        <span class="comment">// no bubbling, should always fire.</span></span><br><span class="line">        <span class="comment">// this is just a safety net in case event.timeStamp is unreliable in</span></span><br><span class="line">        <span class="comment">// certain weird environments...</span></span><br><span class="line">        e.target === e.currentTarget ||</span><br><span class="line">        <span class="comment">// event is fired after handler attachment</span></span><br><span class="line">        e.timeStamp &gt;= attachedTimestamp ||</span><br><span class="line">        <span class="comment">// bail for environments that have buggy event.timeStamp implementations</span></span><br><span class="line">        <span class="comment">// #9462 iOS 9 bug: event.timeStamp is 0 after history.pushState</span></span><br><span class="line">        <span class="comment">// #9681 QtWebEngine event.timeStamp is negative value</span></span><br><span class="line">        e.timeStamp &lt;= <span class="number">0</span> ||</span><br><span class="line">        <span class="comment">// #9448 bail if event is fired in another document in a multi-page</span></span><br><span class="line">        <span class="comment">// electron/nw.js app, since event.timeStamp will be using a different</span></span><br><span class="line">        <span class="comment">// starting reference</span></span><br><span class="line">        e.target.ownerDocument !== <span class="built_in">document</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="keyword">return</span> original.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  target.addEventListener(</span><br><span class="line">    name,</span><br><span class="line">    handler,</span><br><span class="line">    supportsPassive</span><br><span class="line">      ? &#123; capture, passive &#125;</span><br><span class="line">      : capture</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="v-if"><a href="#v-if" class="headerlink" title="v-if"></a>v-if</h1><p>parseStartTag 中剪裁出标签 div 及属性 v-if=”show”, 将当前 attr 同步到 attrs 收集器, 再往下检测是否还有属性, 得知 end 也就是 &gt; 存在, 说明后续就再没属性了, 将 html 又可以推进到 end 的 index</p>
<p>解析完开始标签，那么接下就要处理开始标签，handleStartTag 传入刚才匹配到的结果，获取标签名，然后开始处理属性 match.attrs; 将 attrs 遍历，将每一对属性转成 { name, value } 存入 attrs; 接着将 tag、attrs 生成 AST 树, 其实没多少操作, 就将 attrs 生成了 <code>attrsMap {v-if: &#39;show&#39;}</code>; 接着走到 processIF, 给 v-if 添加 <code>IfConditions { exp: &#39;show&#39;, block: el }</code></p>
<p>接着往下判断, 获取下一个 &lt; 的位置, 将它之前的这段 text 剪下来, 将 html 推进; 接着将不是标签内容的 text 放入 chars 处理; 判断 currentParent(上段标签) 有无, 若有就说明 text 就是上一个标签内的内容; 接着检查 currentParent 是否是 style / script 标签, 若不是就解码这段 text; 然后解析处理好的 text, 看是否其中含有变量分隔符, 获取分隔符里的内容 exp, 用 _s() 包裹, 准备后续代码;最终得到该 text 的对象 child = {type: 2, expression, tokens, text}; 若是纯文本则没有 expression, tokens; 接着将 child 添加到父级的 children 中.</p>
<p>此时处理完的 v-if 的 AST 树为:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  attrsList:(<span class="number">0</span>) []</span><br><span class="line">  attrsMap:&#123;v-<span class="keyword">if</span>: <span class="string">'show'</span>&#125;</span><br><span class="line">  children:(<span class="number">1</span>) </span><br><span class="line">    <span class="number">0</span>:&#123;<span class="attr">type</span>: <span class="number">2</span>, <span class="attr">expression</span>: <span class="string">'_s(show ? '</span>bad ass<span class="string">' : '</span>motherfucker<span class="string">')'</span>, <span class="attr">tokens</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">text</span>: <span class="string">'$[ show ? '</span>bad ass<span class="string">' : '</span>motherfucker<span class="string">' ]'</span>, <span class="attr">start</span>: <span class="number">110</span>, …&#125;</span><br><span class="line">  <span class="keyword">if</span>:<span class="string">'show'</span></span><br><span class="line">  ifConditions:(<span class="number">1</span>)</span><br><span class="line">    <span class="number">0</span>:&#123;<span class="attr">exp</span>: <span class="string">'show'</span>, <span class="attr">block</span>: &#123;…&#125;&#125;</span><br><span class="line">  end:<span class="number">154</span></span><br><span class="line">  start:<span class="number">93</span></span><br><span class="line">  parent:&#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">'div'</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">attrsMap</span>: &#123;…&#125;,&#125;</span><br><span class="line">  rawAttrsMap:&#123;v-<span class="keyword">if</span>:&#123;<span class="attr">name</span>: <span class="string">'v-if'</span>, <span class="attr">value</span>: <span class="string">'show'</span>, <span class="attr">start</span>: <span class="number">98</span>, <span class="attr">end</span>: <span class="number">109</span>&#125;&#125;</span><br><span class="line">  plain:<span class="literal">true</span></span><br><span class="line">  tag:<span class="string">'div'</span></span><br><span class="line">  type:<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="parseHTML"><a href="#parseHTML" class="headerlink" title="parseHTML"></a>parseHTML</h2><p>从 while 开始处理 html, 不断推进生成 AST 树</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">parseHTML</span> (<span class="params">html, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> stack = []</span><br><span class="line">  <span class="keyword">const</span> expectHTML = options.expectHTML</span><br><span class="line">  <span class="keyword">const</span> isUnaryTag = options.isUnaryTag || no</span><br><span class="line">  <span class="keyword">const</span> canBeLeftOpenTag = options.canBeLeftOpenTag || no</span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> last, lastTag</span><br><span class="line">  <span class="keyword">while</span> (html) &#123;</span><br><span class="line">    last = html</span><br><span class="line">    <span class="comment">// Make sure we're not in a plaintext content element like script/style</span></span><br><span class="line">    <span class="keyword">if</span> (!lastTag || !isPlainTextElement(lastTag)) &#123;</span><br><span class="line">      <span class="keyword">let</span> textEnd = html.indexOf(<span class="string">'&lt;'</span>) <span class="comment">// 标记开始标签</span></span><br><span class="line">      <span class="keyword">if</span> (textEnd === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Comment:</span></span><br><span class="line">        <span class="keyword">if</span> (comment.test(html)) &#123;</span><br><span class="line">          <span class="keyword">const</span> commentEnd = html.indexOf(<span class="string">'--&gt;'</span>)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (commentEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (options.shouldKeepComment) &#123;</span><br><span class="line">              options.comment(html.substring(<span class="number">4</span>, commentEnd), index, index + commentEnd + <span class="number">3</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            advance(commentEnd + <span class="number">3</span>) <span class="comment">// --&gt; 占三位</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// http://en.wikipedia.org/wiki/Conditional_comment#Downlevel-revealed_conditional_comment</span></span><br><span class="line">        <span class="keyword">if</span> (conditionalComment.test(html)) &#123;</span><br><span class="line">          <span class="keyword">const</span> conditionalEnd = html.indexOf(<span class="string">']&gt;'</span>)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (conditionalEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            advance(conditionalEnd + <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Doctype:</span></span><br><span class="line">        <span class="keyword">const</span> doctypeMatch = html.match(doctype)</span><br><span class="line">        <span class="keyword">if</span> (doctypeMatch) &#123;</span><br><span class="line">          advance(doctypeMatch[<span class="number">0</span>].length)</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// End tag:</span></span><br><span class="line">        <span class="keyword">const</span> endTagMatch = html.match(endTag)</span><br><span class="line">        <span class="keyword">if</span> (endTagMatch) &#123;</span><br><span class="line">          <span class="keyword">const</span> curIndex = index</span><br><span class="line">          advance(endTagMatch[<span class="number">0</span>].length)</span><br><span class="line">          parseEndTag(endTagMatch[<span class="number">1</span>], curIndex, index)</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start tag:</span></span><br><span class="line">        <span class="keyword">const</span> startTagMatch = parseStartTag() <span class="comment">// 解析开始的标签，把 template 转化成节点名和属性</span></span><br><span class="line">        <span class="keyword">if</span> (startTagMatch) &#123;</span><br><span class="line">          handleStartTag(startTagMatch)</span><br><span class="line">          <span class="keyword">if</span> (shouldIgnoreFirstNewline(startTagMatch.tagName, html)) &#123;</span><br><span class="line">            advance(<span class="number">1</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> text, rest, next</span><br><span class="line">      <span class="keyword">if</span> (textEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        rest = html.slice(textEnd) <span class="comment">// 将结尾标签截出</span></span><br><span class="line">        <span class="keyword">while</span> (</span><br><span class="line">          !endTag.test(rest) &amp;&amp;</span><br><span class="line">          !startTagOpen.test(rest) &amp;&amp;</span><br><span class="line">          !comment.test(rest) &amp;&amp;</span><br><span class="line">          !conditionalComment.test(rest)</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="comment">// &lt; in plain text, be forgiving and treat it as text</span></span><br><span class="line">          next = rest.indexOf(<span class="string">'&lt;'</span>, <span class="number">1</span>)</span><br><span class="line">          <span class="keyword">if</span> (next &lt; <span class="number">0</span>) <span class="keyword">break</span></span><br><span class="line">          textEnd += next</span><br><span class="line">          rest = html.slice(textEnd)</span><br><span class="line">        &#125;</span><br><span class="line">        text = html.substring(<span class="number">0</span>, textEnd)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (textEnd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        text = html</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (text) &#123;</span><br><span class="line">        advance(text.length) <span class="comment">// 更新 index html</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (options.chars &amp;&amp; text) &#123;</span><br><span class="line">        options.chars(text, index - text.length, index)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> endTagLength = <span class="number">0</span></span><br><span class="line">      <span class="keyword">const</span> stackedTag = lastTag.toLowerCase()</span><br><span class="line">      <span class="keyword">const</span> reStackedTag = reCache[stackedTag] || (reCache[stackedTag] = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'([\\s\\S]*?)(&lt;/'</span> + stackedTag + <span class="string">'[^&gt;]*&gt;)'</span>, <span class="string">'i'</span>))</span><br><span class="line">      <span class="keyword">const</span> rest = html.replace(reStackedTag, <span class="function"><span class="keyword">function</span> (<span class="params">all, text, endTag</span>) </span>&#123;</span><br><span class="line">        endTagLength = endTag.length</span><br><span class="line">        <span class="keyword">if</span> (!isPlainTextElement(stackedTag) &amp;&amp; stackedTag !== <span class="string">'noscript'</span>) &#123;</span><br><span class="line">          text = text</span><br><span class="line">            .replace(<span class="regexp">/&lt;!\--([\s\S]*?)--&gt;/g</span>, <span class="string">'$1'</span>) <span class="comment">// #7298</span></span><br><span class="line">            .replace(<span class="regexp">/&lt;!\[CDATA\[([\s\S]*?)]]&gt;/g</span>, <span class="string">'$1'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (shouldIgnoreFirstNewline(stackedTag, text)) &#123;</span><br><span class="line">          text = text.slice(<span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (options.chars) &#123;</span><br><span class="line">          options.chars(text)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">      &#125;)</span><br><span class="line">      index += html.length - rest.length</span><br><span class="line">      html = rest</span><br><span class="line">      parseEndTag(stackedTag, index - endTagLength, index)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (html === last) &#123;</span><br><span class="line">      options.chars &amp;&amp; options.chars(html)</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; !stack.length &amp;&amp; options.warn) &#123;</span><br><span class="line">        options.warn(<span class="string">`Mal-formatted tag at end of template: "<span class="subst">$&#123;html&#125;</span>"`</span>, &#123; <span class="attr">start</span>: index + html.length &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Clean up any remaining tags</span></span><br><span class="line">  parseEndTag()</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">advance</span> (<span class="params">n</span>) </span>&#123;</span><br><span class="line">    index += n</span><br><span class="line">    html = html.substring(n)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解析开始的标签</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">parseStartTag</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> start = html.match(startTagOpen)</span><br><span class="line">    <span class="keyword">if</span> (start) &#123;</span><br><span class="line">      <span class="keyword">const</span> match = &#123;</span><br><span class="line">        tagName: start[<span class="number">1</span>],</span><br><span class="line">        attrs: [],</span><br><span class="line">        start: index</span><br><span class="line">      &#125;</span><br><span class="line">      advance(start[<span class="number">0</span>].length)</span><br><span class="line">      <span class="keyword">let</span> end, attr</span><br><span class="line">      <span class="keyword">while</span> (!(end = html.match(startTagClose)) &amp;&amp; (attr = html.match(dynamicArgAttribute) || html.match(attribute))) &#123;</span><br><span class="line">        attr.start = index</span><br><span class="line">        advance(attr[<span class="number">0</span>].length)</span><br><span class="line">        attr.end = index</span><br><span class="line">        match.attrs.push(attr)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (end) &#123;</span><br><span class="line">        match.unarySlash = end[<span class="number">1</span>]</span><br><span class="line">        advance(end[<span class="number">0</span>].length)</span><br><span class="line">        match.end = index</span><br><span class="line">        <span class="keyword">return</span> match</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理开始标签</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleStartTag</span> (<span class="params">match</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> tagName = match.tagName</span><br><span class="line">    <span class="keyword">const</span> unarySlash = match.unarySlash</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (expectHTML) &#123;</span><br><span class="line">      <span class="keyword">if</span> (lastTag === <span class="string">'p'</span> &amp;&amp; isNonPhrasingTag(tagName)) &#123;</span><br><span class="line">        parseEndTag(lastTag)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (canBeLeftOpenTag(tagName) &amp;&amp; lastTag === tagName) &#123;</span><br><span class="line">        parseEndTag(tagName)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> unary = isUnaryTag(tagName) || !!unarySlash <span class="comment">// 判断标签是否是一元标签</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> l = match.attrs.length</span><br><span class="line">    <span class="keyword">const</span> attrs = <span class="keyword">new</span> <span class="built_in">Array</span>(l)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; l; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> args = match.attrs[i]</span><br><span class="line">      <span class="keyword">const</span> value = args[<span class="number">3</span>] || args[<span class="number">4</span>] || args[<span class="number">5</span>] || <span class="string">''</span></span><br><span class="line">      <span class="keyword">const</span> shouldDecodeNewlines = tagName === <span class="string">'a'</span> &amp;&amp; args[<span class="number">1</span>] === <span class="string">'href'</span></span><br><span class="line">        ? options.shouldDecodeNewlinesForHref</span><br><span class="line">        : options.shouldDecodeNewlines</span><br><span class="line">      attrs[i] = &#123;</span><br><span class="line">        name: args[<span class="number">1</span>],</span><br><span class="line">        value: decodeAttr(value, shouldDecodeNewlines)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; options.outputSourceRange) &#123;</span><br><span class="line">        attrs[i].start = args.start + args[<span class="number">0</span>].match(<span class="regexp">/^\s*/</span>).length</span><br><span class="line">        attrs[i].end = args.end</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将非一元的标签压入栈中，再由 parseRndTag 弹出匹配结束标签</span></span><br><span class="line">    <span class="keyword">if</span> (!unary) &#123; </span><br><span class="line">      stack.push(&#123; <span class="attr">tag</span>: tagName, <span class="attr">lowerCasedTag</span>: tagName.toLowerCase(), <span class="attr">attrs</span>: attrs, <span class="attr">start</span>: match.start, <span class="attr">end</span>: match.end &#125;)</span><br><span class="line">      lastTag = tagName</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.start) &#123;</span><br><span class="line">      options.start(tagName, attrs, unary, match.start, match.end) <span class="comment">// 将解析后的模板挂用传入的配置里 start 函数处理命令等</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">parseEndTag</span> (<span class="params">tagName, start, end</span>) </span>&#123; <span class="comment">// 对于</span></span><br><span class="line">    <span class="keyword">let</span> pos, lowerCasedTagName</span><br><span class="line">    <span class="keyword">if</span> (start == <span class="literal">null</span>) start = index</span><br><span class="line">    <span class="keyword">if</span> (end == <span class="literal">null</span>) end = index</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the closest opened tag of the same type</span></span><br><span class="line">    <span class="keyword">if</span> (tagName) &#123;</span><br><span class="line">      lowerCasedTagName = tagName.toLowerCase()</span><br><span class="line">      <span class="keyword">for</span> (pos = stack.length - <span class="number">1</span>; pos &gt;= <span class="number">0</span>; pos--) &#123; <span class="comment">// 将栈内标签排出</span></span><br><span class="line">        <span class="keyword">if</span> (stack[pos].lowerCasedTag === lowerCasedTagName) &#123;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// If no tag name is provided, clean shop</span></span><br><span class="line">      pos = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pos &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Close all the open elements, up the stack</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = stack.length - <span class="number">1</span>; i &gt;= pos; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">          (i &gt; pos || !tagName) &amp;&amp;</span><br><span class="line">          options.warn</span><br><span class="line">        ) &#123;</span><br><span class="line">          options.warn(</span><br><span class="line">            <span class="string">`tag &lt;<span class="subst">$&#123;stack[i].tag&#125;</span>&gt; has no matching end tag.`</span>,</span><br><span class="line">            &#123; <span class="attr">start</span>: stack[i].start, <span class="attr">end</span>: stack[i].end &#125;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (options.end) &#123;</span><br><span class="line">          options.end(stack[i].tag, start, end)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Remove the open elements from the stack</span></span><br><span class="line">      stack.length = pos <span class="comment">// 清楚 pos 到栈顶的标签</span></span><br><span class="line">      lastTag = pos &amp;&amp; stack[pos - <span class="number">1</span>].tag</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lowerCasedTagName === <span class="string">'br'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (options.start) &#123;</span><br><span class="line">        options.start(tagName, [], <span class="literal">true</span>, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lowerCasedTagName === <span class="string">'p'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (options.start) &#123;</span><br><span class="line">        options.start(tagName, [], <span class="literal">false</span>, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (options.end) &#123;</span><br><span class="line">        options.end(tagName, start, end)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="parseHTML-的-option"><a href="#parseHTML-的-option" class="headerlink" title="parseHTML 的 option"></a>parseHTML 的 option</h2><p>涉及到 start end chars comment 处理方法, processIf 方法就在 start 中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line">parseHTML(template, &#123;</span><br><span class="line">  warn,</span><br><span class="line">  expectHTML: options.expectHTML,</span><br><span class="line">  isUnaryTag: options.isUnaryTag,</span><br><span class="line">  canBeLeftOpenTag: options.canBeLeftOpenTag,</span><br><span class="line">  shouldDecodeNewlines: options.shouldDecodeNewlines,</span><br><span class="line">  shouldDecodeNewlinesForHref: options.shouldDecodeNewlinesForHref,</span><br><span class="line">  shouldKeepComment: options.comments,</span><br><span class="line">  outputSourceRange: options.outputSourceRange,</span><br><span class="line">  start (tag, attrs, unary, start, end) &#123;</span><br><span class="line">    <span class="comment">// check namespace.</span></span><br><span class="line">    <span class="comment">// inherit parent ns if there is one</span></span><br><span class="line">    <span class="keyword">const</span> ns = (currentParent &amp;&amp; currentParent.ns) || platformGetTagNamespace(tag)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// handle IE svg bug</span></span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (isIE &amp;&amp; ns === <span class="string">'svg'</span>) &#123;</span><br><span class="line">      attrs = guardIESVGBug(attrs)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> element: ASTElement = createASTElement(tag, attrs, currentParent) <span class="comment">// 创建 AST 元素</span></span><br><span class="line">    <span class="keyword">if</span> (ns) &#123;</span><br><span class="line">      element.ns = ns</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (options.outputSourceRange) &#123;</span><br><span class="line">        element.start = start</span><br><span class="line">        element.end = end</span><br><span class="line">        element.rawAttrsMap = element.attrsList.reduce(<span class="function">(<span class="params">cumulated, attr</span>) =&gt;</span> &#123;</span><br><span class="line">          cumulated[attr.name] = attr</span><br><span class="line">          <span class="keyword">return</span> cumulated</span><br><span class="line">        &#125;, &#123;&#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      attrs.forEach(<span class="function"><span class="params">attr</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (invalidAttributeRE.test(attr.name)) &#123;</span><br><span class="line">          warn(</span><br><span class="line">            <span class="string">`Invalid dynamic argument expression: attribute names cannot contain `</span> +</span><br><span class="line">            <span class="string">`spaces, quotes, &lt;, &gt;, / or =.`</span>,</span><br><span class="line">            &#123;</span><br><span class="line">              start: attr.start + attr.name.indexOf(<span class="string">`[`</span>),</span><br><span class="line">              end: attr.start + attr.name.length</span><br><span class="line">            &#125;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理 AST 元素</span></span><br><span class="line">    <span class="comment">// 判断是否为禁止的 tag 和服务端渲染</span></span><br><span class="line">    <span class="keyword">if</span> (isForbiddenTag(element) &amp;&amp; !isServerRendering()) &#123;</span><br><span class="line">      element.forbidden = <span class="literal">true</span></span><br><span class="line">      process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warn(</span><br><span class="line">        <span class="string">'Templates should only be responsible for mapping the state to the '</span> +</span><br><span class="line">        <span class="string">'UI. Avoid placing tags with side-effects in your templates, such as '</span> +</span><br><span class="line">        <span class="string">`&lt;<span class="subst">$&#123;tag&#125;</span>&gt;`</span> + <span class="string">', as they will not be parsed.'</span>,</span><br><span class="line">        &#123; <span class="attr">start</span>: element.start &#125;</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// apply pre-transforms</span></span><br><span class="line">    <span class="comment">// 对创建的 ASTElement 做预转换</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; preTransforms.length; i++) &#123;</span><br><span class="line">      element = preTransforms[i](element, options) || element</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!inVPre) &#123;</span><br><span class="line">      processPre(element)</span><br><span class="line">      <span class="keyword">if</span> (element.pre) &#123;</span><br><span class="line">        inVPre = <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (platformIsPreTag(element.tag)) &#123;</span><br><span class="line">      inPre = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (inVPre) &#123;</span><br><span class="line">      processRawAttrs(element)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!element.processed) &#123;</span><br><span class="line">      <span class="comment">// structural directives</span></span><br><span class="line">      <span class="comment">// 构建以前命令</span></span><br><span class="line">      processFor(element) <span class="comment">// 从元素中拿到 v-for 指令的内容，然后分别解析出 for、alias、iterator1、iterator2 等属性的值添加到 AST 的元素</span></span><br><span class="line">      processIf(element) <span class="comment">// 从元素中拿 v-if 指令的内容</span></span><br><span class="line">      processOnce(element)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果不存在 root 则将新建的 element 作为 root ,在检查 root 的约束条件 , 有问题的 tag 及 属性 v-for 均不能在 root 存在</span></span><br><span class="line">    <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">      root = element</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">        checkRootConstraints(root)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!unary) &#123;</span><br><span class="line">      currentParent = element</span><br><span class="line">      stack.push(element)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      closeElement(element)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  end (tag, start, end) &#123;</span><br><span class="line">    <span class="keyword">const</span> element = stack[stack.length - <span class="number">1</span>]</span><br><span class="line">    <span class="comment">// pop stack</span></span><br><span class="line">    stack.length -= <span class="number">1</span></span><br><span class="line">    currentParent = stack[stack.length - <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; options.outputSourceRange) &#123;</span><br><span class="line">      element.end = end</span><br><span class="line">    &#125;</span><br><span class="line">    closeElement(element)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  chars (text: string, <span class="attr">start</span>: number, <span class="attr">end</span>: number) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!currentParent) &#123;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (text === template) &#123;</span><br><span class="line">          warnOnce(</span><br><span class="line">            <span class="string">'Component template requires a root element, rather than just text.'</span>,</span><br><span class="line">            &#123; start &#125;</span><br><span class="line">          )</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((text = text.trim())) &#123;</span><br><span class="line">          warnOnce(</span><br><span class="line">            <span class="string">`text "<span class="subst">$&#123;text&#125;</span>" outside root element will be ignored.`</span>,</span><br><span class="line">            &#123; start &#125;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// IE textarea placeholder bug</span></span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (isIE &amp;&amp;</span><br><span class="line">      currentParent.tag === <span class="string">'textarea'</span> &amp;&amp;</span><br><span class="line">      currentParent.attrsMap.placeholder === text</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> children = currentParent.children</span><br><span class="line">    <span class="keyword">if</span> (inPre || text.trim()) &#123;</span><br><span class="line">      text = isTextTag(currentParent) ? text : decodeHTMLCached(text)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!children.length) &#123;</span><br><span class="line">      <span class="comment">// remove the whitespace-only node right after an opening tag</span></span><br><span class="line">      text = <span class="string">''</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (whitespaceOption) &#123;</span><br><span class="line">      <span class="keyword">if</span> (whitespaceOption === <span class="string">'condense'</span>) &#123; <span class="comment">// 如果此处文本样式 whitespace 配置为 condense，有换行符的取消，没有的单空格</span></span><br><span class="line">        <span class="comment">// in condense mode, remove the whitespace node if it contains</span></span><br><span class="line">        <span class="comment">// line break, otherwise condense to a single space</span></span><br><span class="line">        text = lineBreakRE.test(text) ? <span class="string">''</span> : <span class="string">' '</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        text = <span class="string">' '</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      text = preserveWhitespace ? <span class="string">' '</span> : <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (text) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!inPre &amp;&amp; whitespaceOption === <span class="string">'condense'</span>) &#123;</span><br><span class="line">        <span class="comment">// condense consecutive whitespaces into single space</span></span><br><span class="line">        text = text.replace(whitespaceRE, <span class="string">' '</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> res</span><br><span class="line">      <span class="keyword">let</span> child: ?ASTNode</span><br><span class="line">      <span class="keyword">if</span> (!inVPre &amp;&amp; text !== <span class="string">' '</span> &amp;&amp; (res = parseText(text, delimiters))) &#123;</span><br><span class="line">        child = &#123;</span><br><span class="line">          type: <span class="number">2</span>, <span class="comment">// 有表达式</span></span><br><span class="line">          expression: res.expression,</span><br><span class="line">          tokens: res.tokens,</span><br><span class="line">          text</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (text !== <span class="string">' '</span> || !children.length || children[children.length - <span class="number">1</span>].text !== <span class="string">' '</span>) &#123;</span><br><span class="line">        child = &#123;</span><br><span class="line">          type: <span class="number">3</span>, <span class="comment">// 纯文本</span></span><br><span class="line">          text</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (child) &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; options.outputSourceRange) &#123;</span><br><span class="line">          child.start = start</span><br><span class="line">          child.end = end</span><br><span class="line">        &#125;</span><br><span class="line">        children.push(child)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  comment (text: string, start, end) &#123;</span><br><span class="line">    <span class="comment">// adding anything as a sibling to the root node is forbidden</span></span><br><span class="line">    <span class="comment">// comments should still be allowed, but ignored</span></span><br><span class="line">    <span class="keyword">if</span> (currentParent) &#123;</span><br><span class="line">      <span class="keyword">const</span> child: ASTText = &#123;</span><br><span class="line">        type: <span class="number">3</span>,</span><br><span class="line">        text,</span><br><span class="line">        isComment: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; options.outputSourceRange) &#123;</span><br><span class="line">        child.start = start</span><br><span class="line">        child.end = end</span><br><span class="line">      &#125;</span><br><span class="line">      currentParent.children.push(child)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="parseText"><a href="#parseText" class="headerlink" title="parseText"></a>parseText</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">parseText</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  text: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  delimiters?: [string, string]</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">TextParseResult</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 如果外界用户没有定义 delimiters 分隔符用来传变量，那么就使用 Vue 自带的双括号 &#123;&#123;&#125;&#125;</span></span><br><span class="line">  <span class="comment">// 如要使用此功能，可以在 new Vue 的时候传入 delimiters 属性： delimiters: ['', '']</span></span><br><span class="line">  <span class="keyword">const</span> tagRE = delimiters ? buildRegex(delimiters) : defaultTagRE </span><br><span class="line">  <span class="keyword">if</span> (!tagRE.test(text)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> tokens = []</span><br><span class="line">  <span class="keyword">const</span> rawTokens = []</span><br><span class="line">  <span class="keyword">let</span> lastIndex = tagRE.lastIndex = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> match, index, tokenValue</span><br><span class="line">  <span class="keyword">while</span> ((match = tagRE.exec(text))) &#123;</span><br><span class="line">    index = match.index</span><br><span class="line">    <span class="comment">// push text token</span></span><br><span class="line">    <span class="keyword">if</span> (index &gt; lastIndex) &#123;</span><br><span class="line">      rawTokens.push(tokenValue = text.slice(lastIndex, index))</span><br><span class="line">      tokens.push(<span class="built_in">JSON</span>.stringify(tokenValue))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// tag token</span></span><br><span class="line">    <span class="keyword">const</span> exp = parseFilters(match[<span class="number">1</span>].trim())</span><br><span class="line">    tokens.push(<span class="string">`_s(<span class="subst">$&#123;exp&#125;</span>)`</span>)</span><br><span class="line">    rawTokens.push(&#123; <span class="string">'@binding'</span>: exp &#125;)</span><br><span class="line">    lastIndex = index + match[<span class="number">0</span>].length</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (lastIndex &lt; text.length) &#123;</span><br><span class="line">    rawTokens.push(tokenValue = text.slice(lastIndex))</span><br><span class="line">    tokens.push(<span class="built_in">JSON</span>.stringify(tokenValue))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    expression: tokens.join(<span class="string">'+'</span>),</span><br><span class="line">    tokens: rawTokens</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="genElement-1"><a href="#genElement-1" class="headerlink" title="genElement"></a>genElement</h2><p>进入到 genIf 中, 在 genIfConditions 里获取 ast 时期建立的 IfConditions 对象 {exp, block} , 再进行展开</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (el.if &amp;&amp; !el.ifProcessed) &#123;</span><br><span class="line">  <span class="keyword">return</span> genIf(el, state)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// genIf</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">genIf</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  state: CodegenState,</span></span></span><br><span class="line"><span class="function"><span class="params">  altGen?: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  altEmpty?: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  el.ifProcessed = <span class="literal">true</span> <span class="comment">// avoid recursion</span></span><br><span class="line">  <span class="keyword">return</span> genIfConditions(el.ifConditions.slice(), state, altGen, altEmpty)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// genIfConditions</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genIfConditions</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  conditions: ASTIfConditions,</span></span></span><br><span class="line"><span class="function"><span class="params">  state: CodegenState,</span></span></span><br><span class="line"><span class="function"><span class="params">  altGen?: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  altEmpty?: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!conditions.length) &#123;</span><br><span class="line">    <span class="keyword">return</span> altEmpty || <span class="string">'_e()'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> condition = conditions.shift()</span><br><span class="line">  <span class="keyword">if</span> (condition.exp) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`(<span class="subst">$&#123;condition.exp&#125;</span>)?<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">      genTernaryExp(condition.block)</span></span></span><br><span class="line"><span class="string"><span class="subst">    &#125;</span>:<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">      genIfConditions(conditions, state, altGen, altEmpty)</span></span></span><br><span class="line"><span class="string"><span class="subst">    &#125;</span>`</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;genTernaryExp(condition.block)&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// v-if with v-once should generate code like (a)?_m(0):_m(1)</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">genTernaryExp</span> (<span class="params">el</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> altGen</span><br><span class="line">      ? altGen(el, state)</span><br><span class="line">      : el.once</span><br><span class="line">        ? genOnce(el, state)</span><br><span class="line">        : genElement(el, state)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createElement-1"><a href="#createElement-1" class="headerlink" title="createElement"></a>createElement</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(show)?_c(<span class="string">'div'</span>,[_v(_s(show ? <span class="string">'bad ass'</span> : <span class="string">'motherfucker'</span>))]):_e()</span><br></pre></td></tr></table></figure>
<p>首先获取变量 show, 在 vm 的属性上查找, 触发 proxy 代理通过 proxyGetter 读取挂载 vm 上的该变量, 于是在 vm._data 上进行读取该变量, 从而触发该变量的响应式系统, 进入属性拦截 get, 接着检测当前全局是否由 Dep.target, 正是初始化整个最外层的 Watcher, 通过 watcher 将这个依赖 dep 添加进依赖收集器, 同时依赖 dep 也将当前的观察者添加进 subs, 当然也可能会有很多个观察者, 在 get 时将这些都添加到被观察者 dep 下, 等候该数据变动再通知所有 watcher 更新; 添加完依赖后, 弹出获得的变量值, 进行下一个变量的获取.</p>
<p>在读取完变量后, 开始执行代码, 从 _s 开始, 由里至外执行, 这里的三段式 show 为 true, 那么就会对应 ‘bad ass’, 接着进行 toString 操作</p>
<p>继续进行 _v, 将刚才获得的字符串转为文本虚拟节点; 最后到 _c, 创建元素虚拟节点, 其子节点为刚才的文本虚拟节点</p>
<h2 id="createElm-1"><a href="#createElm-1" class="headerlink" title="createElm"></a>createElm</h2><p>还是首先给当前子节点创建真实节点挂到 vnode.elm 上, 接着进入到创建当前子节点的子节点, 而此时的 v-if 节点其内的子节点模板变量字符串已经在 createElement 阶段确定下来了, 此时为单纯的文本, 因此也就创建真实的文本节点, 再 appendChild 插入到上层节点;</p>
<p>而 v-if 在 render 执行代码阶段就已经读取到 if 后边的值了, 确定下来显示不显示, 其他不相关的属性就正常同步; 完成后将该节点插入到根节点下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vnode.elm = vnode.ns</span><br><span class="line">  ? nodeOps.createElementNS(vnode.ns, tag)</span><br><span class="line">  : nodeOps.createElement(tag, vnode)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">createChildren(vnode, children, insertedVnodeQueue)</span><br><span class="line"><span class="keyword">if</span> (isDef(data)) &#123;</span><br><span class="line">  invokeCreateHooks(vnode, insertedVnodeQueue)</span><br><span class="line">&#125;</span><br><span class="line">insert(parentElm, vnode.elm, refElm) <span class="comment">// 把 DOM 插入到父节点中</span></span><br></pre></td></tr></table></figure>
<h1 id="v-for"><a href="#v-for" class="headerlink" title="v-for"></a>v-for</h1><p>v-for 的编译工作同上, 在 parse 完成后得到 AST 树为:</p>
<p>因为是 li 标签来执行 v-for, 外边还套了一层 ul, 所以此时的根节点就是 ul, 它的 parent 也就是 app; children 里是下一级节点, 也就是 li, 这里新增了 alias 属性, for 属性, key 属性, 均是在 processFor 中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  attrsList:(<span class="number">0</span>) []</span><br><span class="line">  attrsMap:&#123;&#125;</span><br><span class="line">  children:(<span class="number">1</span>) [&#123;…&#125;]</span><br><span class="line">    <span class="number">0</span>: &#123;</span><br><span class="line">      alias:<span class="string">'food'</span></span><br><span class="line">      attrsList:(<span class="number">0</span>) []</span><br><span class="line">      attrsMap:&#123;v-<span class="keyword">for</span>: <span class="string">'food in foodList'</span>, :key: <span class="string">'food.name'</span>&#125;</span><br><span class="line">      children:(<span class="number">1</span>) [&#123;…&#125;]</span><br><span class="line">        <span class="number">0</span>: &#123;</span><br><span class="line">          end:<span class="number">277</span></span><br><span class="line">          expression:<span class="string">'_s(food.name)+"：￥ "+_s(food.price)'</span></span><br><span class="line">          start:<span class="number">249</span></span><br><span class="line">          text:<span class="string">'$[food.name]：￥ $[food.price]'</span></span><br><span class="line">          tokens:(<span class="number">3</span>) [&#123;…&#125;, <span class="string">'：￥ '</span>, &#123;…&#125;]</span><br><span class="line">            <span class="number">0</span>:&#123;@binding: <span class="string">'food.name'</span>&#125;</span><br><span class="line">            <span class="number">1</span>:<span class="string">'：￥ '</span></span><br><span class="line">            <span class="number">2</span>:&#123;@binding: <span class="string">'food.price'</span>&#125;</span><br><span class="line">          type:<span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">      end:<span class="number">282</span></span><br><span class="line">      <span class="keyword">for</span>:<span class="string">'foodList'</span></span><br><span class="line">      key:<span class="string">'food.name'</span></span><br><span class="line">      parent:&#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">'ul'</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">0</span>), <span class="attr">attrsMap</span>: &#123;…&#125;, <span class="attr">rawAttrsMap</span>: &#123;…&#125;, …&#125;</span><br><span class="line">      plain:<span class="literal">false</span></span><br><span class="line">      rawAttrsMap:&#123;v-<span class="keyword">for</span>: &#123;…&#125;, :key: &#123;…&#125;&#125;</span><br><span class="line">      start:<span class="number">203</span></span><br><span class="line">      tag:<span class="string">'li'</span></span><br><span class="line">      type:<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  rawAttrsMap:&#123;&#125;</span><br><span class="line">  plain:<span class="literal">true</span></span><br><span class="line">  parent:&#123;<span class="attr">type</span>: <span class="number">1</span>, <span class="attr">tag</span>: <span class="string">'div'</span>, <span class="attr">attrsList</span>: <span class="built_in">Array</span>(<span class="number">1</span>), <span class="attr">attrsMap</span>: &#123;…&#125;, …&#125;</span><br><span class="line">  end:<span class="number">296</span></span><br><span class="line">  start:<span class="number">186</span></span><br><span class="line">  plain:<span class="literal">true</span></span><br><span class="line">  rawAttrsMap:&#123;&#125;</span><br><span class="line">  tag:<span class="string">'ul'</span></span><br><span class="line">  type:<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="processFor"><a href="#processFor" class="headerlink" title="processFor"></a>processFor</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">processFor</span> (<span class="params">el: ASTElement</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> exp</span><br><span class="line">  <span class="keyword">if</span> ((exp = getAndRemoveAttr(el, <span class="string">'v-for'</span>))) &#123;</span><br><span class="line">    <span class="keyword">const</span> res = parseFor(exp)</span><br><span class="line">    <span class="keyword">if</span> (res) &#123;</span><br><span class="line">      extend(el, res)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`Invalid v-for expression: <span class="subst">$&#123;exp&#125;</span>`</span>,</span><br><span class="line">        el.rawAttrsMap[<span class="string">'v-for'</span>]</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="parseFor"><a href="#parseFor" class="headerlink" title="parseFor"></a>parseFor</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">parseFor</span> (<span class="params">exp: string</span>): ?<span class="title">ForParseResult</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> inMatch = exp.match(forAliasRE)</span><br><span class="line">  <span class="keyword">if</span> (!inMatch) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">const</span> res = &#123;&#125;</span><br><span class="line">  res.for = inMatch[<span class="number">2</span>].trim()</span><br><span class="line">  <span class="keyword">const</span> alias = inMatch[<span class="number">1</span>].trim().replace(stripParensRE, <span class="string">''</span>)</span><br><span class="line">  <span class="keyword">const</span> iteratorMatch = alias.match(forIteratorRE)</span><br><span class="line">  <span class="keyword">if</span> (iteratorMatch) &#123;</span><br><span class="line">    res.alias = alias.replace(forIteratorRE, <span class="string">''</span>).trim()</span><br><span class="line">    res.iterator1 = iteratorMatch[<span class="number">1</span>].trim()</span><br><span class="line">    <span class="keyword">if</span> (iteratorMatch[<span class="number">2</span>]) &#123;</span><br><span class="line">      res.iterator2 = iteratorMatch[<span class="number">2</span>].trim()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.alias = alias</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="genFor"><a href="#genFor" class="headerlink" title="genFor"></a>genFor</h2><p>执行到 genFor 则会直接返回内容, 不会再向下执行, genFor 内部会读取之前的 ast 树添加的 for, 与 _l 拼接在一起, ‘_l((${exp}), function(key) ‘ ; 之后直接 genElement 继续处理其他属性, 以及 children, 且在 genFor 的时候, 改变 forProcessed 为 true, 则在再次调用 genElement 时不会重复执行 genFor; 按例中继续生成 children 的代码, 继而返回.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">genFor</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  state: CodegenState,</span></span></span><br><span class="line"><span class="function"><span class="params">  altGen?: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  altHelper?: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> exp = el.for</span><br><span class="line">  <span class="keyword">const</span> alias = el.alias</span><br><span class="line">  <span class="keyword">const</span> iterator1 = el.iterator1 ? <span class="string">`,<span class="subst">$&#123;el.iterator1&#125;</span>`</span> : <span class="string">''</span></span><br><span class="line">  <span class="keyword">const</span> iterator2 = el.iterator2 ? <span class="string">`,<span class="subst">$&#123;el.iterator2&#125;</span>`</span> : <span class="string">''</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">    state.maybeComponent(el) &amp;&amp;</span><br><span class="line">    el.tag !== <span class="string">'slot'</span> &amp;&amp;</span><br><span class="line">    el.tag !== <span class="string">'template'</span> &amp;&amp;</span><br><span class="line">    !el.key</span><br><span class="line">  ) &#123;</span><br><span class="line">    state.warn(</span><br><span class="line">      <span class="string">`&lt;<span class="subst">$&#123;el.tag&#125;</span> v-for="<span class="subst">$&#123;alias&#125;</span> in <span class="subst">$&#123;exp&#125;</span>"&gt;: component lists rendered with `</span> +</span><br><span class="line">      <span class="string">`v-for should have explicit keys. `</span> +</span><br><span class="line">      <span class="string">`See https://vuejs.org/guide/list.html#key for more info.`</span>,</span><br><span class="line">      el.rawAttrsMap[<span class="string">'v-for'</span>],</span><br><span class="line">      <span class="literal">true</span> <span class="comment">/* tip */</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  el.forProcessed = <span class="literal">true</span> <span class="comment">// avoid recursion</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;altHelper || <span class="string">'_l'</span>&#125;</span>((<span class="subst">$&#123;exp&#125;</span>),`</span> +</span><br><span class="line">    <span class="string">`function(<span class="subst">$&#123;alias&#125;</span><span class="subst">$&#123;iterator1&#125;</span><span class="subst">$&#123;iterator2&#125;</span>)&#123;`</span> +</span><br><span class="line">      <span class="string">`return <span class="subst">$&#123;(altGen || genElement)(el, state)&#125;</span>`</span> +</span><br><span class="line">    <span class="string">'&#125;)'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="genData-1"><a href="#genData-1" class="headerlink" title="genData"></a>genData</h2><p>li 的 ast 树上有 key, 因此 genData 时会执行到下边内容</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// key</span></span><br><span class="line"><span class="keyword">if</span> (el.key) &#123;</span><br><span class="line">  data += <span class="string">`key:<span class="subst">$&#123;el.key&#125;</span>,`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createElement-2"><a href="#createElement-2" class="headerlink" title="createElement"></a>createElement</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_c(<span class="string">'ul'</span>,_l((foodList),<span class="function"><span class="keyword">function</span>(<span class="params">food</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> _c(<span class="string">'li'</span>,&#123;<span class="attr">key</span>:food.name&#125;,[</span><br><span class="line">    _v(_s(food.name)+<span class="string">"：￥ "</span>+_s(food.price))</span><br><span class="line">  ])</span><br><span class="line">&#125;),<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>接着上边创建好的函数, 依次读取变量 _c, _l, foodList, 然后由内而外执行.</p>
<h2 id="renderList"><a href="#renderList" class="headerlink" title="renderList"></a>renderList</h2><p>v-for 使用 _l 来渲染列表, 遍历第一个参数 foodList, 将元素传入第二个参数函数, 借 render 函数使每个元素对应生成一个虚拟节点;</p>
<p>依据上边的 li 节点, 在获取了 _s, 以及 food.name/food.price 后, 将两个变量转成字符串并合并在一起, 用 _v 来生成文本节点; 接着 _c 当前的 li 节点, 根据 ‘li’, 属性 data, 其 children 三个参数来创建 li 的虚拟节点; </p>
<p>如此遍历完 foodList, 就得到一个虚拟节点的数组, 给标记 _isVList = true, 作为 ul 的 chilren</p>
<p>接着回到 ul 的 _c 时刻, 其实就是按普通的内置元素创建虚拟节点, 下边 children 有几个 li 的虚拟节点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">renderList</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  val: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  render: (</span></span></span><br><span class="line"><span class="function"><span class="params">    val: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    keyOrIndex: string | number,</span></span></span><br><span class="line"><span class="function"><span class="params">    index?: number</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) =&gt; <span class="title">VNode</span></span></span><br><span class="line"><span class="function">): ?<span class="title">Array</span>&lt;<span class="title">VNode</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> ret: ?<span class="built_in">Array</span>&lt;VNode&gt;, i, l, keys, key</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(val) || <span class="keyword">typeof</span> val === <span class="string">'string'</span>) &#123;</span><br><span class="line">    ret = <span class="keyword">new</span> <span class="built_in">Array</span>(val.length)</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, l = val.length; i &lt; l; i++) &#123;</span><br><span class="line">      ret[i] = render(val[i], i)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> val === <span class="string">'number'</span>) &#123;</span><br><span class="line">    ret = <span class="keyword">new</span> <span class="built_in">Array</span>(val)</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; val; i++) &#123;</span><br><span class="line">      ret[i] = render(i + <span class="number">1</span>, i)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isObject(val)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (hasSymbol &amp;&amp; val[<span class="built_in">Symbol</span>.iterator]) &#123;</span><br><span class="line">      ret = []</span><br><span class="line">      <span class="keyword">const</span> iterator: Iterator&lt;any&gt; = val[<span class="built_in">Symbol</span>.iterator]()</span><br><span class="line">      <span class="keyword">let</span> result = iterator.next()</span><br><span class="line">      <span class="keyword">while</span> (!result.done) &#123;</span><br><span class="line">        ret.push(render(result.value, ret.length))</span><br><span class="line">        result = iterator.next()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      keys = <span class="built_in">Object</span>.keys(val)</span><br><span class="line">      ret = <span class="keyword">new</span> <span class="built_in">Array</span>(keys.length)</span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>, l = keys.length; i &lt; l; i++) &#123;</span><br><span class="line">        key = keys[i]</span><br><span class="line">        ret[i] = render(val[key], key, i)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!isDef(ret)) &#123;</span><br><span class="line">    ret = []</span><br><span class="line">  &#125;</span><br><span class="line">  (ret: any)._isVList = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createElm-2"><a href="#createElm-2" class="headerlink" title="createElm"></a>createElm</h2><p>v-for 节点的父级设置了 ul, 因而在走到 li 时, 才能看到有 v-for 的一些特性, 但其实也没什么特别;</p>
<p>会在 checkDuplicateKeys 里检查每个 li 上的 key 是否有冲突; 此后再渲染出 li 的真实节点, 它的子节点也是已经准备好的文本节点, 直接创建真实的文本节点, 再添加到 li 上, 遍历 ul 的 children, 把所有 li 都创建完 挂在 ul 上; 再把 ul 挂载到上一级</p>
<h1 id="v-model"><a href="#v-model" class="headerlink" title="v-model"></a>v-model</h1><p>v-model 放在 input 上进行数据双向绑定，input 外边裹了一层 div</p>
<h2 id="processAttrs-1"><a href="#processAttrs-1" class="headerlink" title="processAttrs"></a>processAttrs</h2><p>parse 后生成的 AST 树如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  attrsList:(<span class="number">1</span>) [&#123;…&#125;]</span><br><span class="line">    <span class="number">0</span>:&#123;<span class="attr">name</span>: <span class="string">'v-model'</span>, <span class="attr">value</span>: <span class="string">'text'</span>, <span class="attr">start</span>: <span class="number">342</span>, <span class="attr">end</span>: <span class="number">356</span>&#125;</span><br><span class="line">  attrsMap:&#123;v-model: <span class="string">'text'</span>&#125;</span><br><span class="line">  children:(<span class="number">0</span>) []</span><br><span class="line">  directives: (<span class="number">1</span>) [&#123;…&#125;]</span><br><span class="line">    <span class="number">0</span>: &#123;</span><br><span class="line">      arg:<span class="literal">null</span></span><br><span class="line">      end:<span class="number">356</span></span><br><span class="line">      isDynamicArg:<span class="literal">false</span></span><br><span class="line">      modifiers:<span class="literal">undefined</span></span><br><span class="line">      name:<span class="string">'model'</span></span><br><span class="line">      rawName:<span class="string">'v-model'</span></span><br><span class="line">      start:<span class="number">342</span></span><br><span class="line">      value:<span class="string">'text'</span></span><br><span class="line">    &#125;</span><br><span class="line">  plain:<span class="literal">false</span></span><br><span class="line">  rawAttrsMap:&#123;v-model: &#123;…&#125;&#125;</span><br><span class="line">    v-model:&#123;<span class="attr">name</span>: <span class="string">'v-model'</span>, <span class="attr">value</span>: <span class="string">'text'</span>, <span class="attr">start</span>: <span class="number">342</span>, <span class="attr">end</span>: <span class="number">356</span>&#125;</span><br><span class="line">  start:<span class="number">335</span></span><br><span class="line">  tag:<span class="string">'input'</span></span><br><span class="line">  type:<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="genDirectives"><a href="#genDirectives" class="headerlink" title="genDirectives"></a>genDirectives</h2><p>model 会给 ast 树加上 directives 属性, 来描述 model, 经过 genDefaultModel, 完成了 model 指令对应 value 的 dom 属性绑定以及 input 事件绑定, 得到 </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">directives:[&#123;<span class="attr">name</span>:<span class="string">"model"</span>,<span class="attr">rawName</span>:<span class="string">"v-model"</span>,<span class="attr">value</span>:(text),<span class="attr">expression</span>:<span class="string">"text"</span>&#125;,]</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genDirectives</span> (<span class="params">el: ASTElement, state: CodegenState</span>): <span class="title">string</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dirs = el.directives</span><br><span class="line">  <span class="keyword">if</span> (!dirs) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">let</span> res = <span class="string">'directives:['</span></span><br><span class="line">  <span class="keyword">let</span> hasRuntime = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> i, l, dir, needRuntime</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>, l = dirs.length; i &lt; l; i++) &#123;</span><br><span class="line">    dir = dirs[i]</span><br><span class="line">    needRuntime = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> gen: DirectiveFunction = state.directives[dir.name]</span><br><span class="line">    <span class="keyword">if</span> (gen) &#123;</span><br><span class="line">      <span class="comment">// compile-time directive that manipulates AST.</span></span><br><span class="line">      <span class="comment">// returns true if it also needs a runtime counterpart.</span></span><br><span class="line">      needRuntime = !!gen(el, dir, state.warn)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (needRuntime) &#123;</span><br><span class="line">      hasRuntime = <span class="literal">true</span></span><br><span class="line">      res += <span class="string">`&#123;name:"<span class="subst">$&#123;dir.name&#125;</span>",rawName:"<span class="subst">$&#123;dir.rawName&#125;</span>"<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">        dir.value ? <span class="string">`,value:(<span class="subst">$&#123;dir.value&#125;</span>),expression:<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(dir.value)&#125;</span>`</span> : <span class="string">''</span></span></span></span><br><span class="line"><span class="string"><span class="subst">      &#125;</span><span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">        dir.arg ? <span class="string">`,arg:<span class="subst">$&#123;dir.isDynamicArg ? dir.arg : <span class="string">`"<span class="subst">$&#123;dir.arg&#125;</span>"`</span>&#125;</span>`</span> : <span class="string">''</span></span></span></span><br><span class="line"><span class="string"><span class="subst">      &#125;</span><span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">        dir.modifiers ? <span class="string">`,modifiers:<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(dir.modifiers)&#125;</span>`</span> : <span class="string">''</span></span></span></span><br><span class="line"><span class="string"><span class="subst">      &#125;</span>&#125;,`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (hasRuntime) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.slice(<span class="number">0</span>, <span class="number">-1</span>) + <span class="string">']'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="genDefaultModel"><a href="#genDefaultModel" class="headerlink" title="genDefaultModel"></a>genDefaultModel</h3><p>执行 genAssignmentCode 后获得的代码, 拼接在 <code>if($event.target.composing)return;</code> 其后; </p>
<p>接着调用 addProp 将 value 添加为 dom 属性 <code>props [{name: &#39;value&#39;, value: &#39;(text)&#39;, dynamic: undefined}]</code>;</p>
<p>继续调用 addHandler 将 input 输入事件添加进当前 ast 节点, <code>events: {input:{value: &#39;if($event.target.composing)return;text=$event.target.value&#39;, dynamic: undefined}}</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genDefaultModel</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el: ASTElement,</span></span></span><br><span class="line"><span class="function"><span class="params">  value: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  modifiers: ?ASTModifiers</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): ?<span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> type = el.attrsMap.type</span><br><span class="line"></span><br><span class="line">  <span class="comment">// warn if v-bind:value conflicts with v-model</span></span><br><span class="line">  <span class="comment">// except for inputs with v-bind:type</span></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> value = el.attrsMap[<span class="string">'v-bind:value'</span>] || el.attrsMap[<span class="string">':value'</span>]</span><br><span class="line">    <span class="keyword">const</span> typeBinding = el.attrsMap[<span class="string">'v-bind:type'</span>] || el.attrsMap[<span class="string">':type'</span>]</span><br><span class="line">    <span class="keyword">if</span> (value &amp;&amp; !typeBinding) &#123;</span><br><span class="line">      <span class="keyword">const</span> binding = el.attrsMap[<span class="string">'v-bind:value'</span>] ? <span class="string">'v-bind:value'</span> : <span class="string">':value'</span></span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`<span class="subst">$&#123;binding&#125;</span>="<span class="subst">$&#123;value&#125;</span>" conflicts with v-model on the same element `</span> +</span><br><span class="line">        <span class="string">'because the latter already expands to a value binding internally'</span>,</span><br><span class="line">        el.rawAttrsMap[binding]</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; lazy, number, trim &#125; = modifiers || &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> needCompositionGuard = !lazy &amp;&amp; type !== <span class="string">'range'</span></span><br><span class="line">  <span class="keyword">const</span> event = lazy</span><br><span class="line">    ? <span class="string">'change'</span></span><br><span class="line">    : type === <span class="string">'range'</span></span><br><span class="line">      ? RANGE_TOKEN</span><br><span class="line">      : <span class="string">'input'</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> valueExpression = <span class="string">'$event.target.value'</span></span><br><span class="line">  <span class="keyword">if</span> (trim) &#123;</span><br><span class="line">    valueExpression = <span class="string">`$event.target.value.trim()`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (number) &#123;</span><br><span class="line">    valueExpression = <span class="string">`_n(<span class="subst">$&#123;valueExpression&#125;</span>)`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> code = genAssignmentCode(value, valueExpression)</span><br><span class="line">  <span class="keyword">if</span> (needCompositionGuard) &#123;</span><br><span class="line">    code = <span class="string">`if($event.target.composing)return;<span class="subst">$&#123;code&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  addProp(el, <span class="string">'value'</span>, <span class="string">`(<span class="subst">$&#123;value&#125;</span>)`</span>)</span><br><span class="line">  addHandler(el, event, code, <span class="literal">null</span>, <span class="literal">true</span>)</span><br><span class="line">  <span class="keyword">if</span> (trim || number) &#123;</span><br><span class="line">    addHandler(el, <span class="string">'blur'</span>, <span class="string">'$forceUpdate()'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="genAssignmentCode"><a href="#genAssignmentCode" class="headerlink" title="genAssignmentCode"></a>genAssignmentCode</h3><p>解析 model 后, 看返回的结果 key 是否存在, 然后与传入的参数 valueExpression 进行拼接, 实际上也是 input 输入事件获取到的值, 同步到这里,  ‘text’=’$event.target.value’</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">genAssignmentCode</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  value: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  assignment: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = parseModel(value)</span><br><span class="line">  <span class="keyword">if</span> (res.key === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;value&#125;</span>=<span class="subst">$&#123;assignment&#125;</span>`</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`$set(<span class="subst">$&#123;res.exp&#125;</span>, <span class="subst">$&#123;res.key&#125;</span>, <span class="subst">$&#123;assignment&#125;</span>)`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="parseModel"><a href="#parseModel" class="headerlink" title="parseModel"></a>parseModel</h3><p>解析 model 绑定的变量, 返回一个对象 {exp: ‘text’, key: null}</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">parseModel</span> (<span class="params">val: string</span>): <span class="title">ModelParseResult</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Fix https://github.com/vuejs/vue/pull/7730</span></span><br><span class="line">  <span class="comment">// allow v-model="obj.val " (trailing whitespace)</span></span><br><span class="line">  val = val.trim()</span><br><span class="line">  len = val.length</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (val.indexOf(<span class="string">'['</span>) &lt; <span class="number">0</span> || val.lastIndexOf(<span class="string">']'</span>) &lt; len - <span class="number">1</span>) &#123;</span><br><span class="line">    index = val.lastIndexOf(<span class="string">'.'</span>)</span><br><span class="line">    <span class="keyword">if</span> (index &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        exp: val.slice(<span class="number">0</span>, index),</span><br><span class="line">        key: <span class="string">'"'</span> + val.slice(index + <span class="number">1</span>) + <span class="string">'"'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        exp: val,</span><br><span class="line">        key: <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  str = val</span><br><span class="line">  index = expressionPos = expressionEndPos = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (!eof()) &#123;</span><br><span class="line">    chr = next()</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (isStringStart(chr)) &#123;</span><br><span class="line">      parseString(chr)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (chr === <span class="number">0x5B</span>) &#123;</span><br><span class="line">      parseBracket(chr)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    exp: val.slice(<span class="number">0</span>, expressionPos),</span><br><span class="line">    key: val.slice(expressionPos + <span class="number">1</span>, expressionEndPos)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="genProps"><a href="#genProps" class="headerlink" title="genProps"></a>genProps</h2><p>经过 genDirectives, 给当前节点的 ast 树挂上了 props 属性, 用来描述 model 对应的 value, 判断是静态属性还是动态属性, 最终得到 <code>domProps:{&quot;value&quot;:(text)},</code> , 与之前的指令进行拼接; </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DOM props</span></span><br><span class="line"><span class="keyword">if</span> (el.props) &#123;</span><br><span class="line">  data += <span class="string">`domProps:<span class="subst">$&#123;genProps(el.props)&#125;</span>,`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// genProps</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genProps</span> (<span class="params">props: Array&lt;ASTAttr&gt;</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> staticProps = <span class="string">``</span></span><br><span class="line">  <span class="keyword">let</span> dynamicProps = <span class="string">``</span> <span class="comment">// 动态的</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; props.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> prop = props[i]</span><br><span class="line">    <span class="keyword">const</span> value = __WEEX__</span><br><span class="line">      ? generateValue(prop.value)</span><br><span class="line">      : transformSpecialNewlines(prop.value)</span><br><span class="line">    <span class="keyword">if</span> (prop.dynamic) &#123;</span><br><span class="line">      dynamicProps += <span class="string">`<span class="subst">$&#123;prop.name&#125;</span>,<span class="subst">$&#123;value&#125;</span>,`</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      staticProps += <span class="string">`"<span class="subst">$&#123;prop.name&#125;</span>":<span class="subst">$&#123;value&#125;</span>,`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  staticProps = <span class="string">`&#123;<span class="subst">$&#123;staticProps.slice(<span class="number">0</span>, <span class="number">-1</span>)&#125;</span>&#125;`</span></span><br><span class="line">  <span class="keyword">if</span> (dynamicProps) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`_d(<span class="subst">$&#123;staticProps&#125;</span>,[<span class="subst">$&#123;dynamicProps.slice(<span class="number">0</span>, <span class="number">-1</span>)&#125;</span>])`</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> staticProps</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="genHandlers-1"><a href="#genHandlers-1" class="headerlink" title="genHandlers"></a>genHandlers</h2><p>经过 genDirectives, 给当前节点的 ast 树挂上了 events 属性, 用来描述 model 对应的输入事件, 将 model 事件的 value 加入函数, 接着绑定 input, 也就是说 input 事件的监听函数就是 value 的变动: </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 事件的 prefix</span></span><br><span class="line">on: &#123;<span class="string">"input"</span>:<span class="function"><span class="keyword">function</span>(<span class="params">$event</span>)</span>&#123;<span class="keyword">if</span>($event.target.composing)<span class="keyword">return</span>;text=$event.target.value&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>最后将 directives props events 的代码拼接起来:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_c(<span class="string">'input'</span>,&#123;<span class="attr">directives</span>:[&#123;<span class="attr">name</span>:<span class="string">"model"</span>,<span class="attr">rawName</span>:<span class="string">"v-model"</span>,<span class="attr">value</span>:(text),<span class="attr">expression</span>:<span class="string">"text"</span>&#125;],<span class="attr">domProps</span>:&#123;<span class="string">"value"</span>:(text)&#125;,<span class="attr">on</span>:&#123;<span class="string">"input"</span>:<span class="function"><span class="keyword">function</span>(<span class="params">$event</span>)</span>&#123;<span class="keyword">if</span>($event.target.composing)<span class="keyword">return</span>;text=$event.target.value&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// event handlers</span></span><br><span class="line"><span class="keyword">if</span> (el.events) &#123;</span><br><span class="line">  data += <span class="string">`<span class="subst">$&#123;genHandlers(el.events, <span class="literal">false</span>)&#125;</span>,`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// genHandlers</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">genHandlers</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  events: ASTElementHandlers,</span></span></span><br><span class="line"><span class="function"><span class="params">  isNative: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prefix = isNative ? <span class="string">'nativeOn:'</span> : <span class="string">'on:'</span></span><br><span class="line">  <span class="keyword">let</span> staticHandlers = <span class="string">``</span></span><br><span class="line">  <span class="keyword">let</span> dynamicHandlers = <span class="string">``</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> name <span class="keyword">in</span> events) &#123;</span><br><span class="line">    <span class="keyword">const</span> handlerCode = genHandler(events[name])</span><br><span class="line">    <span class="keyword">if</span> (events[name] &amp;&amp; events[name].dynamic) &#123;</span><br><span class="line">      dynamicHandlers += <span class="string">`<span class="subst">$&#123;name&#125;</span>,<span class="subst">$&#123;handlerCode&#125;</span>,`</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      staticHandlers += <span class="string">`"<span class="subst">$&#123;name&#125;</span>":<span class="subst">$&#123;handlerCode&#125;</span>,`</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  staticHandlers = <span class="string">`&#123;<span class="subst">$&#123;staticHandlers.slice(<span class="number">0</span>, <span class="number">-1</span>)&#125;</span>&#125;`</span></span><br><span class="line">  <span class="keyword">if</span> (dynamicHandlers) &#123;</span><br><span class="line">    <span class="keyword">return</span> prefix + <span class="string">`_d(<span class="subst">$&#123;staticHandlers&#125;</span>,[<span class="subst">$&#123;dynamicHandlers.slice(<span class="number">0</span>, <span class="number">-1</span>)&#125;</span>])`</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> prefix + staticHandlers</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// genHandler</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genHandler</span> (<span class="params">handler: ASTElementHandler | Array&lt;ASTElementHandler&gt;</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!handler) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'function()&#123;&#125;'</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(handler)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`[<span class="subst">$&#123;handler.map(handler =&gt; genHandler(handler)).join(<span class="string">','</span>)&#125;</span>]`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> isMethodPath = simplePathRE.test(handler.value)</span><br><span class="line">  <span class="keyword">const</span> isFunctionExpression = fnExpRE.test(handler.value)</span><br><span class="line">  <span class="keyword">const</span> isFunctionInvocation = simplePathRE.test(handler.value.replace(fnInvokeRE, <span class="string">''</span>))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!handler.modifiers) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isMethodPath || isFunctionExpression) &#123;</span><br><span class="line">      <span class="keyword">return</span> handler.value</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (__WEEX__ &amp;&amp; handler.params) &#123;</span><br><span class="line">      <span class="keyword">return</span> genWeexHandler(handler.params, handler.value)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`function($event)&#123;<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">      isFunctionInvocation ? <span class="string">`return <span class="subst">$&#123;handler.value&#125;</span>`</span> : handler.value</span></span></span><br><span class="line"><span class="string"><span class="subst">    &#125;</span>&#125;`</span> <span class="comment">// inline statement</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> code = <span class="string">''</span></span><br><span class="line">    <span class="keyword">let</span> genModifierCode = <span class="string">''</span></span><br><span class="line">    <span class="keyword">const</span> keys = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> handler.modifiers) &#123;</span><br><span class="line">      <span class="keyword">if</span> (modifierCode[key]) &#123;</span><br><span class="line">        genModifierCode += modifierCode[key]</span><br><span class="line">        <span class="comment">// left/right</span></span><br><span class="line">        <span class="keyword">if</span> (keyCodes[key]) &#123;</span><br><span class="line">          keys.push(key)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key === <span class="string">'exact'</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> modifiers: ASTModifiers = (handler.modifiers: any)</span><br><span class="line">        genModifierCode += genGuard(</span><br><span class="line">          [<span class="string">'ctrl'</span>, <span class="string">'shift'</span>, <span class="string">'alt'</span>, <span class="string">'meta'</span>]</span><br><span class="line">            .filter(<span class="function"><span class="params">keyModifier</span> =&gt;</span> !modifiers[keyModifier])</span><br><span class="line">            .map(<span class="function"><span class="params">keyModifier</span> =&gt;</span> <span class="string">`$event.<span class="subst">$&#123;keyModifier&#125;</span>Key`</span>)</span><br><span class="line">            .join(<span class="string">'||'</span>)</span><br><span class="line">        )</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        keys.push(key)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (keys.length) &#123;</span><br><span class="line">      code += genKeyFilter(keys)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Make sure modifiers like prevent and stop get executed after key filtering</span></span><br><span class="line">    <span class="keyword">if</span> (genModifierCode) &#123;</span><br><span class="line">      code += genModifierCode</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> handlerCode = isMethodPath</span><br><span class="line">      ? <span class="string">`return <span class="subst">$&#123;handler.value&#125;</span>.apply(null, arguments)`</span></span><br><span class="line">      : isFunctionExpression</span><br><span class="line">        ? <span class="string">`return (<span class="subst">$&#123;handler.value&#125;</span>).apply(null, arguments)`</span></span><br><span class="line">        : isFunctionInvocation</span><br><span class="line">          ? <span class="string">`return <span class="subst">$&#123;handler.value&#125;</span>`</span></span><br><span class="line">          : handler.value</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (__WEEX__ &amp;&amp; handler.params) &#123;</span><br><span class="line">      <span class="keyword">return</span> genWeexHandler(handler.params, code + handlerCode)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`function($event)&#123;<span class="subst">$&#123;code&#125;</span><span class="subst">$&#123;handlerCode&#125;</span>&#125;`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createElement-3"><a href="#createElement-3" class="headerlink" title="createElement"></a>createElement</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">_c(<span class="string">'div'</span>,[_c(<span class="string">'input'</span>,&#123;</span><br><span class="line">  directives:[&#123;<span class="attr">name</span>:<span class="string">"model"</span>,<span class="attr">rawName</span>:<span class="string">"v-model"</span>,<span class="attr">value</span>:(text),<span class="attr">expression</span>:<span class="string">"text"</span>&#125;],</span><br><span class="line">  domProps:&#123;<span class="string">"value"</span>:(text)&#125;,</span><br><span class="line">  on:&#123;</span><br><span class="line">    <span class="string">"input"</span>:<span class="function"><span class="keyword">function</span>(<span class="params">$event</span>)</span>&#123;<span class="keyword">if</span>($event.target.composing)<span class="keyword">return</span>;text=$event.target.value&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)])</span><br></pre></td></tr></table></figure>
<p>依次读取完各变量, input 开始生成虚拟节点, ‘input’ 其后为属性抽象出来的 data 对象, 而此时 input 创建虚拟节点的 data 就直接为该对象, 只不过做了变量替换.</p>
<h2 id="createElm-3"><a href="#createElm-3" class="headerlink" title="createElm"></a>createElm</h2><p>创建 input 标签, 再看其 children, 没有则继续进行 invokeCreateHooks, 这也是 v-model 的重点, 因为当前节点的属性 data 有 directives, domProps, on; 也就是指令 model, input 的 dom 属性 value 用以事件读取, input 输入事件</p>
<p>接下来着重处理属性 data</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vnode.elm = vnode.ns</span><br><span class="line">  ? nodeOps.createElementNS(vnode.ns, tag)</span><br><span class="line">  : nodeOps.createElement(tag, vnode)</span><br><span class="line"></span><br><span class="line">createChildren(vnode, children, insertedVnodeQueue)</span><br><span class="line"><span class="keyword">if</span> (isDef(data)) &#123;</span><br><span class="line">  invokeCreateHooks(vnode, insertedVnodeQueue)</span><br><span class="line">&#125;</span><br><span class="line">insert(parentElm, vnode.elm, refElm)</span><br></pre></td></tr></table></figure>
<h2 id="invokeCreateHooks"><a href="#invokeCreateHooks" class="headerlink" title="invokeCreateHooks"></a>invokeCreateHooks</h2><p>在这个方法里, 会遍历 cbs.create 里的方法来处理传入的 vnode 属性 data, 如属性, class, 事件, dom 属性, 行内样式, 指令等的挂载更新</p>
<p>这里会执行到 updateDOMListeners, updateDOMProps, </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cbs.create &#123;</span><br><span class="line">  <span class="number">0</span>:ƒ updateAttrs(oldVnode, vnode)</span><br><span class="line">  <span class="number">1</span>:ƒ updateClass (oldVnode, vnode) </span><br><span class="line">  <span class="number">2</span>:ƒ updateDOMListeners (oldVnode, vnode) </span><br><span class="line">  <span class="number">3</span>:ƒ updateDOMProps(oldVnode, vnode)</span><br><span class="line">  <span class="number">4</span>:ƒ updateStyle(oldVnode, vnode)</span><br><span class="line">  <span class="number">5</span>:ƒ _enter (_, vnode) </span><br><span class="line">  <span class="number">6</span>:ƒ create (_, vnode) </span><br><span class="line">  <span class="number">7</span>:ƒ updateDirectives (oldVnode, vnode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">invokeCreateHooks</span> (<span class="params">vnode, insertedVnodeQueue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cbs.create.length; ++i) &#123;</span><br><span class="line">    cbs.create[i](emptyNode, vnode)</span><br><span class="line">  &#125;</span><br><span class="line">  i = vnode.data.hook <span class="comment">// Reuse variable</span></span><br><span class="line">  <span class="keyword">if</span> (isDef(i)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDef(i.create)) i.create(emptyNode, vnode)</span><br><span class="line">    <span class="keyword">if</span> (isDef(i.insert)) insertedVnodeQueue.push(vnode) <span class="comment">// 插入的 VNode 队列</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="updateDOMListeners-1"><a href="#updateDOMListeners-1" class="headerlink" title="updateDOMListeners"></a>updateDOMListeners</h3><p>updateDOMListeners 是因为存在 input 事件; 同之前说到的处理事件的方法一样, 会对比新旧节点属性 data 里 on 中的事件, 初始化时, 旧节点没有, 因此就直接将新节点 on 里的事件方法进行 createFnInvoker 处理, 接着直接在 add 方法里用 addEventListener 给当前节点 vnode.elm 绑定 input 事件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateDOMListeners</span> (<span class="params">oldVnode: VNodeWithData, vnode: VNodeWithData</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isUndef(oldVnode.data.on) &amp;&amp; isUndef(vnode.data.on)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> on = vnode.data.on || &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> oldOn = oldVnode.data.on || &#123;&#125;</span><br><span class="line">  target = vnode.elm</span><br><span class="line">  normalizeEvents(on)</span><br><span class="line">  updateListeners(on, oldOn, add, remove, createOnceHandler, vnode.context)</span><br><span class="line">  target = <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// updateListeners</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateListeners</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  on: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  oldOn: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  add: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  remove: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  createOnceHandler: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  vm: Component</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> name, def, cur, old, event</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> on) &#123;</span><br><span class="line">    def = cur = on[name]</span><br><span class="line">    old = oldOn[name]</span><br><span class="line">    event = normalizeEvent(name)</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (__WEEX__ &amp;&amp; isPlainObject(def)) &#123;</span><br><span class="line">      cur = def.handler</span><br><span class="line">      event.params = def.params</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isUndef(cur)) &#123;</span><br><span class="line">      process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warn(</span><br><span class="line">        <span class="string">`Invalid handler for event "<span class="subst">$&#123;event.name&#125;</span>": got `</span> + <span class="built_in">String</span>(cur),</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isUndef(old)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isUndef(cur.fns)) &#123;</span><br><span class="line">        cur = on[name] = createFnInvoker(cur, vm)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (isTrue(event.once)) &#123;</span><br><span class="line">        cur = on[name] = createOnceHandler(event.name, cur, event.capture)</span><br><span class="line">      &#125;</span><br><span class="line">      add(event.name, cur, event.capture, event.passive, event.params)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur !== old) &#123;</span><br><span class="line">      old.fns = cur</span><br><span class="line">      on[name] = old</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (name <span class="keyword">in</span> oldOn) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isUndef(on[name])) &#123;</span><br><span class="line">      event = normalizeEvent(name)</span><br><span class="line">      remove(event.name, oldOn[name], event.capture)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="updateDOMProps"><a href="#updateDOMProps" class="headerlink" title="updateDOMProps"></a>updateDOMProps</h3><p>接着进行 domProps 的处理, 获取当前的 domProps, 进行遍历, 对每个 prop 的名字进行判断, 看是否是 textContent, innerHTML, value, 按不同方式处理;</p>
<p>此时是 input 键入的值, 也就是 value, 设置当前节点 elm 的 _value 为 value 对应的值, 也就是已经存在与 input 框内的值; 接着检查 shouldUpdateValue 是否应该更新值, 避免值相同了还做重复设定</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateDOMProps</span> (<span class="params">oldVnode: VNodeWithData, vnode: NodeWithData</span>) </span></span><br><span class="line"><span class="function">  <span class="title">if</span> (<span class="params">isUndef(oldVnode.data.domProps</span>) &amp;&amp; <span class="title">isUndef</span>(<span class="params">vnode.data.domProps</span>)) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> key, cur</span><br><span class="line">  <span class="keyword">const</span> elm: any = vnode.elm</span><br><span class="line">  <span class="keyword">const</span> oldProps = oldVnode.data.domProps || &#123;&#125;</span><br><span class="line">  <span class="keyword">let</span> props = vnode.data.domProps || &#123;&#125;</span><br><span class="line">  <span class="comment">// clone observed objects, as the user probably wants to mutate it</span></span><br><span class="line">  <span class="keyword">if</span> (isDef(props.__ob__)) &#123;</span><br><span class="line">    props = vnode.data.domProps = extend(&#123;&#125;, props)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (key <span class="keyword">in</span> oldProps) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> props)) &#123;</span><br><span class="line">      elm[key] = <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (key <span class="keyword">in</span> props) &#123;</span><br><span class="line">    cur = props[key]</span><br><span class="line">    <span class="comment">// ignore children if the node has textContent or innerHTML,</span></span><br><span class="line">    <span class="comment">// as these will throw away existing DOM nodes and cause removal errors</span></span><br><span class="line">    <span class="comment">// on subsequent patches (#3360)</span></span><br><span class="line">    <span class="keyword">if</span> (key === <span class="string">'textContent'</span> || key === <span class="string">'innerHTML'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (vnode.children) vnode.children.length = <span class="number">0</span></span><br><span class="line">      <span class="keyword">if</span> (cur === oldProps[key]) <span class="keyword">continue</span></span><br><span class="line">      <span class="comment">// #6601 work around Chrome version &lt;= 55 bug where single textNode</span></span><br><span class="line">      <span class="comment">// replaced by innerHTML/textContent retains its parentNode property</span></span><br><span class="line">      <span class="keyword">if</span> (elm.childNodes.length === <span class="number">1</span>) &#123;</span><br><span class="line">        elm.removeChild(elm.childNodes[<span class="number">0</span>])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (key === <span class="string">'value'</span> &amp;&amp; elm.tagName !== <span class="string">'PROGRESS'</span>) &#123;</span><br><span class="line">      <span class="comment">// store value as _value as well since</span></span><br><span class="line">      <span class="comment">// non-string values will be stringified</span></span><br><span class="line">      elm._value = cur</span><br><span class="line">      <span class="comment">// avoid resetting cursor position when value is the same</span></span><br><span class="line">      <span class="keyword">const</span> strCur = isUndef(cur) ? <span class="string">''</span> : <span class="built_in">String</span>(cur)</span><br><span class="line">      <span class="keyword">if</span> (shouldUpdateValue(elm, strCur)) &#123;</span><br><span class="line">        elm.value = strCur</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key === <span class="string">'innerHTML'</span> &amp;&amp; isSVG(elm.tagName) &amp;&amp; isUndef(elm.innerHTML)) &#123;</span><br><span class="line">      <span class="comment">// IE doesn't support innerHTML for SVG elements</span></span><br><span class="line">      svgContainer = svgContainer || <span class="built_in">document</span>.createElement(<span class="string">'div'</span>)</span><br><span class="line">      svgContainer.innerHTML = <span class="string">`&lt;svg&gt;<span class="subst">$&#123;cur&#125;</span>&lt;/svg&gt;`</span></span><br><span class="line">      <span class="keyword">const</span> svg = svgContainer.firstChild</span><br><span class="line">      <span class="keyword">while</span> (elm.firstChild) &#123;</span><br><span class="line">        elm.removeChild(elm.firstChild)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> (svg.firstChild) &#123;</span><br><span class="line">        elm.appendChild(svg.firstChild)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      <span class="comment">// skip the update if old and new VDOM state is the same.</span></span><br><span class="line">      <span class="comment">// `value` is handled separately because the DOM value may be temporarily</span></span><br><span class="line">      <span class="comment">// out of sync with VDOM state due to focus, composition and modifiers.</span></span><br><span class="line">      <span class="comment">// This  #4521 by skipping the unnecessary `checked` update.</span></span><br><span class="line">      cur !== oldProps[key]</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// some property updates can throw</span></span><br><span class="line">      <span class="comment">// e.g. `value` on &lt;progress&gt; w/ non-finite value</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        elm[key] = cur</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="updateDirectives"><a href="#updateDirectives" class="headerlink" title="updateDirectives"></a>updateDirectives</h2><p>当前的节点有 Directives 命令, 将新节点的命令数组获取, 遍历, 如果不存在旧节点, 那么就将新命令绑定, 存入 dirsWithInsert; 如果存在旧节点, 那么就将命令作以更新;</p>
<p>在 _update 中, 如果旧节点等于空节点, 那么 isCreate 就为 true, 表示新创建; 因此之后会执行 <code>mergeVNodeHook(vnode, &#39;insert&#39;, callInsert)</code> 给当前的节点属性 data 插入 insert hook</p>
<p>在 中, oldHook 是 <code>vnode.data.hook[&#39;insert&#39;]</code>, 当前并不存在, 因此为 undefined; 在后续会执行 <code>invoker = createFnInvoker([wrappedHook])</code> , 也是用 callInsert 生成 invoker, 再令 <code>vnode.data.hook[&#39;insert&#39;] = invoker</code></p>
<p>如此就完成了; 再往下回到 invokeCreateHooks, 会检查 if (isDef(i.insert)) 是否定义, 而此时定义了, 那么就将当前的 VNode 加入 <code>insertedVnodeQueue.push(vnode)</code> 队列</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateDirectives</span> (<span class="params">oldVnode: VNodeWithData, vnode: VNodeWithData</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (oldVnode.data.directives || vnode.data.directives) &#123;</span><br><span class="line">    _update(oldVnode, vnode)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_update</span> (<span class="params">oldVnode, vnode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> isCreate = oldVnode === emptyNode</span><br><span class="line">  <span class="keyword">const</span> isDestroy = vnode === emptyNode</span><br><span class="line">  <span class="keyword">const</span> oldDirs = normalizeDirectives(oldVnode.data.directives, oldVnode.context)</span><br><span class="line">  <span class="keyword">const</span> newDirs = normalizeDirectives(vnode.data.directives, vnode.context)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> dirsWithInsert = []</span><br><span class="line">  <span class="keyword">const</span> dirsWithPostpatch = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> key, oldDir, dir</span><br><span class="line">  <span class="keyword">for</span> (key <span class="keyword">in</span> newDirs) &#123;</span><br><span class="line">    oldDir = oldDirs[key]</span><br><span class="line">    dir = newDirs[key]</span><br><span class="line">    <span class="keyword">if</span> (!oldDir) &#123;</span><br><span class="line">      <span class="comment">// new directive, bind</span></span><br><span class="line">      callHook(dir, <span class="string">'bind'</span>, vnode, oldVnode)</span><br><span class="line">      <span class="keyword">if</span> (dir.def &amp;&amp; dir.def.inserted) &#123;</span><br><span class="line">        dirsWithInsert.push(dir)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// existing directive, update</span></span><br><span class="line">      dir.oldValue = oldDir.value</span><br><span class="line">      dir.oldArg = oldDir.arg</span><br><span class="line">      callHook(dir, <span class="string">'update'</span>, vnode, oldVnode)</span><br><span class="line">      <span class="keyword">if</span> (dir.def &amp;&amp; dir.def.componentUpdated) &#123;</span><br><span class="line">        dirsWithPostpatch.push(dir)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dirsWithInsert.length) &#123;</span><br><span class="line">    <span class="keyword">const</span> callInsert = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dirsWithInsert.length; i++) &#123;</span><br><span class="line">        callHook(dirsWithInsert[i], <span class="string">'inserted'</span>, vnode, oldVnode)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isCreate) &#123;</span><br><span class="line">      mergeVNodeHook(vnode, <span class="string">'insert'</span>, callInsert)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      callInsert()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dirsWithPostpatch.length) &#123;</span><br><span class="line">    mergeVNodeHook(vnode, <span class="string">'postpatch'</span>, () =&gt; &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dirsWithPostpatch.length; i++) &#123;</span><br><span class="line">        callHook(dirsWithPostpatch[i], <span class="string">'componentUpdated'</span>, vnode, oldVnode)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!isCreate) &#123;</span><br><span class="line">    <span class="keyword">for</span> (key <span class="keyword">in</span> oldDirs) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!newDirs[key]) &#123;</span><br><span class="line">        <span class="comment">// no longer present, unbind</span></span><br><span class="line">        callHook(oldDirs[key], <span class="string">'unbind'</span>, oldVnode, oldVnode, isDestroy)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mergeVNodeHook</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mergeVNodeHook</span> (<span class="params">def: Object, hookKey: string, hook: Function</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (def <span class="keyword">instanceof</span> VNode) &#123;</span><br><span class="line">    def = def.data.hook || (def.data.hook = &#123;&#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> invoker</span><br><span class="line">  <span class="keyword">const</span> oldHook = def[hookKey]</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">wrappedHook</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    hook.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>)</span><br><span class="line">    <span class="comment">// important: remove merged hook to ensure it's called only once</span></span><br><span class="line">    <span class="comment">// and prevent memory leak</span></span><br><span class="line">    remove(invoker.fns, wrappedHook)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isUndef(oldHook)) &#123;</span><br><span class="line">    <span class="comment">// no existing hook</span></span><br><span class="line">    invoker = createFnInvoker([wrappedHook])</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (isDef(oldHook.fns) &amp;&amp; isTrue(oldHook.merged)) &#123;</span><br><span class="line">      <span class="comment">// already a merged invoker</span></span><br><span class="line">      invoker = oldHook</span><br><span class="line">      invoker.fns.push(wrappedHook)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// existing plain hook</span></span><br><span class="line">      invoker = createFnInvoker([oldHook, wrappedHook])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  invoker.merged = <span class="literal">true</span></span><br><span class="line">  def[hookKey] = invoker</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="v-bind"><a href="#v-bind" class="headerlink" title="v-bind"></a>v-bind</h1><h2 id="processAttrs-2"><a href="#processAttrs-2" class="headerlink" title="processAttrs"></a>processAttrs</h2><p>在 processAttrs 对 v-bind 的处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (bindRE.test(name)) &#123; <span class="comment">// v-bind</span></span><br><span class="line">  name = name.replace(bindRE, <span class="string">''</span>)</span><br><span class="line">  value = parseFilters(value)</span><br><span class="line">  isDynamic = dynamicArgRE.test(name)</span><br><span class="line">  <span class="keyword">if</span> (isDynamic) &#123;</span><br><span class="line">    name = name.slice(<span class="number">1</span>, <span class="number">-1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">    value.trim().length === <span class="number">0</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`The value for a v-bind expression cannot be empty. Found in "v-bind:<span class="subst">$&#123;name&#125;</span>"`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (modifiers) &#123;</span><br><span class="line">    <span class="keyword">if</span> (modifiers.prop &amp;&amp; !isDynamic) &#123;</span><br><span class="line">      name = camelize(name)</span><br><span class="line">      <span class="keyword">if</span> (name === <span class="string">'innerHtml'</span>) name = <span class="string">'innerHTML'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (modifiers.camel &amp;&amp; !isDynamic) &#123;</span><br><span class="line">      name = camelize(name)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (modifiers.sync) &#123;</span><br><span class="line">      syncGen = genAssignmentCode(value, <span class="string">`$event`</span>)</span><br><span class="line">      <span class="keyword">if</span> (!isDynamic) &#123;</span><br><span class="line">        addHandler(</span><br><span class="line">          el,</span><br><span class="line">          <span class="string">`update:<span class="subst">$&#123;camelize(name)&#125;</span>`</span>,</span><br><span class="line">          syncGen,</span><br><span class="line">          <span class="literal">null</span>,</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          warn,</span><br><span class="line">          list[i]</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> (hyphenate(name) !== camelize(name)) &#123;</span><br><span class="line">          addHandler(</span><br><span class="line">            el,</span><br><span class="line">            <span class="string">`update:<span class="subst">$&#123;hyphenate(name)&#125;</span>`</span>,</span><br><span class="line">            syncGen,</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            <span class="literal">false</span>,</span><br><span class="line">            warn,</span><br><span class="line">            list[i]</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// handler w/ dynamic event name</span></span><br><span class="line">        addHandler(</span><br><span class="line">          el,</span><br><span class="line">          <span class="string">`"update:"+(<span class="subst">$&#123;name&#125;</span>)`</span>,</span><br><span class="line">          syncGen,</span><br><span class="line">          <span class="literal">null</span>,</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          warn,</span><br><span class="line">          list[i],</span><br><span class="line">          <span class="literal">true</span> <span class="comment">// dynamic</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ((modifiers &amp;&amp; modifiers.prop) || (</span><br><span class="line">    !el.component &amp;&amp; platformMustUseProp(el.tag, el.attrsMap.type, name)</span><br><span class="line">  )) &#123;</span><br><span class="line">    addProp(el, name, value, list[i], isDynamic)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    addAttr(el, name, value, list[i], isDynamic)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="genElement-2"><a href="#genElement-2" class="headerlink" title="genElement"></a>genElement</h2><p>dataGenFns 中的方法使动态属性及动态样式表示出来</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// module data generation functions</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; state.dataGenFns.length; i++) &#123;</span><br><span class="line">  data += state.dataGenFns[i](el)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用 dataGenFns 中的方法</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genData</span> (<span class="params">el: ASTElement</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data = <span class="string">''</span></span><br><span class="line">  <span class="keyword">if</span> (el.staticClass) &#123;</span><br><span class="line">    data += <span class="string">`staticClass:<span class="subst">$&#123;el.staticClass&#125;</span>,`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.classBinding) &#123;</span><br><span class="line">    data += <span class="string">`class:<span class="subst">$&#123;el.classBinding&#125;</span>,`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// style</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genData</span> (<span class="params">el: ASTElement</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data = <span class="string">''</span></span><br><span class="line">  <span class="keyword">if</span> (el.staticStyle) &#123;</span><br><span class="line">    data += <span class="string">`staticStyle:<span class="subst">$&#123;el.staticStyle&#125;</span>,`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.styleBinding) &#123;</span><br><span class="line">    data += <span class="string">`style:(<span class="subst">$&#123;el.styleBinding&#125;</span>),`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createElement-4"><a href="#createElement-4" class="headerlink" title="createElement"></a>createElement</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_c(<span class="string">'div'</span>,&#123;<span class="attr">class</span>:bindClass,<span class="attr">on</span>:&#123;<span class="string">"click"</span>:update&#125;&#125;,[_v(_s(sum))])])&#125;</span><br></pre></td></tr></table></figure>
<p>sum 通过 computedGetter 获取, 会得到 initComputed 时期创建的计算属性 watcher , 通过 watcher 添加依赖, 其实 在对数据的每次 getter 时, 都会触发相应的依赖收集, 将新的订阅添加完，会移除掉旧的订阅, newDeps 表示新添加的 Dep 实例数组，而 deps 表示上一次添加的 Dep 实例数组。</p>
<p>同时我们也能看到, 计算属性 sum 对应的依赖 dep 当前已有三个观察者, 一个是初始化计算属性, 一个是初始化 watch 时我们写入了 sum, 再有就是刚才做 render 生成虚拟节点时读取到了 sum;</p>
<p>读取完 sum 后将其转为字符串, 接着生成文本虚拟节点.</p>
<p>此时 div 标签 _c 的准备工作就做完了, 标签, 属性 data, children, 创建元素虚拟节点; 动态属性也在之前读取变量时得到了对应的值</p>
<h2 id="createElm-4"><a href="#createElm-4" class="headerlink" title="createElm"></a>createElm</h2><p>计算属性到这一步, 和一般的其实也差不多, 这里说下上边没有的 class 的更新;</p>
<p>判断如果和之前旧的节点的 class 不同, 那么就用 setAttribute 设定现在的 class, 同时再用 _prevClass 存储当前的 class, 以便之后 class 改变了与 _prevClass 再进行对比</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateClass</span> (<span class="params">oldVnode: any, vnode: any</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> el = vnode.elm</span><br><span class="line">  <span class="keyword">const</span> data: VNodeData = vnode.data</span><br><span class="line">  <span class="keyword">const</span> oldData: VNodeData = oldVnode.data</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    isUndef(data.staticClass) &amp;&amp;</span><br><span class="line">    isUndef(data.class) &amp;&amp; (</span><br><span class="line">      isUndef(oldData) || (</span><br><span class="line">        isUndef(oldData.staticClass) &amp;&amp;</span><br><span class="line">        isUndef(oldData.class)</span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> cls = genClassForVnode(vnode)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// handle transition classes</span></span><br><span class="line">  <span class="keyword">const</span> transitionClass = el._transitionClasses</span><br><span class="line">  <span class="keyword">if</span> (isDef(transitionClass)) &#123;</span><br><span class="line">    cls = concat(cls, stringifyClass(transitionClass))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set the class</span></span><br><span class="line">  <span class="keyword">if</span> (cls !== el._prevClass) &#123;</span><br><span class="line">    el.setAttribute(<span class="string">'class'</span>, cls)</span><br><span class="line">    el._prevClass = cls</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <br>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/blog/categories/notes/">notes</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Frontend/">Frontend</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Vue/">Vue</a></li></ul>

      
	<span class="ico-date"></span>
	<a href="/blog/2021/08/12/2-frontend-vue-source-etc/" class="article-date">
	  <time datetime="2021-08-11T16:00:00.000Z" itemprop="datePublished">八月 12, 2021</time>
	</a>

      <!-- 添加字数统计 -->
      
        <span class="ico-fontcount"></span><span class="post-count">12.8k字</span>
      
    </footer>
    <!-- 文章添加评论 -->
    
      
    <script src="//github.elemecdn.com/leancloud-storage@3/dist/av-min.js"></script>
    <script src='//unpkg.com/valine@latest/dist/Valine.min.js'></script>
    <div id="vcomments"></div>
    <script>
        var notify = 'false' == true ? true : false;
        var verify = 'false' == true ? true : false;
        window.onload = function() {
            new Valine({
                el: '#vcomments',
                notify: notify,
                verify: verify,
                app_id: "AJj6aG4cDMBqBIISAr1U53Az-gzGzoHsz",
                app_key: "bIYBhlht4PSXI4pCWuH7Gnuo",
                placeholder: "write here ~",
                avatar:"monsterid"
            });
        }
    </script>



    
    <hr class="entry-footer-hr">
  </div>
  
    
<nav id="article-nav">
  
    <a href="/blog/2021/08/14/2-frontend-vue-diff/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          前端 | Vue2 diff 流程
        
      </div>
    </a>
  
  
    <a href="/blog/2021/08/07/2-frontend-vue-source-mount/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">前端 | Vue2 初始化流程 - mount</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
      <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#例子"><span class="nav-number">1.</span> <span class="nav-text">例子</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#parse"><span class="nav-number">1.1.</span> <span class="nav-text">parse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#generate"><span class="nav-number">1.2.</span> <span class="nav-text">generate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#render"><span class="nav-number">1.3.</span> <span class="nav-text">render</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#update"><span class="nav-number">1.4.</span> <span class="nav-text">update</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#event"><span class="nav-number">2.</span> <span class="nav-text">event</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#processAttrs"><span class="nav-number">2.1.</span> <span class="nav-text">processAttrs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genElement"><span class="nav-number">2.2.</span> <span class="nav-text">genElement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genData"><span class="nav-number">2.3.</span> <span class="nav-text">genData</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genHandlers"><span class="nav-number">2.4.</span> <span class="nav-text">genHandlers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElement"><span class="nav-number">2.5.</span> <span class="nav-text">createElement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElm"><span class="nav-number">2.6.</span> <span class="nav-text">createElm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#updateDOMListeners"><span class="nav-number">2.7.</span> <span class="nav-text">updateDOMListeners</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#v-if"><span class="nav-number">3.</span> <span class="nav-text">v-if</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#parseHTML"><span class="nav-number">3.1.</span> <span class="nav-text">parseHTML</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#parseHTML-的-option"><span class="nav-number">3.2.</span> <span class="nav-text">parseHTML 的 option</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#parseText"><span class="nav-number">3.3.</span> <span class="nav-text">parseText</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genElement-1"><span class="nav-number">3.4.</span> <span class="nav-text">genElement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElement-1"><span class="nav-number">3.5.</span> <span class="nav-text">createElement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElm-1"><span class="nav-number">3.6.</span> <span class="nav-text">createElm</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#v-for"><span class="nav-number">4.</span> <span class="nav-text">v-for</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#processFor"><span class="nav-number">4.1.</span> <span class="nav-text">processFor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#parseFor"><span class="nav-number">4.2.</span> <span class="nav-text">parseFor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genFor"><span class="nav-number">4.3.</span> <span class="nav-text">genFor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genData-1"><span class="nav-number">4.4.</span> <span class="nav-text">genData</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElement-2"><span class="nav-number">4.5.</span> <span class="nav-text">createElement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#renderList"><span class="nav-number">4.6.</span> <span class="nav-text">renderList</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElm-2"><span class="nav-number">4.7.</span> <span class="nav-text">createElm</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#v-model"><span class="nav-number">5.</span> <span class="nav-text">v-model</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#processAttrs-1"><span class="nav-number">5.1.</span> <span class="nav-text">processAttrs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genDirectives"><span class="nav-number">5.2.</span> <span class="nav-text">genDirectives</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#genDefaultModel"><span class="nav-number">5.2.1.</span> <span class="nav-text">genDefaultModel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#genAssignmentCode"><span class="nav-number">5.2.2.</span> <span class="nav-text">genAssignmentCode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#parseModel"><span class="nav-number">5.2.3.</span> <span class="nav-text">parseModel</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genProps"><span class="nav-number">5.3.</span> <span class="nav-text">genProps</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genHandlers-1"><span class="nav-number">5.4.</span> <span class="nav-text">genHandlers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElement-3"><span class="nav-number">5.5.</span> <span class="nav-text">createElement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElm-3"><span class="nav-number">5.6.</span> <span class="nav-text">createElm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#invokeCreateHooks"><span class="nav-number">5.7.</span> <span class="nav-text">invokeCreateHooks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#updateDOMListeners-1"><span class="nav-number">5.7.1.</span> <span class="nav-text">updateDOMListeners</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#updateDOMProps"><span class="nav-number">5.7.2.</span> <span class="nav-text">updateDOMProps</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#updateDirectives"><span class="nav-number">5.8.</span> <span class="nav-text">updateDirectives</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#v-bind"><span class="nav-number">6.</span> <span class="nav-text">v-bind</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#processAttrs-2"><span class="nav-number">6.1.</span> <span class="nav-text">processAttrs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#genElement-2"><span class="nav-number">6.2.</span> <span class="nav-text">genElement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElement-4"><span class="nav-number">6.3.</span> <span class="nav-text">createElement</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#createElm-4"><span class="nav-number">6.4.</span> <span class="nav-text">createElm</span></a></li></ol></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">HOME</a>
  
    <a href="/blog/archives" class="mobile-nav-link">ARCHIVES</a>
  
    <a href="/blog/categories" class="mobile-nav-link">CATEGORIES</a>
  
    <a href="/blog/about" class="mobile-nav-link">ABOUT</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2025 Arginsen&#39;s Blog All Rights Reserved.
      </div>
      <div class="site-credit">
        ID  <a href="https://lixupeng.cn" target="_blank">Arginsen</a>
      </div>
      <br>
      <div class="busuanzi-analytics">
        
        <span id="busuanzi_container_site_pv">
          本站总访问量<span id="busuanzi_value_site_pv"></span>次
        </span>
        <span class="post-meta-divider">|</span>
        <!-- <span id="busuanzi_container_site_uv">
          本站访客数<span id="busuanzi_value_site_uv"></span>人
        </span> -->
        <span class="post-count">全站共 321.3k 字</span>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        
      </div>
  </div> 
</footer>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>


  <link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">
  <script src="/blog/fancybox/jquery.fancybox.pack.js"></script>


<script src="/blog/js/script.js"></script>
<script src="/blog/js/bootstrap.js"></script>
<script src="/blog/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>


<script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?bb74e3da22205cadfa4f6e0a31a76ac4";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
</script>
    


  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/blog/js/totop.js" async=""></script>
</body>
</html>
